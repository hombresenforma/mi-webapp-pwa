<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Configuración PWA -->
    <link rel="manifest" href="/mi-webapp-pwa/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/mi-webapp-pwa/icons/icon-192x192.png">
    
    <!-- Metadatos y Viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Entrenamiento - Programa Hombres en Forma</title>
    
    <!-- Scripts de Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fuentes de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> 
    
    <!-- Estilos CSS Personalizados -->
    <style>
        /* Estilos generales del cuerpo y la barra de desplazamiento */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821c6f4dbcf316861282241.png');
            background-color: #1A263A;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden; 
            color: #e5e7eb;
            touch-action: manipulation;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #4A5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #eab308; }

        /* Contenedor principal de la aplicación */
        .main-container {
            width: 100%;
            max-width: 36rem;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 640px) { .main-container { max-width: 42rem; } }
        @media (min-width: 768px) { .main-container { max-width: 48rem; } }

        /* Estilos de la navegación por pestañas */
        .app-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .app-tab {
            position: relative;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            color: #d1d5db;
            background-color: rgba(31, 41, 55, 0.8);
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }
        .app-tab:hover {
            background-color: rgba(55, 65, 81, 0.9);
            color: #facc15;
        }
        .app-tab.active {
            background-color: #facc15;
            color: #1f2937;
            border-color: #facc15;
        }
        .app-tab.app-tab-notify {
            background-color: #22c55e;
            color: #1f2937;
            border-color: #22c55e;
        }
        .app-tab.app-tab-notify:hover {
            background-color: #16a34a;
            border-color: #16a34a;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Estilos de modales */
        .modal, .modal-base { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; max-height: 90vh; }
        #quickModeWorkoutModal .modal-content, #detailedHistoryModal .modal-content, #mainHistoryModal .modal-content, #fullWorkoutLogModal .modal-content { width: 95%; max-width: 700px; }
        #workoutSummaryModal .modal-content, #warmupModal .modal-content, #extrasModal .modal-content { width: 95%; max-width: 450px; }
        
        /* Estilos específicos del modal de calendario */
        #calendarModal .modal-content {
            width: 95%;
            max-width: 500px;
            background-color: #2D3748;
            border: 2px solid #FACC15;
            border-radius: 1rem;
        }
        #calendarModal .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            color: #FACC15;
            font-size: 1.25rem;
            font-weight: 600;
        }
        #calendarModal .calendar-nav-btn {
            background: none;
            border: none;
            color: #FACC15;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        #calendarModal .calendar-nav-btn:hover { color: #EAB308; }
        #calendarModal .day-entry {
            background-color: #1A202C;
            border-bottom: 2px solid #4A5568;
            color: #D1D5DB;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        #calendarModal .day-entry.current-day { border-left: 5px solid #FACC15; padding-left: 0.75rem; }
        #calendarModal .day-entry:hover { background-color: #2D3748; }
        #calendarModal .day-name { font-weight: 600; }
        #calendarModal .day-date { color: #9CA3AF; }
        #calendarModal .workout-info { display: flex; align-items: center; gap: 0.5rem; }
        #calendarModal .workout-name {
            background-color: #4A5568;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #FACC15;
        }
        #calendarModal .workout-count {
            background-color: #FACC15;
            color: #1A202C;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        #calendarModal .day-scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background-color: #FACC15;
            border-radius: 0 5px 5px 0;
        }
        #calendarModal .day-entry.has-more .workout-count { background-color: #22c55e; color: #fff; }
        #calendarModal .expanded-day-view { background-color: #1f2937; border-left: 5px solid #22c55e; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        #calendarModal .expanded-day-view .expanded-title { font-size: 1.1rem; font-weight: 600; color: #FACC15; margin-bottom: 0.75rem; }
        #calendarModal .expanded-day-view .expanded-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #4a5568; }
        #calendarModal .expanded-day-view .expanded-item:last-child { border-bottom: none; }
        #calendarModal .expanded-day-view .item-name { color: #D1D5DB; }
        #calendarModal .expanded-day-view .item-time { color: #9CA3AF; }

        /* Estilos de la sección de entrenamientos */
        .day-selection-container { display: flex; flex-direction: column; gap: 1rem; }
        .day-tab-bar { display: flex; flex-direction: column; gap: 0.5rem; }
        .day-tab { padding: 0.75rem 1rem; color: #d1d5db; font-weight: 500; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; text-align: center; background-color: rgba(31, 41, 55, 0.8); border: 1px solid #4b5563; }
        .day-tab:hover { background-color: rgba(55, 65, 81, 0.9); color: #facc15; }
        .day-tab.active { background-color: #facc15; color: #1f2937; font-weight: 600; border-color: #facc15; }
        .workout-preview-container { background-color: rgba(55, 65, 81, 0.7); border-radius: 0.5rem; padding: 1rem; border: 1px solid rgba(250, 204, 21, 0.3); min-height: 200px; display: flex; flex-direction: column; justify-content: space-between; }
        .workout-preview-container h3 { color: #fde047; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .workout-preview-container ul { list-style: none; padding-left: 0; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; flex-grow: 1; }
        .workout-preview-container li { color: #d1d5db; padding: 0.2rem 0; font-size: 0.85rem; }
        .start-workout-preview-button { background-color: #facc15; color: #1f2937; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out; margin-top: auto; font-size: 0.95rem; }
        .start-workout-preview-button:hover { background-color: #eab308; }
        .main-action-button { background-color: #4A5568; color: #facc15; border: 1px solid #facc15; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; margin-top: 1rem; font-size: 0.95rem; }
        .main-action-button:hover:not(:disabled) { background-color: #facc15; color: #1f2937; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Estilos de las tarjetas de ejercicio */
        .exercise-card-container, .quick-mode-superset-container { border-left: 4px solid #facc15; background-color: rgba(42, 50, 62, 0.8); backdrop-filter: blur(5px); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1-px rgba(0,0,0,0.06); padding: 0.75rem; margin-bottom: 1rem; position: relative; }
        .exercise-card-container-title, .quick-mode-superset-container .superset-title { font-size: 1rem; font-weight: 600; color: #fde047; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #4b5563; }
        .set-input input[readonly], .action-button:disabled, .quick-mode-register-button:disabled { background-color: #4A5568 !important; border-color: #718096 !important; color: #a0aec0 !important; cursor: not-allowed; }
        input::placeholder { color: #718096; opacity: 1; }
        .history-entry { border-bottom: 1px solid #4A5568; }
        .history-entry:last-child { border-bottom: none; }
        .history-reps-good { color: #4ade80; font-weight: bold; }
        .history-reps-bad { color: #f87171; font-weight: bold; }
        .main-history-item { background-color: #4a5568; color: #e5e7eb; padding: 0.75rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; width: 100%; margin-bottom: 0.5rem; text-align: left; cursor: pointer; }
        .main-history-item:hover { background-color: #5a6578; }
        .quick-mode-exercise-item { background-color: rgba(55, 65, 81, 0.8); border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #facc15; box-shadow: 0 2px 4px rgba(0,0,0,0.2); padding: 0.75rem; transition: border-left-color 0.3s ease; position: relative; }
        .quick-mode-exercise-item.completed-good { border-left-color: #22c55e; background-color: rgba(34, 197, 94, 0.2); }
        .quick-mode-exercise-item.completed-bad { border-left-color: #ef4444; background-color: rgba(239, 68, 68, 0.2); }
        .quick-mode-superset-container .quick-mode-exercise-item { border-left: none; padding-left: 0.5rem; margin-left: -0.5rem; }
        
        /* Estilos del encabezado de la tarjeta de ejercicio */
        .quick-mode-exercise-header { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 0.75rem; }
        .quick-mode-exercise-header .flex-top-row { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
        .quick-mode-exercise-header .info-and-settings { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }
        .quick-mode-exercise-header .info-line-with-settings { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 0.5rem; }
        .quick-mode-exercise-header .info { flex-grow: 1; min-width: 0; }
        .quick-mode-exercise-header .info .title-line { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .quick-mode-exercise-header .info strong { color: #fde047; font-weight: 600; font-size: 1rem; line-height: 1.3; }
        .quick-mode-exercise-header .info span { color: #d1d5db; font-size: 0.75rem; display: block; }
        
        /* Estilos del menú de opciones */
        .quick-mode-header-buttons {
            display: none;
            flex-direction: column;
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 10;
        }
        .quick-mode-header-buttons.is-active { display: flex; }
        .quick-mode-header-buttons .quick-action-btn { background: transparent; border: none; color: #facc15; cursor: pointer; width: auto; height: auto; padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; text-align: left; }
        .quick-mode-header-buttons .quick-action-btn:hover:not(:disabled) { background-color: #4b5563; }
        .quick-mode-header-buttons .quick-action-btn:disabled { opacity: 0.5; cursor: not-allowed; color: #718096; }
        
        /* Botón de configuración */
        .quick-mode-settings-button {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            width: 2rem;
            height: 2rem;
            background: #4A5568;
            border-radius: 9999px;
            color: #9CA3AF;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #4A5568;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .quick-mode-settings-button:hover { background-color: #5a6578; color: #e5e7eb; }
        .quick-mode-settings-button.active { background-color: #facc15; color: #1f2937; border-color: #facc15; }
        .increase-weight-btn { background: #facc15; border-color: #facc15; width: 2rem; height: 2rem; font-size: 0.9rem; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center; }

        /* Estilos de los inputs y botones de registro */
        .quick-mode-input-row { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 0.5rem; align-items: center; }
        .quick-mode-input { width: 100%; background-color: #1f2937; border: 1px solid #4b5563; color: white; border-radius: 0.375rem; padding: 0.5rem; text-align: center; font-size: 0.9rem; }
        .quick-mode-register-button { width: 100%; height: 100%; background-color: #facc15; color: #1f2937; font-weight: bold; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .quick-mode-register-button i { font-size: 1.1rem; }
        .quick-mode-register-button:hover:not(:disabled) { background-color: #eab308; }
        
        /* Estilos de los temporizadores */
        .timer-modal .modal-content { background-color: #1f2937; border: 2px solid #facc15; }
        .timer-modal h3 { color: #facc15; }
        .timer-modal .timer-display { font-family: 'Orbitron', sans-serif; color: #ffffff; }
        .timer-modal .timer-actions { display: flex; gap: 1rem; justify-content: center; }
        .timer-modal .timer-action-button { flex-grow: 1; }
        .set-data-row { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 0.5rem; }
        .set-data-row > span { flex-basis: auto; margin-right: 0.75rem; white-space: nowrap; }
        .set-data-row .set-input { display: flex; gap: 0.5rem; flex-grow: 1; }
        
        /* Estilos del modal de nuevo récord */
        #newRecordModal .modal-content { position: relative; background: linear-gradient(145deg, #fde047, #facc15); color: #1f2937; }
        #newRecordModal .close-button, #warmupModal .close-button { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #a0aec0; cursor: pointer; line-height: 1; }
        #newRecordModal .close-button:hover, #warmupModal .close-button:hover { color: white; }
        
        /* Estilos para el modal de compartir */
        .settings-menu-button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; color: #e5e7eb; background-color: #4a5568; border-radius: 0.375rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease-in-out; }
        .settings-menu-button i { margin-right: 0.75rem; width: 20px; text-align: center; }
        #shareCard { background: linear-gradient(135deg, #2d3748, #1a202c); color: white; padding: 2rem; border-radius: 1rem; border: 2px solid #facc15; width: 350px; }
        #shareCard h4 { color: #facc15; font-weight: bold; font-size: 1.5rem; text-align: center; }
        #shareCard p { font-size: 1.1rem; margin-top: 0.5rem; }
        #shareCard .logo { max-height: 50px; margin: 1rem auto; display: block; }
        #shareModal .modal-content { background: transparent; border: none; box-shadow: none; }
        
        /* Estilos para las tarjetas de temporizador */
        .timer-card { display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem; border-radius: 0.75rem; background-color: #2d3748; border: 2px solid #4a5568; width: 100%; max-width: 400px; color: #e5e7eb; }
        .timer-card-header { text-align: center; }
        .timer-card-header h3 { font-size: 1.5rem; font-weight: 700; color: #facc15; }
        .timer-card-header p { font-size: 0.9rem; color: #9ca3af; }
        .timer-card-body { text-align: center; }
        .timer-card-main-time { font-family: 'Orbitron', sans-serif; font-size: 5rem; font-weight: 700; line-height: 1; margin: 1rem 0; color: #ffffff; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .timer-card-info { background-color: rgba(31, 41, 55, 0.7); border-radius: 0.5rem; padding: 1rem; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #4a5568; gap: 0.5rem; }
        .timer-card-info .state-label { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .timer-card-info .state-label.work { color: #f87171; }
        .timer-card-info .state-label.rest { color: #34d399; }
        .timer-card-info .state-label.countdown { color: #facc15; }
        .timer-card-info .exercise-name { font-size: 1rem; font-weight: 500; color: #e5e7eb; text-align: center; }
        .timer-card-info .exercise-details { font-size: 0.8rem; color: #9ca3af; }
        .timer-card-actions { display: flex; gap: 1rem; width: 100%; }
        .timer-card-actions button { flex-grow: 1; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease; }
        
        /* Estilos del modal de historial completo */
        .workout-log-entry { background-color: rgba(55, 65, 81, 0.8); border-left: 4px solid #facc15; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .workout-log-entry h4 { font-size: 1.1rem; font-weight: 600; color: #fde047; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .workout-log-entry h4:hover { color: #eab308; }
        .workout-log-entry ul { list-style: none; padding-left: 0; }
        .workout-log-entry li { font-size: 0.9rem; color: #d1d5db; padding: 0.2rem 0; }
        .workout-log-entry .pr-icon { color: #facc15; font-size: 1.2em; }
        
        /* Otros estilos misceláneos */
        .button-disabled { opacity: 0.5; cursor: not-allowed !important; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #FACC15; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos del temporizador minimizado */
        #minimizedRestTimer {
            background-color: rgba(31, 41, 55, 0.9);
            border: 2px solid #facc15;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease-in-out;
            min-width: 120px;
            max-width: 150px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            display: none;
        }
        #minimizedRestTimer.is-active { display: flex; }
        #minimizedRestTimer:hover { background-color: rgba(55, 65, 81, 0.95); transform: scale(1.05); }
        #minimizedRestTimer .min-time { font-size: 1.8rem; line-height: 1; }
        #minimizedRestTimer .min-next-exercise { font-size: 0.7rem; color: #d1d5db; line-height: 1.2; }
        
        /* Estilos del botón de minimizar */
        .minimize-button {
            background-color: #4A5568;
            color: #facc15;
            border: 1px solid #facc15;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        .minimize-button:hover { background-color: #facc15; color: #1f2937; }

        /* Estilos de las vistas de registro */
        .quick-view-body { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 0.5rem; align-items: center; }
        .full-log-view-body { border-top: 2px solid #4b5563; padding-top: 1rem; margin-top: 0.75rem; }
        .full-log-view-body .set-data-row { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 0.5rem; gap: 0.5rem; }
        .full-log-view-body .set-data-row > span { flex-basis: auto; margin-right: 0.25rem; white-space: nowrap; font-size: 0.85rem; }
        .full-log-view-body .set-data-row .set-input { display: flex; gap: 0.5rem; flex-grow: 1; }
        .full-log-view-body .set-input input { padding: 0.4rem; font-size: 0.85rem; }
        .full-log-view-body .actions-footer { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .full-log-view-body .actions-footer button { padding: 0.6rem 0.8rem; font-size: 0.85rem; }
        
        /* Estilos de notas de ejercicio e imágenes */
        .quick-mode-exercise-item .notes { color: #d1d5db; font-size: 0.75rem; display: block; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #4b5563; }
        .timer-exercise-image { max-height: 120px; width: auto; max-width: 90%; border-radius: 0.5rem; object-fit: cover; display: none; }
        
        /* Estilos del modal de actividades extra */
        .extras-button { background: none; border: none; color: #3b82f6; padding: 0; margin: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: color 0.2s ease-in-out; }
        .extras-button:hover { color: #2563eb; }
        .extras-option-button { background-color: #4a5568; color: #e5e7eb; border: 1px solid #718096; padding: 0.75rem 1rem; border-radius: 0.375rem; width: 100%; text-align: left; transition: background-color 0.2s ease-in-out; display: flex; align-items: center; gap: 0.75rem; font-size: 0.95rem; }
        .extras-option-button:hover { background-color: #5a6578; }
        .extras-option-button i { width: 20px; text-align: center; }
        #extrasFormModal .modal-content { background-color: #1f2937; border: 2px solid #3b82f6; color: #e5e7eb; padding: 1.5rem; width: 95%; max-width: 450px; }
        #extrasFormModal h3 { color: #3b82f6; }
        #extrasFormModal .form-group { margin-bottom: 1rem; }
        #extrasFormModal input, #extrasFormModal select { background-color: #2d3748; border: 1px solid #4a5568; color: #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; width: 100%; }
        #extrasFormModal .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #extrasFormModal .custom-file-input { display: block; width: 100%; background-color: #2d3748; border: 1px solid #4a5568; padding: 0.75rem; border-radius: 0.375rem; cursor: pointer; text-align: center; color: #9ca3af; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        #extrasFormModal .custom-file-input:hover { background-color: #4a5568; border-color: #facc15; }
        #extrasFormModal .file-name { display: block; margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        #extrasFormModal .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        #extrasFormModal .modal-actions .cancel-button { background-color: #4a5568; color: #e5e7eb; }
        #extrasFormModal .modal-actions .submit-button { background-color: #3b82f6; color: #fff; }
        #extrasFormModal #otherActivityInputGroup { display: none; }
        .history-entry .extra-activity-image-container { display: block; margin-top: 1rem; text-align: center; max-width: 100%; }
        .history-entry .extra-activity-image-container img { max-width: 100%; height: auto; border-radius: 0.5rem; object-fit: contain; border: 1px solid #4a5568; }
        #registerExtraActivityButton { background-color: #22c55e; color: #fff; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; border: 2px solid transparent; }
        #registerExtraActivityButton:hover { background-color: #16a34a; }
        #cancelExtraActivityButton { background-color: #ef4444; color: #fff; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; border: 2px solid transparent; }
        #cancelExtraActivityButton:hover { background-color: #dc2626; }
        
        /* Estilos de las pantallas de bienvenida de los temporizadores */
        .timer-modal-welcome-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; padding: 2rem; border-radius: 0.75rem; background-color: #2d3748; border: 2px solid #4a5568; width: 100%; max-width: 400px; color: #e5e7eb; text-align: center; }
        .timer-modal-welcome-card h3 { font-size: 1.5rem; font-weight: 700; color: #facc15; }
        .timer-modal-welcome-card p { font-size: 0.95rem; color: #d1d5db; }
        .timer-modal-welcome-card .start-button { width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; background-color: #22c55e; color: #fff; transition: background-color 0.2s ease; }
        .timer-modal-welcome-card .start-button:hover { background-color: #16a34a; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-2 sm:p-4 text-gray-200">

    <div class="main-container mb-8">
        <header class="bg-gray-800/90 backdrop-blur-md shadow-xl rounded-t-xl p-4 sm:p-6 mb-0 border-b-2 border-yellow-500 text-center">
            <div class="flex justify-center items-center">
                <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" alt="Logo Programa Hombres en Forma" class="h-12 sm:h-14 md:h-16" onerror="this.alt='Logo HEF'; this.src='https://placehold.co/250x80/1a202c/facc15?text=Logo+Error';">
            </div>
        </header>

        <main class="bg-gray-800/85 backdrop-blur-md shadow-xl rounded-b-xl p-3 sm:p-4 md:p-6">
            <div class="mb-4">
                <a id="mainMenuButton" href="#" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    <i class="fas fa-home mr-2"></i>Menú Principal
                </a>
            </div>

            <!-- Sección principal del entrenamiento -->
            <div id="workoutSection" class="tab-content active">
                <section id="mainControlsSection" class="mb-4 sm:mb-6">
                    <div class="flex justify-center items-center gap-2 mb-2 sm:mb-3">
                        <h2 class="text-md sm:text-lg font-semibold text-yellow-400 text-center">SELECCIONA TU ENTRENAMIENTO</h2>
                        <button id="addExtrasButton" class="extras-button" title="Añadir Actividad Extra">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                    </div>
                    
                    <div class="day-selection-container">
                        <div id="daySelectionTabs" class="day-tab-bar"></div>
                        <div id="workoutPreviewContainer" class="workout-preview-container">
                            <p class="text-gray-400 text-center">Selecciona un día para ver la vista previa.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <button id="viewWorkoutHistoryButton" class="main-action-button">
                            <i class="fas fa-history mr-2"></i>Histórico Entrenamientos
                        </button>
                        <button id="viewExerciseHistoryButton" class="main-action-button">
                            <i class="fas fa-chart-line mr-2"></i>Histórico Ejercicios
                        </button>
                        <button id="videoCorrectionsButton" class="main-action-button">
                            <i class="fas fa-video mr-2"></i>Correcciones de Ejercicios
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modales de la aplicación -->
    
    <!-- Modal: Historial de Entrenamientos (Calendario) -->
    <div id="mainHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="calendarModal" class="modal-content transform scale-95">
            <div class="flex justify-between items-center px-4 py-2">
                <h3 class="text-xl font-semibold text-yellow-400">Historial de Entrenamientos</h3>
                <button onclick="closeModalElement(mainHistoryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial">×</button>
            </div>
            <div class="calendar-header px-4">
                <button class="calendar-nav-btn" onclick="changeWeek(-1)" aria-label="Semana anterior">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div id="currentMonthYear"></div>
                <button class="calendar-nav-btn" onclick="changeWeek(1)" aria-label="Semana siguiente">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div id="calendarDaysContainer" class="max-h-[70vh] overflow-y-auto px-2 pb-2"></div>
        </div>
    </div>

    <!-- Modal: Historial Detallado de Ejercicios -->
    <div id="detailedHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-[55] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            
            <div id="exerciseHistoryListView">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-semibold text-yellow-400">Historial de Ejercicios</h3>
                    <button onclick="closeDetailedHistoryModal()" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial detallado">×</button>
                </div>
                <div class="relative mb-4">
                    <input type="search" id="historySearchInput" placeholder="Escribe para filtrar ejercicios..." class="w-full bg-gray-700 border-2 border-gray-600 focus:border-yellow-500 text-white rounded-lg p-3 pl-10 transition-colors focus:outline-none">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="exerciseHistoryList" class="max-h-96 overflow-y-auto pr-2 space-y-2"></div>
            </div>

            <div id="exerciseHistoryDetailView" style="display: none;">
                <div class="flex justify-between items-center mb-2">
                    <button id="backToExerciseListBtn" class="text-gray-400 hover:text-yellow-400"><i class="fas fa-arrow-left mr-2"></i> Volver</button>
                    <button onclick="closeDetailedHistoryModal()" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial detallado">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <h3 id="detailedHistoryExerciseName" class="text-lg sm:text-xl font-semibold text-yellow-400 text-center mb-4 truncate"></h3>
                <div id="record1RMDisplay" class="text-center bg-gray-900/50 p-3 rounded-lg mb-4"></div>
                <div class="mb-6">
                    <canvas id="rmEvolutionChart"></canvas>
                </div>
                <div id="detailedHistoryContent" class="max-h-80 overflow-y-auto pr-2 text-sm text-gray-300 space-y-4"></div>
            </div>

        </div>
    </div>

    <!-- Modal: Log de Entrenamiento Completo -->
    <div id="fullWorkoutLogModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-[56] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="fullWorkoutLogTitle" class="text-lg sm:text-xl font-semibold text-yellow-400"></h3>
                <button onclick="closeModalElement(fullWorkoutLogModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de entrenamiento completo">×</button>
            </div>
            <div id="fullWorkoutLogContent" class="max-h-[70vh] overflow-y-auto pr-2 text-sm text-gray-300 space-y-4"></div>
            <button onclick="closeModalElement(fullWorkoutLogModal)" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2.5 px-4 rounded-lg shadow-md transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal: Añadir Actividades Extra -->
    <div id="extrasModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-yellow-400">Seleccionar Actividad</h3>
                <button onclick="closeModalElement(extrasModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de extras">×</button>
            </div>
            <div id="extrasOptionsContainer" class="space-y-3">
                <div class="form-group">
                    <label for="extraDateInput" class="block text-sm mb-1">Fecha de la actividad:</label>
                    <input type="date" id="extraDateInput" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
                </div>
                <div class="form-group">
                    <label for="extraActivitySelect" class="block text-sm mb-1">Actividad:</label>
                    <select id="extraActivitySelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2">
                        <option value="Pádel" data-icon="fas fa-tennis-ball">Pádel</option>
                        <option value="Bici" data-icon="fas fa-bicycle">Bici</option>
                        <option value="Natación" data-icon="fas fa-swimmer">Natación</option>
                        <option value="Kayak" data-icon="fas fa-water">Kayak</option>
                        <option value="Correr" data-icon="fas fa-running">Correr</option>
                        <option value="Trekking" data-icon="fas fa-hiking">Trekking</option>
                        <option value="Caminar" data-icon="fas fa-walking">Caminar</option>
                        <option value="Fútbol" data-icon="fas fa-futbol">Fútbol</option>
                        <option value="Otros">Otros...</option>
                    </select>
                </div>
                <div id="otherActivityInputGroup" class="form-group" style="display: none;">
                    <label for="otherActivityName" class="block text-sm mb-1">Nombre de la actividad:</label>
                    <input type="text" id="otherActivityName" placeholder="Escribe aquí..." class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
                </div>
                <div class="form-group">
                    <label for="extraTimeInput" class="block text-sm mb-1">Tiempo invertido (hh:mm):</label>
                    <input type="text" id="extraTimeInput" placeholder="Ej: 01:30" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md" oninput="this.value = this.value.replace(/[^0-9:]/g, ''); if(this.value.split(':').length > 2) { this.value = this.value.substring(0, this.value.lastIndexOf(':')); }">
                </div>
                <div class="form-group">
                    <label for="extraVolumeInput" class="block text-sm mb-1">Volumen de entrenamiento (en metros):</label>
                    <input type="number" id="extraVolumeInput" placeholder="Ej: 8000" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
                <div class="form-group">
                    <label for="extraCaptureInput" class="block text-sm mb-1">Subir captura (opcional):</label>
                    <input type="file" id="extraCaptureInput" accept="image/*" class="hidden">
                    <label for="extraCaptureInput" class="custom-file-input">
                        <i class="fas fa-upload mr-2"></i>Seleccionar Archivo
                    </label>
                    <span id="extraCaptureFileName" class="file-name">Ningún archivo seleccionado</span>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelExtraActivityButton" class="cancel-button">Cancelar</button>
                <button id="registerExtraActivityButton" class="submit-button">Registrar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Entrenamiento Rápido -->
    <div id="quickModeWorkoutModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-40 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 id="quickModeWorkoutModalTitle" class="text-xl sm:text-2xl font-bold text-yellow-500 text-left"></h3>
                <span id="workoutDuration" class="text-lg font-mono text-white">00:00</span>
            </div>
            <div id="quickModeExerciseList" class="space-y-4 sm:space-y-6"></div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeQuickModeWorkoutModal()" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-3 px-4 rounded-lg shadow-md">
                    Cerrar
                </button>
                <button id="endQuickModeWorkoutButton" onclick="toggleWorkoutState()" class="w-1/2 workout-control-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
                    <i class="fas fa-flag-checkered mr-2"></i>Terminar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Récord -->
    <div id="newRecordModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content text-center transform scale-95 p-8 rounded-xl shadow-2xl">
            <button class="close-button" onclick="closeModalElement(newRecordModal)">&times;</button>
            <i class="fas fa-trophy text-6xl text-yellow-900/80 mb-4"></i>
            <h3 class="text-3xl font-bold text-gray-800">¡NUEVO RÉCORD!</h3>
            <p id="newRecordText" class="text-lg mt-2 text-gray-700">Has superado tu 1RM anterior.</p>
        </div>
    </div>

    <!-- Modal: Temporizador de Descanso -->
    <div id="restTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[70] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="restTimerTitle">TIEMPO DE DESCANSO</h3>
                    <p id="restOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="restTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="restCurrentImage" src="" alt="Siguiente ejercicio" class="timer-exercise-image">
                        <div id="restStateLabel" class="state-label rest">DESCANSO</div>
                        <p id="restExerciseName" class="exercise-name">Siguiente: </p>
                        <p id="restExerciseDetails" class="exercise-details">Objetivo: </p>
                    </div>
                    <button onclick="toggleRestTimerMinimize()" class="minimize-button">MINIMIZAR</button>
                </div>
                <div class="timer-card-actions">
                    <button onclick="adjustRestTime(-15)" class="bg-gray-600 hover:bg-gray-700 text-white">-15s</button>
                    <button onclick="closeRestTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Saltar</button>
                    <button onclick="adjustRestTime(15)" class="bg-gray-600 hover:bg-gray-700 text-white">+15s</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Temporizador de Descanso Minimizado -->
    <div id="minimizedRestTimer" class="fixed top-4 left-4 z-[100] hidden" onclick="toggleRestTimerMinimize()">
        <span id="minimizedTimerDisplay" class="min-time">00:00</span>
        <span id="minimizedNextExercise" class="min-next-exercise"></span>
    </div>

    <!-- Modal: Temporizador de Trabajo (Para EMOM y Circuitos) -->
    <div id="workTimerModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[71] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="workTimerTitle">TIEMPO DE TRABAJO</h3>
                    <p id="workOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="workTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="workCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="workStateLabel" class="state-label work">TRABAJO</div>
                        <p id="workExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="workExerciseDetails" class="exercise-details">Objetivo:</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="closeWorkTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Finalizar Antes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Temporizador de Circuito -->
    <div id="circuitTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[76] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
            <div id="circuitWelcomeView" class="timer-modal-welcome-card" style="display: none;">
                <h3 id="circuitWelcomeTitle"></h3>
                <p id="circuitWelcomeDetails"></p>
                <img id="circuitWelcomeImage" src="" alt="Ejercicio de Circuito" class="timer-exercise-image" style="display: none;">
                <button onclick="runNextCircuitInterval()" class="start-button">EMPEZAR</button>
            </div>
             <div id="circuitActiveView" class="timer-card" style="display: none;">
                <div class="timer-card-header">
                    <h3 id="circuitTimerTitle"></h3>
                    <p id="circuitOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="circuitTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="circuitCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="circuitStateLabel" class="state-label"></div>
                        <p id="circuitExerciseName" class="exercise-name"></p>
                        <p id="circuitExerciseDetails" class="exercise-details"></p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateCircuitEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipCircuitInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Intercambiar Ejercicio -->
    <div id="swapExerciseModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[65] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-5 sm:p-6 w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="swapExerciseModalTitle" class="text-lg sm:text-xl font-semibold text-yellow-400">Sugerir Alternativa</h3>
                <button onclick="closeModalElement(swapExerciseModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de sugerencias">×</button>
            </div>
            <div id="swapExerciseModalContent" class="space-y-3 max-h-60 overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button onclick="closeModalElement(swapExerciseModal)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Temporizador EMOM -->
    <div id="emomTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[75] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
            <div id="emomWelcomeView" class="timer-modal-welcome-card" style="display: none;">
                <h3 id="emomWelcomeTitle"></h3>
                <p id="emomWelcomeDetails"></p>
                <img id="emomWelcomeImage" src="" alt="Ejercicio de EMOM" class="timer-exercise-image" style="display: none;">
                <button onclick="runNextEmomInterval()" class="start-button">EMPEZAR</button>
            </div>
            <div id="emomActiveView" class="timer-card" style="display: none;">
                <div class="timer-card-header">
                    <h3 id="emomTimerTitle"></h3>
                    <p id="emomOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="emomIntervalTimerDisplay" class="timer-card-main-time">01:00</div>
                    <div class="timer-card-info">
                        <img id="emomCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="emomStateLabel" class="state-label work">TRABAJO</div>
                        <p id="emomCurrentExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="emomCurrentExerciseDetails" class="exercise-details">Objetivo: <span id="emomCurrentExerciseReps">Reps</span> con <span id="emomCurrentExerciseWeight">--</span> Kg</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateEmomEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipEmomInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Resumen de Entrenamiento -->
    <div id="workoutSummaryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[95] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl shadow-xl p-6 sm:p-8 w-full transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-yellow-400">Resumen del Entrenamiento</h3>
                <button onclick="closeModalElement(workoutSummaryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar resumen">×</button>
            </div>
            <p class="text-gray-300 text-lg mb-2">Tiempo Total: <span id="workoutSummaryTotalTime" class="font-bold text-white">00:00</span></p>
            <p class="text-gray-300 text-lg mb-4">Volumen Total: <span id="workoutSummaryTotalVolume" class="font-bold text-white">0 Kg</span></p>
            <div id="workoutSummaryExerciseList" class="max-h-60 overflow-y-auto pr-2 mb-6 space-y-3"></div>
            <div class="grid grid-cols-2 gap-4">
                 <button onclick="closeWorkoutSummaryModal(false)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-3 px-4 rounded-lg shadow-md">
                    Volver
                </button>
                <button id="registerWorkoutButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                    Registrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Calculadora de Calentamiento -->
    <div id="warmupModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[67] opacity-0 pointer-events-none">
        <div class="modal-content relative bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-6 w-full transform scale-95">
            <button class="close-button" onclick="closeModalElement(warmupModal)">&times;</button>
            <h3 class="text-lg font-semibold text-yellow-400 mb-4">Calculadora de Aproximación</h3>
            <div class="mb-4">
                <label for="workingSetWeightInput" class="block text-sm text-gray-300 mb-1">Peso de tu primera serie efectiva (Kg):</label>
                <input type="number" id="workingSetWeightInput" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
            </div>
            <button onclick="calculateWarmupSets()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md mb-4">Calcular</button>
            <div id="warmupSetsResult" class="space-y-2 text-gray-200"></div>
        </div>
    </div>

    <!-- Modal: Compartir -->
    <div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[98] opacity-0 pointer-events-none">
        <div class="modal-content">
            <div id="shareCard"></div>
            <div class="flex justify-center gap-4 mt-4">
                <button onclick="downloadShareableImage()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg">Descargar</button>
                <button onclick="closeModalElement(shareModal)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Aviso de Día Incorrecto -->
    <div id="weekdayNoticeModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl p-6 w-full max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-semibold text-yellow-400">Función No Disponible</h3>
            <p class="text-gray-300 mb-6">Esta función solo está disponible en los días configurados.</p>
            <button onclick="closeModalElement(weekdayNoticeModal)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>

    <!-- Lógica de la aplicación con JavaScript -->
    <script>
        // =================================================================
        // ================ CONFIGURACIÓN Y ESTADO GLOBAL =================
        // =================================================================
        const APP_CONFIG = {
            urls: {
                workoutSubmission: 'https://aceleratumetabolismo.es/registro-entrenos',
                progressExternalUrl: 'https://aceleratumetabolismo.es/registro_', 
                mainPanelUrl: 'https://www.aceleratumetabolismo.es/panel_',
                videoUploadUrl: 'https://forms.gle/FSmmciaUWurD4A2g6'
            },
        };
        let VIDEO_PROMPT_CONFIG = { activeWeeks: 'none' };

        // Variables de estado de la aplicación
        let individualExerciseLogs = [];
        let workoutSessionSummaries = [];
        let extraActivities = [];
        let allHistoryItems = [];
        let currentActiveDayKey = null;
        let isWorkoutInProgress = false;
        let workoutTimerInterval = null;
        let workoutStartTime = 0;
        let currentSessionId = null;
        let rmChartInstance = null;
        let workoutData = null;
        let exerciseAlternatives = null;
        let wakeLock = null;

        // Variables de estado del temporizador de descanso
        let restTimerInterval = null;
        let currentRestDuration = 0;
        let restTimerEndTime = 0;
        let nextRestTimerTitle = '';
        
        // Variables de estado del temporizador de trabajo
        let workTimerInterval = null;
        let currentWorkDuration = 0;
        let workTimerEndTime = 0;
        let currentTimedExerciseCardId = null;
        let currentTimedExerciseSetNumber = 0;
        let totalSetsForCurrentTimedExercise = 0;
        let currentRestDurationForTimedExercise = 0;
        let timedExerciseSetsLogged = [];

        // Variables de estado para EMOM y Circuito
        let emomIntervalTimer = null;
        let currentEmomIntervalNumber = 0;
        let currentEmomExerciseIndex = 0;
        let emomExercisesArray = [];
        let totalEmomIntervals = 0;
        let emomWorkIntervalSeconds = 60;
        let currentEmomMainOrder = null;
        let circuitTimerInterval = null;
        let currentCircuitPhase = 'idle';
        let currentCircuitRound = 0;
        let currentCircuitExerciseIndexInRound = 0;
        let currentCircuitTimeLeft = 0;
        let circuitExercisesArray = [];
        let circuitDetailsGlobal = null;
        let currentCircuitMainOrder = null;

        // Variables de estado para los datos de registro
        let currentWorkoutSummaryData = [];
        let hasUnsavedFullLogChanges = false;
        let uploadedCaptureFile = null;
        let exerciseProgressMap = new Map();

        // Variables de estado del calendario
        let currentDate = new Date();
        const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let groupedHistory = {};
        
        // Configuración de Supabase
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6b2NtdGFjdmRmb3J4eXdmeGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MTQzNDQsImV4cCI6MjA2NDI5MDM0NH0.aPqF71fIUas99K3TY2heedNdj-X2MflrndmYjtCOgNU';
        let supabase = null;
        let userIdentifier = null;
        
        // Utilidades de audio
        let toneSynth = null;
        let countdownTimerInterval = null;
        let countdownTimeLeft = 0;
        let countdownCallback = null;
        let countdownType = '';

        // =================================================================
        // =================== REFERENCIAS A ELEMENTOS DEL DOM =============
        // =================================================================
        const dom = {
            daySelectionTabsContainer: document.getElementById('daySelectionTabs'),
            workoutPreviewContainer: document.getElementById('workoutPreviewContainer'),
            mainHistoryModal: document.getElementById('mainHistoryModal'),
            viewWorkoutHistoryButton: document.getElementById('viewWorkoutHistoryButton'),
            viewExerciseHistoryButton: document.getElementById('viewExerciseHistoryButton'),
            mainMenuButton: document.getElementById('mainMenuButton'),
            addExtrasButton: document.getElementById('addExtrasButton'),
            cancelExtraActivityButton: document.getElementById('cancelExtraActivityButton'),
            calendarModal: document.getElementById('calendarModal'),
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarDaysContainer: document.getElementById('calendarDaysContainer'),
            detailedHistoryModal: document.getElementById('detailedHistoryModal'),
            exerciseHistoryListView: document.getElementById('exerciseHistoryListView'),
            exerciseHistoryDetailView: document.getElementById('exerciseHistoryDetailView'),
            historySearchInput: document.getElementById('historySearchInput'),
            exerciseHistoryList: document.getElementById('exerciseHistoryList'),
            backToExerciseListBtn: document.getElementById('backToExerciseListBtn'),
            detailedHistoryExerciseName: document.getElementById('detailedHistoryExerciseName'),
            detailedHistoryContent: document.getElementById('detailedHistoryContent'),
            record1RMDisplay: document.getElementById('record1RMDisplay'),
            rmEvolutionChartCanvas: document.getElementById('rmEvolutionChart'),
            fullWorkoutLogModal: document.getElementById('fullWorkoutLogModal'),
            fullWorkoutLogTitle: document.getElementById('fullWorkoutLogTitle'),
            fullWorkoutLogContent: document.getElementById('fullWorkoutLogContent'),
            quickModeWorkoutModal: document.getElementById('quickModeWorkoutModal'),
            quickModeWorkoutModalTitle: document.getElementById('quickModeWorkoutModalTitle'),
            quickModeExerciseList: document.getElementById('quickModeExerciseList'),
            endQuickModeWorkoutButton: document.getElementById('endQuickModeWorkoutButton'),
            restTimerModal: document.getElementById('restTimerModal'),
            restTimerTitle: document.getElementById('restTimerTitle'),
            restOverallProgress: document.getElementById('restOverallProgress'),
            restTimerDisplay: document.getElementById('restTimerDisplay'),
            restStateLabel: document.getElementById('restStateLabel'),
            restExerciseName: document.getElementById('restExerciseName'),
            restExerciseDetails: document.getElementById('restExerciseDetails'),
            restCurrentImage: document.getElementById('restCurrentImage'),
            minimizedRestTimer: document.getElementById('minimizedRestTimer'),
            minimizedTimerDisplay: document.getElementById('minimizedTimerDisplay'),
            minimizedNextExercise: document.getElementById('minimizedNextExercise'),
            extrasModal: document.getElementById('extrasModal'),
            extraActivitySelect: document.getElementById('extraActivitySelect'),
            otherActivityInputGroup: document.getElementById('otherActivityInputGroup'),
            otherActivityNameInput: document.getElementById('otherActivityName'),
            extraTimeInput: document.getElementById('extraTimeInput'),
            extraVolumeInput: document.getElementById('extraVolumeInput'),
            extraCaptureInput: document.getElementById('extraCaptureInput'),
            extraCaptureFileName: document.getElementById('extraCaptureFileName'),
            registerExtraActivityButton: document.getElementById('registerExtraActivityButton'),
            extraDateInput: document.getElementById('extraDateInput'),
            workTimerModal: document.getElementById('workTimerModal'),
            workTimerTitle: document.getElementById('workTimerTitle'),
            workOverallProgress: document.getElementById('workOverallProgress'),
            workTimerDisplay: document.getElementById('workTimerDisplay'),
            workStateLabel: document.getElementById('workStateLabel'),
            workExerciseName: document.getElementById('workExerciseName'),
            workExerciseDetails: document.getElementById('workExerciseDetails'),
            workCurrentImage: document.getElementById('workCurrentImage'),
            circuitTimerModal: document.getElementById('circuitTimerModal'),
            circuitWelcomeView: document.getElementById('circuitWelcomeView'),
            circuitWelcomeTitle: document.getElementById('circuitWelcomeTitle'),
            circuitWelcomeDetails: document.getElementById('circuitWelcomeDetails'),
            circuitWelcomeImage: document.getElementById('circuitWelcomeImage'),
            circuitActiveView: document.getElementById('circuitActiveView'),
            circuitOverallProgress: document.getElementById('circuitOverallProgress'),
            circuitStateLabel: document.getElementById('circuitStateLabel'),
            circuitExerciseName: document.getElementById('circuitExerciseName'),
            circuitExerciseDetails: document.getElementById('circuitExerciseDetails'),
            circuitTimerDisplay: document.getElementById('circuitTimerDisplay'),
            swapExerciseModal: document.getElementById('swapExerciseModal'),
            swapExerciseModalTitle: document.getElementById('swapExerciseModalTitle'),
            swapExerciseModalContent: document.getElementById('swapExerciseModalContent'),
            emomTimerModal: document.getElementById('emomTimerModal'),
            emomWelcomeView: document.getElementById('emomWelcomeView'),
            emomWelcomeTitle: document.getElementById('emomWelcomeTitle'),
            emomWelcomeDetails: document.getElementById('emomWelcomeDetails'),
            emomWelcomeImage: document.getElementById('emomWelcomeImage'),
            emomActiveView: document.getElementById('emomActiveView'),
            emomTimerTitle: document.getElementById('emomTimerTitle'),
            emomOverallProgress: document.getElementById('emomOverallProgress'),
            emomStateLabel: document.getElementById('emomStateLabel'),
            emomCurrentExerciseName: document.getElementById('emomCurrentExerciseName'),
            emomCurrentExerciseReps: document.getElementById('emomCurrentExerciseReps'),
            emomCurrentExerciseWeight: document.getElementById('emomCurrentExerciseWeight'),
            emomCurrentExerciseDetails: document.getElementById('emomCurrentExerciseDetails'),
            emomIntervalTimerDisplay: document.getElementById('emomIntervalTimerDisplay'),
            workoutSummaryModal: document.getElementById('workoutSummaryModal'),
            workoutSummaryTotalTime: document.getElementById('workoutSummaryTotalTime'),
            workoutSummaryTotalVolume: document.getElementById('workoutSummaryTotalVolume'),
            workoutSummaryExerciseList: document.getElementById('workoutSummaryExerciseList'),
            registerWorkoutButton: document.getElementById('registerWorkoutButton'),
            newRecordModal: document.getElementById('newRecordModal'),
            newRecordText: document.getElementById('newRecordText'),
            warmupModal: document.getElementById('warmupModal'),
            shareModal: document.getElementById('shareModal'),
            weekdayNoticeModal: document.getElementById('weekdayNoticeModal')
        };
        
        // =================================================================
        // ======================== FUNCIONES UTILITY ======================
        // =================================================================
        function openModal(modalElement) {
            if (!modalElement) return;
            modalElement.classList.remove('opacity-0', 'pointer-events-none', 'hidden');
            modalElement.classList.add('opacity-100');
            const content = modalElement.querySelector('.modal-content, .relative');
            if (content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
        }
        function closeModalElement(modalElement) {
            if (!modalElement) return;
            const content = modalElement.querySelector('.modal-content, .relative');
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            modalElement.classList.remove('opacity-100', 'pointer-events-auto');
            modalElement.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                if (!modalElement.classList.contains('opacity-100')) {
                    modalElement.classList.add('hidden');
                }
            }, 300);
        }
        function showCustomAlert(message, type = 'info') {
            const alertContainerId = 'customAlert';
            const existingAlert = document.getElementById(alertContainerId);
            if (existingAlert) existingAlert.remove();
            const alertContainer = document.createElement('div');
            alertContainer.id = alertContainerId;
            alertContainer.className = `fixed top-5 right-5 z-[100] p-4 rounded-md shadow-lg text-white max-w-sm transition-opacity duration-300 ease-out opacity-0`;
            let bgColor = 'bg-blue-500 border-blue-700';
            let iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            if (type === 'error') { bgColor = 'bg-red-500 border-red-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; } 
            else if (type === 'warning') { bgColor = 'bg-yellow-500 border-yellow-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`; } 
            else if (type === 'info') { bgColor = 'bg-sky-500 border-sky-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 0118 0zm0 14a6 6 0 110-12 6 6 0 010 12zm-1-5a1 10 011-1h.01a1 10 110 2H10a1 10 01-1-1zm0-3a1 10 011-1h.01a1 10 110 2H10a1 10 01-1-1z"></path></svg>`; }
            alertContainer.classList.add(...bgColor.split(' '));
            alertContainer.innerHTML = `<div class="flex items-center">${iconSVG}<span class="text-sm">${message}</span><button onclick="this.closest('#${alertContainerId}').remove()" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-white hover:text-gray-200 rounded-lg p-1.5 inline-flex h-8 w-8 items-center justify-center"><span class="sr-only">Cerrar</span><svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg></button></div>`;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.classList.remove('opacity-0'); alertContainer.classList.add('opacity-100'); }, 10);
            setTimeout(() => { alertContainer.classList.remove('opacity-100'); alertContainer.classList.add('opacity-0'); setTimeout(() => {alertContainer.remove();}, 7000); }, 7000);
        }
        function showCustomConfirm(message, callback) {
            const confirmContainerId = 'customConfirmModal';
            if (document.getElementById(confirmContainerId)) return;
            const confirmContainer = document.createElement('div');
            confirmContainer.id = confirmContainerId;
            confirmContainer.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-75 p-4 transition-opacity duration-300 ease-out opacity-0';
            confirmContainer.innerHTML = `<div class="bg-gray-700 p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all duration-300 ease-out scale-95"><p class="text-gray-200 text-lg mb-6">${message}</p><div class="flex justify-end space-x-3"><button id="confirmCancelBtn" class="nav-button py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-600">Cancelar</button><button id="confirmOkBtn" class="danger-button py-2 px-4 rounded-md text-sm font-medium">Confirmar</button></div></div>`;
            document.body.appendChild(confirmContainer);
            setTimeout(() => { confirmContainer.classList.remove('opacity-0'); confirmContainer.classList.add('opacity-100'); confirmContainer.querySelector('div > div').classList.remove('scale-95'); confirmContainer.querySelector('div > div').classList.add('scale-100'); }, 10);
            document.getElementById('confirmOkBtn').onclick = () => { callback(); confirmContainer.remove(); };
            document.getElementById('confirmCancelBtn').onclick = () => { confirmContainer.remove(); };
        }
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        function openVideoLink(videoUrl) { if (videoUrl) { window.open(videoUrl, '_blank'); } }
        function calculateEpley1RM(weight, reps) { if (reps == 0 || weight == 0) return 0; if (reps == 1) return parseFloat(weight); return parseFloat(weight) * (1 + (parseFloat(reps) / 30)); }
        function isTimeBased(repsString) { return typeof repsString === 'string' && repsString.endsWith('s'); }
        function parseRepRange(repString) { if (!repString || typeof repString !== 'string') return { type: 'unknown' }; const cleaned = repString.replace(/reps|lado|\/lado/gi, '').trim(); if (cleaned.includes('-')) { const [min, max] = cleaned.split('-').map(n => parseInt(n, 10)); return { type: 'range', min, max }; } if (cleaned.includes(',')) { const reps = cleaned.split(',').map(n => parseInt(n.trim(), 10)); return { type: 'specific', target: Math.min(...reps) }; } const specific = parseInt(cleaned, 10); if (!isNaN(specific)) { return { type: 'specific', target: specific }; } return { type: 'unknown' }; }
        function getRepCompletionState(performedReps, targetRepsString) { 
            if (isTimeBased(targetRepsString)) { return 'good'; }
            const parsedTarget = parseRepRange(targetRepsString); 
            const performed = parseInt(performedReps, 10); 
            if (isNaN(performed)) return 'neutral'; 
            switch (parsedTarget.type) { 
                case 'range': 
                    if (performed >= parsedTarget.max) return 'good'; 
                    if (performed < parsedTarget.min) return 'bad'; 
                    return 'neutral'; 
                case 'specific': 
                    if (performed >= parsedTarget.target) return 'good'; 
                    if (performed <= parsedTarget.target - 3) return 'bad'; 
                    return 'neutral'; 
                default: return 'neutral'; 
            } 
        }
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) { return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function formatTimeHHMM(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
        }
        function parseDurationToSeconds(durationInput) {
            if (durationInput === null || typeof durationInput === 'undefined' || durationInput === '') { return 0; }
            const durationString = String(durationInput).trim().toLowerCase();
            let totalSeconds = 0;
            const hmsMatch = durationString.match(/^(\d+):(\d+):(\d+)$/);
            if(hmsMatch) { totalSeconds = parseInt(hmsMatch[1], 10) * 3600 + parseInt(hmsMatch[2], 10) * 60 + parseInt(hmsMatch[3], 10); } 
            else { const hmMatch = durationString.match(/^(\d+):(\d+)$/);
                if(hmMatch) { totalSeconds = parseInt(hmMatch[1], 10) * 3600 + parseInt(hmMatch[2], 10) * 60; } 
                else { const minutesMatch = durationString.match(/(\d+)\s*(min|minute|minutes|m)/);
                    const secondsMatch = durationString.match(/(\d+)\s*(s|sec|second|seconds)/);
                    const justNumberMatch = durationString.match(/^(\d+)$/);
                    if (minutesMatch) { totalSeconds += parseInt(minutesMatch[1], 10) * 60; }
                    if (secondsMatch) { totalSeconds += parseInt(secondsMatch[1], 10); } 
                    else if (justNumberMatch && !minutesMatch && !secondsMatch) { totalSeconds += parseInt(justNumberMatch[1], 10); }
                }
            }
            if (isNaN(totalSeconds) || totalSeconds === 0) { return 0; }
            return totalSeconds;
        }

        // =================================================================
        // ======================= LÓGICA DE DATOS =========================
        // =================================================================
        function getLastLoggedDataForSet(exerciseName, setNumber) {
            const entries = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a,b) => new Date(b.raw_date) - new Date(a.raw_date));
            if (entries.length > 0) {
                const setsPerformed = entries[0].sets_performed;
                const setData = setsPerformed.find(s => s.serie === setNumber);
                if (setData) return { kg: setData.kg || "", reps: setData.reps || "" };
            }
            return { kg: "", reps: "" };
        }
        function getLastLoggedWeightForExercise(exerciseName) {
            const entry = getLastWorkoutEntry(exerciseName);
            if (entry && entry.sets_performed && entry.sets_performed.length > 0) {
                for (let i = entry.sets_performed.length - 1; i >= 0; i--) {
                    const set = entry.sets_performed[i];
                    if (set.kg && !isNaN(parseFloat(set.kg))) { return set.kg; }
                }
            }
            return "";
        }
        function getLastWorkoutEntry(exerciseName) {
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a, b) => new Date(b.raw_date) - new Date(a.raw_date));
            return historyForExercise.length > 0 ? historyForExercise[0] : null;
        }
        function getHistoricalMaxRm(exerciseName) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName);
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) { maxRm = currentRm; }
                    }
                });
            });
            return maxRm;
        }
        function getHistoricalMaxRmExcludingSession(exerciseName, sessionId) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName && e.session_id !== sessionId);
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) { maxRm = currentRm; }
                    }
                });
            });
            return maxRm;
        }
        function showNewRecordAlert(newRm) { dom.newRecordText.textContent = `¡Has alcanzado un 1RM estimado de ${newRm.toFixed(1)}kg!`; openModal(dom.newRecordModal); }
        function getStartOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }
        function groupHistoryByDay() {
            groupedHistory = allHistoryItems.reduce((acc, item) => {
                const date = new Date(item.raw_date).toISOString().slice(0, 10);
                if (!acc[date]) { acc[date] = []; }
                acc[date].push(item);
                return acc;
            }, {});
        }
        function renderRmEvolutionChart(labels, data) { 
            if (rmChartInstance) { rmChartInstance.destroy(); } 
            const ctx = dom.rmEvolutionChartCanvas.getContext('2d'); 
            rmChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Evolución 1RM (kg)', 
                        data, 
                        backgroundColor: 'rgba(250, 204, 21, 0.2)', 
                        borderColor: '#facc15', 
                        borderWidth: 2 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } }, 
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } } 
                    }, 
                    plugins: { legend: { labels: { color: '#d1d5db' } } } 
                } 
            }); 
        }

        // =================================================================
        // ====================== LÓGICA PRINCIPAL DE LA APP ===============
        // =================================================================
        function initializeSupabaseClient() {
            const supabaseUrl = 'https://izocmtacvdforxywfxgr.supabase.co';
            try {
                supabase = window.supabase.createClient(supabaseUrl, SUPABASE_API_KEY);
            } catch (e) {
                console.error("Error inicializando Supabase:", e);
                showCustomAlert("Error de configuración: No se pudo conectar a la base de datos.", "error");
                return;
            }
            function obtenerParametroUrl(nombre) {
                nombre = nombre.replace(/[\[\]]/g, '\\$&');
                var regex = new RegExp('[?&]' + nombre + '(=([^&#]*)|&|#|$)'),
                    resultados = regex.exec(window.location.href);
                if (!resultados) return null;
                if (!resultados[2]) return '';
                return decodeURIComponent(resultados[2].replace(/\+/g, ' '));
            }
            userIdentifier = obtenerParametroUrl('usuario');
            if (!userIdentifier) {
                const path = window.location.pathname;
                const match = path.match(/\/app_([^/]+)/);
                userIdentifier = match ? match[1] : null;
            }
            if (!userIdentifier) {
                const urlParams = new URLSearchParams(window.location.search);
                const userFromQuery = urlParams.get('user');
                userIdentifier = userFromQuery || "default-user-id";
                console.warn("User identifier not found in URL. Using a default/placeholder. Data might not be isolated correctly.");
                showCustomAlert("Advertencia: Usuario no identificado en la URL. Los datos pueden no guardarse correctamente.", "warning");
            }
        }
        async function fetchVideoConfigFromSupabase() {
            if (!supabase || !userIdentifier) {
                console.warn("Supabase client or user identifier not available. Cannot fetch video config.");
                setupVideoCorrectionsButton();
                return;
            }
            try {
                const { data, error } = await supabase.from('user_configs').select('exercises_data').eq('client_id', userIdentifier).single();
                if (error && error.code !== 'PGRST116') {
                    console.error("Error fetching video config from Supabase:", error);
                    showCustomAlert("Error al cargar la configuración de correcciones de vídeo.", "error");
                }
                if (data && data.exercises_data && data.exercises_data.activeWeeks) {
                    VIDEO_PROMPT_CONFIG.activeWeeks = data.exercises_data.activeWeeks;
                } else {
                    VIDEO_PROMPT_CONFIG.activeWeeks = 'none';
                }
            } catch (e) {
                console.error("Unexpected error fetching video config:", e);
                showCustomAlert("Error inesperado al cargar la configuración de vídeo.", "error");
            }
            setupVideoCorrectionsButton();
        }
        async function loadWorkoutLogs() {
            if (!supabase || !userIdentifier) {
                individualExerciseLogs = []; workoutSessionSummaries = []; extraActivities = [];
                return;
            }
            try {
                const { data, error } = await supabase.from('workout_logs').select('*').eq('client_id', userIdentifier).order('raw_date', { ascending: false });
                if (error) { throw new Error(`Error loading workout logs: ${error.message}`); }
                individualExerciseLogs = data.filter(log => log.exercise_name !== "Workout Session Summary" && log.exercise_name !== "Extra Activity");
                workoutSessionSummaries = data.filter(log => log.exercise_name === "Workout Session Summary");
                extraActivities = data.filter(log => log.exercise_name === "Extra Activity");
                allHistoryItems = [...workoutSessionSummaries, ...extraActivities];
                groupHistoryByDay();
            } catch (e) {
                console.error("Error inesperado al cargar el historial de entrenamientos:", e);
                showCustomAlert(`Error al cargar el historial de entrenamientos: ${e.message}`, "error");
                individualExerciseLogs = []; workoutSessionSummaries = []; extraActivities = [];
            }
        }
        async function initializeWorkoutApp() {
            try {
                const workoutDataUrl = `https://raw.githubusercontent.com/hombresenforma/ivan-data/main/${userIdentifier || 'default-user'}.js`;
                const mainResponse = await fetch(workoutDataUrl);
                if (!mainResponse.ok) { throw new Error(`Network response for workout data was not ok: ${mainResponse.statusText}`); }
                const mainDataText = await mainResponse.text();
                const workoutDataRegex = /const workoutData = ({[\s\S]*?});/;
                const workoutDataMatch = mainDataText.match(workoutDataRegex);
                if (!workoutDataMatch) throw new Error("Could not find 'workoutData' object in the main source file.");
                workoutData = new Function(`return ${workoutDataMatch[1]}`)();
                const alternativesRegex = /const exerciseAlternatives = ({[\s\S]*?});/;
                const alternativesMatch = mainDataText.match(alternativesRegex);
                if (!alternativesMatch) throw new Error("Could not find 'exerciseAlternatives' object in the main source file.");
                exerciseAlternatives = new Function(`return ${alternativesMatch[1]}`)();
                await loadWorkoutLogs();
                setupDaySelectionTabs();
                await fetchVideoConfigFromSupabase();
            } catch (error) {
                console.error("Error initializing workout app:", error);
                if (dom.workoutPreviewContainer) {
                    dom.workoutPreviewContainer.innerHTML = `<p class="text-center text-red-500 font-semibold">Error al cargar la rutina. Asegúrate de que el usuario en la URL ('${userIdentifier}') es correcto y tiene un plan asignado.</p>`;
                }
            }
        }

        // =================================================================
        // ====================== GESTIÓN DE WAKE LOCK =====================
        // =================================================================
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => { console.log('Screen Wake Lock was released'); });
                    showCustomAlert('La pantalla se mantendrá encendida.', 'info');
                } catch (err) { console.error(`${err.name}, ${err.message}`); }
            } else { console.warn('Wake Lock API not supported.'); }
        };
        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
            }
        };
        const handleVisibilityChange = async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && isWorkoutInProgress) {
                await requestWakeLock();
            }
        };

        // =================================================================
        // ======================= RENDERIZADO DEL UI ======================
        // =================================================================
        function setupDaySelectionTabs() {
            dom.daySelectionTabsContainer.innerHTML = '';
            if (typeof workoutData === 'undefined') { return; }
            const dayKeys = Object.keys(workoutData);
            dayKeys.forEach((dayKey) => {
                const tab = document.createElement('button');
                tab.className = 'day-tab';
                tab.textContent = workoutData[dayKey].name.split(':')[0].trim();
                tab.dataset.dayKey = dayKey;
                tab.onclick = () => displayWorkoutPreview(dayKey);
                dom.daySelectionTabsContainer.appendChild(tab);
            });
            if (dayKeys[0]) { displayWorkoutPreview(dayKeys[0]); }
        }
        function displayWorkoutPreview(dayKey) {
            currentActiveDayKey = dayKey;
            if (typeof workoutData === 'undefined' || !workoutData[dayKey]) { return; }
            const dayData = workoutData[dayKey];
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.dayKey === dayKey));
            let previewHtml = `<h3>${dayData.name.toUpperCase()}</h3><ul>`;
            dayData.exercises.forEach(ex => {
                let titleText = '';
                if (ex.isEMOM) { titleText = 'EMOM'; }
                else if (ex.circuitDetails) { titleText = 'CIRCUITO'; }
                else if (ex.isSuperset) { titleText = 'SUPERSERIE'; }
                else { titleText = ex.name; }
                previewHtml += `<li>${ex.order}. ${titleText.toUpperCase()}</li>`;
                if (ex.items && Array.isArray(ex.items)) {
                    ex.items.forEach(sub => { previewHtml += `<li style="padding-left: 1.5rem;">${ex.order}.${sub.subOrder}. ${sub.name}</li>`; });
                }
            });
            previewHtml += `</ul><button onclick="startQuickMode('${dayKey}')" class="start-workout-preview-button"><i class="fas fa-play mr-2"></i>Empezar Entrenamiento</button>`;
            dom.workoutPreviewContainer.innerHTML = previewHtml;
        }
        function createQuickModeExerciseCard(dayKey, mainOrder, exerciseInput, isSubItem, specialData = null) {
            const card = document.createElement('div');
            const cardId = isSubItem ? `qm-ex-${dayKey}-${mainOrder}-${exerciseInput.subOrder}` : `qm-ex-${dayKey}-${mainOrder}`;
            card.id = cardId;
            card.className = `quick-mode-exercise-item`;
            card.dataset.dayKey = dayKey;
            card.dataset.mainOrder = String(mainOrder);
            card.dataset.subOrder = exerciseInput.subOrder !== undefined ? String(exerciseInput.subOrder) : '';
            card.dataset.currentName = exerciseInput.name;
            const originalData = exerciseInput.originalExerciseData || exerciseInput;
            card.dataset.originalExerciseData = JSON.stringify(originalData);
            card.dataset.primordialExerciseData = JSON.stringify(exerciseInput.primordialExerciseData || originalData);
            card.dataset.isSwapped = (exerciseInput.name !== originalData.name).toString();
            const isTimeBasedExercise = isTimeBased(exerciseInput.reps);
            const inputType = isTimeBasedExercise ? 'text' : 'number';
            const repsPlaceholder = Array.isArray(exerciseInput.reps) ? exerciseInput.reps.join(', ') : exerciseInput.reps;
            const kgPlaceholder = 'kg';
            const lastData = getLastLoggedDataForSet(exerciseInput.name, 1);
            const repsOnClick = isTimeBasedExercise ? `onclick="handleTimeBasedRepsClick(this, '${cardId}')"` : '';
            const dataIsTimeBased = isTimeBasedExercise ? `data-is-time-based="true"` : '';
            const totalSets = specialData ? specialData.series : (exerciseInput.sets || 1);
            card.dataset.totalSets = String(totalSets);
            const repsString = isTimeBasedExercise ? exerciseInput.reps : (Array.isArray(exerciseInput.reps) ? exerciseInput.reps.join(', ') : `${exerciseInput.reps || 'N/A'}`);
            let increaseWeightIndicator = '';
            if (getLastWorkoutEntry(exerciseInput.name) && getLastWorkoutEntry(exerciseInput.name).completion_state === 'good') { increaseWeightIndicator = `<div class="increase-weight-btn" title="¡Buen trabajo! Sube el peso en esta sesión."><i class="fas fa-arrow-up text-gray-900"></i></div>`; }
            let seriesText = `Series: ${totalSets}`;
            let settingsButtonHtml = '';
            let settingsDropdownHtml = '';
            const originalEscapedName = (originalData.name || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
            settingsButtonHtml = `<button class="quick-mode-settings-button" onclick="toggleSettingsMenu(this, '${cardId}')" aria-label="Opciones de ejercicio"><i class="fas fa-cog"></i></button>`;
            const showWarmupButton = !isSubItem && !isTimeBased(exerciseInput.reps) && !isTimeBased(repsPlaceholder);
            const warmupButtonHtml = showWarmupButton ? `<button onclick="openWarmupModal()" class="quick-action-btn"><i class="fas fa-fire w-5 text-center"></i> Calc. Aproximación</button>` : '';
            const primordialExerciseName = (JSON.parse(card.dataset.primordialExerciseData || '{}').name);
            const showSwapButton = (exerciseAlternatives[primordialExerciseName] || []).length > 0 || card.dataset.isSwapped === "true";
            const swapButtonHtml = showSwapButton ? `<button onclick="openSwapExerciseModal('${cardId}')" class="quick-action-btn"><i class="fas fa-exchange-alt w-5 text-center"></i> Cambiar Ejercicio</button>` : '';
            settingsDropdownHtml = `
                <div class="quick-mode-header-buttons" id="settingsMenu-${cardId}">
                    ${(typeof exerciseInput.rest === 'string' && !isTimeBasedExercise) ? `<button onclick="startRestTimer(${parseInt(exerciseInput.rest.match(/(\d+)s/)[1])})" class="quick-action-btn"><i class="fas fa-clock w-5 text-center"></i> Descanso</button>` : ''}
                    <button onclick="viewExerciseHistoryFromLog('${originalEscapedName}')" class="quick-action-btn"><i class="fas fa-chart-line w-5 text-center"></i> Ver Historial</button>
                    ${warmupButtonHtml}
                    ${swapButtonHtml}
                </div>
            `;
            const notesHtml = exerciseInput.notes ? `<div class="notes">${exerciseInput.notes}</div>` : '';
            const imageUrl = exerciseInput.imageUrl;
            const videoUrl = exerciseInput.videoUrl;
            let imageHtml = '';
            if (imageUrl) {
                const imageTag = `<img src="${imageUrl}" alt="Preview de ${exerciseInput.name}" class="w-24 h-24 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/4A5568/FACC15?text=No+Img';">`;
                if (videoUrl) { imageHtml = `<a href="${videoUrl}" target="_blank" class="flex-shrink-0" title="Ver vídeo">${imageTag}</a>`; }
                else { imageHtml = `<div class="flex-shrink-0">${imageTag}</div>`; }
            }
            card.innerHTML = ` 
                <div class="quick-mode-exercise-header"> 
                    <div class="flex-top-row">
                        ${imageHtml}
                        <div class="info-and-settings">
                            <div class="info-line-with-settings">
                                <div class="info"> 
                                    <div class="title-line"> 
                                        <strong>${isSubItem ? `${mainOrder}.${exerciseInput.subOrder}` : exerciseInput.order}. ${exerciseInput.name}</strong> ${increaseWeightIndicator} 
                                    </div> 
                                    <span>${seriesText} | Objetivo: ${repsString}</span> 
                                </div> 
                            </div>
                        </div>
                    </div>
                </div> 
                <div id="quickViewBody-${cardId}" class="quick-mode-input-row"> 
                    <input type="number" oninput="this.value=this.value.replace(/[^0-9]/g,'')" value="${lastData.kg || ''}" placeholder="${kgPlaceholder}" class="quick-mode-input" aria-label="Peso para ${exerciseInput.name}"> 
                    <input type="${inputType}" oninput="this.value=this.value.replace(/[^0-9]/g,'')" value="${lastData.reps || ''}" placeholder="${repsPlaceholder}" class="quick-mode-input" aria-label="Repeticiones para ${exerciseInput.name}" ${repsOnClick} ${dataIsTimeBased}> 
                    <button class="quick-mode-register-button" onclick="logSingleSetStepByStep(this, '${cardId}')" aria-label="Registrar set"> 
                        <i class="fas fa-check"></i> 
                    </button> 
                </div> 
                <div id="progressDisplay-${cardId}">
                    <div class="text-center text-sm font-semibold text-gray-400 mt-2">
                        Serie 1 de ${totalSets}
                    </div>
                </div>
                ${notesHtml}
                ${settingsButtonHtml}
                ${settingsDropdownHtml}
            `; 
            return card; 
        }
        function createQuickModeSupersetCard(dayKey, mainOrder, supersetInput) {
            const card = document.createElement('div');
            card.className = 'quick-mode-superset-container';
            card.id = `qm-superset-${dayKey}-${mainOrder}`;
            let controlButtonHtml = '', specialData = null, titleText = '';
            if (supersetInput.isEMOM) {
                titleText = 'EMOM';
                controlButtonHtml = `<button onclick="startEmom('${dayKey}', ${mainOrder})" class="bg-purple-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR EMOM</button>`;
                if (supersetInput.emomDetails && supersetInput.items) {
                    const exerciseCount = supersetInput.items.length;
                    const totalIntervals = parseInt(supersetInput.emomDetails.totalIntervals, 10);
                    if (exerciseCount > 0 && totalIntervals > 0) { specialData = { series: Math.ceil(totalIntervals / exerciseCount) }; }
                }
            } else if (supersetInput.circuitDetails) {
                titleText = 'CIRCUITO';
                controlButtonHtml = `<button onclick="startCircuit('${dayKey}', ${mainOrder})" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR CIRCUITO</button>`;
                specialData = { series: supersetInput.circuitDetails.totalRounds };
            } else if (supersetInput.isSuperset) {
                titleText = 'SUPERSERIE';
            } else {
                titleText = supersetInput.name;
            }
            card.innerHTML = `<div class="flex justify-between items-center"><h3 class="exercise-card-container-title" style="border-bottom:0; margin-bottom:0;">${mainOrder}. ${titleText.toUpperCase()}</h3><div>${controlButtonHtml}</div></div>`;
            if (supersetInput.items && Array.isArray(supersetInput.items)) {
                supersetInput.items.forEach((subExercise) => {
                    card.appendChild(createQuickModeExerciseCard(dayKey, mainOrder, subExercise, true, specialData));
                });
            }
            return card;
        }

        // =================================================================
        // ======================== GESTIÓN DE MODALES =====================
        // =================================================================
        function openWorkoutHistoryExplorer() {
            showExerciseListView();
            dom.historySearchInput.value = '';
            handleExerciseHistorySearch();
            openModal(dom.detailedHistoryModal);
        }
        function showExerciseListView() {
            dom.exerciseHistoryListView.style.display = 'block';
            dom.exerciseHistoryDetailView.style.display = 'none';
        }
        function showExerciseDetailView(exerciseName) {
            dom.exerciseHistoryListView.style.display = 'none';
            dom.exerciseHistoryDetailView.style.display = 'block';
            dom.detailedHistoryExerciseName.textContent = exerciseName;
            const entries = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a, b) => new Date(a.raw_date) - new Date(b.raw_date));
            dom.detailedHistoryContent.innerHTML = '';
            const chartLabels = [], chartData = [];
            let historicalMaxRm = 0, historicalMaxRmDate = '';
            if (entries.length === 0) {
                dom.detailedHistoryContent.innerHTML = '<p class="text-gray-400 text-center">No hay registros.</p>';
                dom.record1RMDisplay.innerHTML = '<p class="text-gray-400">Sin récord de 1RM</p>';
            } else {
                entries.forEach(entry => {
                    let maxRmForEntry = 0, bestSetForRm = null;
                    const setsPerformed = entry.sets_performed || [];
                    setsPerformed.forEach(set => {
                        if (!isTimeBased(set.reps)) {
                            const currentRm = calculateEpley1RM(set.kg, set.reps);
                            if (currentRm > maxRmForEntry) { maxRmForEntry = currentRm; bestSetForRm = set; }
                            if (currentRm > historicalMaxRm) { historicalMaxRm = currentRm; historicalMaxRmDate = entry.date; }
                        }
                    });
                    if (maxRmForEntry > 0) { chartLabels.push(entry.date); chartData.push(maxRmForEntry.toFixed(1)); }
                    const rmDisplay = maxRmForEntry > 0 && bestSetForRm ? `<p class="text-xs text-blue-400">1RM Est. (Serie ${bestSetForRm.serie}): ${maxRmForEntry.toFixed(1)}kg</p>` : '';
                    const setsList = setsPerformed.map(s => {
                        const completionClass = s.completionState === 'good' ? 'history-reps-good' : (s.completionState === 'bad' ? 'history-reps-bad' : 'neutral');
                        return `<li>Serie ${s.serie}: ${s.kg || 0}kg x <span class="${completionClass}">${s.reps || 0} ${isTimeBased(s.reps) ? 's' : 'reps'}</span></li>`;
                    }).join('');
                    dom.detailedHistoryContent.innerHTML += `<div class="history-entry pb-3 mb-3"><p class="font-semibold text-yellow-400">${entry.date} - ${entry.time}</p>${rmDisplay}<ul class="list-disc list-inside pl-2 text-gray-300 mt-1">${setsList}</ul></div>`;
                });
                dom.record1RMDisplay.innerHTML = `<span class="text-gray-300">Récord Histórico (1RM): </span><strong class="text-yellow-400 text-lg">${historicalMaxRm.toFixed(1)} kg</strong> <span class="text-gray-400 text-sm">(${historicalMaxRmDate})</span>`;
            }
            renderRmEvolutionChart(chartLabels, chartData);
        }
        function handleExerciseHistorySearch() {
            const query = dom.historySearchInput.value.toLowerCase().trim();
            dom.exerciseHistoryList.innerHTML = '';
            const uniqueExercises = [...new Set(individualExerciseLogs.map(item => item.exercise_name))].sort();
            const filteredExercises = uniqueExercises.filter(name => name.toLowerCase().includes(query));
            if (filteredExercises.length === 0) { dom.exerciseHistoryList.innerHTML = '<p class="text-gray-400 text-center py-4">No se encontraron ejercicios.</p>'; return; }
            filteredExercises.forEach(exerciseName => {
                const button = document.createElement('button');
                button.className = 'main-history-item';
                button.textContent = exerciseName;
                const escapedName = exerciseName.replace(/'/g, "\\'").replace(/"/g, '\\"');
                button.onclick = () => showExerciseDetailView(escapedName);
                dom.exerciseHistoryList.appendChild(button);
            });
        }
        function closeDetailedHistoryModal() { if (rmChartInstance) { rmChartInstance.destroy(); rmChartInstance = null; } closeModalElement(dom.detailedHistoryModal); }
        function viewExerciseHistoryFromLog(exerciseName) { showExerciseDetailView(exerciseName); openModal(dom.detailedHistoryModal); }
        function renderCalendar() {
            const startOfWeek = getStartOfWeek(currentDate);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            dom.currentMonthYear.textContent = `${months[startOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
            if (startOfWeek.getMonth() !== endOfWeek.getMonth()) { dom.currentMonthYear.textContent += ` - ${months[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`; }
            dom.calendarDaysContainer.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayKey = day.toISOString().slice(0, 10);
                const isCurrentDay = day.toDateString() === today.toDateString();
                const dayName = daysOfWeek[day.getDay()];
                const dayDate = day.getDate();
                const itemsForDay = groupedHistory[dayKey] || [];
                const hasMultipleItems = itemsForDay.length > 1;
                const dayEntry = document.createElement('div');
                dayEntry.className = `day-entry ${isCurrentDay ? 'current-day' : ''} ${hasMultipleItems ? 'has-more' : ''}`;
                dayEntry.innerHTML = `
                    <div class="day-info">
                        <span class="day-name">${dayName}</span>
                        <span class="day-date">${dayDate}</span>
                    </div>
                    <div class="workout-info">
                        ${itemsForDay.length > 0 ? `<span class="workout-name">${itemsForDay[0].name_workout.toUpperCase().substring(0, 15)}${itemsForDay[0].name_workout.length > 15 ? '...' : ''}</span>` : ''}
                        ${hasMultipleItems ? `<span class="workout-count">+${itemsForDay.length - 1}</span>` : ''}
                    </div>
                    ${isCurrentDay ? '<div class="day-scroll-indicator"></div>' : ''}
                `;
                if (itemsForDay.length > 0) { dayEntry.onclick = () => showDetailedDayLog(dayKey); }
                dom.calendarDaysContainer.appendChild(dayEntry);
            }
        }
        function changeWeek(direction) { currentDate.setDate(currentDate.getDate() + direction * 7); renderCalendar(); }
        function showDetailedDayLog(dayKey) {
            const items = groupedHistory[dayKey];
            if (!items || items.length === 0) return;
            const detailedContent = document.createElement('div');
            detailedContent.className = 'expanded-day-view';
            detailedContent.innerHTML = `<div class="expanded-title">Entrenos del Día ${new Date(dayKey + 'T00:00:00').getDate()}</div>`;
            items.sort((a,b) => new Date(a.raw_date) - new Date(b.raw_date)).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'expanded-item';
                const duration = item.total_time_session ? `Duración: ${item.total_time_session}` : `Hora: ${item.time}`;
                itemDiv.innerHTML = `<div class="item-name">${item.name_workout}</div><div class="item-time">${duration}</div>`;
                itemDiv.onclick = () => {
                    if (item.exercise_name === "Extra Activity") { showExtraActivityDetails(item); } 
                    else { openFullWorkoutLogModal(item.session_id); }
                };
                detailedContent.appendChild(itemDiv);
            });
            dom.calendarDaysContainer.innerHTML = '';
            dom.calendarDaysContainer.appendChild(detailedContent);
            const backButton = document.createElement('button');
            backButton.className = 'main-action-button mt-4';
            backButton.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>Volver';
            backButton.onclick = renderCalendar;
            dom.calendarDaysContainer.appendChild(backButton);
        }
        function openFullWorkoutLogModal(sessionId) {
            closeModalElement(dom.mainHistoryModal);
            dom.fullWorkoutLogContent.innerHTML = '';
            const sessionSummaryEntry = workoutSessionSummaries.find(s => s.session_id === sessionId);
            if (!sessionSummaryEntry) {
                dom.fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se encontraron detalles para este entrenamiento.</p>';
                openModal(dom.fullWorkoutLogModal);
                return;
            }
            dom.fullWorkoutLogTitle.textContent = `Entrenamiento del ${sessionSummaryEntry.date} a las ${sessionSummaryEntry.time}`;
            let exercisesInSession = [];
            try { exercisesInSession = JSON.parse(sessionSummaryEntry.sets_performed); } 
            catch (e) { console.error("Error parsing exercises_performed for session summary:", e); dom.fullWorkoutLogContent.innerHTML = '<p class="text-red-400 text-center">Error al cargar los detalles del entrenamiento.</p>'; openModal(dom.fullWorkoutLogModal); return; }
            if (exercisesInSession.length === 0) { dom.fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios en esta sesión.</p>'; } 
            else {
                exercisesInSession.forEach(exerciseEntry => {
                    const isNewPR = exerciseEntry.personalRecord !== null && exerciseEntry.personalRecord !== undefined;
                    const prIcon = isNewPR ? `<i class="fas fa-trophy pr-icon ml-2" title="¡Nuevo Récord Personal! (${exerciseEntry.personalRecord} kg)"></i>` : '';
                    const escapedExerciseName = exerciseEntry.exerciseName.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const exerciseHtml = document.createElement('div');
                    exerciseHtml.className = 'workout-log-entry';
                    exerciseHtml.innerHTML = `
                        <h4 onclick="viewExerciseHistoryFromLog('${escapedExerciseName}')" style="cursor: pointer;" title="Ver historial de este ejercicio">${exerciseEntry.exerciseName}${prIcon}</h4>
                        <ul>
                            ${exerciseEntry.setsPerformed.map(set => {
                                const completionClass = set.completionState === 'good' ? 'history-reps-good' : (set.completionState === 'bad' ? 'history-reps-bad' : '');
                                const repsUnit = isTimeBased(set.reps) ? 's' : 'reps';
                                return `<li>S.${set.serie}: ${set.kg || 0}kg x <span class="${completionClass}">${set.reps || 0} ${repsUnit}</span></li>`;
                            }).join('')}
                        </ul>
                    `;
                    dom.fullWorkoutLogContent.appendChild(exerciseHtml);
                });
            }
            openModal(dom.fullWorkoutLogModal);
        }
        function setupExtrasForm() {
            dom.extraActivitySelect.value = 'Pádel'; dom.otherActivityInputGroup.style.display = 'none'; dom.otherActivityNameInput.value = ''; dom.extraTimeInput.value = ''; dom.extraVolumeInput.value = ''; dom.extraCaptureInput.value = ''; dom.extraCaptureFileName.textContent = 'Ningún archivo seleccionado'; uploadedCaptureFile = null;
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dom.extraDateInput.value = `${year}-${month}-${day}`;
            dom.extraActivitySelect.onchange = () => { dom.otherActivityInputGroup.style.display = dom.extraActivitySelect.value === 'Otros' ? 'block' : 'none'; };
            dom.extraCaptureInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) { dom.extraCaptureFileName.textContent = file.name; uploadedCaptureFile = file; } 
                else { dom.extraCaptureFileName.textContent = 'Ningún archivo seleccionado'; uploadedCaptureFile = null; }
            };
            dom.registerExtraActivityButton.onclick = () => {
                const activityName = dom.extraActivitySelect.value === 'Otros' ? dom.otherActivityNameInput.value.trim() : dom.extraActivitySelect.value;
                const activityDate = dom.extraDateInput.value;
                if (activityName === '' || activityDate === '') { showCustomAlert("Por favor, introduce el nombre de la actividad y la fecha.", "warning"); return; }
                registerExtraActivity(activityName, activityDate, dom.extraTimeInput.value.trim(), dom.extraVolumeInput.value.trim(), uploadedCaptureFile);
            };
        }
        async function registerExtraActivity(activityName, activityDate, time, volume, captureFile) {
            if (!supabase || !userIdentifier) { showCustomAlert("No se pudo registrar la actividad. Usuario no identificado.", "error"); return; }
            closeModalElement(dom.extrasModal);
            showCustomAlert(`Registrando "${activityName}"...`, "info");
            let captureUrl = null;
            if (captureFile) {
                try {
                    const filePath = `extra_captures/${userIdentifier}/${Date.now()}_${captureFile.name}`;
                    const { data, error } = await supabase.storage.from('workout-captures').upload(filePath, captureFile, { cacheControl: '3600', upsert: false });
                    if (error) { throw new Error(`Error uploading image: ${error.message}`); }
                    const publicUrl = supabase.storage.from('workout-captures').getPublicUrl(filePath).data.publicUrl;
                    captureUrl = publicUrl;
                } catch (error) { console.error("Error al subir la imagen:", error); showCustomAlert(`Error al subir la imagen: ${error.message}`, "error"); }
            }
            const [hoursStr = '0', minutesStr = '0'] = time.split(':');
            const totalTimeInSeconds = (parseInt(hoursStr) * 3600) + (parseInt(minutesStr) * 60);
            
            // Corrige la lógica para usar la fecha y hora seleccionadas por el usuario
            const [year, month, day] = activityDate.split('-').map(Number);
            const logDate = new Date(year, month - 1, day, parseInt(hoursStr, 10), parseInt(minutesStr, 10));

            const logEntry = {
                client_id: userIdentifier,
                date: logDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: logDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                raw_date: logDate.toISOString(),
                exercise_name: "Extra Activity",
                name_workout: activityName,
                sets_performed: '[]',
                completion_state: "completed",
                session_id: crypto.randomUUID(),
                total_time_session: formatTimeHHMM(totalTimeInSeconds) || null,
                total_volume_session: volume || null,
                capture_url: captureUrl
            };
            try {
                const { error } = await supabase.from('workout_logs').insert([logEntry]);
                if (error) { throw new Error(`Error inserting extra activity log: ${error.message}`); }
                showCustomAlert(`Actividad "${activityName}" registrada con éxito.`, "info");
                await loadWorkoutLogs();
                renderCalendar();
            } catch (error) { console.error("Error al registrar la actividad extra:", error); showCustomAlert(`Error al registrar la actividad: ${error.message}`, "error"); }
        }
        function openSwapExerciseModal(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const originalExerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const primordialExerciseData = JSON.parse(card.dataset.primordialExerciseData || '{}');
            dom.swapExerciseModalTitle.textContent = `Alternativas para: ${primordialExerciseData.name}`;
            dom.swapExerciseModalContent.innerHTML = '';
            const alternatives = exerciseAlternatives[primordialExerciseData.name] || [];
            const isSwapped = card.dataset.isSwapped === "true";
            if (isSwapped) {
                const revertButton = document.createElement('button');
                revertButton.className = 'w-full text-left p-3 bg-blue-700 hover:bg-blue-600 rounded-md transition-colors mb-2';
                revertButton.innerHTML = `<strong class="text-yellow-300"><i class="fas fa-undo mr-2"></i>Volver a ${originalExerciseData.name}</strong>`;
                revertButton.onclick = () => { performExerciseSwap(cardId, originalExerciseData); closeModalElement(dom.swapExerciseModal); };
                dom.swapExerciseModalContent.appendChild(revertButton);
            }
            let hasAlternatives = false;
            if (alternatives.length > 0) {
                alternatives.forEach(alt => {
                    if (alt.name === card.dataset.currentName) return;
                    hasAlternatives = true;
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md transition-colors';
                    button.innerHTML = `<strong class="text-yellow-400">${alt.name}</strong>`;
                    button.onclick = () => { performExerciseSwap(cardId, { ...primordialExerciseData, name: alt.name, videoUrl: alt.videoUrl, imageUrl: alt.imageUrl }); closeModalElement(dom.swapExerciseModal); };
                    dom.swapExerciseModalContent.appendChild(button);
                });
            }
            if (!hasAlternatives && !isSwapped) { dom.swapExerciseModalContent.innerHTML = '<p class="text-gray-400 text-center">No hay alternativas disponibles para este ejercicio.</p>'; }
            openModal(dom.swapExerciseModal);
        }
        function performExerciseSwap(cardId, newExerciseData) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const parent = card.parentNode;
            const isSubItem = card.dataset.subOrder !== '';
            let specialData = null;
            if (isSubItem) {
                const supersetContainer = card.closest('.quick-mode-superset-container');
                if(supersetContainer){
                    const supersetBlockData = workoutData[currentActiveDayKey].exercises.find(ex => `qm-superset-${currentActiveDayKey}-${ex.order}` === supersetContainer.id);
                    if(supersetBlockData && supersetBlockData.isEMOM) { specialData = { series: Math.ceil(supersetBlockData.emomDetails.totalIntervals / supersetBlockData.items.length) }; }
                    else if (supersetBlockData && supersetBlockData.circuitDetails) { specialData = { series: supersetBlockData.circuitDetails.totalRounds }; }
                }
            }
            const exerciseInput = newExerciseData;
            const originalData = exerciseInput.originalExerciseData || exerciseInput;
            const exerciseToCreate = { ...newExerciseData, originalExerciseData: originalData };
            const newCard = createQuickModeExerciseCard(card.dataset.dayKey, parseInt(card.dataset.mainOrder), exerciseToCreate, isSubItem, specialData);
            if (parent) { parent.replaceChild(newCard, card); }
            updateAllExerciseCardInputStates();
        }
        function updateAllExerciseCardInputStates() {
            document.querySelectorAll('#quickModeWorkoutModal .quick-mode-exercise-item').forEach(card => {
                const exerciseName = card.dataset.currentName;
                const cardId = card.id;
                const logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseName);
                const setsLoggedCount = logEntry ? logEntry.setsPerformed.length : 0;
                const totalSets = parseInt(card.dataset.totalSets);
                const isFinalized = setsLoggedCount >= totalSets;
                const quickViewBody = document.getElementById(`quickViewBody-${cardId}`);
                if (!quickViewBody) return;
                const kgInput = quickViewBody.querySelector('input[aria-label*="Peso"]');
                const repsInput = quickViewBody.querySelector('input[aria-label*="Repeticiones"]');
                const registerBtn = quickViewBody.querySelector('.quick-mode-register-button');
                const progressDisplayContainer = document.getElementById(`progressDisplay-${cardId}`);
                if (progressDisplayContainer) {
                    let seriesHtml = `<div class="text-center text-sm font-semibold text-gray-400 mt-2">Serie ${setsLoggedCount + 1} de ${totalSets}</div>`;
                    const setsList = logEntry ? logEntry.setsPerformed.map(s => {
                        const repsUnit = isTimeBased(s.reps) ? 's' : 'reps';
                        const completionClass = s.completionState === 'good' ? 'text-green-400' : (s.completionState === 'bad' ? 'text-red-400' : 'text-gray-400');
                        return `<li>S.${s.serie}: ${s.kg}kg x <span class="${completionClass} font-bold">${s.reps} ${repsUnit}</span></li>`;
                    }).join('') : '';
                    if (isFinalized) { seriesHtml = `<div class="text-center text-sm font-semibold text-green-400 mt-2">¡Completado!</div>`; }
                    const registeredSetsListHtml = logEntry && logEntry.setsPerformed.length > 0 ? `
                        <div class="bg-gray-700/50 p-3 rounded-md mb-2 mt-2">
                            <h5 class="text-yellow-400 text-sm font-semibold mb-1">Series registradas:</h5>
                            <ul class="list-disc list-inside space-y-1 text-xs">${setsList}</ul>
                        </div>` : '';
                    progressDisplayContainer.innerHTML = seriesHtml + registeredSetsListHtml;
                }
                kgInput.disabled = isFinalized; repsInput.disabled = isFinalized; registerBtn.disabled = isFinalized;
                if (isFinalized) {
                    registerBtn.innerHTML = '<i class="fas fa-check-double text-xl"></i>';
                    registerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    registerBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    card.classList.add('completed-good');
                } else {
                    registerBtn.innerHTML = '<i class="fas fa-check-circle text-xl"></i>';
                    registerBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    registerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    card.classList.remove('completed-good', 'completed-bad');
                }
            });
        }
        function toggleSettingsMenu(button, cardId) {
            const menu = document.getElementById(`settingsMenu-${cardId}`);
            button.classList.toggle('active');
            if (menu.classList.contains('is-active')) { menu.classList.remove('is-active'); } 
            else {
                document.querySelectorAll('.quick-mode-header-buttons').forEach(m => m.classList.remove('is-active'));
                document.querySelectorAll('.quick-mode-settings-button').forEach(b => b.classList.remove('active'));
                menu.classList.add('is-active');
            }
        }

        // =================================================================
        // ======================== LÓGICA DE TEMPORIZADORES =================
        // =================================================================
        function playTimerSound(note, duration) { if (toneSynth && Tone.context.state === 'running') { try { toneSynth.triggerAttackRelease(note, duration, Tone.now()); } catch (e) { console.error("Error playing sound:", e); } } }
        function startRestTimer(durationSeconds, nextExerciseData = null) {
            currentRestDuration = durationSeconds; clearInterval(restTimerInterval); restTimerEndTime = Date.now() + currentRestDuration * 1000;
            dom.restStateLabel.textContent = 'DESCANSO'; dom.restStateLabel.className = 'state-label rest';
            if(dom.restCurrentImage) { dom.restCurrentImage.style.display = 'none'; dom.restCurrentImage.src = ''; }
            if (nextExerciseData) {
                if (nextExerciseData.type === 'nextSet') { dom.restExerciseName.textContent = `Siguiente: Serie ${nextExerciseData.setNumber} de ${nextExerciseData.totalSets}`; dom.restExerciseDetails.textContent = `Objetivo: ${nextExerciseData.reps} con ${nextExerciseData.kg} Kg`; nextRestTimerTitle = `Serie ${nextExerciseData.setNumber} de ${nextExerciseData.totalSets}`; } 
                else { dom.restExerciseName.textContent = `Siguiente: ${nextExerciseData.name || ''}`; dom.restExerciseDetails.textContent = `Objetivo: ${nextExerciseData.reps || ''} con ${nextExerciseData.kg || '--'} Kg`; nextRestTimerTitle = `Siguiente: ${nextExerciseData.name || ''}`; }
                if(nextExerciseData.imageUrl && dom.restCurrentImage) { dom.restCurrentImage.src = nextExerciseData.imageUrl; dom.restCurrentImage.style.display = 'block'; }
            } else { dom.restExerciseName.textContent = ''; dom.restExerciseDetails.textContent = ''; nextRestTimerTitle = ''; }
            dom.minimizedRestTimer.classList.remove('is-active'); openModal(dom.restTimerModal); playTimerSound("C5", "16n");
            restTimerInterval = setInterval(() => {
                const timeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) { clearInterval(restTimerInterval); closeRestTimerModal(false); playTimerSound("A5", "8n"); } 
                else { updateRestTimerDisplay(timeLeft); if (timeLeft <= 3 && timeLeft > 0) { playTimerSound("C4", "16n"); } }
            }, 1000);
        }
        function adjustRestTime(secondsAdjustment) {
            if (!restTimerInterval) return;
            restTimerEndTime += secondsAdjustment * 1000;
            let newTimeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
            if (newTimeLeft <= 0) { clearInterval(restTimerInterval); closeRestTimerModal(false); playTimerSound("A5", "8n"); }
            updateRestTimerDisplay(newTimeLeft);
        }
        function updateRestTimerDisplay(timeLeft) {
            const seconds = timeLeft % 60;
            const minutes = Math.floor(timeLeft / 60);
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            dom.restTimerDisplay.textContent = formattedTime;
            dom.minimizedTimerDisplay.textContent = formattedTime;
            dom.minimizedNextExercise.textContent = nextRestTimerTitle;
        }
        function closeRestTimerModal(skipped = false) {
            clearInterval(restTimerInterval); dom.restTimerDisplay.textContent = '00:00'; dom.minimizedTimerDisplay.textContent = '00:00'; dom.minimizedNextExercise.textContent = '';
            dom.minimizedRestTimer.classList.remove('is-active'); closeModalElement(dom.restTimerModal);
            if(dom.restCurrentImage) { dom.restCurrentImage.style.display = 'none'; dom.restCurrentImage.src = ''; }
        }
        function toggleRestTimerMinimize() {
            if (dom.restTimerModal.classList.contains('opacity-100')) { closeModalElement(dom.restTimerModal); dom.minimizedRestTimer.classList.add('is-active'); } 
            else { dom.minimizedRestTimer.classList.remove('is-active'); openModal(dom.restTimerModal); }
        }
        function startWorkTimer(durationSeconds) { currentWorkDuration = durationSeconds; clearInterval(workTimerInterval); startCountdownTimer('work', 5, () => { runWorkTimer(); }); }
        function runWorkTimer() {
            workTimerEndTime = Date.now() + currentWorkDuration * 1000;
            updateWorkTimerDisplay(currentWorkDuration); openModal(dom.workTimerModal);
            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) { clearInterval(workTimerInterval); closeWorkTimerModal(false); playTimerSound("A5", "8n"); } 
                else { updateWorkTimerDisplay(timeLeft); if (timeLeft <= 3 && timeLeft > 0) { playTimerSound("C4", "16n"); } }
            }, 1000);
        }
        function updateWorkTimerDisplay(timeLeft) {
            const seconds = timeLeft % 60;
            const minutes = Math.floor(timeLeft / 60);
            dom.workTimerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function closeWorkTimerModal(skipped = false) {
            clearInterval(workTimerInterval); closeModalElement(dom.workTimerModal);
            if (skipped && currentTimedExerciseCardId !== null) { finalizeTimedExerciseSequence(); showCustomAlert("Ejercicio basado en tiempo finalizado antes de tiempo.", "warning"); }
        }
        function startEmom(dayKey, mainOrder) {
            const emomBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.isEMOM);
            if (!emomBlock || !emomBlock.emomDetails || !emomBlock.items) { showCustomAlert("Datos de EMOM no encontrados.", "error"); return; }
            emomExercisesArray = emomBlock.items;
            totalEmomIntervals = parseInt(emomBlock.emomDetails.totalIntervals, 10);
            emomWorkIntervalSeconds = 60;
            currentEmomMainOrder = mainOrder;
            if (isNaN(totalEmomIntervals) || isNaN(emomWorkIntervalSeconds) || emomWorkIntervalSeconds <= 0) { showCustomAlert("Configuración de EMOM inválida.", "error"); return; }
            currentEmomIntervalNumber = 0; currentEmomExerciseIndex = 0;
            dom.emomActiveView.style.display = 'none'; dom.emomWelcomeView.style.display = 'flex';
            dom.emomWelcomeTitle.textContent = 'EMOM';
            const totalMinutes = Math.floor(totalEmomIntervals * emomWorkIntervalSeconds / 60);
            dom.emomWelcomeDetails.innerHTML = `Tendrás que completar <strong>${totalEmomIntervals} intervalos de 1 minuto</strong>. <br>Ejercicios: ${emomExercisesArray.map(e => e.name).join(', ')}.`;
            const firstExerciseImage = emomExercisesArray[0].imageUrl;
            if (dom.emomWelcomeImage && firstExerciseImage) { dom.emomWelcomeImage.src = firstExerciseImage; dom.emomWelcomeImage.style.display = 'block'; }
            else if(dom.emomWelcomeImage) { dom.emomWelcomeImage.style.display = 'none'; dom.emomWelcomeImage.src = ''; }
            openModal(dom.emomTimerModal);
        }
        function runNextEmomInterval() {
            dom.emomWelcomeView.style.display = 'none'; dom.emomActiveView.style.display = 'flex'; clearInterval(emomIntervalTimer);
            if (currentEmomIntervalNumber >= totalEmomIntervals) { terminateEmom(true); return; }
            currentEmomIntervalNumber++;
            currentEmomExerciseIndex = (currentEmomIntervalNumber - 1) % emomExercisesArray.length;
            const currentExercise = emomExercisesArray[currentEmomExerciseIndex];
            updateEmomModalDisplay(currentExercise);
            let timeLeftInInterval = emomWorkIntervalSeconds;
            dom.emomStateLabel.textContent = 'TRABAJO'; dom.emomStateLabel.className = 'state-label work';
            dom.emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
            emomIntervalTimer = setInterval(() => {
                timeLeftInInterval--; dom.emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
                if (timeLeftInInterval <= 3 && timeLeftInInterval > 0) { playTimerSound("C4", "16n"); }
                if (timeLeftInInterval <= 0) { clearInterval(emomIntervalTimer); playTimerSound("A5", "8n"); runNextEmomInterval(); }
            }, 1000);
        }
        function updateEmomModalDisplay(exercise) {
            dom.emomTimerTitle.innerHTML = `<span class="text-yellow-400">Ronda ${Math.floor((currentEmomIntervalNumber - 1) / emomExercisesArray.length) + 1} de ${Math.ceil(totalEmomIntervals / emomExercisesArray.length)}</span>`;
            dom.emomOverallProgress.textContent = `Intervalo ${currentEmomIntervalNumber} de ${totalEmomIntervals}`;
            dom.emomCurrentExerciseName.textContent = exercise.name;
            dom.emomCurrentExerciseReps.textContent = exercise.reps || 'N/A';
            dom.emomCurrentExerciseWeight.textContent = exercise.kg || '--';
            const imgElement = dom.emomCurrentImage;
            if (imgElement && exercise.imageUrl) { imgElement.src = exercise.imageUrl; imgElement.style.display = 'block'; }
            else if (imgElement) { imgElement.style.display = 'none'; imgElement.src = ''; }
        }
        function terminateEmom(completed = false) { clearInterval(emomIntervalTimer); closeModalElement(dom.emomTimerModal); if (completed) { showCustomAlert("¡EMOM completado!", "info"); } else { showCustomAlert("EMOM terminado antes de tiempo.", "warning"); } }
        function terminateEmomEarly() { terminateEmom(false); }
        function skipEmomInterval() { clearInterval(emomIntervalTimer); playTimerSound("A4", "8n"); runNextEmomInterval(); }
        function startCircuit(dayKey, mainOrder) {
            const circuitBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.circuitDetails);
            if (!circuitBlock || !circuitBlock.circuitDetails || !circuitBlock.items) { showCustomAlert("Datos de Circuito no encontrados.", "error"); return; }
            circuitExercisesArray = circuitBlock.items; circuitDetailsGlobal = circuitBlock.circuitDetails; currentCircuitMainOrder = mainOrder;
            if (isNaN(circuitDetailsGlobal.totalRounds) || circuitDetailsGlobal.totalRounds <= 0) { showCustomAlert("Configuración de Circuito inválida.", "error"); return; }
            currentCircuitRound = 1; currentCircuitExerciseIndexInRound = 0; currentCircuitPhase = 'countdown'; currentCircuitTimeLeft = 5;
            dom.circuitActiveView.style.display = 'none'; dom.circuitWelcomeView.style.display = 'flex';
            dom.circuitWelcomeTitle.textContent = 'CIRCUITO';
            let totalCircuitDuration = 0;
            circuitExercisesArray.forEach(ex => { totalCircuitDuration += parseDurationToSeconds(ex.reps); });
            totalCircuitDuration += parseDurationToSeconds(circuitDetailsGlobal.restBetweenExercisesSeconds) * (circuitExercisesArray.length - 1);
            totalCircuitDuration = totalCircuitDuration * circuitDetailsGlobal.totalRounds;
            totalCircuitDuration += parseDurationToSeconds(circuitDetailsGlobal.restBetweenRoundsSeconds) * (circuitDetailsGlobal.totalRounds - 1);
            const formattedTotalDuration = formatTime(totalCircuitDuration);
            dom.circuitWelcomeDetails.innerHTML = `Consta de <strong>${circuitDetailsGlobal.totalRounds} rondas</strong> con una duración total de ${formattedTotalDuration}. <br>Ejercicios: ${circuitExercisesArray.map(e => e.name).join(', ')}.`;
            const firstExerciseImage = circuitExercisesArray[0].imageUrl;
            if (dom.circuitWelcomeImage && firstExerciseImage) { dom.circuitWelcomeImage.src = firstExerciseImage; dom.circuitWelcomeImage.style.display = 'block'; } 
            else if (dom.circuitWelcomeImage) { dom.circuitWelcomeImage.style.display = 'none'; dom.circuitWelcomeImage.src = ''; }
            openModal(dom.circuitTimerModal);
        }
        function runNextCircuitInterval() {
            dom.circuitWelcomeView.style.display = 'none'; dom.circuitActiveView.style.display = 'flex'; clearInterval(circuitTimerInterval);
            if (currentCircuitPhase === 'countdown') { currentCircuitPhase = 'working'; }
            else if (currentCircuitPhase === 'working') {
                currentCircuitExerciseIndexInRound++;
                if (currentCircuitExerciseIndexInRound >= circuitExercisesArray.length) {
                    if (currentCircuitRound < circuitDetailsGlobal.totalRounds) { currentCircuitPhase = 'resting_round'; } 
                    else { terminateCircuit(true); return; }
                } else { currentCircuitPhase = 'resting_exercise'; }
            } else if (currentCircuitPhase === 'resting_exercise') { currentCircuitPhase = 'working'; }
            else if (currentCircuitPhase === 'resting_round') { currentCircuitRound++; currentCircuitExerciseIndexInRound = 0; currentCircuitPhase = 'working'; }
            switch(currentCircuitPhase) {
                case 'working':
                    const currentExercise = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    currentCircuitTimeLeft = parseDurationToSeconds(currentExercise.reps);
                    if (currentCircuitTimeLeft === 0 && isTimeBased(currentExercise.reps)) { showCustomAlert(`Ejercicio ${currentExercise.name} no tiene duración definida. Saltando.`, "warning"); runNextCircuitInterval(); return; }
                    break;
                case 'resting_exercise': currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenExercisesSeconds); break;
                case 'resting_round': currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenRoundsSeconds); break;
            }
            updateCircuitModalDisplay();
            if (currentCircuitTimeLeft > 0) {
                circuitTimerInterval = setInterval(() => {
                    currentCircuitTimeLeft--; dom.circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
                    if (currentCircuitTimeLeft <= 3 && currentCircuitTimeLeft > 0) { playTimerSound("C4", "16n"); }
                    if (currentCircuitTimeLeft <= 0) { clearInterval(circuitTimerInterval); playTimerSound("A5", "8n"); runNextCircuitInterval(); }
                }, 1000);
            } else { runNextCircuitInterval(); }
        }
        function updateCircuitModalDisplay() {
            dom.circuitTimerTitle.innerHTML = `<span class="text-yellow-400">Ronda ${currentCircuitRound} de ${circuitDetailsGlobal.totalRounds}</span>`;
            dom.circuitOverallProgress.textContent = ''; dom.circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
            let exerciseForDisplay = null;
            switch (currentCircuitPhase) {
                case 'countdown': exerciseForDisplay = circuitExercisesArray[0]; dom.circuitStateLabel.textContent = 'CUENTA ATRÁS'; dom.circuitStateLabel.className = 'state-label countdown'; dom.circuitExerciseName.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`; dom.circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`; break;
                case 'working': exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound]; dom.circuitStateLabel.textContent = 'TRABAJO'; dom.circuitStateLabel.className = 'state-label work'; dom.circuitExerciseName.textContent = exerciseForDisplay?.name || ''; dom.circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`; break;
                case 'resting_exercise': exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound]; dom.circuitStateLabel.textContent = 'DESCANSO'; dom.circuitStateLabel.className = 'state-label rest'; dom.circuitExerciseName.textContent = `Siguiente: ${exerciseForDisplay?.name || ''}`; dom.circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`; break;
                case 'resting_round': exerciseForDisplay = circuitExercisesArray[0]; dom.circuitStateLabel.textContent = 'DESCANSO'; dom.circuitStateLabel.className = 'state-label rest'; dom.circuitExerciseName.textContent = `Prepárate para la Ronda ${currentCircuitRound + 1}`; dom.circuitExerciseDetails.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`; break;
            }
            const imgElement = dom.circuitCurrentImage;
            if (imgElement && exerciseForDisplay && exerciseForDisplay.imageUrl) { imgElement.src = exerciseForDisplay.imageUrl; imgElement.style.display = 'block'; } 
            else if (imgElement) { imgElement.style.display = 'none'; imgElement.src = ''; }
        }
        function terminateCircuit(completed = false) { clearInterval(circuitTimerInterval); closeModalElement(dom.circuitTimerModal); if (completed) { showCustomAlert("¡Circuito completado!", "info"); } else { showCustomAlert("Circuito terminado antes de tiempo.", "warning"); } }
        function terminateCircuitEarly() { terminateCircuit(false); }
        function skipCircuitInterval() { clearInterval(circuitTimerInterval); playTimerSound("A4", "8n"); runNextCircuitInterval(); }
        
        // =================================================================
        // =================== LÓGICA DE GESTIÓN DE WORKOUT =================
        // =================================================================
        function toggleWorkoutState() {
            if (isWorkoutInProgress) { openWorkoutSummaryModal(); releaseWakeLock(); } 
            else { isWorkoutInProgress = true; workoutStartTime = Date.now(); workoutTimerInterval = setInterval(updateWorkoutDuration, 1000); currentSessionId = crypto.randomUUID(); updateAllExerciseCardInputStates(); requestWakeLock(); }
        }
        function updateWorkoutDuration() {
            if (!isWorkoutInProgress || !workoutStartTime) return;
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const h = Math.floor(elapsed / 3600);
            const m = Math.floor((elapsed % 3600) / 60);
            const timeString = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            if (dom.workoutDuration) dom.workoutDuration.textContent = timeString;
        }
        function confirmBeforeClosingWorkoutModal(modalElement, callbackOnConfirm) {
            if (isWorkoutInProgress) {
                const confirmCloseModal = document.createElement('div');
                confirmCloseModal.id = 'confirmCloseModal';
                confirmCloseModal.className = 'modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[90]';
                confirmCloseModal.innerHTML = `<div class="modal-content bg-gray-800 border-2 border-red-500 rounded-xl p-6 w-full max-w-sm text-center"><h3 class="text-xl font-semibold text-red-400 mb-3">Entrenamiento en Curso</h3><p class="text-gray-300 mb-6 text-sm">¿Seguro que quieres cerrar? El progreso se perderá.</p><div class="flex gap-4"><button id="confirmCloseYes" class="w-1/2 bg-red-600 text-white py-2.5 rounded-lg">Sí, Cerrar</button><button id="confirmCloseNo" class="w-1/2 bg-gray-600 text-white py-2.5 rounded-lg">No</button></div></div>`;
                document.body.appendChild(confirmCloseModal);
                openModal(confirmCloseModal);
                document.getElementById('confirmCloseYes').onclick = () => {
                    isWorkoutInProgress = false; clearInterval(workoutTimerInterval); currentWorkoutSummaryData = []; releaseWakeLock();
                    closeModalElement(modalElement); closeModalElement(confirmCloseModal); confirmCloseModal.remove();
                    if (callbackOnConfirm) callbackOnConfirm();
                };
                document.getElementById('confirmCloseNo').onclick = () => { closeModalElement(confirmCloseModal); confirmCloseModal.remove(); };
            } else {
                closeModalElement(modalElement);
                if (callbackOnConfirm) callbackOnConfirm();
            }
        }
        function closeQuickModeWorkoutModal() { confirmBeforeClosingWorkoutModal(dom.quickModeWorkoutModal, () => { releaseWakeLock(); }); }
        function startQuickMode(dayKey) {
            if (isWorkoutInProgress) { showCustomAlert("Ya hay un entrenamiento en curso. Por favor, termínalo antes de empezar uno nuevo.", "warning"); return; }
            toggleWorkoutState();
            const dayData = workoutData[dayKey];
            dom.quickModeWorkoutModalTitle.textContent = dayData.name;
            dom.quickModeExerciseList.innerHTML = '';
            dayData.exercises.forEach(exercise => {
                if (exercise.isSuperset || exercise.isEMOM || exercise.circuitDetails) { dom.quickModeExerciseList.appendChild(createQuickModeSupersetCard(dayKey, exercise.order, exercise)); } 
                else { dom.quickModeExerciseList.appendChild(createQuickModeExerciseCard(dayKey, exercise.order, exercise, false)); }
            });
            updateAllExerciseCardInputStates(); openModal(dom.quickModeWorkoutModal);
        }
        function handleTimeBasedRepsClick(inputElement, cardId) {
            if (!isWorkoutInProgress) { showCustomAlert("Inicia el entrenamiento primero para usar el cronómetro.", "warning"); return; }
            const card = document.getElementById(cardId);
            if (!card) return;
            if (currentTimedExerciseCardId !== null && currentTimedExerciseCardId !== cardId && workTimerInterval !== null) { showCustomAlert("Ya hay un cronómetro de ejercicio activo. Finalízalo antes de empezar otro.", "warning"); return; }
            if (currentTimedExerciseCardId === cardId) {
                // If the same card is clicked again, it's a stop action
                finalizeTimedExerciseSequence();
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const workDuration = parseDurationToSeconds(exerciseData.reps);
            const totalSets = parseInt(card.dataset.totalSets, 10);
            const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
            currentRestDurationForTimedExercise = restDurationMatch ? parseInt(restDurationMatch[1], 10) : 0;
            if (workDuration <= 0) { showCustomAlert("Duración de trabajo no válida para el ejercicio basado en tiempo.", "error"); return; }
            currentTimedExerciseCardId = cardId; currentTimedExerciseSetNumber = 1; totalSetsForCurrentTimedExercise = totalSets; timedExerciseSetsLogged = [];
            const registerBtn = card.querySelector('.quick-mode-register-button');
            if (registerBtn) { registerBtn.disabled = true; registerBtn.innerHTML = '<i class="fas fa-hourglass-half text-xl"></i>'; }
            startCountdownTimer('work', 5);
        }
        function runWorkTimerForTimedExercise(durationSeconds) {
            clearInterval(workTimerInterval); const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) { console.error("Timed exercise card not found for work timer."); finalizeTimedExerciseSequence(); return; }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            workTimerEndTime = Date.now() + durationSeconds * 1000;
            dom.workTimerTitle.textContent = 'TIEMPO DE TRABAJO'; dom.workOverallProgress.textContent = `Serie ${currentTimedExerciseSetNumber} de ${totalSetsForCurrentTimedExercise}`;
            dom.workStateLabel.textContent = 'TRABAJO'; dom.workStateLabel.className = 'state-label work'; dom.workExerciseName.textContent = exerciseData.name; dom.workExerciseDetails.textContent = `Objetivo: ${exerciseData.reps}`;
            if (dom.workCurrentImage && exerciseData.imageUrl) { dom.workCurrentImage.src = exerciseData.imageUrl; dom.workCurrentImage.style.display = 'block'; }
            else if (dom.workCurrentImage) { dom.workCurrentImage.style.display = 'none'; dom.workCurrentImage.src = ''; }
            updateWorkTimerDisplay(durationSeconds); openModal(dom.workTimerModal);
            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(workTimerInterval); closeWorkTimerModal(false); playTimerSound("A5", "8n");
                    timedExerciseSetsLogged.push({ serie: currentTimedExerciseSetNumber, kg: 'N/A', reps: exerciseData.reps, isQuickMode: true, completionState: 'good' });
                    if (currentTimedExerciseSetNumber < totalSetsForCurrentTimedExercise) { currentTimedExerciseSetNumber++; startRestTimerForTimedExercise(); } 
                    else { finalizeTimedExerciseSequence(); }
                } else { updateWorkTimerDisplay(timeLeft); if (timeLeft <= 3 && timeLeft > 0) { playTimerSound("C4", "16n"); } }
            }, 1000);
        }
        function startRestTimerForTimedExercise() {
            clearInterval(restTimerInterval); const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) { console.error("Timed exercise card not found for rest timer."); finalizeTimedExerciseSequence(); return; }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            let nextExerciseForRest = null;
            if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) {
                nextExerciseForRest = { type: 'nextSet', name: card.dataset.currentName, reps: exerciseData.reps, kg: 'N/A', setNumber: currentTimedExerciseSetNumber, totalSets: totalSetsForCurrentTimedExercise, imageUrl: exerciseData.imageUrl };
            } else {
                const allExerciseCards = Array.from(dom.quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                const currentCardElement = document.getElementById(currentTimedExerciseCardId);
                const currentCardIndex = allExerciseCards.findIndex(el => el.id === currentTimedExerciseCardId || el.contains(currentCardElement));
                if (currentCardIndex !== -1) {
                    let nextCard = null;
                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) { nextCard = allExerciseCards[i]; break; }
                        else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) { const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item'); if (firstSubExercise) { nextCard = firstSubExercise; break; } }
                    }
                    if (nextCard) { const nextExerciseData = JSON.parse(nextCard.dataset.originalExerciseData || '{}'); nextExerciseForRest = { type: 'nextExercise', name: nextCard.dataset.currentName, reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A', kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--', imageUrl: nextExerciseData.imageUrl }; }
                }
            }
            currentRestDuration = currentRestDurationForTimedExercise; restTimerEndTime = Date.now() + currentRestDuration * 1000;
            dom.restTimerTitle.textContent = `DESCANSO - Serie ${currentTimedExerciseSetNumber - 1} de ${totalSetsForCurrentTimedExercise} completada`;
            dom.restStateLabel.textContent = 'DESCANSO'; dom.restStateLabel.className = 'state-label rest';
            if (nextExerciseForRest) {
                dom.restExerciseName.textContent = `Siguiente: ${nextExerciseForRest.name || ''}`;
                dom.restExerciseDetails.textContent = `Objetivo: ${nextExerciseForRest.reps || ''} con ${nextExerciseForRest.kg || '--'} Kg`;
                if(nextExerciseForRest.imageUrl && dom.restCurrentImage) { dom.restCurrentImage.src = nextExerciseForRest.imageUrl; dom.restCurrentImage.style.display = 'block'; }
            } else {
                dom.restExerciseName.textContent = 'Entrenamiento casi terminado'; dom.restExerciseDetails.textContent = '';
                if(dom.restCurrentImage) { dom.restCurrentImage.style.display = 'none'; dom.restCurrentImage.src = ''; }
            }
            dom.minimizedRestTimer.classList.remove('is-active'); openModal(dom.restTimerModal); playTimerSound("C5", "16n");
            restTimerInterval = setInterval(() => {
                const timeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(restTimerInterval); closeRestTimerModal(false); playTimerSound("A5", "8n");
                    if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) { const workDuration = parseDurationToSeconds(exerciseData.reps); startCountdownTimer('work', 5); } 
                    else { finalizeTimedExerciseSequence(); }
                } else { updateRestTimerDisplay(timeLeft); if (timeLeft <= 3 && timeLeft > 0) { playTimerSound("C4", "16n"); } }
            }, 1000);
        }
        function finalizeTimedExerciseSequence() {
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) { console.error("Timed exercise card not found during finalization."); return; }
            const exerciseName = card.dataset.currentName;
            const logEntry = {
                exerciseName,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                rawDate: new Date().toISOString(),
                dayKey: card.dataset.dayKey,
                setsPerformed: timedExerciseSetsLogged,
                completionState: 'good'
            };
            const existingEntryIndex = currentWorkoutSummaryData.findIndex(e => e.exerciseName === exerciseName);
            if (existingEntryIndex > -1) { currentWorkoutSummaryData[existingEntryIndex] = logEntry; } 
            else { currentWorkoutSummaryData.push(logEntry); }
            card.dataset.completionState = 'good'; updateAllExerciseCardInputStates(); showCustomAlert(`¡Ejercicio "${exerciseName}" completado!`, "info");
            currentTimedExerciseCardId = null; currentTimedExerciseSetNumber = 0; totalSetsForCurrentTimedExercise = 0; currentRestDurationForTimedExercise = 0; timedExerciseSetsLogged = [];
        }

        // =================================================================
        // ======================== LÓGICA DE REGISTRO =====================
        // =================================================================
        async function logSingleSetStepByStep(button, cardId) {
            if (!isWorkoutInProgress) { showCustomAlert("Inicia el entrenamiento primero para registrar series.", "warning"); return; }
            const card = document.getElementById(cardId);
            if (!card || card.querySelector('.quick-mode-register-button').disabled) { return; }
            const kgInput = card.querySelector('.quick-mode-input-row input[aria-label*="Peso"]');
            const repsInput = card.querySelector('.quick-mode-input-row input[aria-label*="Repeticiones"]');
            const kg = kgInput.value.trim();
            const reps = repsInput.value.trim();
            const totalSets = parseInt(card.dataset.totalSets, 10);
            const isTimeBasedExercise = isTimeBased(repsInput.placeholder);
            if (!isTimeBasedExercise && (kg === '' || reps === '')) { showCustomAlert("Por favor, introduce el peso y las repeticiones.", "warning"); return; }
            const originalButtonContent = button.innerHTML; button.innerHTML = '<i class="fas fa-check-circle text-xl animate-pulse"></i>';
            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); button.classList.add('bg-green-500');
            setTimeout(() => { if (!card.querySelector('.quick-mode-register-button').disabled) { button.innerHTML = originalButtonContent; button.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); button.classList.remove('bg-green-500'); } }, 500);
            let currentSet = exerciseProgressMap.get(cardId) || 1;
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const targetReps = isTimeBasedExercise ? exerciseData.reps : (Array.isArray(exerciseData.reps) && exerciseData.reps.length >= currentSet ? exerciseData.reps[currentSet - 1] : exerciseData.reps);
            const completionState = getRepCompletionState(reps, targetReps);
            let newPrValue = null;
            if (!isTimeBasedExercise && parseFloat(kg) > 0 && parseInt(reps) > 0) {
                const currentRm = calculateEpley1RM(kg, reps);
                const historicalMaxRm = getHistoricalMaxRmExcludingSession(exerciseData.name, currentSessionId);
                if (historicalMaxRm > 0 && currentRm > historicalMaxRm) { showNewRecordAlert(currentRm); newPrValue = currentRm.toFixed(1); }
                else if (historicalMaxRm === 0 && currentRm > 0) { newPrValue = currentRm.toFixed(1); }
            }
            let logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseData.name);
            if (!logEntry) {
                logEntry = {
                    exerciseName: exerciseData.name,
                    date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    rawDate: new Date().toISOString(),
                    dayKey: card.dataset.dayKey,
                    setsPerformed: [],
                    completionState: 'neutral',
                    personalRecord: newPrValue
                };
                currentWorkoutSummaryData.push(logEntry);
            }
            logEntry.setsPerformed.push({ serie: currentSet, kg, reps, completionState });
            let overallCompletion = 'good';
            for(const set of logEntry.setsPerformed) {
                const setCompletionState = getRepCompletionState(set.reps, targetReps);
                if(setCompletionState === 'bad') { overallCompletion = 'bad'; break; }
                if(setCompletionState === 'neutral') { overallCompletion = 'neutral'; }
            }
            logEntry.completionState = overallCompletion;
            if (newPrValue && (!logEntry.personalRecord || parseFloat(newPrValue) > parseFloat(logEntry.personalRecord))) { logEntry.personalRecord = newPrValue; }
            if (currentSet >= totalSets) { exerciseProgressMap.delete(cardId); updateAllExerciseCardInputStates(); showCustomAlert(`¡Ejercicio "${exerciseData.name}" completado!`, "info"); } 
            else {
                exerciseProgressMap.set(cardId, currentSet + 1);
                const nextSetData = getLastLoggedDataForSet(exerciseData.name, currentSet + 1);
                if (nextSetData.kg) { kgInput.value = nextSetData.kg; } else { kgInput.value = ''; }
                if (nextSetData.reps) { repsInput.value = nextSetData.reps; } else { repsInput.value = ''; }
                const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
                if (restDurationMatch) {
                    const restSeconds = parseInt(restDurationMatch[1], 10);
                    if (restSeconds > 0) {
                        let nextExerciseForRest = null;
                        const allExerciseCards = Array.from(dom.quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                        const currentCardIndex = allExerciseCards.findIndex(el => el.id === cardId || el.contains(card));
                        const currentSupersetContainer = card.closest('.quick-mode-superset-container');
                        if (currentSupersetContainer && currentSet < totalSets) {
                            const supersetItems = Array.from(currentSupersetContainer.querySelectorAll('.quick-mode-exercise-item'));
                            const currentSubIndex = supersetItems.findIndex(el => el.id === cardId);
                            const nextSubExerciseCard = supersetItems[currentSubIndex + 1];
                            if (nextSubExerciseCard) {
                                const nextExerciseData = JSON.parse(nextSubExerciseCard.dataset.originalExerciseData || '{}');
                                nextExerciseForRest = { type: 'nextExercise', name: nextExerciseData.name, reps: nextExerciseData.reps, kg: nextExerciseData.kg || '--', imageUrl: nextExerciseData.imageUrl };
                            } else {
                                const firstSubExerciseCard = supersetItems[0];
                                if (firstSubExerciseCard) {
                                    const nextExerciseData = JSON.parse(firstSubExerciseCard.dataset.originalExerciseData || '{}');
                                    nextExerciseForRest = { type: 'nextExercise', name: nextExerciseData.name, reps: nextExerciseData.reps, kg: nextExerciseData.kg || '--', imageUrl: nextExerciseData.imageUrl };
                                }
                            }
                        } else {
                            if (currentSet < totalSets) {
                                const nextSetNumber = currentSet + 1;
                                const nextKg = getLastLoggedDataForSet(exerciseData.name, nextSetNumber).kg || '--';
                                const nextReps = getLastLoggedDataForSet(exerciseData.name, nextSetNumber).reps || exerciseData.reps;
                                nextExerciseForRest = { type: 'nextSet', name: exerciseData.name, reps: nextReps, kg: nextKg, setNumber: nextSetNumber, totalSets: totalSets, imageUrl: exerciseData.imageUrl };
                            } else {
                                if (currentCardIndex !== -1) {
                                    let nextCard = null;
                                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) { nextCard = allExerciseCards[i]; break; }
                                        else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) { const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item'); if (firstSubExercise) { nextCard = firstSubExercise; break; } }
                                    }
                                    if (nextCard) { const nextExerciseData = JSON.parse(nextCard.dataset.originalExerciseData || '{}'); nextExerciseForRest = { type: 'nextExercise', name: nextCard.dataset.currentName, reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A', kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--', imageUrl: nextExerciseData.imageUrl }; }
                                }
                            }
                        }
                        startRestTimer(restSeconds, nextExerciseForRest);
                    }
                }
            }
            updateAllExerciseCardInputStates();
        }
        function openWorkoutSummaryModal() {
            const elapsed = workoutStartTime > 0 ? Math.floor((Date.now() - workoutStartTime) / 1000) : 0;
            const h = Math.floor(elapsed / 3600), m = Math.floor((elapsed % 3600) / 60);
            dom.workoutSummaryTotalTime.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            let totalVolume = 0;
            currentWorkoutSummaryData.forEach(entry => {
                entry.setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) { totalVolume += (parseFloat(set.kg) || 0) * (parseInt(set.reps) || 0); }
                });
            });
            dom.workoutSummaryTotalVolume.textContent = `${totalVolume.toFixed(0)} Kg`;
            dom.workoutSummaryExerciseList.innerHTML = '';
            if (currentWorkoutSummaryData.length === 0) { dom.workoutSummaryExerciseList.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios.</p>'; } 
            else {
                currentWorkoutSummaryData.forEach(entry => {
                    let displayInfo = entry.setsPerformed.map(s => { const repsUnit = isTimeBased(s.reps) ? 's' : 'r'; return `${s.kg}kg x ${s.reps}${repsUnit}`; }).join(', ');
                    dom.workoutSummaryExerciseList.innerHTML += `<div class="summary-exercise-item"><p class="font-semibold text-yellow-400">${entry.exerciseName}</p><p class="text-gray-300 text-sm">${displayInfo}</p></div>`;
                });
            }
            dom.registerWorkoutButton.onclick = async () => {
                dom.registerWorkoutButton.innerHTML = 'Procesando...'; dom.registerWorkoutButton.disabled = true; releaseWakeLock();
                try {
                    const individualLogsToInsert = currentWorkoutSummaryData.map(entry => ({ client_id: userIdentifier, date: entry.date, time: entry.time, raw_date: entry.rawDate, day_key: entry.dayKey, exercise_name: entry.exerciseName, sets_performed: entry.setsPerformed, completion_state: entry.completionState, session_id: currentSessionId }));
                    if (individualLogsToInsert.length > 0) { const { error: individualInsertError } = await supabase.from('workout_logs').insert(individualLogsToInsert); if (individualInsertError) { throw new Error(`Error inserting individual exercise logs: ${individualInsertError.message}`); } }
                    const sessionSummaryLog = {
                        client_id: userIdentifier,
                        date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                        time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                        raw_date: new Date().toISOString(),
                        exercise_name: "Workout Session Summary",
                        name_workout: workoutData[currentActiveDayKey].name,
                        sets_performed: JSON.stringify(currentWorkoutSummaryData),
                        completion_state: "completed",
                        session_id: currentSessionId,
                        total_time_session: dom.workoutSummaryTotalTime.textContent,
                        total_volume_session: parseFloat(dom.workoutSummaryTotalVolume.textContent.replace(' Kg', ''))
                    };
                    const { error: summaryInsertError } = await supabase.from('workout_logs').insert([sessionSummaryLog]);
                    if (summaryInsertError) { throw new Error(`Error inserting workout session summary: ${summaryInsertError.message}`); }
                    showCustomAlert("¡Entrenamiento registrado con éxito!", "info");
                    await loadWorkoutLogs(); isWorkoutInProgress = false; dom.registerWorkoutButton.innerHTML = '¡Registrado!';
                    setTimeout(() => {
                        closeModalElement(dom.workoutSummaryModal); closeModalElement(dom.quickModeWorkoutModal);
                        if(dom.registerWorkoutButton) { dom.registerWorkoutButton.innerHTML = 'Registrar'; dom.registerWorkoutButton.disabled = false; }
                    }, 1500);
                } catch (error) {
                    console.error("Unexpected error during workout registration:", error);
                    showCustomAlert(`Ha ocurrido un error inesperado al registrar el entrenamiento: ${error.message}`, "error");
                    dom.registerWorkoutButton.innerHTML = 'Error';
                    setTimeout(() => { dom.registerWorkoutButton.innerHTML = 'Registrar'; dom.registerWorkoutButton.disabled = false; }, 2000);
                }
            };
            openModal(dom.workoutSummaryModal);
        }
        function closeWorkoutSummaryModal(registered = false) { closeModalElement(dom.workoutSummaryModal); if (registered) { currentWorkoutSummaryData = []; closeModalElement(dom.quickModeWorkoutModal); } }
        function openWarmupModal() { dom.warmupSetsResult.innerHTML = ''; dom.workingSetWeightInput.value = ''; openModal(dom.warmupModal); }
        function calculateWarmupSets() {
            const workingWeight = parseFloat(dom.workingSetWeightInput.value);
            const resultDiv = dom.warmupSetsResult; resultDiv.innerHTML = '';
            if (isNaN(workingWeight) || workingWeight <= 0) { resultDiv.innerHTML = '<p class="text-red-400">Por favor, introduce un peso válido.</p>'; return; }
            const sets = [
                { weight: workingWeight * 0.5, reps: '8', label: 'Serie 1' },
                { weight: workingWeight * 0.7, reps: '6', label: 'Serie 2' },
                { weight: workingWeight * 0.85, reps: '3', label: 'Serie 3' },
            ];
            const list = document.createElement('ul'); list.className = 'list-disc list-inside space-y-1';
            sets.forEach(set => { const li = document.createElement('li'); li.innerHTML = `<span class="font-semibold text-yellow-400">${set.label}:</span> ${set.weight.toFixed(1)} Kg x ${set.reps} reps`; list.appendChild(li); });
            resultDiv.appendChild(list);
        }
        function prepareShareableCard() {
            const cardContent = dom.shareCard;
            const dayData = workoutData[currentActiveDayKey];
            const totalVolume = dom.workoutSummaryTotalVolume.textContent;
            const totalTime = dom.workoutSummaryTotalTime.textContent;
            cardContent.innerHTML = `<h4>${dayData.name.toUpperCase()}</h4> <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" class="logo" alt="Logo"> <p><strong><i class="fas fa-clock mr-2"></i>Tiempo:</strong> ${totalTime}</p> <p><strong><i class="fas fa-weight-hanging mr-2"></i>Volumen:</strong> ${totalVolume}</p> <p class="text-center text-xs mt-4">¡Entrenamiento completado!</p>`;
            openModal(dom.shareModal);
        }
        function downloadShareableImage() {
            const cardToCapture = dom.shareCard;
            html2canvas(cardToCapture, { backgroundColor: null, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'resumen-entrenamiento.png'; link.href = canvas.toDataURL('image/png'); link.click();
            });
        }
        function setupVideoCorrectionsButton() {
            if (!dom.videoCorrectionsButton) return;
            const currentWeek = getWeekNumber(new Date());
            const config = VIDEO_PROMPT_CONFIG.activeWeeks;
            let isFeatureActive = false;
            if (config === 'all') { isFeatureActive = true; } 
            else if (config === 'none') { isFeatureActive = false; } 
            else if (config === 'even') { isFeatureActive = currentWeek % 2 === 0; } 
            else if (config === 'odd') { isFeatureActive = currentWeek % 2 !== 0; } 
            else if (Array.isArray(config)) { isFeatureActive = config.includes(currentWeek); }
            if (isFeatureActive) {
                dom.videoCorrectionsButton.classList.remove('button-disabled');
                dom.videoCorrectionsButton.addEventListener('click', () => { window.open(APP_CONFIG.urls.videoUploadUrl, '_blank'); });
            } else {
                dom.videoCorrectionsButton.classList.add('button-disabled');
                dom.videoCorrectionsButton.addEventListener('click', () => { openModal(dom.weekdayNoticeModal); });
            }
        }
        
        // =================================================================
        // ======================= INICIALIZACIÓN DE LA APP ================
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const initAudio = async () => {
                try {
                    if (Tone.context.state !== 'running') { await Tone.start(); }
                    if (!toneSynth) { toneSynth = new Tone.Synth().toDestination(); }
                    toneSynth.volume.value = -Infinity; toneSynth.triggerAttackRelease("C4", "32n", Tone.now()); toneSynth.volume.value = 0;
                } catch (e) { console.error('Could not initialize or prime audio:', e); } finally {
                    document.body.removeEventListener('click', initAudio);
                    document.body.removeEventListener('touchstart', initAudio);
                }
            };
            document.body.addEventListener('click', initAudio, { once: true });
            document.body.addEventListener('touchstart', initAudio, { once: true });
            document.addEventListener('click', (event) => {
                document.querySelectorAll('.quick-mode-header-buttons.is-active').forEach(menu => {
                    const card = menu.closest('.quick-mode-exercise-item');
                    const button = card ? card.querySelector('.quick-mode-settings-button') : null;
                    const isClickInsideMenu = menu.contains(event.target);
                    const isClickOnButton = button && button.contains(event.target);
                    if (!isClickInsideMenu && !isClickOnButton) {
                        menu.classList.remove('is-active');
                        if (button) { button.classList.remove('active'); }
                    }
                });
            });
            initializeSupabaseClient();
            initializeWorkoutApp();
            if(dom.addExtrasButton) { dom.addExtrasButton.addEventListener('click', () => { setupExtrasForm(); openModal(dom.extrasModal); }); }
            if(dom.cancelExtraActivityButton) { dom.cancelExtraActivityButton.addEventListener('click', () => { closeModalElement(dom.extrasModal); }); }
            if (dom.mainMenuButton && userIdentifier) { dom.mainMenuButton.href = `/mi-webapp-pwa/index.html?usuario=${userIdentifier}`; } 
            else if (dom.mainMenuButton) { dom.mainMenuButton.href = `/mi-webapp-pwa/index.html`; console.warn("User identifier not found for main menu button. Using default link."); }
            document.addEventListener('visibilitychange', handleVisibilityChange);
            if(dom.viewWorkoutHistoryButton) dom.viewWorkoutHistoryButton.addEventListener('click', () => { renderCalendar(); openModal(dom.mainHistoryModal); });
            if(dom.viewExerciseHistoryButton) dom.viewExerciseHistoryButton.addEventListener('click', openExerciseHistoryExplorer);
            if(dom.historySearchInput) dom.historySearchInput.addEventListener('input', handleExerciseHistorySearch);
            if(dom.backToExerciseListBtn) dom.backToExerciseListBtn.addEventListener('click', showExerciseListView);
        });
    </script>
</body>
</html>
