<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="/mi-webapp-pwa/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/mi-webapp-pwa/icons/icon-192x192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Entrenamiento - Programa Hombres en Forma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> 
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821c6f4dbcf316861282241.png');
            background-color: #1A263A;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden; 
            color: #e5e7eb;
            touch-action: manipulation;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #4A5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #eab308; }

        .main-container {
            width: 100%;
            max-width: 36rem;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 640px) { .main-container { max-width: 42rem; } }
        @media (min-width: 768px) { .main-container { max-width: 48rem; } }

        .app-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .app-tab {
            position: relative;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            color: #d1d5db;
            background-color: rgba(31, 41, 55, 0.8);
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }
        .app-tab:hover {
            background-color: rgba(55, 65, 81, 0.9);
            color: #facc15;
        }
        .app-tab.active {
            background-color: #facc15;
            color: #1f2937;
            border-color: #facc15;
        }
        .app-tab.app-tab-notify {
            background-color: #22c55e;
            color: #1f2937;
            border-color: #22c55e;
        }
        .app-tab.app-tab-notify:hover {
            background-color: #16a34a;
            border-color: #16a34a;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .modal, .modal-base { 
            transition: opacity 0.25s ease; 
        }
        .modal-content { 
            transition: transform 0.25s ease; 
            max-height: 90vh; 
        }
        #quickModeWorkoutModal .modal-content, #detailedHistoryModal .modal-content, #mainHistoryModal .modal-content, #fullWorkoutLogModal .modal-content {
            width: 95%;
            max-width: 700px; 
        }
        #workoutSummaryModal .modal-content, #warmupModal .modal-content, #extrasModal .modal-content {
            width: 95%;
            max-width: 450px;
        }
        #calendarModal .modal-content {
            width: 95%;
            max-width: 500px;
            background-color: #2D3748;
            border: 2px solid #FACC15;
            border-radius: 1rem;
        }
        #calendarModal .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            color: #FACC15;
            font-size: 1.25rem;
            font-weight: 600;
        }
        #calendarModal .calendar-nav-btn {
            background: none;
            border: none;
            color: #FACC15;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        #calendarModal .calendar-nav-btn:hover {
            color: #EAB308;
        }
        #calendarModal .day-entry {
            background-color: #1A202C;
            border-bottom: 2px solid #4A5568;
            color: #D1D5DB;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        #calendarModal .day-entry.current-day {
            border-left: 5px solid #FACC15;
            padding-left: 0.75rem;
        }
        #calendarModal .day-entry:hover {
            background-color: #2D3748;
        }
        #calendarModal .day-name {
            font-weight: 600;
        }
        #calendarModal .day-date {
            color: #9CA3AF;
        }
        #calendarModal .workout-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #calendarModal .workout-name {
            background-color: #4A5568;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #FACC15;
        }
        #calendarModal .workout-count {
            background-color: #FACC15;
            color: #1A202C;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        #calendarModal .day-scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background-color: #FACC15;
            border-radius: 0 5px 5px 0;
        }
        #calendarModal .day-entry.has-more .workout-count {
            background-color: #22c55e;
            color: #fff;
        }
        #calendarModal .expanded-day-view {
            background-color: #1f2937;
            border-left: 5px solid #22c55e;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        #calendarModal .expanded-day-view .expanded-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #FACC15;
            margin-bottom: 0.75rem;
        }
        #calendarModal .expanded-day-view .expanded-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #4a5568;
        }
        #calendarModal .expanded-day-view .expanded-item:last-child {
            border-bottom: none;
        }
        #calendarModal .expanded-day-view .item-name {
            color: #D1D5DB;
        }
        #calendarModal .expanded-day-view .item-time {
            color: #9CA3AF;
        }


        .day-selection-container { display: flex; flex-direction: column; gap: 1rem; }
        .day-tab-bar { display: flex; flex-direction: column; gap: 0.5rem; }
        .day-tab { padding: 0.75rem 1rem; color: #d1d5db; font-weight: 500; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; text-align: center; background-color: rgba(31, 41, 55, 0.8); border: 1px solid #4b5563; }
        .day-tab:hover { background-color: rgba(55, 65, 81, 0.9); color: #facc15; }
        .day-tab.active { background-color: #facc15; color: #1f2937; font-weight: 600; border-color: #facc15; }
        .day-tab.active-resume {
            background-color: #22c55e;
            color: #ffffff;
            font-weight: 600;
            border-color: #16a34a;
        }
        .day-tab.active-resume:hover {
            background-color: #16a34a;
        }
        .workout-preview-container { background-color: rgba(55, 65, 81, 0.7); border-radius: 0.5rem; padding: 1rem; border: 1px solid rgba(250, 204, 21, 0.3); min-height: 200px; display: flex; flex-direction: column; justify-content: space-between; }
        .workout-preview-container h3 { color: #fde047; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .workout-preview-container ul { list-style: none; padding-left: 0; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; flex-grow: 1; }
        .workout-preview-container li { color: #d1d5db; padding: 0.2rem 0; font-size: 0.85rem; }
        .start-workout-preview-button { background-color: #facc15; color: #1f2937; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out; margin-top: auto; font-size: 0.95rem; }
        .start-workout-preview-button:hover { background-color: #eab308; }
        .main-action-button { background-color: #4A5568; color: #facc15; border: 1px solid #facc15; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; margin-top: 1rem; font-size: 0.95rem; }
        .main-action-button:hover:not(:disabled) { background-color: #facc15; color: #1f2937; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .exercise-card-container, .quick-mode-superset-container { border-left: 4px solid #facc15; background-color: rgba(42, 50, 62, 0.8); backdrop-filter: blur(5px); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 0.75rem; margin-bottom: 1rem; position: relative; }
        .exercise-card-container-title, .quick-mode-superset-container .superset-title { font-size: 1rem; font-weight: 600; color: #fde047; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #4b5563; }
        .set-input input[readonly], .action-button:disabled, .quick-mode-register-button:disabled { background-color: #4A5568 !important; border-color: #718096 !important; color: #a0aec0 !important; cursor: not-allowed; }
        input::placeholder { color: #718096; opacity: 1; }
        .history-entry { border-bottom: 1px solid #4A5568; }
        .history-entry:last-child { border-bottom: none; }
        .history-reps-good { color: #4ade80; font-weight: bold; }
        .history-reps-bad { color: #f87171; font-weight: bold; }
        .main-history-item { background-color: #4a5568; color: #e5e7eb; padding: 0.75rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; width: 100%; margin-bottom: 0.5rem; text-align: left; cursor: pointer; }
        .main-history-item:hover { background-color: #5a6578; }
        .quick-mode-exercise-item { background-color: rgba(55, 65, 81, 0.8); border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #facc15; box-shadow: 0 2px 4px rgba(0,0,0,0.2); padding: 0.75rem; transition: border-left-color 0.3s ease; position: relative; }
        .quick-mode-exercise-item.completed-good { border-left-color: #22c55e; background-color: rgba(34, 197, 94, 0.2); }
        .quick-mode-exercise-item.completed-bad { border-left-color: #ef4444; background-color: rgba(239, 68, 68, 0.2); }
        .quick-mode-superset-container .quick-mode-exercise-item { border-left: none; padding-left: 0.5rem; margin-left: -0.5rem; }
        
        .quick-mode-exercise-header { 
            display: flex; 
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .quick-mode-exercise-header .flex-top-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }
        .quick-mode-exercise-header .info-and-settings {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        .quick-mode-exercise-header .info-line-with-settings {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            gap: 0.5rem;
        }

        .quick-mode-exercise-header .info { flex-grow: 1; min-width: 0; }
        .quick-mode-exercise-header .info .title-line { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .quick-mode-exercise-header .info strong { color: #fde047; font-weight: 600; font-size: 1rem; line-height: 1.3; }
        .quick-mode-exercise-header .info span { color: #d1d5db; font-size: 0.75rem; display: block; }

        .quick-mode-header-buttons {
            display: none;
            flex-direction: column;
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 10;
        }
        .quick-mode-header-buttons.is-active {
            display: flex;
        }
        .quick-mode-header-buttons .quick-action-btn {
            background: transparent;
            border: none;
            color: #facc15;
            cursor: pointer;
            width: auto;
            height: auto;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }
        .quick-mode-header-buttons .quick-action-btn:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .quick-mode-header-buttons .quick-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #718096;
        }
        .settings-icon-button {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid #4b5563;
            color: #facc15;
            width: 2.75rem;
            height: 2.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 0.2s;
            z-index: 11;
        }
        .settings-icon-button:hover {
             color: #eab308; background-color: #4b5563;
        }
        .settings-icon-button.is-active {
            background-color: #facc15;
            color: #1f2937;
        }

        .quick-mode-settings-button {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            width: 2rem;
            height: 2rem;
            background: #4A5568;
            border-radius: 9999px;
            color: #9CA3AF;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #4A5568;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .quick-mode-settings-button:hover {
            background-color: #5a6578;
            color: #e5e7eb;
        }
        .quick-mode-settings-button.active {
            background-color: #facc15;
            color: #1f2937;
            border-color: #facc15;
        }

        .increase-weight-btn { background: #facc15; border-color: #facc15; width: 2rem; height: 2rem; font-size: 0.9rem; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center; }
        .quick-mode-input-row { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 0.5rem; align-items: center; }
        .quick-mode-input { width: 100%; background-color: #1f2937; border: 1px solid #4b5563; color: white; border-radius: 0.375rem; padding: 0.5rem; text-align: center; font-size: 0.9rem; }
        .quick-mode-register-button { width: 100%; height: 100%; background-color: #facc15; color: #1f2937; font-weight: bold; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .quick-mode-register-button i { font-size: 1.1rem; }
        .quick-mode-register-button:hover:not(:disabled) { background-color: #eab308; }
        .timer-modal .modal-content { background-color: #1f2937; border: 2px solid #facc15; }
        .timer-modal h3 { color: #facc15; }
        .timer-modal .timer-display { font-family: 'Orbitron', sans-serif; color: #ffffff; }
        .timer-modal .timer-actions { display: flex; gap: 1rem; justify-content: center; }
        .timer-modal .timer-action-button { flex-grow: 1; }
        .set-data-row { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 0.5rem; }
        .set-data-row > span { flex-basis: auto; margin-right: 0.75rem; white-space: nowrap; }
        .set-data-row .set-input { display: flex; gap: 0.5rem; flex-grow: 1; }
        #newRecordModal .modal-content { position: relative; background: linear-gradient(145deg, #fde047, #facc15); color: #1f2937; }
        #newRecordModal .close-button, #warmupModal .close-button { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #a0aec0; cursor: pointer; line-height: 1; }
        #newRecordModal .close-button:hover, #warmupModal .close-button:hover { color: white; }
        .settings-menu-button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; color: #e5e7eb; background-color: #4a5568; border-radius: 0.375rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease-in-out; }
        .settings-menu-button i { margin-right: 0.75rem; width: 20px; text-align: center; }
        #shareCard { background: linear-gradient(135deg, #2d3748, #1a202c); color: white; padding: 2rem; border-radius: 1rem; border: 2px solid #facc15; width: 350px; }
        #shareCard h4 { color: #facc15; font-weight: bold; font-size: 1.5rem; text-align: center; }
        #shareCard p { font-size: 1.1rem; margin-top: 0.5rem; }
        #shareCard .logo { max-height: 50px; margin: 1rem auto; display: block; }
        #shareModal .modal-content { background: transparent; border: none; box-shadow: none; }
        .timer-card { display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem; border-radius: 0.75rem; background-color: #2d3748; border: 2px solid #4a5568; width: 100%; max-width: 400px; color: #e5e7eb; }
        .timer-card-header { text-align: center; }
        .timer-card-header h3 { font-size: 1.5rem; font-weight: 700; color: #facc15; }
        .timer-card-header p { font-size: 0.9rem; color: #9ca3af; }
        .timer-card-body { text-align: center; }
        .timer-card-main-time { font-family: 'Orbitron', sans-serif; font-size: 5rem; font-weight: 700; line-height: 1; margin: 1rem 0; color: #ffffff; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .timer-card-info { background-color: rgba(31, 41, 55, 0.7); border-radius: 0.5rem; padding: 1rem; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #4a5568; gap: 0.5rem; }
        .timer-card-info .state-label { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .timer-card-info .state-label.work { color: #f87171; }
        .timer-card-info .state-label.rest { color: #34d399; }
        .timer-card-info .state-label.countdown { color: #facc15; }
        .timer-card-info .exercise-name { font-size: 1rem; font-weight: 500; color: #e5e7eb; text-align: center; }
        .timer-card-info .exercise-details { font-size: 0.8rem; color: #9ca3af; }
        .timer-card-actions { display: flex; gap: 1rem; width: 100%; }
        .timer-card-actions button { flex-grow: 1; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease; }
        
        .workout-log-entry {
            background-color: rgba(55, 65, 81, 0.8);
            border-left: 4px solid #facc15;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .workout-log-entry h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fde047;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .workout-log-entry h4:hover {
            color: #eab308;
        }
        .workout-log-entry ul {
            list-style: none;
            padding-left: 0;
        }
        .workout-log-entry li {
            font-size: 0.9rem;
            color: #d1d5db;
            padding: 0.2rem 0;
        }
        .workout-log-entry .pr-icon {
            color: #facc15;
            font-size: 1.2em;
        }
        .full-log-history-button {
            background: none;
            border: none;
            color: #facc15;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            padding: 0.2rem;
            transition: color 0.2s ease-in-out;
        }
        .full-log-history-button:hover {
            color: #eab308;
        }

        .button-disabled { opacity: 0.5; cursor: not-allowed !important; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #FACC15; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #minimizedRestTimer {
            background-color: rgba(31, 41, 55, 0.9);
            border: 2px solid #facc15;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease-in-out;
            min-width: 120px;
            max-width: 150px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            display: none;
        }
        #minimizedRestTimer.is-active {
            display: flex;
        }
        #minimizedRestTimer:hover {
            background-color: rgba(55, 65, 81, 0.95);
            transform: scale(1.05);
        }
        #minimizedRestTimer .min-time {
            font-size: 1.8rem;
            line-height: 1;
        }
        #minimizedRestTimer .min-next-exercise {
            font-size: 0.7rem;
            color: #d1d5db;
            line-height: 1.2;
        }

        .minimize-button {
            background-color: #4A5568;
            color: #facc15;
            border: 1px solid #facc15;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        .minimize-button:hover {
            background-color: #facc15;
            color: #1f2937;
        }

        .quick-view-body {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 0.5rem;
            align-items: center;
        }

        .full-log-view-body {
            border-top: 2px solid #4b5563;
            padding-top: 1rem;
            margin-top: 0.75rem;
        }
        .full-log-view-body .set-data-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        .full-log-view-body .set-data-row > span {
            flex-basis: auto;
            margin-right: 0.25rem;
            white-space: nowrap;
            font-size: 0.85rem;
        }
        .full-log-view-body .set-data-row .set-input {
            display: flex;
            gap: 0.5rem;
            flex-grow: 1;
        }
        .full-log-view-body .set-input input {
            padding: 0.4rem;
            font-size: 0.85rem;
        }
        .full-log-view-body .actions-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .full-log-view-body .actions-footer button {
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
        }

        .quick-mode-exercise-item .notes {
            color: #d1d5db;
            font-size: 0.75rem;
            display: block;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #4b5563;
        }
        
        .timer-exercise-image {
            max-height: 120px;
            width: auto;
            max-width: 90%;
            border-radius: 0.5rem;
            object-fit: cover;
            display: none;
        }
        
        .history-filter-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .history-filter-select {
            background-color: #4a5568;
            color: #e5e7eb;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .history-filter-select:hover {
            background-color: #5a6578;
        }
        
        .extras-button {
            background: none;
            border: none;
            color: #3b82f6;
            padding: 0;
            margin: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: color 0.2s ease-in-out;
        }
        .extras-button:hover {
            color: #2563eb;
        }
        .extras-option-button {
            background-color: #4a5568;
            color: #e5e7eb;
            border: 1px solid #718096;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }
        .extras-option-button:hover {
            background-color: #5a6578;
        }
        .extras-option-button i {
            width: 20px;
            text-align: center;
        }
        #extrasFormModal .modal-content {
            background-color: #1f2937;
            border: 2px solid #3b82f6;
            color: #e5e7eb;
            padding: 1.5rem;
            width: 95%;
            max-width: 450px;
        }
        #extrasFormModal h3 {
            color: #3b82f6;
        }
        #extrasFormModal .form-group {
            margin-bottom: 1rem;
        }
        #extrasFormModal input,
        #extrasFormModal select {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        #extrasFormModal .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .custom-file-input {
            display: block;
            width: 100%;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-align: center;
            color: #9ca3af;
        }
        #extrasFormModal .custom-file-input:hover {
            background-color: #4a5568;
            border-color: #facc15;
        }
        #extrasFormModal .file-name {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        #extrasFormModal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        #extrasFormModal .modal-actions .cancel-button {
            background-color: #4a5568;
            color: #e5e7eb;
        }
        #extrasFormModal .modal-actions .submit-button {
            background-color: #3b82f6;
            color: #fff;
        }
        #extrasFormModal #otherActivityInputGroup {
            display: none;
        }
        .history-entry .extra-activity-image-container {
            display: block;
            margin-top: 1rem;
            text-align: center;
            max-width: 100%;
        }
        .history-entry .extra-activity-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            object-fit: contain;
            border: 1px solid #4a5568;
        }
        
        #registerExtraActivityButton {
            background-color: #22c55e;
            color: #fff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        #registerExtraActivityButton:hover {
            background-color: #16a34a;
        }
        #cancelExtraActivityButton {
            background-color: #ef4444;
            color: #fff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        #cancelExtraActivityButton:hover {
            background-color: #dc2626;
        }

        .timer-modal-welcome-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            padding: 2rem;
            border-radius: 0.75rem;
            background-color: #2d3748;
            border: 2px solid #4a5568;
            width: 100%;
            max-width: 400px;
            color: #e5e7eb;
            text-align: center;
        }
        .timer-modal-welcome-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #facc15;
        }
        .timer-modal-welcome-card p {
            font-size: 0.95rem;
            color: #d1d5db;
        }
        .timer-modal-welcome-card .start-button {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            background-color: #22c55e;
            color: #fff;
            transition: background-color 0.2s ease;
        }
        .timer-modal-welcome-card .start-button:hover {
            background-color: #16a34a;
        }

        #numericKeypadModal .modal-content {
            background-color: rgba(31, 41, 55, 0.95);
            border-color: #facc15;
            padding: 1rem;
            width: 95%;
            max-width: 400px;
        }
        #keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        #keypad button {
            background-color: #4a5568;
            color: #e5e7eb;
            font-size: 2rem;
            padding: 1.25rem 0;
            border-radius: 0.5rem;
            border: 1px solid #718096;
            transition: background-color 0.2s ease-in-out;
        }
        #keypad button:hover {
            background-color: #616e80;
        }
        #keypad button.keypad-action-btn {
            background-color: #facc15;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
        }
        #keypad button.keypad-action-btn:hover {
            background-color: #eab308;
        }
        #keypad button.keypad-close-btn {
            background-color: #ef4444;
            color: #fff;
        }
        #keypad button.keypad-close-btn:hover {
            background-color: #dc2626;
        }
        #keypad button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #4a5568;
        }

        #videoConfirmModal .modal-content {
            background-color: #1f2937;
            border: 2px solid #facc15;
            color: #e5e7eb;
            padding: 1.5rem;
            width: 95%;
            max-width: 450px;
            text-align: center;
        }

        /* Simple Mode Enhancements */
        #simpleModeExerciseContainer .quick-mode-exercise-item,
        #simpleModeExerciseContainer .quick-mode-superset-container {
            padding: 1rem 1.5rem; /* More padding */
        }

        #simpleModeExerciseContainer .quick-mode-exercise-header .info strong {
            font-size: 1.5rem; /* Larger exercise title */
            line-height: 1.2;
        }

        #simpleModeExerciseContainer .quick-mode-input-row {
            grid-template-columns: 1fr 1fr 50px; /* Make button narrower */
            gap: 0.75rem;
        }

        #simpleModeExerciseContainer .quick-mode-input {
            font-size: 1.2rem; /* Smaller input text */
            padding: 0.5rem;
            height: 50px;
        }

        #simpleModeExerciseContainer .quick-mode-register-button {
            height: 50px;
        }
        #simpleModeExerciseContainer .quick-mode-register-button i {
            font-size: 1.5rem; /* Smaller icon */
        }

        #simpleModeExerciseContainer [id^="progressDisplay-"] .text-sm {
            font-size: 1rem !important; /* Larger set counter */
        }
        
        #simpleModeExerciseContainer [id^="progressDisplay-"] .text-xs {
             font-size: 1.1rem !important; /* Larger registered set list */
        }

        #simpleModeExerciseContainer .bg-gray-700\/50 h5 {
            font-size: 0.9rem; /* Larger "Series registradas" */
        }

        /* Simple Mode Header Layout Customization */
        .list-mode-header-wrapper { display: block; }
        .simple-mode-header-wrapper { display: none; }

        #simpleModeWorkoutModal .list-mode-header-wrapper { display: none; }
        #simpleModeWorkoutModal .simple-mode-header-wrapper { 
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #simpleModeWorkoutModal .simple-mode-header-wrapper .title-line {
            border-bottom: 1px solid #4b5563;
            padding-bottom: 0.5rem;
        }
        #simpleModeWorkoutModal .simple-mode-content-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #simpleModeWorkoutModal .simple-mode-header-wrapper .info {
            display: flex;
            flex-direction: column;
        }

        /* START: New styles for Simple Mode settings button positioning */
        #simpleModeWorkoutModal .quick-mode-exercise-item .quick-mode-settings-button {
            top: 5.75rem; /* Position vertically aligned with Series/Objective text */
            right: 1.5rem; /* Align with card padding */
            bottom: auto;
            z-index: 12;
        }

        #simpleModeWorkoutModal .quick-mode-exercise-item .quick-mode-header-buttons {
            top: 8rem; /* Position the dropdown menu below the button */
            right: 1.5rem;
            bottom: auto;
        }
        /* END: New styles */

        /* Estilos de cabecera para el Modo Simple */
        #simpleModeWorkoutModal .quick-mode-exercise-header {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #simpleModeWorkoutModal .simple-mode-content-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #simpleModeWorkoutModal .quick-mode-exercise-header .info {
            display: flex;
            flex-direction: column;
        }


    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-2 sm:p-4 text-gray-200">

    <div class="main-container mb-8">
        <header class="bg-gray-800/90 backdrop-blur-md shadow-xl rounded-t-xl p-4 sm:p-6 mb-0 border-b-2 border-yellow-500 text-center">
            <div class="flex justify-center items-center">
                <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" alt="Logo Programa Hombres en Forma" class="h-12 sm:h-14 md:h-16" onerror="this.alt='Logo HEF'; this.src='https://placehold.co/250x80/1a202c/facc15?text=Logo+Error';">
            </div>
        </header>

        <main class="bg-gray-800/85 backdrop-blur-md shadow-xl rounded-b-xl p-3 sm:p-4 md:p-6">
            <div class="mb-4">
                <a id="mainMenuButton" href="#" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    <i class="fas fa-home mr-2"></i>Menú Principal
                </a>
            </div>

            <div id="workoutSection" class="tab-content active">
                <section id="mainControlsSection" class="mb-4 sm:mb-6">
                    <div class="flex justify-center items-center gap-2 mb-2 sm:mb-3">
                        <h2 class="text-md sm:text-lg font-semibold text-yellow-400 text-center">SELECCIONA TU ENTRENAMIENTO</h2>
                        <button id="addExtrasButton" class="extras-button" title="Añadir Actividad Extra">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                    </div>
                    
                    <div class="day-selection-container">
                        <div id="daySelectionTabs" class="day-tab-bar"></div>
                        <div id="workoutPreviewContainer" class="workout-preview-container">
                            <p class="text-gray-400 text-center">Selecciona un día para ver la vista previa.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <button id="viewWorkoutHistoryButton" class="main-action-button">
                            <i class="fas fa-history mr-2"></i>Histórico Entrenamientos
                        </button>
                        <button id="viewExerciseHistoryButton" class="main-action-button">
                            <i class="fas fa-chart-line mr-2"></i>Histórico Ejercicios
                        </button>
                        <button id="videoCorrectionsButton" class="main-action-button">
                            <i class="fas fa-video mr-2"></i>Correcciones de Ejercicios
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="mainHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="calendarModal" class="modal-content transform scale-95">
            <div class="flex justify-between items-center px-4 py-2">
                <h3 class="text-xl font-semibold text-yellow-400">Historial de Entrenamientos</h3>
                <button onclick="closeModalElement(mainHistoryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial">×</button>
            </div>
            <div class="calendar-header px-4">
                <button class="calendar-nav-btn" onclick="changeWeek(-1)" aria-label="Semana anterior">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div id="currentMonthYear"></div>
                <button class="calendar-nav-btn" onclick="changeWeek(1)" aria-label="Semana siguiente">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div id="calendarDaysContainer" class="max-h-[70vh] overflow-y-auto px-2 pb-2">
                 <!-- The days will be rendered here by JS -->
            </div>
        </div>
    </div>

    <!-- El Modal de Modo Lista (quickModeWorkoutModal) ha sido eliminado -->

    <div id="newRecordModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content text-center transform scale-95 p-8 rounded-xl shadow-2xl">
            <button class="close-button" onclick="closeModalElement(newRecordModal)">&times;</button>
            <i class="fas fa-trophy text-6xl text-yellow-900/80 mb-4"></i>
            <h3 class="text-3xl font-bold text-gray-800">¡NUEVO RÉCORD!</h3>
            <p id="newRecordText" class="text-lg mt-2 text-gray-700">Has superado tu 1RM anterior.</p>
        </div>
    </div>

    <div id="restTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[70] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="restTimerTitle">TIEMPO DE DESCANSO</h3>
                    <p id="restOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="restTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="restCurrentImage" src="" alt="Siguiente ejercicio" class="timer-exercise-image">
                        <div id="restStateLabel" class="state-label rest">DESCANSO</div>
                        <p id="restExerciseName" class="exercise-name">Siguiente: </p>
                        <p id="restExerciseDetails" class="exercise-details">Objetivo: </p>
                    </div>
                    <button onclick="toggleRestTimerMinimize()" class="minimize-button">MINIMIZAR</button>
                </div>
                <div class="timer-card-actions">
                    <button onclick="adjustRestTime(-15)" class="bg-gray-600 hover:bg-gray-700 text-white">-15s</button>
                    <button onclick="closeRestTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Saltar</button>
                    <button onclick="adjustRestTime(15)" class="bg-gray-600 hover:bg-gray-700 text-white">+15s</button>
                </div>
            </div>
        </div>
    </div>

    <div id="minimizedRestTimer" class="fixed top-4 left-4 z-[100] hidden" onclick="toggleRestTimerMinimize()">
        <span id="minimizedTimerDisplay" class="min-time">00:00</span>
        <span id="minimizedNextExercise" class="min-next-exercise"></span>
    </div>

    <div id="workTimerModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[71] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="workTimerTitle">TIEMPO DE TRABAJO</h3>
                    <p id="workOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="workTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="workCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="workStateLabel" class="state-label work">TRABAJO</div>
                        <p id="workExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="workExerciseDetails" class="exercise-details">Objetivo:</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="closeWorkTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Finalizar Antes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="circuitTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[76] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
            <div id="circuitWelcomeView" class="timer-modal-welcome-card" style="display: none;">
                <h3 id="circuitWelcomeTitle"></h3>
                <p id="circuitWelcomeDetails"></p>
                <img id="circuitWelcomeImage" src="" alt="Ejercicio de Circuito" class="timer-exercise-image" style="display: none;">
                <button onclick="runNextCircuitInterval()" class="start-button">EMPEZAR</button>
            </div>
             <div id="circuitActiveView" class="timer-card" style="display: none;">
                <div class="timer-card-header">
                    <h3 id="circuitTimerTitle"></h3>
                    <p id="circuitOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="circuitTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="circuitCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="circuitStateLabel" class="state-label"></div>
                        <p id="circuitExerciseName" class="exercise-name"></p>
                        <p id="circuitExerciseDetails" class="exercise-details"></p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateCircuitEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipCircuitInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="swapExerciseModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[65] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-5 sm:p-6 w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="swapExerciseModalTitle" class="text-lg sm:text-xl font-semibold text-yellow-400">Sugerir Alternativa</h3>
                <button onclick="closeModalElement(swapExerciseModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de sugerencias">×</button>
            </div>
            <div id="swapExerciseModalContent" class="space-y-3 max-h-60 overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button onclick="closeModalElement(swapExerciseModal)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="emomTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[75] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
            <div id="emomWelcomeView" class="timer-modal-welcome-card" style="display: none;">
                <h3 id="emomWelcomeTitle"></h3>
                <p id="emomWelcomeDetails"></p>
                <img id="emomWelcomeImage" src="" alt="Ejercicio de EMOM" class="timer-exercise-image" style="display: none;">
                <button onclick="runNextEmomInterval()" class="start-button">EMPEZAR</button>
            </div>
            <div id="emomActiveView" class="timer-card" style="display: none;">
                <div class="timer-card-header">
                    <h3 id="emomTimerTitle"></h3>
                    <p id="emomOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="emomIntervalTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="emomCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="emomStateLabel" class="state-label work">TRABAJO</div>
                        <p id="emomCurrentExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="emomCurrentExerciseDetails" class="exercise-details">Objetivo: <span id="emomCurrentExerciseReps">Reps</span> con <span id="emomCurrentExerciseWeight">--</span> Kg</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateEmomEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipEmomInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="workoutSummaryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[95] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl shadow-xl p-6 sm:p-8 w-full transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-yellow-400">Resumen del Entrenamiento</h3>
                <button onclick="closeModalElement(workoutSummaryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar resumen">×</button>
            </div>
            <p class="text-gray-300 text-lg mb-2">Tiempo Total: <span id="workoutSummaryTotalTime" class="font-bold text-white">00:00</span></p>
            <p class="text-gray-300 text-lg mb-4">Volumen Total: <span id="workoutSummaryTotalVolume" class="font-bold text-white">0 Kg</span></p>
            
            <div id="workoutSummaryExerciseList" class="max-h-60 overflow-y-auto pr-2 mb-6 space-y-3"></div>
            
            <div class="grid grid-cols-2 gap-4">
                 <button onclick="closeWorkoutSummaryModal(false)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-3 px-4 rounded-lg shadow-md">
                    Volver
                </button>
                <button id="registerWorkoutButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                    Registrar
                </button>
            </div>
        </div>
    </div>
    
    <div id="warmupModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[67] opacity-0 pointer-events-none">
        <div class="modal-content relative bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-6 w-full transform scale-95">
            <button class="close-button" onclick="closeModalElement(warmupModal)">&times;</button>
            <h3 class="text-lg font-semibold text-yellow-400 mb-4">Calculadora de Aproximación</h3>
            <div class="mb-4">
                <label for="workingSetWeightInput" class="block text-sm text-gray-300 mb-1">Peso de tu primera serie efectiva (Kg):</label>
                <input type="number" id="workingSetWeightInput" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
            </div>
            <button onclick="calculateWarmupSets()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md mb-4">Calcular</button>
            <div id="warmupSetsResult" class="space-y-2 text-gray-200"></div>
        </div>
    </div>

    <div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[98] opacity-0 pointer-events-none">
        <div class="modal-content">
            <div id="shareCard">
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button onclick="downloadShareableImage()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg">Descargar</button>
                <button onclick="closeModalElement(shareModal)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="weekdayNoticeModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl p-6 w-full max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-semibold text-yellow-400">Función No Disponible</h3>
            <p class="text-gray-300 mb-6">Esta función solo está disponible en los días configurados.</p>
            <button onclick="closeModalElement(weekdayNoticeModal)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>

    <!-- In-Progress Warning Modal -->
    <div id="inProgressWarningModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl p-6 w-full max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-semibold text-yellow-400">Entrenamiento en Curso</h3>
            <p class="text-gray-300 my-4">Para seleccionar otro entrenamiento, primero debes registrar o cerrar la sesión actual.</p>
            <div class="flex gap-4">
                <button onclick="closeModalElement(document.getElementById('inProgressWarningModal'))" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white py-2.5 rounded-lg">Entendido</button>
                <button onclick="goToCurrentWorkout()" class="w-1/2 bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-lg">Continuar Entreno</button>
            </div>
        </div>
    </div>

    <!-- Video Confirmation Modal -->
    <div id="videoConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[100] opacity-0 pointer-events-none">
        <div class="modal-content relative bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <h3 class="text-lg font-semibold text-yellow-400 mb-4">Abrir Vídeo</h3>
            <p class="text-gray-300 mb-6">¿Quieres abrir el vídeo de este ejercicio en una nueva pestaña?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModalElement(videoConfirmModal)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirmVideoOpen" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Abrir</button>
            </div>
        </div>
    </div>
    <!-- End Video Confirmation Modal -->

    <!-- El Modal de Elección de Modo (workoutModeChoiceModal) ha sido eliminado -->

    <!-- Simple Mode Workout Modal -->
    <div id="simpleModeWorkoutModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-between p-2 sm:p-4 z-40 opacity-0 pointer-events-none">
        <div class="w-full max-w-2xl mt-4">
            <div class="flex justify-between items-center bg-gray-800/95 p-4 rounded-t-lg">
                <h3 id="simpleModeWorkoutModalTitle" class="text-lg sm:text-xl font-bold text-yellow-500 text-left"></h3>
                <span id="simpleModeWorkoutDuration" class="text-lg font-mono text-white">00:00</span>
                <button onclick="closeSimpleModeWorkoutModal()" class="text-gray-400 hover:text-yellow-400 text-2xl leading-none" aria-label="Cerrar entrenamiento">&times;</button>
            </div>
            <div id="simpleModeProgress" class="text-center bg-gray-700 p-2 text-sm font-semibold text-gray-300"></div>
        </div>

        <div id="simpleModeExerciseContainer" class="w-full max-w-2xl overflow-y-auto px-4 flex-grow my-4">
            <!-- Exercise card will be injected here -->
        </div>

        <div class="w-full max-w-2xl bg-gray-800/95 p-4 rounded-b-lg mb-4">
            <div class="flex justify-between items-center gap-4">
                <button onclick="navigateSimpleMode(-1)" id="simpleModePrevButton" class="w-1/3 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md"><i class="fas fa-arrow-left"></i></button>
                <button id="simpleModeEndWorkoutButton" onclick="toggleWorkoutState()" class="w-1/3 workout-control-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Terminar</button>
                <button onclick="navigateSimpleMode(1)" id="simpleModeNextButton" class="w-1/3 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
    <!-- End Simple Mode Workout Modal -->

    <!-- Numeric Keypad Modal -->
    <div id="numericKeypadModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-end justify-center z-[100] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-t-xl shadow-xl p-4 w-full transform scale-95">
            <div class="text-center mb-2">
                <span id="keypadTitle" class="text-lg text-yellow-400 font-bold"></span>
            </div>
            
            <!-- New Display and Check Button -->
            <div class="flex items-center justify-between mb-4 mt-2">
                <div id="keypadDisplay" class="bg-gray-700/50 flex-grow text-center text-3xl font-bold p-3 rounded-lg border-2 border-gray-600 min-h-[50px] overflow-hidden">0</div>
                <button onclick="handleKeypadCheck()" class="ml-4 w-16 h-12 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold rounded-lg flex items-center justify-center transition-colors">
                    <i class="fas fa-check text-xl"></i>
                </button>
            </div>
            
            <div id="keypad">
                <button onclick="handleKeypadClick('1')">1</button>
                <button onclick="handleKeypadClick('2')">2</button>
                <button onclick="handleKeypadClick('3')">3</button>
                <button onclick="handleKeypadClick('4')">4</button>
                <button onclick="handleKeypadClick('5')">5</button>
                <button onclick="handleKeypadClick('6')">6</button>
                <button onclick="handleKeypadClick('7')">7</button>
                <button onclick="handleKeypadClick('8')">8</button>
                <button onclick="handleKeypadClick('9')">9</button>
                <button onclick="handleKeypadClick('.')">.</button>
                <button onclick="handleKeypadClick('0')">0</button>
                <button onclick="handleKeypadClick('backspace')" class="keypad-action-btn col-span-1"><i class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>
    <!-- End Numeric Keypad Modal -->

    <script>
        const APP_CONFIG = {
            urls: {
                workoutSubmission: 'https://aceleratumetabolismo.es/registro-entrenos',
                progressExternalUrl: 'https://aceleratumetabolismo.es/registro_', 
                mainPanelUrl: 'https://www.aceleratumetabolismo.es/panel_',
                videoUploadUrl: 'https://forms.gle/FSmmciaUWurD4A2g6'
            },
        };

        let VIDEO_PROMPT_CONFIG = {
            activeWeeks: 'none'
        };

        // Supabase table for temporary workout progress
        // CREATE TABLE realtime_workout_progress (
        //   id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        //   client_id text NOT NULL,
        //   session_id text NOT NULL,
        //   workout_data jsonb NOT NULL,
        //   workout_start_time bigint,
        //   workout_day_key text,
        //   created_at timestamp with time zone DEFAULT now(),
        //   CONSTRAINT unique_session_id UNIQUE (session_id)
        // );
        //
        // ALTER TABLE realtime_workout_progress ENABLE ROW LEVEL SECURITY;
        //
        // CREATE POLICY "Allow user to manage own progress" ON realtime_workout_progress
        //   FOR ALL
        //   TO authenticated
        //   USING (auth.uid()::text = client_id); // NOTE: This assumes you use Supabase Auth. For public access based on a URL param, you might need a different approach or a backend function.
        //   For this implementation, we'll rely on the client_id field matching the URL parameter for isolation.

        let individualExerciseLogs = [];
        let workoutSessionSummaries = [];
        let extraActivities = [];
        let allHistoryItems = [];
        let currentActiveDayKey = null;
        let isWorkoutInProgress = false; 
        let workoutTimerInterval = null;
        let workoutStartTime = 0;
        let restTimerInterval = null, currentRestDuration = 0, restTimerEndTime = 0;
        let workTimerInterval = null, currentWorkDuration = 0, workTimerEndTime = 0; 
        let emomIntervalTimer = null, currentEmomIntervalNumber = 0, currentEmomExerciseIndex = 0, emomExercisesArray = [], totalEmomIntervals = 0, emomWorkIntervalSeconds = 60, currentEmomMainOrder = null; 
        let circuitTimerInterval = null, currentCircuitPhase = 'idle', currentCircuitRound = 0, currentCircuitExerciseIndexInRound = 0, currentCircuitTimeLeft = 0, circuitExercisesArray = [], circuitDetailsGlobal = null, currentCircuitMainOrder = null;
        let toneSynth = null;
        let currentWorkoutSummaryData = [];
        let currentSessionId = null;
        let rmChartInstance = null;
        let workoutData = null;
        let exerciseAlternatives = null;
        let wakeLock = null;
        let nextRestTimerTitle = '';
        let currentTimedExerciseCardId = null;
        let currentTimedExerciseSetNumber = 0;
        let totalSetsForCurrentTimedExercise = 0;
        let currentRestDurationForTimedExercise = 0;
        let timedExerciseSetsLogged = [];
        let hasUnsavedFullLogChanges = false;
        let uploadedCaptureFile = null;
        let exerciseProgressMap = new Map();
        let currentDate = new Date();
        const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let groupedHistory = {};
        let supabase = null;
        let userIdentifier = null;
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6b2NtdGFjdmRmb3J4eXdmeGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MTQzNDQsImV4cCI6MjA2NDI5MDM0NH0.aPqF71fIUas99K3TY2heedNdj-X2MflrndmYjtCOgNU';
        let isKeypadOpen = false;
        let ignoreNextKeypadClose = false;

        // --- Simple Mode Variables ---
        let currentWorkoutDayKeyForPrompt = null;
        let isSimpleModeActive = false;
        let currentSimpleModeIndex = 0;
        let simpleModeExercises = [];
        // --- End Simple Mode Variables ---

        // Numeric Keypad Variables
        let activeInput = null;
        let keypadDisplayValue = '';
        const keypadDisplay = document.getElementById('keypadDisplay');
        let isNewInput = false;

        function openNumericPad(input) {
            if (!isWorkoutInProgress) {
                // If not in workout, use the default keyboard.
                return;
            }
            activeInput = input;
            const keypadModal = document.getElementById('numericKeypadModal');
            const keypadTitle = document.getElementById('keypadTitle');
            const decimalButton = keypadModal.querySelector('button[onclick*="handleKeypadClick(\'.\')"]');
            
            if (input.dataset.fieldType === 'kg') {
                keypadTitle.textContent = 'Ingresar Peso (kg)';
                decimalButton.disabled = false;
            } else {
                keypadTitle.textContent = 'Ingresar Reps';
                decimalButton.disabled = true;
            }
            
            keypadDisplayValue = input.value;
            if (keypadDisplayValue === '') {
                keypadDisplayValue = '0';
            }
            keypadDisplay.textContent = keypadDisplayValue;
            isNewInput = true;

            // Mark the keypad as open and set the flag to ignore the next click
            isKeypadOpen = true;
            ignoreNextKeypadClose = true;

            openModal(keypadModal);
            input.blur();
        }

        function handleKeypadClick(value) {
            if (!activeInput) return;
            if (value === 'backspace') {
                keypadDisplayValue = keypadDisplayValue.slice(0, -1);
                if (keypadDisplayValue === '') {
                    keypadDisplayValue = '0';
                }
            } else if (isNewInput && value !== '.') {
                keypadDisplayValue = value;
                isNewInput = false;
            } else if (value === '.' && keypadDisplayValue.includes('.')) {
                return;
            } else {
                if (keypadDisplayValue === '0' && value !== '.') {
                    keypadDisplayValue = value;
                } else {
                    keypadDisplayValue += value;
                }
            }
            
            keypadDisplay.textContent = keypadDisplayValue;
        }

        function handleKeypadCheck() {
            if (!activeInput) return;
            activeInput.value = keypadDisplayValue;
            closeModalElement(numericKeypadModal);
            isKeypadOpen = false;
            isNewInput = false;
        }

        function openModal(modalElement) {
            if (!modalElement) return;
            modalElement.classList.remove('opacity-0', 'pointer-events-none', 'hidden');
            modalElement.classList.add('opacity-100');
            const content = modalElement.querySelector('.modal-content, .relative');
            if (content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
        }

        function closeQuickModeWorkoutModal() { /* Esta función ha sido eliminada */ }

        function toggleWorkoutState() { 
            if (isWorkoutInProgress) { 
                openWorkoutSummaryModal(); 
                releaseWakeLock();
            } else { 
                isWorkoutInProgress = true; 
                workoutStartTime = Date.now(); 
                workoutTimerInterval = setInterval(updateWorkoutDuration, 1000); 
                if(!currentSessionId) {
                    currentSessionId = crypto.randomUUID();
                }
                updateAllExerciseCardInputStates(); 
                requestWakeLock();
            } 
        }
        function updateWorkoutDuration() { 
            if (!isWorkoutInProgress || !workoutStartTime) return; 
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000); 
            const h = Math.floor(elapsed / 3600);
            const m = Math.floor((elapsed % 3600) / 60);
            const timeString = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            const durationEl = document.getElementById('workoutDuration'); 
            const simpleDurationEl = document.getElementById('simpleModeWorkoutDuration');
            if (durationEl) durationEl.textContent = timeString; 
            if (simpleDurationEl) simpleDurationEl.textContent = timeString;
        }
        
        function getHistoricalMaxRm(exerciseName) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName);
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) {
                            maxRm = currentRm;
                        }
                    }
                });
            });
            return maxRm;
        }

        function getHistoricalMaxRmExcludingSession(exerciseName, sessionId) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => 
                e.exercise_name === exerciseName && 
                e.session_id !== sessionId
            );
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) {
                            maxRm = currentRm;
                        }
                    }
                });
            });
            return maxRm;
        }

        function showNewRecordAlert(newRm) { newRecordText.textContent = `¡Has alcanzado un 1RM estimado de ${newRm.toFixed(1)}kg!`; openModal(newRecordModal); }
        
        // La función closeQuickModeWorkoutModal() ha sido eliminada.

        function closeSimpleModeWorkoutModal() {
            confirmBeforeClosingWorkoutModal(document.getElementById('simpleModeWorkoutModal'), () => {
                isSimpleModeActive = false;
                releaseWakeLock();
            });
        }

        function updateAllExerciseCardInputStates() {
            document.querySelectorAll('#quickModeWorkoutModal .quick-mode-exercise-item, #simpleModeWorkoutModal .quick-mode-exercise-item').forEach(card => {
                const exerciseName = card.dataset.currentName;
                const cardId = card.id;
                const logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseName);
                const setsLoggedCount = logEntry ? logEntry.setsPerformed.length : 0;
                const totalSets = parseInt(card.dataset.totalSets);
                const isFinalized = setsLoggedCount >= totalSets;

                const quickViewBody = document.getElementById(`quickViewBody-${cardId}`);
                if (!quickViewBody) return;

                const kgInput = quickViewBody.querySelector('input[aria-label*="Peso"]');
                const repsInput = quickViewBody.querySelector('input[aria-label*="Repeticiones"]');
                const registerBtn = quickViewBody.querySelector('.quick-mode-register-button');
                
                const progressDisplayContainer = document.getElementById(`progressDisplay-${cardId}`);
                if (progressDisplayContainer) {
                    let seriesHtml = `
                        <div class="text-center text-sm font-semibold text-gray-400 mt-2">
                            Serie ${setsLoggedCount + 1} de ${totalSets}
                        </div>
                    `;
                    const setsList = logEntry ? logEntry.setsPerformed.map(s => {
                        const repsUnit = isTimeBased(s.reps) ? 's' : 'reps';
                        const completionClass = s.completionState === 'good' ? 'text-green-400' : (s.completionState === 'bad' ? 'text-red-400' : 'text-gray-400');
                        return `<li>
                                    S.${s.serie}: ${s.kg}kg x <span class="${completionClass} font-bold">${s.reps} ${repsUnit}</span>
                                    <button onclick="deleteLoggedSet('${cardId}', ${s.serie})" class="text-red-400 hover:text-red-500 ml-2" title="Eliminar serie">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </li>`;
                    }).join('') : '';

                    if (isFinalized) {
                        seriesHtml = `
                            <div class="text-center text-sm font-semibold text-green-400 mt-2">
                                ¡Completado!
                            </div>
                        `;
                    }
                    
                    const registeredSetsListHtml = logEntry && logEntry.setsPerformed.length > 0 ? `
                        <div class="bg-gray-700/50 p-3 rounded-md mb-2 mt-2">
                            <h5 class="text-yellow-400 text-sm font-semibold mb-1">Series registradas:</h5>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                ${setsList}
                            </ul>
                        </div>
                    ` : '';
                    
                    progressDisplayContainer.innerHTML = seriesHtml + registeredSetsListHtml;
                }

                kgInput.disabled = isFinalized;
                repsInput.disabled = isFinalized;
                registerBtn.disabled = isFinalized;

                if (isFinalized) {
                    registerBtn.innerHTML = '<i class="fas fa-check-double text-xl"></i>';
                    registerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    registerBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    card.classList.add('completed-good');
                } else {
                     registerBtn.innerHTML = '<i class="fas fa-check-circle text-xl"></i>';
                     registerBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                     registerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                     card.classList.remove('completed-good', 'completed-bad');
                }
            });
        }
        
        function deleteLoggedSet(cardId, setNumberToDelete) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const exerciseName = card.dataset.currentName;
            const logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseName);
            
            if (!logEntry) return;

            // Find the index of the set to delete
            const setIndex = logEntry.setsPerformed.findIndex(s => s.serie === setNumberToDelete);
            if (setIndex === -1) return;

            // Remove the set
            logEntry.setsPerformed.splice(setIndex, 1);

            // Re-index the remaining sets
            logEntry.setsPerformed.forEach((s, index) => {
                s.serie = index + 1;
            });

            // Update the progress map for this card
            exerciseProgressMap.set(cardId, logEntry.setsPerformed.length);

            // Update the UI
            updateAllExerciseCardInputStates();
            
            // Re-save progress to the database
            saveRealtimeProgress();

            showCustomAlert(`Serie ${setNumberToDelete} eliminada.`, 'info');
        }

        function createQuickModeExerciseCard(dayKey, mainOrder, exerciseInput, isSubItem, specialData = null) { 
            const card = document.createElement('div'); 
            const cardId = isSubItem ? `qm-ex-${dayKey}-${mainOrder}-${exerciseInput.subOrder}` : `qm-ex-${dayKey}-${mainOrder}`; 
            card.id = cardId; 
            card.className = `quick-mode-exercise-item`; 
            card.dataset.dayKey = dayKey; 
            card.dataset.mainOrder = String(mainOrder); 
            card.dataset.subOrder = exerciseInput.subOrder !== undefined ? String(exerciseInput.subOrder) : ''; 
            card.dataset.currentName = exerciseInput.name; 
            const originalData = exerciseInput.originalExerciseData || exerciseInput;
            card.dataset.originalExerciseData = JSON.stringify(originalData); 
            card.dataset.primordialExerciseData = JSON.stringify(exerciseInput.primordialExerciseData || originalData);
            card.dataset.isSwapped = (exerciseInput.name !== originalData.name).toString(); 
            const isTimeBasedExercise = isTimeBased(exerciseInput.reps);
            
            const repsPlaceholder = Array.isArray(exerciseInput.reps) ? exerciseInput.reps.join(', ') : exerciseInput.reps;
            const kgPlaceholder = 'kg';

            const lastData = getLastLoggedDataForSet(exerciseInput.name, 1);
            const repsOnClick = isTimeBasedExercise ? `onclick="handleTimeBasedRepsClick(this, '${cardId}')"` : '';
            const dataIsTimeBased = isTimeBasedExercise ? `data-is-time-based="true"` : '';
            const totalSets = specialData ? specialData.series : (exerciseInput.sets || 1);
            card.dataset.totalSets = String(totalSets);
            const repsString = isTimeBasedExercise ? exerciseInput.reps : (Array.isArray(exerciseInput.reps) ? exerciseInput.reps.join(', ') : `${exerciseInput.reps || 'N/A'}`);
            let increaseWeightIndicator = ''; 
            if (getLastWorkoutEntry(exerciseInput.name) && getLastWorkoutEntry(exerciseInput.name).completion_state === 'good') { 
                increaseWeightIndicator = `<div class="increase-weight-btn" title="¡Buen trabajo! Sube el peso en esta sesión."><i class="fas fa-arrow-up text-gray-900"></i></div>`; 
            } 
            let seriesText = `Series: ${totalSets}`; 
            
            let settingsButtonHtml = '';
            let settingsDropdownHtml = '';
            const originalEscapedName = (originalData.name || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            settingsButtonHtml = `<button class="quick-mode-settings-button" onclick="toggleSettingsMenu(this, '${cardId}')" aria-label="Opciones de ejercicio"><i class="fas fa-cog"></i></button>`;

            const showWarmupButton = !isSubItem && !isTimeBased(exerciseInput.reps) && !isTimeBased(repsPlaceholder);
            const warmupButtonHtml = showWarmupButton ? `<button onclick="openWarmupModal()" class="quick-action-btn"><i class="fas fa-fire w-5 text-center"></i> Calc. Aproximación</button>` : '';

            const primordialExerciseName = (JSON.parse(card.dataset.primordialExerciseData || '{}').name);
            const showSwapButton = (exerciseAlternatives[primordialExerciseName] || []).length > 0 || card.dataset.isSwapped === "true";
            const swapButtonHtml = showSwapButton ? 
                `<button onclick="openSwapExerciseModal('${cardId}')" class="quick-action-btn"><i class="fas fa-exchange-alt w-5 text-center"></i> Cambiar Ejercicio</button>` : '';

            settingsDropdownHtml = `
                <div class="quick-mode-header-buttons" id="settingsMenu-${cardId}">
                    ${(typeof exerciseInput.rest === 'string' && !isTimeBasedExercise) ? 
                        `<button onclick="startRestTimer(${parseInt(exerciseInput.rest.match(/(\d+)s/)[1])})" class="quick-action-btn"><i class="fas fa-clock w-5 text-center"></i> Descanso</button>` : ''
                    }
                    <button onclick="viewExerciseHistoryFromLog('${originalEscapedName}')" class="quick-action-btn"><i class="fas fa-chart-line w-5 text-center"></i> Ver Historial</button>
                    ${warmupButtonHtml}
                    ${swapButtonHtml}
                </div>
            `;
            
            const notesHtml = exerciseInput.notes ? `<div class="notes">${exerciseInput.notes}</div>` : '';
            const imageUrl = exerciseInput.imageUrl;
            const videoUrl = exerciseInput.videoUrl;
            let imageHtml = '';
            if (imageUrl) {
                const imageTag = `<img src="${imageUrl}" alt="Preview de ${exerciseInput.name}" class="w-24 h-24 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/4A5568/FACC15?text=No+Img';">`;
                if (videoUrl) {
                    imageHtml = `<a href="#" onclick="openVideoLink('${videoUrl}')" class="flex-shrink-0" title="Ver vídeo">${imageTag}</a>`;
                } else {
                    imageHtml = `<div class="flex-shrink-0">${imageTag}</div>`;
                }
            }

            // El HTML de listModeHeaderHtml ha sido eliminado.

            const simpleModeHeaderHtml = `
                <div class="title-line">
                    <strong class="text-yellow-400">${isSubItem ? `${mainOrder}.${exerciseInput.subOrder}` : exerciseInput.order}. ${exerciseInput.name}</strong> ${increaseWeightIndicator}
                </div>
                <div class="simple-mode-content-row">
                    ${imageHtml}
                    <div class="info flex-grow">
                        <span class="block text-sm font-medium text-gray-400">Nº de Series:</span>
                        <span class="block text-2xl font-bold text-white mb-2">${totalSets}</span>
                        <span class="block text-sm font-medium text-gray-400">Objetivo:</span>
                        <span class="block text-2xl font-bold text-white">${repsString}</span>
                    </div>
                </div>
            `;

            card.innerHTML = ` 
                <div class="quick-mode-exercise-header"> 
                    ${simpleModeHeaderHtml}
                </div> 
                <div id="quickViewBody-${cardId}" class="quick-mode-input-row"> 
                    <input type="text" pattern="[0-9]*[.,]?[0-9]*" inputmode="none" onfocus="openNumericPad(this)" value="${lastData.kg || ''}" placeholder="${kgPlaceholder}" class="quick-mode-input" aria-label="Peso para ${exerciseInput.name}" data-field-type="kg"> 
                    <input type="text" pattern="[0-9]*" inputmode="none" onfocus="openNumericPad(this)" value="${lastData.reps || ''}" placeholder="${repsPlaceholder}" class="quick-mode-input" aria-label="Repeticiones para ${exerciseInput.name}" ${repsOnClick} ${dataIsTimeBased} data-field-type="reps"> 
                    <button class="quick-mode-register-button" onclick="logSingleSetStepByStep(this, '${cardId}')" aria-label="Registrar set"> 
                        <i class="fas fa-check"></i> 
                    </button> 
                </div> 
                <div id="progressDisplay-${cardId}">
                    <div class="text-center text-sm font-semibold text-gray-400 mt-2">
                        Serie 1 de ${totalSets}
                    </div>
                </div>
                ${notesHtml}
                ${settingsButtonHtml}
                ${settingsDropdownHtml}
            `; 
            return card; 
        }

        function createQuickModeSupersetCard(dayKey, mainOrder, supersetInput) { 
            const card = document.createElement('div'); 
            card.className = 'quick-mode-superset-container'; 
            card.id = `qm-superset-${dayKey}-${mainOrder}`; 
            let controlButtonHtml = ''; 
            let specialData = null; 
            let titleText = ''; 
            if (supersetInput.isEMOM) { 
                titleText = 'EMOM'; 
                controlButtonHtml = `<button onclick="startEmom('${dayKey}', ${mainOrder})" class="bg-purple-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR EMOM</button>`; 
                if (supersetInput.emomDetails && supersetInput.items) { 
                    const exerciseCount = supersetInput.items.length; 
                    const totalIntervals = parseInt(supersetInput.emomDetails.totalIntervals, 10); 
                    if (exerciseCount > 0 && totalIntervals > 0) { 
                        specialData = { series: Math.ceil(totalIntervals / exerciseCount) }; 
                    } 
                } 
            } else if (supersetInput.circuitDetails) { 
                titleText = 'CIRCUITO'; 
                controlButtonHtml = `<button onclick="startCircuit('${dayKey}', ${mainOrder})" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR CIRCUITO</button>`; 
                specialData = { series: supersetInput.circuitDetails.totalRounds }; 
            } else if (supersetInput.isSuperset) { 
                titleText = 'SUPERSERIE'; 
            } else { 
                titleText = supersetInput.name; 
            } 
            card.innerHTML = `<div class="flex justify-between items-center"><h3 class="exercise-card-container-title" style="border-bottom:0; margin-bottom:0;">${mainOrder}. ${titleText.toUpperCase()}</h3><div>${controlButtonHtml}</div></div>`; 
            if (supersetInput.items && Array.isArray(supersetInput.items)) { 
                supersetInput.items.forEach((subExercise) => { 
                    card.appendChild(createQuickModeExerciseCard(dayKey, mainOrder, subExercise, true, specialData));
                }); 
            } 
            return card; 
        }
        
        async function logSingleSetStepByStep(button, cardId) {
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para registrar series.", "warning");
                return;
            }

            const card = document.getElementById(cardId);
            if (!card || card.querySelector('.quick-mode-register-button').disabled) {
                return;
            }

            const kgInput = card.querySelector('.quick-mode-input-row input[aria-label*="Peso"]');
            const repsInput = card.querySelector('.quick-mode-input-row input[aria-label*="Repeticiones"]');
            const progressSpan = document.getElementById(`progressDisplay-${cardId}`);
            
            const kg = kgInput.value.trim().replace(',', '.');
            const reps = repsInput.value.trim();
            const totalSets = parseInt(card.dataset.totalSets, 10);

            const isTimeBasedExercise = isTimeBased(repsInput.placeholder);
            if (!isTimeBasedExercise && (kg === '' || reps === '')) {
                showCustomAlert("Por favor, introduce el peso y las repeticiones.", "warning");
                return;
            }

            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check-circle text-xl animate-pulse"></i>';
            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            button.classList.add('bg-green-500');
            setTimeout(() => {
                if (!card.querySelector('.quick-mode-register-button').disabled) {
                    button.innerHTML = originalButtonContent;
                    button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    button.classList.remove('bg-green-500');
                }
            }, 500);

            let currentSet = (exerciseProgressMap.get(cardId) || 0) + 1;
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const targetReps = isTimeBasedExercise ? exerciseData.reps : (Array.isArray(exerciseData.reps) && exerciseData.reps.length >= currentSet ? exerciseData.reps[currentSet - 1] : exerciseData.reps);
            const completionState = getRepCompletionState(reps, targetReps);

            let newPrValue = null;
            if (!isTimeBasedExercise && parseFloat(kg) > 0 && parseInt(reps) > 0) {
                const currentRm = calculateEpley1RM(kg, reps);
                const historicalMaxRm = getHistoricalMaxRmExcludingSession(exerciseData.name, currentSessionId);
                if (historicalMaxRm > 0 && currentRm > historicalMaxRm) {
                    showNewRecordAlert(currentRm);
                    newPrValue = currentRm.toFixed(1);
                } else if (historicalMaxRm === 0 && currentRm > 0) {
                    newPrValue = currentRm.toFixed(1);
                }
            }

            let logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseData.name);
            if (!logEntry) {
                logEntry = {
                    exerciseName: exerciseData.name,
                    date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    rawDate: new Date().toISOString(),
                    dayKey: card.dataset.dayKey,
                    setsPerformed: [],
                    completionState: 'neutral',
                    personalRecord: newPrValue
                };
                currentWorkoutSummaryData.push(logEntry);
            }
            logEntry.setsPerformed.push({ serie: currentSet, kg, reps, completionState });
            logEntry.setsPerformed.sort((a, b) => a.serie - b.serie);

            let overallCompletion = 'good';
            for(const set of logEntry.setsPerformed) {
                const setCompletionState = getRepCompletionState(set.reps, targetReps);
                if(setCompletionState === 'bad') {
                    overallCompletion = 'bad';
                    break;
                }
                if(setCompletionState === 'neutral') {
                    overallCompletion = 'neutral';
                }
            }
            logEntry.completionState = overallCompletion;
            
            if (newPrValue && (!logEntry.personalRecord || parseFloat(newPrValue) > parseFloat(logEntry.personalRecord))) {
                logEntry.personalRecord = newPrValue;
            }

            await saveRealtimeProgress();

            if (currentSet >= totalSets) {
                exerciseProgressMap.set(cardId, totalSets);
                updateAllExerciseCardInputStates();
                showCustomAlert(`¡Ejercicio "${exerciseData.name}" completado!`, "info");

                if (isSimpleModeActive) {
                    setTimeout(() => {
                        if (currentSimpleModeIndex < simpleModeExercises.length - 1) {
                            navigateSimpleMode(1);
                        }
                    }, 800);
                }
            } else {
                exerciseProgressMap.set(cardId, currentSet);
                
                // Clear the inputs for the next set
                kgInput.value = '';
                repsInput.value = '';

                const nextSetData = getLastLoggedDataForSet(exerciseData.name, currentSet + 1);
                if (nextSetData.kg) {
                    kgInput.value = nextSetData.kg;
                } else {
                    kgInput.value = '';
                }
                if (nextSetData.reps) {
                    repsInput.value = nextSetData.reps;
                } else {
                    repsInput.value = '';
                }
                
                const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
                if (restDurationMatch) {
                    const restSeconds = parseInt(restDurationMatch[1], 10);
                    if (restSeconds > 0) {
                        let nextExerciseForRest = null;
                        
                        const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item'));
                        const currentCardIndex = allExerciseCards.findIndex(el => el.id === cardId);
                        
                        const currentSupersetContainer = card.closest('.quick-mode-superset-container');
                        
                        if (currentSupersetContainer && currentSet < totalSets) {
                            const supersetItems = Array.from(currentSupersetContainer.querySelectorAll('.quick-mode-exercise-item'));
                            const currentSubIndex = supersetItems.findIndex(el => el.id === cardId);
                            
                            const nextSubExerciseCard = supersetItems[currentSubIndex + 1];
                            
                            if (nextSubExerciseCard) {
                                const nextExerciseData = JSON.parse(nextSubExerciseCard.dataset.originalExerciseData || '{}');
                                nextExerciseForRest = {
                                    type: 'nextExercise',
                                    name: nextExerciseData.name,
                                    reps: nextExerciseData.reps,
                                    kg: nextExerciseData.kg || '--',
                                    imageUrl: nextExerciseData.imageUrl
                                };
                            } else {
                                const firstSubExerciseCard = supersetItems[0];
                                if (firstSubExerciseCard) {
                                    const nextExerciseData = JSON.parse(firstSubExerciseCard.dataset.originalExerciseData || '{}');
                                    nextExerciseForRest = {
                                        type: 'nextExercise',
                                        name: nextExerciseData.name,
                                        reps: nextExerciseData.reps,
                                        kg: nextExerciseData.kg || '--',
                                        imageUrl: nextExerciseData.imageUrl
                                    };
                                }
                            }
                        } else {
                            if (currentSet < totalSets) {
                                const nextSetNumber = currentSet + 1;
                                const nextKg = getLastLoggedDataForSet(exerciseData.name, nextSetNumber).kg || '--';
                                const nextReps = getLastLoggedDataForSet(exerciseData.name, nextSetNumber).reps || exerciseData.reps;
                                nextExerciseForRest = {
                                    type: 'nextSet',
                                    name: exerciseData.name,
                                    reps: nextReps,
                                    kg: nextKg,
                                    setNumber: nextSetNumber,
                                    totalSets: totalSets,
                                    imageUrl: exerciseData.imageUrl
                                };
                            } else {
                                const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                                const currentCardElement = document.getElementById(cardId);
                                const currentCardIndex = allExerciseCards.findIndex(el => el.id === cardId || el.contains(currentCardElement));
                                if (currentCardIndex !== -1) {
                                    let nextCard = null;
                                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) {
                                            nextCard = allExerciseCards[i];
                                            break;
                                        } else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) {
                                            const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item');
                                            if (firstSubExercise) {
                                                nextCard = firstSubExercise;
                                                break;
                                            }
                                        }
                                    }
                                    if (nextCard) {
                                        const nextExerciseData = JSON.parse(nextCard.dataset.originalExerciseData || '{}');
                                        nextExerciseForRest = {
                                            type: 'nextExercise',
                                            name: nextCard.dataset.currentName,
                                            reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                                            kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--',
                                            imageUrl: nextExerciseData.imageUrl
                                        };
                                    }
                                }
                            }
                        }
                        startRestTimer(restSeconds, nextExerciseForRest);
                    }
                }
            }

            updateAllExerciseCardInputStates();
        }

        async function saveRealtimeProgress() {
            if (!userIdentifier || !currentSessionId || !isWorkoutInProgress) return;
            try {
                const progress = {
                    sessionId: currentSessionId,
                    workoutData: currentWorkoutSummaryData,
                    startTime: workoutStartTime,
                    dayKey: currentActiveDayKey
                };
                localStorage.setItem(`realtimeProgress_${userIdentifier}`, JSON.stringify(progress));
                console.log("Real-time progress saved to local storage.");
            } catch (err) {
                console.error("Error saving progress to local storage:", err);
                showCustomAlert("No se pudo guardar el progreso.", "error");
            }
        }
        
        async function loadRealtimeProgress() {
            if (!userIdentifier) return;
            try {
                const savedProgressJSON = localStorage.getItem(`realtimeProgress_${userIdentifier}`);
                if (savedProgressJSON) {
                    const savedProgress = JSON.parse(savedProgressJSON);
        
                    if (savedProgress.dayKey) {
                        currentWorkoutSummaryData = savedProgress.workoutData;
                        currentSessionId = savedProgress.sessionId;
                        workoutStartTime = savedProgress.startTime;
                        currentActiveDayKey = savedProgress.dayKey;
                        isWorkoutInProgress = true;
        
                        updateUIAfterResume();
                    }
                } else {
                    console.log("No real-time progress to load from local storage.");
                }
            } catch (err) {
                console.error("Error loading progress from local storage:", err);
            }
        }

        async function clearRealtimeProgress() {
            if (!userIdentifier) return;
            try {
                localStorage.removeItem(`realtimeProgress_${userIdentifier}`);
                console.log("Real-time progress cleared from local storage.");
            } catch (err) {
                console.error("Error clearing progress from local storage:", err);
            }
        }

        function openWorkoutSummaryModal() {
            const elapsed = workoutStartTime > 0 ? Math.floor((Date.now() - workoutStartTime) / 1000) : 0;
            const h = Math.floor(elapsed / 3600), m = Math.floor((elapsed % 3600) / 60);
            workoutSummaryTotalTime.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            let totalVolume = 0;
            currentWorkoutSummaryData.forEach(entry => {
                entry.setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        totalVolume += (parseFloat(set.kg) || 0) * (parseInt(set.reps) || 0);
                    }
                });
            });
            workoutSummaryTotalVolume.textContent = `${totalVolume.toFixed(0)} Kg`;
            workoutSummaryExerciseList.innerHTML = '';
            if (currentWorkoutSummaryData.length === 0) {
                workoutSummaryExerciseList.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios.</p>';
            } else {
                currentWorkoutSummaryData.forEach(entry => {
                    let displayInfo = entry.setsPerformed.map(s => {
                        const repsUnit = isTimeBased(s.reps) ? 's' : 'r';
                        return `${s.kg}kg x ${s.reps}${repsUnit}`;
                    }).join(', ');
                    workoutSummaryExerciseList.innerHTML += `<div class="summary-exercise-item"><p class="font-semibold text-yellow-400">${entry.exerciseName}</p><p class="text-gray-300 text-sm">${displayInfo}</p></div>`;
                });
            }
            registerWorkoutButton.onclick = async () => {
                registerWorkoutButton.innerHTML = 'Procesando...';
                registerWorkoutButton.disabled = true;
                releaseWakeLock();
                try {
                    const individualLogsToInsert = currentWorkoutSummaryData.map(entry => ({
                        client_id: userIdentifier,
                        date: entry.date,
                        time: entry.time,
                        raw_date: entry.rawDate,
                        day_key: entry.dayKey,
                        exercise_name: entry.exerciseName,
                        sets_performed: entry.setsPerformed,
                        completion_state: entry.completionState,
                        session_id: currentSessionId
                    }));
                    if (individualLogsToInsert.length > 0) {
                        const { error: individualInsertError } = await supabase
                            .from('workout_logs')
                            .insert(individualLogsToInsert);
                        if (individualInsertError) {
                            throw new Error(`Error inserting individual exercise logs: ${individualInsertError.message}`);
                        }
                    }
                    const sessionSummaryLog = {
                        client_id: userIdentifier,
                        date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                        time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                        raw_date: new Date().toISOString(),
                        exercise_name: "Workout Session Summary",
                        name_workout: workoutData[currentActiveDayKey].name,
                        sets_performed: JSON.stringify(currentWorkoutSummaryData),
                        completion_state: "completed",
                        session_id: currentSessionId,
                        total_time_session: workoutSummaryTotalTime.textContent,
                        total_volume_session: parseFloat(workoutSummaryTotalVolume.textContent.replace(' Kg', ''))
                    };
                    const { error: summaryInsertError } = await supabase
                        .from('workout_logs')
                        .insert([sessionSummaryLog]);
                    if (summaryInsertError) {
                        throw new Error(`Error inserting workout session summary: ${summaryInsertError.message}`);
                        }
                    showCustomAlert("¡Entrenamiento registrado con éxito!", "info");
                    await loadWorkoutLogs();
                    const lastActiveDayKey = currentActiveDayKey;
                    isWorkoutInProgress = false;
                    await clearRealtimeProgress();
                    registerWorkoutButton.innerHTML = '¡Registrado!';
                    
                    setTimeout(() => {
                        closeModalElement(workoutSummaryModal);
                        closeModalElement(quickModeWorkoutModal);
                        if (lastActiveDayKey) {
                            displayWorkoutPreview(lastActiveDayKey);
                        }
                        if(registerWorkoutButton) {
                            registerWorkoutButton.innerHTML = 'Registrar';
                            registerWorkoutButton.disabled = false;
                        }
                    }, 1500);

                } catch (error) {
                    console.error("Unexpected error during workout registration:", error);
                    showCustomAlert(`Ha ocurrido un error inesperado al registrar el entrenamiento: ${error.message}`, "error");
                    registerWorkoutButton.innerHTML = 'Error';
                    setTimeout(() => { registerWorkoutButton.innerHTML = 'Registrar'; registerWorkoutButton.disabled = false; }, 2000);
                }
            };
            openModal(workoutSummaryModal);
        }

        function closeWorkoutSummaryModal(registered = false) { 
            closeModalElement(workoutSummaryModal); 
            if (registered) { 
                currentWorkoutSummaryData = []; 
                if (isSimpleModeActive) {
                    closeModalElement(document.getElementById('simpleModeWorkoutModal'));
                    isSimpleModeActive = false;
                } else {
                    closeModalElement(quickModeWorkoutModal);
                }
            } 
        }
        
        function parseDurationToSeconds(durationInput) {
            if (durationInput === null || typeof durationInput === 'undefined' || durationInput === '') { return 0; }
            const durationString = String(durationInput).trim().toLowerCase();
            let totalSeconds = 0;
            
            const hmsMatch = durationString.match(/^(\d+):(\d+):(\d+)$/);
            if(hmsMatch) {
                totalSeconds = parseInt(hmsMatch[1], 10) * 3600 + parseInt(hmsMatch[2], 10) * 60 + parseInt(hmsMatch[3], 10);
            } else {
                 const hmMatch = durationString.match(/^(\d+):(\d+)$/);
                 if(hmMatch) {
                    totalSeconds = parseInt(hmMatch[1], 10) * 3600 + parseInt(hmMatch[2], 10) * 60;
                 } else {
                    const minutesMatch = durationString.match(/(\d+)\s*(min|minute|minutes|m)/);
                    const secondsMatch = durationString.match(/(\d+)\s*(s|sec|second|seconds)/);
                    const justNumberMatch = durationString.match(/^(\d+)$/);
                    if (minutesMatch) { totalSeconds += parseInt(minutesMatch[1], 10) * 60; }
                    if (secondsMatch) { totalSeconds += parseInt(secondsMatch[1], 10); } 
                    else if (justNumberMatch && !minutesMatch && !secondsMatch) { totalSeconds += parseInt(justNumberMatch[1], 10); }
                 }
            }
            if (isNaN(totalSeconds) || totalSeconds === 0) { return 0; }
            return totalSeconds;
        }

        function openWarmupModal() { document.getElementById('warmupSetsResult').innerHTML = ''; document.getElementById('workingSetWeightInput').value = ''; openModal(warmupModal); }
        
        function calculateWarmupSets() { 
            const workingWeight = parseFloat(document.getElementById('workingSetWeightInput').value); 
            const resultDiv = document.getElementById('warmupSetsResult'); 
            resultDiv.innerHTML = ''; 
            
            if (isNaN(workingWeight) || workingWeight <= 0) { 
                resultDiv.innerHTML = '<p class="text-red-400">Por favor, introduce un peso válido.</p>'; 
                return; 
            } 
            
            const sets = [ 
                { weight: workingWeight * 0.5, reps: '8', label: 'Serie 1' }, 
                { weight: workingWeight * 0.7, reps: '6', label: 'Serie 2' }, 
                { weight: workingWeight * 0.85, reps: '3', label: 'Serie 3' }, 
            ]; 
            
            const list = document.createElement('ul'); 
            list.className = 'list-disc list-inside space-y-1'; 
            
            sets.forEach(set => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span class="font-semibold text-yellow-400">${set.label}:</span> ${set.weight.toFixed(1)} Kg x ${set.reps} reps`; 
                list.appendChild(li); 
            }); 
            
            resultDiv.appendChild(list); 
        }
        function prepareShareableCard() { const cardContent = document.getElementById('shareCard'); const dayData = workoutData[currentActiveDayKey]; const totalVolume = workoutSummaryTotalVolume.textContent; const totalTime = workoutSummaryTotalTime.textContent; cardContent.innerHTML = ` <h4>${dayData.name.toUpperCase()}</h4> <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" class="logo" alt="Logo"> <p><strong><i class="fas fa-clock mr-2"></i>Tiempo:</strong> ${totalTime}</p> <p><strong><i class="fas fa-weight-hanging mr-2"></i>Volumen:</strong> ${totalVolume}</p> <p class="text-center text-xs mt-4">¡Entrenamiento completado!</p> `; openModal(shareModal); }
        function downloadShareableImage() { const cardToCapture = document.getElementById('shareCard'); html2canvas(cardToCapture, { backgroundColor: null, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = 'resumen-entrenamiento.png'; link.href = canvas.toDataURL('image/png'); link.click(); }); }
        
        function startEmom(dayKey, mainOrder) {
            const emomBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.isEMOM);
            if (!emomBlock || !emomBlock.emomDetails || !emomBlock.items) {
                showCustomAlert("Datos de EMOM no encontrados.", "error");
                return;
            }
            emomExercisesArray = emomBlock.items;
            totalEmomIntervals = parseInt(emomBlock.emomDetails.totalIntervals, 10);
            emomWorkIntervalSeconds = 60;
            currentEmomMainOrder = mainOrder;
            if (isNaN(totalEmomIntervals) || isNaN(emomWorkIntervalSeconds) || emomWorkIntervalSeconds <= 0) {
                showCustomAlert("Configuración de EMOM inválida.", "error");
                return;
            }
            currentEmomIntervalNumber = 0;
            currentEmomExerciseIndex = 0;
            
            emomActiveView.style.display = 'none';
            emomWelcomeView.style.display = 'flex';
            emomWelcomeTitle.textContent = 'EMOM';
            const totalMinutes = Math.floor(totalEmomIntervals * emomWorkIntervalSeconds / 60);
            emomWelcomeDetails.innerHTML = `Tendrás que completar <strong>${totalEmomIntervals} intervalos de 1 minuto</strong>. <br>Ejercicios: ${emomExercisesArray.map(e => e.name).join(', ')}.`;
            const firstExerciseImage = emomExercisesArray[0].imageUrl;
            if (emomWelcomeImage && firstExerciseImage) {
                emomWelcomeImage.src = firstExerciseImage;
                emomWelcomeImage.style.display = 'block';
            } else if(emomWelcomeImage) {
                emomWelcomeImage.style.display = 'none';
                emomWelcomeImage.src = '';
            }
            openModal(emomTimerModal);
        }

        function runNextEmomInterval() {
            emomWelcomeView.style.display = 'none';
            emomActiveView.style.display = 'flex';
            clearInterval(emomIntervalTimer);
            if (currentEmomIntervalNumber >= totalEmomIntervals) {
                terminateEmom(true); return;
            }
            currentEmomIntervalNumber++;
            currentEmomExerciseIndex = (currentEmomIntervalNumber - 1) % emomExercisesArray.length;
            const currentExercise = emomExercisesArray[currentEmomExerciseIndex];
            updateEmomModalDisplay(currentExercise);
            let timeLeftInInterval = emomWorkIntervalSeconds;
            emomStateLabel.textContent = 'TRABAJO';
            emomStateLabel.className = 'state-label work';
            emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
            emomIntervalTimer = setInterval(() => {
                timeLeftInInterval--;
                emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
                if (timeLeftInInterval <= 3 && timeLeftInInterval > 0) {
                    playTimerSound("C4", "16n");
                }
                if (timeLeftInInterval <= 0) {
                    clearInterval(emomIntervalTimer);
                    playTimerSound("A5", "8n");
                    runNextEmomInterval();
                }
            }, 1000);
        }

        function updateEmomModalDisplay(exercise) {
            emomTimerTitle.innerHTML = `<span class="text-yellow-400">Ronda ${Math.floor((currentEmomIntervalNumber - 1) / emomExercisesArray.length) + 1} de ${Math.ceil(totalEmomIntervals / emomExercisesArray.length)}</span>`;
            emomOverallProgress.textContent = `Intervalo ${currentEmomIntervalNumber} de ${totalEmomIntervals}`;
            emomCurrentExerciseName.textContent = exercise.name;
            emomCurrentExerciseReps.textContent = exercise.reps || 'N/A';
            emomCurrentExerciseWeight.textContent = exercise.kg || '--';
            const imgElement = document.getElementById('emomCurrentImage');
            if (imgElement && exercise.imageUrl) {
                imgElement.src = exercise.imageUrl;
                imgElement.style.display = 'block';
            } else if (imgElement) {
                imgElement.style.display = 'none';
                imgElement.src = '';
            }
        }

        function terminateEmom(completed = false) {
            clearInterval(emomIntervalTimer);
            closeModalElement(emomTimerModal);
            if (completed) { showCustomAlert("¡EMOM completado!", "info"); } 
            else { showCustomAlert("EMOM terminado antes de tiempo.", "warning"); }
        }

        function terminateEmomEarly() { terminateEmom(false); }
        function skipEmomInterval() {
            clearInterval(emomIntervalTimer);
            playTimerSound("A4", "8n");
            runNextEmomInterval();
        }

        function startCircuit(dayKey, mainOrder) {
            const circuitBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.circuitDetails);
            if (!circuitBlock || !circuitBlock.circuitDetails || !circuitBlock.items) {
                showCustomAlert("Datos de Circuito no encontrados.", "error"); return;
            }
            circuitExercisesArray = circuitBlock.items;
            circuitDetailsGlobal = circuitBlock.circuitDetails;
            currentCircuitMainOrder = mainOrder;
            if (isNaN(circuitDetailsGlobal.totalRounds) || circuitDetailsGlobal.totalRounds <= 0) {
                showCustomAlert("Configuración de Circuito inválida.", "error"); return;
            }
            currentCircuitRound = 1;
            currentCircuitExerciseIndexInRound = 0;
            currentCircuitPhase = 'countdown';
            currentCircuitTimeLeft = 5;
            
            circuitActiveView.style.display = 'none';
            circuitWelcomeView.style.display = 'flex';
            circuitWelcomeTitle.textContent = 'CIRCUITO';
            let totalCircuitDuration = 0;
            circuitExercisesArray.forEach(ex => {
                totalCircuitDuration += parseDurationToSeconds(ex.reps);
            });
            totalCircuitDuration += parseDurationToSeconds(circuitDetailsGlobal.restBetweenExercisesSeconds) * (circuitExercisesArray.length - 1);
            totalCircuitDuration = totalCircuitDuration * circuitDetailsGlobal.totalRounds;
            totalCircuitDuration += parseDurationToSeconds(circuitDetailsGlobal.restBetweenRoundsSeconds) * (circuitDetailsGlobal.totalRounds - 1);

            const formattedTotalDuration = formatTime(totalCircuitDuration);

            circuitWelcomeDetails.innerHTML = `Consta de <strong>${circuitDetailsGlobal.totalRounds} rondas</strong> con una duración total de ${formattedTotalDuration}. <br>Ejercicios: ${circuitExercisesArray.map(e => e.name).join(', ')}.`;
            const firstExerciseImage = circuitExercisesArray[0].imageUrl;
            if (circuitWelcomeImage && firstExerciseImage) {
                circuitWelcomeImage.src = firstExerciseImage;
                circuitWelcomeImage.style.display = 'block';
            } else if (circuitWelcomeImage) {
                circuitWelcomeImage.style.display = 'none';
                circuitWelcomeImage.src = '';
            }

            openModal(circuitTimerModal);
        }

        function runNextCircuitInterval() {
            circuitWelcomeView.style.display = 'none';
            circuitActiveView.style.display = 'flex';

            clearInterval(circuitTimerInterval);

            if (currentCircuitPhase === 'countdown') {
                currentCircuitPhase = 'working';
            } else if (currentCircuitPhase === 'working') {
                currentCircuitExerciseIndexInRound++;
                if (currentCircuitExerciseIndexInRound >= circuitExercisesArray.length) {
                    if (currentCircuitRound < circuitDetailsGlobal.totalRounds) {
                        currentCircuitPhase = 'resting_round';
                    } else {
                        terminateCircuit(true);
                        return;
                    }
                } else {
                    currentCircuitPhase = 'resting_exercise';
                }
            } else if (currentCircuitPhase === 'resting_exercise') {
                currentCircuitPhase = 'working';
            } else if (currentCircuitPhase === 'resting_round') {
                currentCircuitRound++;
                currentCircuitExerciseIndexInRound = 0;
                currentCircuitPhase = 'working';
            }
            
            switch(currentCircuitPhase) {
                case 'working':
                    const currentExercise = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    currentCircuitTimeLeft = parseDurationToSeconds(currentExercise.reps);
                    if (currentCircuitTimeLeft === 0 && isTimeBased(currentExercise.reps)) {
                         showCustomAlert(`Ejercicio ${currentExercise.name} no tiene duración definida. Saltando.`, "warning");
                         runNextCircuitInterval();
                         return;
                    }
                    break;
                case 'resting_exercise':
                    currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenExercisesSeconds);
                    break;
                case 'resting_round':
                    currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenRoundsSeconds);
                    break;
            }

            updateCircuitModalDisplay();

            if (currentCircuitTimeLeft > 0) {
                circuitTimerInterval = setInterval(() => {
                    currentCircuitTimeLeft--;
                    circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
                    if (currentCircuitTimeLeft <= 3 && currentCircuitTimeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                    if (currentCircuitTimeLeft <= 0) {
                        clearInterval(circuitTimerInterval);
                        playTimerSound("A5", "8n");
                        runNextCircuitInterval();
                    }
                }, 1000);
            } else {
                runNextCircuitInterval();
            }
        }

        function updateCircuitModalDisplay() {
            circuitTimerTitle.innerHTML = `<span class="text-yellow-400">Ronda ${currentCircuitRound} de ${circuitDetailsGlobal.totalRounds}</span>`;
            
            circuitOverallProgress.textContent = '';
            circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
            let exerciseForDisplay = null;
            switch (currentCircuitPhase) {
                case 'countdown':
                    exerciseForDisplay = circuitExercisesArray[0];
                    circuitStateLabel.textContent = 'CUENTA ATRÁS';
                    circuitStateLabel.className = 'state-label countdown';
                    circuitExerciseName.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`;
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'working':
                    exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    circuitStateLabel.textContent = 'TRABAJO';
                    circuitStateLabel.className = 'state-label work';
                    circuitExerciseName.textContent = exerciseForDisplay?.name || '';
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'resting_exercise':
                    exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    circuitStateLabel.textContent = 'DESCANSO';
                    circuitStateLabel.className = 'state-label rest';
                    circuitExerciseName.textContent = `Siguiente: ${exerciseForDisplay?.name || ''}`;
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'resting_round':
                    exerciseForDisplay = circuitExercisesArray[0];
                    circuitStateLabel.textContent = 'DESCANSO';
                    circuitStateLabel.className = 'state-label rest';
                    circuitExerciseName.textContent = `Prepárate para la Ronda ${currentCircuitRound + 1}`;
                    circuitExerciseDetails.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`;
                    break;
            }
            const imgElement = document.getElementById('circuitCurrentImage');
            if (imgElement && exerciseForDisplay && exerciseForDisplay.imageUrl) {
                imgElement.src = exerciseForDisplay.imageUrl;
                imgElement.style.display = 'block';
            } else if (imgElement) {
                imgElement.style.display = 'none';
                imgElement.src = '';
            }
        }
        
        function terminateCircuit(completed = false) {
            clearInterval(circuitTimerInterval);
            closeModalElement(circuitTimerModal);
            if (completed) { showCustomAlert("¡Circuito completado!", "info"); } 
            else { showCustomAlert("Circuito terminado antes de tiempo.", "warning"); }
        }

        function terminateCircuitEarly() { terminateCircuit(false); }
        
        function skipCircuitInterval() {
            clearInterval(circuitTimerInterval);
            playTimerSound("A4", "8n");
            runNextCircuitInterval();
        }

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function formatTimeHHMM(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
        }

        let countdownTimerInterval = null;
        let countdownTimeLeft = 0;
        let countdownCallback = null;
        let countdownType = '';

        function startCountdownTimer(type, duration = 5, callback = null) {
            countdownType = type;
            countdownTimeLeft = duration;
            countdownCallback = callback;
            clearInterval(countdownTimerInterval);

            let modalTitleEl, timerDisplayEl, stateLabelEl, progressEl, nameEl, detailsEl, imgEl;
            if (type === 'work') {
                modalTitleEl = workTimerTitle;
                timerDisplayEl = workTimerDisplay;
                stateLabelEl = workStateLabel;
                progressEl = workOverallProgress;
                nameEl = workExerciseName;
                detailsEl = workExerciseDetails;
                imgEl = workCurrentImage;
                openModal(workTimerModal);
            } else if (type === 'emom') {
                modalTitleEl = emomTimerTitle;
                timerDisplayEl = emomIntervalTimerDisplay;
                stateLabelEl = emomStateLabel;
                openModal(emomTimerModal);
            } else if (type === 'circuit') {
                modalTitleEl = circuitTimerTitle;
                timerDisplayEl = circuitTimerDisplay;
                stateLabelEl = circuitStateLabel;
                openModal(circuitTimerModal);
            }
            
            if (type === 'work') {
                if (modalTitleEl) modalTitleEl.textContent = 'TIEMPO DE TRABAJO';
            } else if (type === 'emom') {
                 if (modalTitleEl) modalTitleEl.textContent = `<span class="text-yellow-400">EMOM</span>`;
            } else if (type === 'circuit') {
                 if (modalTitleEl) modalTitleEl.textContent = `<span class="text-yellow-400">CIRCUITO</span>`;
            }

            if (stateLabelEl) {
                stateLabelEl.textContent = 'CUENTA ATRÁS';
                stateLabelEl.className = 'state-label countdown';
            }
            
            if (type === 'work' && currentTimedExerciseCardId) {
                const card = document.getElementById(currentTimedExerciseCardId);
                if (card) {
                    const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
                    if(progressEl) progressEl.textContent = `Serie ${currentTimedExerciseSetNumber} de ${totalSetsForCurrentTimedExercise}`;
                    if(nameEl) nameEl.textContent = `Empezando con: ${exerciseData.name}`;
                    if(detailsEl) detailsEl.textContent = `Objetivo: ${exerciseData.reps}`;
                    if (imgEl && exerciseData.imageUrl) {
                        imgEl.src = exerciseData.imageUrl;
                        imgEl.style.display = 'block';
                    } else if (imgEl) {
                        imgEl.style.display = 'none';
                        imgEl.src = '';
                    }
                }
            }
            
            if (timerDisplayEl) timerDisplayEl.textContent = formatTime(countdownTimeLeft);

            countdownTimerInterval = setInterval(() => {
                countdownTimeLeft--;
                if (timerDisplayEl) timerDisplayEl.textContent = formatTime(countdownTimeLeft);
                if (countdownTimeLeft <= 0) {
                    clearInterval(countdownTimerInterval);
                    playTimerSound("A5", "8n");
                    if (type === 'work') {
                        if (currentTimedExerciseCardId !== null) {
                            runWorkTimerForTimedExercise(parseDurationToSeconds(JSON.parse(document.getElementById(currentTimedExerciseCardId).dataset.originalExerciseData).reps));
                        } else { runWorkTimer(); }
                    } else if (type === 'emom') { runNextEmomInterval(); } 
                    else if (type === 'circuit') { runNextCircuitInterval(); }
                    if (countdownCallback) countdownCallback();
                } else if (countdownTimeLeft <= 3 && countdownTimeLeft > 0) {
                    playTimerSound("C4", "16n");
                }
            }, 1000);
        }

        function startWorkTimer(durationSeconds, exerciseCardId) {
            currentWorkDuration = durationSeconds;
            clearInterval(workTimerInterval);
            startCountdownTimer('work', 5, () => { runWorkTimer(); });
        }

        function runWorkTimer() {
            workTimerEndTime = Date.now() + currentWorkDuration * 1000;
            updateWorkTimerDisplay(currentWorkDuration);
            openModal(workTimerModal);
            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(workTimerInterval);
                    closeWorkTimerModal(false);
                    playTimerSound("A5", "8n");
                } else {
                    updateWorkTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function updateWorkTimerDisplay(timeLeft) {
            const seconds = timeLeft % 60;
            const minutes = Math.floor(timeLeft / 60);
            workTimerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function closeWorkTimerModal(skipped = false) { 
            clearInterval(workTimerInterval); 
            closeModalElement(workTimerModal); 
            if (skipped && currentTimedExerciseCardId !== null) {
                finalizeTimedExerciseSequence();
                showCustomAlert("Ejercicio basado en tiempo finalizado antes de tiempo.", "warning");
            }
        }

        function handleTimeBasedRepsClick(inputElement, cardId) {
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para usar el cronómetro.", "warning");
                return;
            }
            const card = document.getElementById(cardId);
            if (!card) return;
            if (currentTimedExerciseCardId === cardId && workTimerInterval !== null) {
                showCustomAlert("El cronómetro para este ejercicio ya está activo.", "info");
                return;
            }
            if (currentTimedExerciseCardId !== null && currentTimedExerciseCardId !== cardId && workTimerInterval !== null) {
                 showCustomAlert("Ya hay un cronómetro de ejercicio activo. Finalízalo antes de empezar otro.", "warning");
                 return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const workDuration = parseDurationToSeconds(exerciseData.reps);
            const totalSets = parseInt(card.dataset.totalSets, 10);
            const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
            currentRestDurationForTimedExercise = restDurationMatch ? parseInt(restDurationMatch[1], 10) : 0;
            if (workDuration <= 0) {
                showCustomAlert("Duración de trabajo no válida para el ejercicio basado en tiempo.", "error");
                return;
            }
            currentTimedExerciseCardId = cardId;
            currentTimedExerciseSetNumber = 1;
            totalSetsForCurrentTimedExercise = totalSets;
            timedExerciseSetsLogged = [];
            const registerBtn = card.querySelector('.quick-view-body .quick-mode-register-button');
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<i class="fas fa-hourglass-half text-xl"></i>';
            }
            startCountdownTimer('work', 5);
        }

        function runWorkTimerForTimedExercise(durationSeconds) {
            clearInterval(workTimerInterval);
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found for work timer.");
                finalizeTimedExerciseSequence();
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            workTimerEndTime = Date.now() + durationSeconds * 1000;
            
            workTimerTitle.textContent = 'TIEMPO DE TRABAJO';
            workOverallProgress.textContent = `Serie ${currentTimedExerciseSetNumber} de ${totalSetsForCurrentTimedExercise}`;
            workStateLabel.textContent = 'TRABAJO';
            workStateLabel.className = 'state-label work';
            workExerciseName.textContent = exerciseData.name;
            workExerciseDetails.textContent = `Objetivo: ${exerciseData.reps}`;
            if (workCurrentImage && exerciseData.imageUrl) {
                workCurrentImage.src = exerciseData.imageUrl;
                workCurrentImage.style.display = 'block';
            } else if (workCurrentImage) {
                workCurrentImage.style.display = 'none';
                workCurrentImage.src = '';
            }

            updateWorkTimerDisplay(durationSeconds);
            openModal(workTimerModal);

            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(workTimerInterval);
                    closeWorkTimerModal(false);
                    playTimerSound("A5", "8n");
                    timedExerciseSetsLogged.push({
                        serie: currentTimedExerciseSetNumber,
                        kg: 'N/A',
                        reps: exerciseData.reps,
                        isQuickMode: true,
                        completionState: 'good'
                    });
                    if (currentTimedExerciseSetNumber < totalSetsForCurrentTimedExercise) {
                        currentTimedExerciseSetNumber++;
                        startRestTimerForTimedExercise();
                    } else {
                        finalizeTimedExerciseSequence();
                    }
                } else {
                    updateWorkTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function startRestTimerForTimedExercise() {
            clearInterval(restTimerInterval);
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found for rest timer.");
                finalizeTimedExerciseSequence();
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            let nextExerciseForRest = null;
            if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) {
                nextExerciseForRest = {
                    type: 'nextSet',
                    name: card.dataset.currentName,
                    reps: exerciseData.reps,
                    kg: 'N/A',
                    setNumber: currentTimedExerciseSetNumber,
                    totalSets: totalSetsForCurrentTimedExercise,
                    imageUrl: exerciseData.imageUrl
                };
            } else {
                const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                const currentCardElement = document.getElementById(currentTimedExerciseCardId);
                const currentCardIndex = allExerciseCards.findIndex(el => el.id === currentTimedExerciseCardId || el.contains(currentCardElement));
                if (currentCardIndex !== -1) {
                    let nextCard = null;
                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) {
                            nextCard = allExerciseCards[i];
                            break;
                        } else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) {
                            const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item');
                            if (firstSubExercise) {
                                nextCard = firstSubExercise;
                                break;
                            }
                        }
                    }
                    if (nextCard) {
                        const nextExerciseData = JSON.parse(nextCard.dataset.originalExerciseData || '{}');
                        nextExerciseForRest = {
                            type: 'nextExercise',
                            name: nextCard.dataset.currentName,
                            reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                            kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--',
                            imageUrl: nextExerciseData.imageUrl
                        };
                    }
                }
            }
            currentRestDuration = currentRestDurationForTimedExercise;
            restTimerEndTime = Date.now() + currentRestDuration * 1000;
            restTimerTitle.textContent = `DESCANSO - Serie ${currentTimedExerciseSetNumber - 1} de ${totalSetsForCurrentTimedExercise} completada`;
            restStateLabel.textContent = 'DESCANSO';
            restStateLabel.className = 'state-label rest';
            
            if (nextExerciseForRest) {
                restExerciseName.textContent = `Siguiente: ${nextExerciseForRest.name || ''}`;
                restExerciseDetails.textContent = `Objetivo: ${nextExerciseForRest.reps || ''} con ${nextExerciseForRest.kg || '--'} Kg`;
                if(nextExerciseForRest.imageUrl && restCurrentImage) {
                    restCurrentImage.src = nextExerciseForRest.imageUrl;
                    restCurrentImage.style.display = 'block';
                }
            } else {
                restExerciseName.textContent = 'Entrenamiento casi terminado';
                restExerciseDetails.textContent = '';
                if(restCurrentImage) {
                    restCurrentImage.style.display = 'none';
                    restCurrentImage.src = '';
                }
            }
            
            minimizedRestTimer.classList.remove('is-active');
            openModal(restTimerModal);
            playTimerSound("C5", "16n");
            restTimerInterval = setInterval(() => {
                const timeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(restTimerInterval);
                    closeRestTimerModal(false);
                    playTimerSound("A5", "8n");
                     if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) {
                        const workDuration = parseDurationToSeconds(exerciseData.reps);
                        startCountdownTimer('work', 5);
                    } else {
                        finalizeTimedExerciseSequence();
                    }
                } else {
                    updateRestTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function finalizeTimedExerciseSequence() {
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found during finalization.");
                return;
            }
            const exerciseName = card.dataset.currentName;
            const logEntry = {
                exerciseName,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                rawDate: new Date().toISOString(),
                dayKey: card.dataset.dayKey,
                setsPerformed: timedExerciseSetsLogged,
                completionState: 'good'
            };
            const existingEntryIndex = currentWorkoutSummaryData.findIndex(e => e.exerciseName === exerciseName);
            if (existingEntryIndex > -1) {
                currentWorkoutSummaryData[existingEntryIndex] = logEntry;
            } else {
                currentWorkoutSummaryData.push(logEntry);
            }
            card.dataset.completionState = 'good';
            updateAllExerciseCardInputStates();
            showCustomAlert(`¡Ejercicio "${exerciseName}" completado!`, "info");
            currentTimedExerciseCardId = null;
            currentTimedExerciseSetNumber = 0;
            totalSetsForCurrentTimedExercise = 0;
            currentRestDurationForTimedExercise = 0;
            timedExerciseSetsLogged = [];
        }

        function setupExtrasForm() {
            extraActivitySelect.value = 'Pádel';
            otherActivityInputGroup.style.display = 'none';
            otherActivityNameInput.value = '';
            extraTimeInput.value = '';
            extraVolumeInput.value = '';
            extraCaptureInput.value = '';
            extraCaptureFileName.textContent = 'Ningún archivo seleccionado';
            uploadedCaptureFile = null;

            extraActivitySelect.onchange = () => {
                if (extraActivitySelect.value === 'Otros') {
                    otherActivityInputGroup.style.display = 'block';
                } else {
                    otherActivityInputGroup.style.display = 'none';
                }
            };

            extraCaptureInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    extraCaptureFileName.textContent = file.name;
                    uploadedCaptureFile = file;
                } else {
                    extraCaptureFileName.textContent = 'Ningún archivo seleccionado';
                    uploadedCaptureFile = null;
                }
            };
            
            registerExtraActivityButton.onclick = () => {
                const activityName = extraActivitySelect.value === 'Otros' ? otherActivityNameInput.value.trim() : extraActivitySelect.value;
                if (activityName === '') {
                    showCustomAlert("Por favor, introduce el nombre de la actividad.", "warning");
                    return;
                }
                registerExtraActivity(activityName, extraTimeInput.value.trim(), extraVolumeInput.value.trim(), uploadedCaptureFile);
            };
        }

        async function registerExtraActivity(activityName, time, volume, captureFile) {
            if (!supabase || !userIdentifier) {
                showCustomAlert("No se pudo registrar la actividad. Usuario no identificado.", "error");
                return;
            }
            
            closeModalElement(extrasModal);
            showCustomAlert(`Registrando "${activityName}"...`, "info");
            
            let captureUrl = null;
            if (captureFile) {
                try {
                    const filePath = `extra_captures/${userIdentifier}/${Date.now()}_${captureFile.name}`;
                    const { data, error } = await supabase.storage
                        .from('workout-captures')
                        .upload(filePath, captureFile, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        throw new Error(`Error uploading image: ${error.message}`);
                    }
                    
                    const publicUrl = supabase.storage
                        .from('workout-captures')
                        .getPublicUrl(filePath).data.publicUrl;
                    captureUrl = publicUrl;
                } catch (error) {
                    console.error("Error al subir la imagen:", error);
                    showCustomAlert(`Error al subir la imagen: ${error.message}`, "error");
                }
            }
            
            const [hoursStr = '0', minutesStr = '0'] = time.split(':');
            const totalTimeInSeconds = (parseInt(hoursStr) * 3600) + (parseInt(minutesStr) * 60);

            const logEntry = {
                client_id: userIdentifier,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                raw_date: new Date().toISOString(),
                exercise_name: "Extra Activity",
                name_workout: activityName,
                sets_performed: '[]',
                completion_state: "completed",
                session_id: crypto.randomUUID(),
                total_time_session: formatTimeHHMM(totalTimeInSeconds) || null,
                total_volume_session: volume || null,
                capture_url: captureUrl
            };
            
            try {
                const { error } = await supabase
                    .from('workout_logs')
                    .insert([logEntry]);
                
                if (error) {
                    throw new Error(`Error inserting extra activity log: ${error.message}`);
                }
                
                showCustomAlert(`Actividad "${activityName}" registrada con éxito.`, "info");
                await loadWorkoutLogs();
                renderCalendar();
            } catch (error) {
                console.error("Error al registrar la actividad extra:", error);
                showCustomAlert(`Error al registrar la actividad: ${error.message}`, "error");
            }
        }

        async function initializeWorkoutApp() {
            try {
                const workoutDataUrl = `https://raw.githubusercontent.com/hombresenforma/ivan-data/main/${userIdentifier || 'default-user'}.js?v=${Date.now()}`;
                console.log(`Fetching workout data from: ${workoutDataUrl}`);

                const mainResponse = await fetch(workoutDataUrl);
                if (!mainResponse.ok) {
                    throw new Error(`Network response for workout data was not ok: ${mainResponse.statusText} (URL: ${workoutDataUrl})`);
                }
                const mainDataText = await mainResponse.text();
                
                const workoutDataRegex = /const workoutData = ({[\s\S]*?});/;
                const workoutDataMatch = mainDataText.match(workoutDataRegex);
                if (!workoutDataMatch) throw new Error("Could not find 'workoutData' object in the main source file.");
                workoutData = new Function(`return ${workoutDataMatch[1]}`)();

                const alternativesRegex = /const exerciseAlternatives = ({[\s\S]*?});/;
                const alternativesMatch = mainDataText.match(alternativesRegex);
                if (!alternativesMatch) throw new Error("Could not find 'exerciseAlternatives' object in the main source file.");
                exerciseAlternatives = new Function(`return ${alternativesMatch[1]}`)();
                
                await loadWorkoutLogs();
                setupDaySelectionTabs();
                await fetchVideoConfigFromSupabase();
                await loadRealtimeProgress();

            } catch (error) {
                console.error("Error initializing workout app:", error);
                const previewContainer = document.getElementById('workoutPreviewContainer');
                if (previewContainer) {
                    previewContainer.innerHTML = `<p class="text-center text-red-500 font-semibold">Error al cargar la rutina. Asegúrate de que el usuario en la URL ('${userIdentifier}') es correcto y tiene un plan asignado.</p>`;
                }
            }
        }
        
        async function fetchVideoConfigFromSupabase() {
            if (!supabase || !userIdentifier) {
                console.warn("Supabase client or user identifier not available. Cannot fetch video config.");
                setupVideoCorrectionsButton();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_configs')
                    .select('exercises_data')
                    .eq('client_id', userIdentifier)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error("Error fetching video config from Supabase:", error);
                    showCustomAlert("Error al cargar la configuración de correcciones de vídeo.", "error");
                }
                
                if (data && data.exercises_data && data.exercises_data.activeWeeks) {
                    VIDEO_PROMPT_CONFIG.activeWeeks = data.exercises_data.activeWeeks;
                    console.log(`Video activeWeeks configured from Supabase to: "${VIDEO_PROMPT_CONFIG.activeWeeks}"`);
                } else {
                    console.log('No video config found in Supabase for this user. Using default \'none\'.');
                    VIDEO_PROMPT_CONFIG.activeWeeks = 'none';
                }

            } catch (e) {
                console.error("Unexpected error fetching video config:", e);
                showCustomAlert("Error inesperado al cargar la configuración de vídeo.", "error");
            }

            setupVideoCorrectionsButton();
        }

        function setupVideoCorrectionsButton() {
            const videoCorrectionsButton = document.getElementById('videoCorrectionsButton');
            if (!videoCorrectionsButton) return;

            const currentWeek = getWeekNumber(new Date());
            const config = VIDEO_PROMPT_CONFIG.activeWeeks;
            let isFeatureActive = false;

            if (config === 'all') {
                isFeatureActive = true;
            } else if (config === 'none') {
                isFeatureActive = false;
            } else if (config === 'even') {
                isFeatureActive = currentWeek % 2 === 0;
            } else if (config === 'odd') {
                isFeatureActive = currentWeek % 2 !== 0;
            } else if (Array.isArray(config)) {
                isFeatureActive = config.includes(currentWeek);
            }

            if (isFeatureActive) {
                                videoCorrectionsButton.classList.remove('button-disabled');
                videoCorrectionsButton.addEventListener('click', () => {
                    window.open(APP_CONFIG.urls.videoUploadUrl, '_blank');
                });
            } else {
                videoCorrectionsButton.classList.add('button-disabled');
                videoCorrectionsButton.addEventListener('click', () => {
                    openModal(document.getElementById('weekdayNoticeModal'));
                });
            }
        }

        async function loadWorkoutLogs() {
            if (!supabase || !userIdentifier) {
                console.warn("Supabase client or user identifier not available. Cannot load workout logs.");
                individualExerciseLogs = [];
                workoutSessionSummaries = [];
                extraActivities = [];
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('workout_logs')
                    .select('*')
                   .eq('client_id', userIdentifier)
                    .order('raw_date', { ascending: false });
                if (error) {
                    console.error("Error loading workout logs from Supabase:", error);
                    showCustomAlert("No se pudo cargar el historial de entrenamientos.", "error");
                    individualExerciseLogs = [];
                    workoutSessionSummaries = [];
                    extraActivities = [];
                    return;
                }
                individualExerciseLogs = data.filter(log => log.exercise_name !== "Workout Session Summary" && log.exercise_name !== "Extra Activity");
                workoutSessionSummaries = data.filter(log => log.exercise_name === "Workout Session Summary");
                extraActivities = data.filter(log => log.exercise_name === "Extra Activity");
                allHistoryItems = [...workoutSessionSummaries, ...extraActivities];
                groupHistoryByDay();
                console.log("Individual Exercise Logs loaded:", individualExerciseLogs);
                console.log("Workout Session Summaries loaded:", workoutSessionSummaries);
                console.log("Extra Activities loaded:", extraActivities);
            } catch (e) {
                console.error("Error inesperado al cargar el historial de entrenamientos.", "error");
                individualExerciseLogs = [];
                workoutSessionSummaries = [];
                extraActivities = [];
            }
        }
        
        function groupHistoryByDay() {
            groupedHistory = allHistoryItems.reduce((acc, item) => {
                const date = new Date(item.raw_date).toISOString().slice(0, 10);
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(item);
                return acc;
            }, {});
        }

        function openFullWorkoutLogModal(sessionId) {
            closeModalElement(mainHistoryModal);
            fullWorkoutLogContent.innerHTML = '';
            const sessionSummaryEntry = workoutSessionSummaries.find(s => s.session_id === sessionId);
            if (!sessionSummaryEntry) {
                fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se encontraron detalles para este entrenamiento.</p>';
                openModal(fullWorkoutLogModal);
                return;
            }
            fullWorkoutLogTitle.textContent = `Entrenamiento del ${sessionSummaryEntry.date} a las ${sessionSummaryEntry.time}`;
            let exercisesInSession = [];
            try {
                exercisesInSession = JSON.parse(sessionSummaryEntry.sets_performed); 
            } catch (e) {
                console.error("Error parsing exercises_performed for session summary:", e);
                fullWorkoutLogContent.innerHTML = '<p class="text-red-400 text-center">Error al cargar los detalles del entrenamiento.</p>';
                openModal(fullWorkoutLogModal);
                return;
            }
            if (exercisesInSession.length === 0) {
                fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios en esta sesión.</p>';
            } else {
                exercisesInSession.forEach(exerciseEntry => {
                    const isNewPR = exerciseEntry.personalRecord !== null && exerciseEntry.personalRecord !== undefined;
                    const prIcon = isNewPR ? `<i class="fas fa-trophy pr-icon ml-2" title="¡Nuevo Récord Personal! (${exerciseEntry.personalRecord} kg)"></i>` : '';
                    const escapedExerciseName = exerciseEntry.exerciseName.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    const exerciseHtml = document.createElement('div');
                    exerciseHtml.className = 'workout-log-entry';
                    exerciseHtml.innerHTML = `
                        <h4 onclick="viewExerciseHistoryFromLog('${escapedExerciseName}')" style="cursor: pointer;" title="Ver historial de este ejercicio">${exerciseEntry.exerciseName}${prIcon}</h4>
                        <ul>
                            ${exerciseEntry.setsPerformed.map(set => {
                                const completionClass = set.completionState === 'good' ? 'history-reps-good' : (set.completionState === 'bad' ? 'history-reps-bad' : '');
                                const repsUnit = isTimeBased(set.reps) ? 's' : 'reps';
                                                                return `<li>S.${set.serie}: ${set.kg || 0}kg x <span class="${completionClass}">${set.reps || 0} ${repsUnit}</span></li>`;
                            }).join('')}
                        </ul>
                    `;
                    fullWorkoutLogContent.appendChild(exerciseHtml);
                });
            }
            openModal(fullWorkoutLogModal);
        }

        function setupDaySelectionTabs() { 
            daySelectionTabsContainer.innerHTML = ''; 
            if (typeof workoutData === 'undefined') { 
                return; 
            } 
            const dayKeys = Object.keys(workoutData); 
            dayKeys.forEach((dayKey) => { 
                const tab = document.createElement('button'); 
                tab.className = 'day-tab'; 
                tab.textContent = workoutData[dayKey].name.split(':')[0].trim(); 
                tab.dataset.dayKey = dayKey; 
                tab.onclick = () => displayWorkoutPreview(dayKey); 
                daySelectionTabsContainer.appendChild(tab); 
            }); 
            if (dayKeys[0]) { 
                displayWorkoutPreview(dayKeys[0]); 
            } 
        }
        
        function displayWorkoutPreview(dayKey) {
            if (isWorkoutInProgress && dayKey !== currentActiveDayKey) {
                showInProgressWarningModal();
                return;
            }

            currentActiveDayKey = dayKey;
            if (typeof workoutData === 'undefined' || !workoutData[dayKey]) {
                return;
            }
            const dayData = workoutData[dayKey];
            
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active', 'active-resume');
                if (tab.dataset.dayKey === dayKey) {
                    if (isWorkoutInProgress) {
                        tab.classList.add('active-resume');
                    } else {
                        tab.classList.add('active');
                    }
                }
            });

            let previewHtml = `<h3>${dayData.name.toUpperCase()}</h3><ul>`;
            dayData.exercises.forEach(ex => {
                let titleText = '';
                if (ex.isEMOM) { titleText = 'EMOM'; } 
                else if (ex.circuitDetails) { titleText = 'CIRCUITO'; } 
                else if (ex.isSuperset) { titleText = 'SUPERSERIE'; } 
                else { titleText = ex.name; }
                previewHtml += `<li>${ex.order}. ${titleText.toUpperCase()}</li>`;
                if (ex.items && Array.isArray(ex.items)) {
                    ex.items.forEach(sub => { previewHtml += `<li style="padding-left: 1.5rem;">${ex.order}.${sub.subOrder}. ${sub.name}</li>`; });
                }
            });
            previewHtml += `</ul><button onclick="promptWorkoutMode('${dayKey}')" class="start-workout-preview-button"><i class="fas fa-play mr-2"></i>Empezar Entrenamiento</button>`;
            workoutPreviewContainer.innerHTML = previewHtml;
        }

        function updateUIAfterResume() {
            if (!currentActiveDayKey) return;

            displayWorkoutPreview(currentActiveDayKey);

            setTimeout(() => {
                const previewContainer = document.getElementById('workoutPreviewContainer');
                const startButton = previewContainer.querySelector('.start-workout-preview-button');

                if (startButton) {
                    startButton.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Continuar Entrenamiento';
                    startButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    startButton.onclick = () => promptWorkoutMode(currentActiveDayKey, true);
                }
                
                showCustomAlert("¡Tienes un entrenamiento en curso! Continúa donde lo dejaste.", "info");
            }, 100);
        }

        function startQuickMode(dayKey, isResuming = false) {
            if (isWorkoutInProgress && !isResuming) {
                showCustomAlert("Ya hay un entrenamiento en curso. Por favor, termínalo antes de empezar uno nuevo.", "warning");
                return;
            }
            
            if (!isResuming) {
                toggleWorkoutState();
            } else {
                isWorkoutInProgress = true;
                updateWorkoutDuration();
                workoutTimerInterval = setInterval(updateWorkoutDuration, 1000);
                requestWakeLock();
            }
            
            const dayData = workoutData[dayKey];
            quickModeWorkoutModalTitle.textContent = dayData.name;
            quickModeExerciseList.innerHTML = '';
            
            dayData.exercises.forEach(exercise => {
                if (exercise.isSuperset || exercise.isEMOM || exercise.circuitDetails) {
                    quickModeExerciseList.appendChild(createQuickModeSupersetCard(dayKey, exercise.order, exercise));
                } else {
                    quickModeExerciseList.appendChild(createQuickModeExerciseCard(dayKey, exercise.order, exercise, false));
                }
            });

            if(isResuming) {
                currentWorkoutSummaryData.forEach(entry => {
                    const card = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item')).find(c => c.dataset.currentName === entry.exerciseName);
                    if (card) {
                        exerciseProgressMap.set(card.id, entry.setsPerformed.length);
                    }
                });
            }

            updateAllExerciseCardInputStates();
            openModal(quickModeWorkoutModal);
        }
        
        function toggleSettingsMenu(button, cardId) {
            const menu = document.getElementById(`settingsMenu-${cardId}`);
            button.classList.toggle('active');
            if (menu.classList.contains('is-active')) {
                menu.classList.remove('is-active');
            } else {
                document.querySelectorAll('.quick-mode-header-buttons').forEach(m => m.classList.remove('is-active'));
                document.querySelectorAll('.quick-mode-settings-button').forEach(b => b.classList.remove('active'));
                menu.classList.add('is-active');
            }
        }

        function showInProgressWarningModal() {
            openModal(document.getElementById('inProgressWarningModal'));
        }

        function goToCurrentWorkout() {
            closeModalElement(document.getElementById('inProgressWarningModal'));
            if (currentActiveDayKey) {
                if (isSimpleModeActive) {
                    startSimpleMode(currentActiveDayKey, true);
                }
                // No 'else' needed, as Simple Mode is the only mode.
            }
        }

        function promptWorkoutMode(dayKey, isResuming = false) {
            currentWorkoutDayKeyForPrompt = dayKey;
            // No more modal, just start Simple Mode directly.
            startSimpleMode(currentWorkoutDayKeyForPrompt, isResuming);
        }

        function startSimpleMode(dayKey, isResuming = false) {
            if (isWorkoutInProgress && !isResuming) {
                showCustomAlert("Ya hay un entrenamiento en curso.", "warning");
                return;
            }

            if (!isResuming) {
                toggleWorkoutState();
            } else {
                isWorkoutInProgress = true;
                updateWorkoutDuration();
                workoutTimerInterval = setInterval(updateWorkoutDuration, 1000);
                requestWakeLock();
            }

            isSimpleModeActive = true;
            const dayData = workoutData[dayKey];
            document.getElementById('simpleModeWorkoutModalTitle').textContent = dayData.name;
            simpleModeExercises = dayData.exercises;
            
            if (isResuming) {
                // 1. Popular el exerciseProgressMap desde los datos cargados
                exerciseProgressMap.clear(); 
                currentWorkoutSummaryData.forEach(entry => {
                    let cardId = null;
                    for (const ex of simpleModeExercises) {
                        if (ex.items) {
                            const subEx = ex.items.find(item => item.name === entry.exerciseName);
                            if (subEx) {
                                cardId = `qm-ex-${dayKey}-${subEx.order}-${subEx.subOrder}`;
                                break;
                            }
                        } else if (ex.name === entry.exerciseName) {
                            cardId = `qm-ex-${dayKey}-${ex.order}`;
                            break;
                        }
                    }
                    if (cardId) {
                        exerciseProgressMap.set(cardId, entry.setsPerformed.length);
                    }
                });

                // 2. Encontrar el índice correcto para reanudar
                let resumeIndex = 0;
                for (let i = 0; i < simpleModeExercises.length; i++) {
                    const ex = simpleModeExercises[i];
                    const exercisesToCheck = ex.items ? ex.items : [ex];
                    let allSubItemsCompleted = true;

                    // Determinar specialData para sets (lógica duplicada de createQuickModeSupersetCard)
                    let specialData = null;
                    if (ex.isEMOM && ex.emomDetails && ex.items) {
                        const exerciseCount = ex.items.length;
                        const totalIntervals = parseInt(ex.emomDetails.totalIntervals, 10);
                        if (exerciseCount > 0 && totalIntervals > 0) {
                            specialData = { series: Math.ceil(totalIntervals / exerciseCount) };
                        }
                    } else if (ex.circuitDetails) {
                        specialData = { series: ex.circuitDetails.totalRounds };
                    }

                    for (const subEx of exercisesToCheck) {
                        const subCardId = ex.items ? `qm-ex-${dayKey}-${subEx.order}-${subEx.subOrder}` : `qm-ex-${dayKey}-${subEx.order}`;
                        // Lógica de createQuickModeExerciseCard para totalSets
                        const totalSets = specialData ? specialData.series : (subEx.sets || 1); 
                        const loggedSets = exerciseProgressMap.get(subCardId) || 0;
                        
                        if (loggedSets < totalSets) {
                            allSubItemsCompleted = false;
                            break;
                        }
                    }
                    
                    if (!allSubItemsCompleted) {
                        resumeIndex = i;
                        break;
                    }
                }
                currentSimpleModeIndex = resumeIndex;

            } else {
                currentSimpleModeIndex = 0;
                exerciseProgressMap.clear(); // Limpiar mapa para un nuevo entreno
            }

            renderSimpleModeExercise(currentSimpleModeIndex);
            openModal(document.getElementById('simpleModeWorkoutModal'));
        }

        // La función startQuickMode() ha sido eliminada.

        function renderSimpleModeExercise(index) {
            const container = document.getElementById('simpleModeExerciseContainer');
            const progressEl = document.getElementById('simpleModeProgress');
            const prevButton = document.getElementById('simpleModePrevButton');
            const nextButton = document.getElementById('simpleModeNextButton');

            container.innerHTML = ''; // Limpiar tarjeta anterior

            if (!simpleModeExercises || index < 0 || index >= simpleModeExercises.length) {
                container.innerHTML = '<p class="text-center text-red-500">Error: Ejercicio no encontrado.</p>';
                if (prevButton) {
                    prevButton.disabled = true;
                    prevButton.classList.add('button-disabled');
                }
                if (nextButton) {
                    nextButton.disabled = true;
                    nextButton.classList.add('button-disabled');
                }
                return;
            }

            currentSimpleModeIndex = index;
            const exercise = simpleModeExercises[index];
            const dayKey = currentActiveDayKey;

            let card;
            if (exercise.isSuperset || exercise.isEMOM || exercise.circuitDetails) {
                card = createQuickModeSupersetCard(dayKey, exercise.order, exercise);
            } else {
                card = createQuickModeExerciseCard(dayKey, exercise.order, exercise, false);
            }
            
            if (card) {
                container.appendChild(card);
            } else {
                console.error("No se pudo crear la tarjeta para el ejercicio:", exercise);
                container.innerHTML = '<p class="text-center text-red-500">Error al crear la tarjeta del ejercicio.</p>';
            }
            
            // Actualizar texto de progreso
            if (progressEl) {
                progressEl.textContent = `Ejercicio ${index + 1} de ${simpleModeExercises.length}`;
            }

            // Actualizar botones de navegación
            if (prevButton) {
                prevButton.disabled = (index === 0);
                prevButton.classList.toggle('button-disabled', prevButton.disabled);
            }
            if (nextButton) {
                nextButton.disabled = (index === simpleModeExercises.length - 1);
                nextButton.classList.toggle('button-disabled', nextButton.disabled);
            }

            // Actualizar el estado de la tarjeta (para progreso, etc.)
            updateAllExerciseCardInputStates();
        }

        function navigateSimpleMode(direction) {
            const newIndex = currentSimpleModeIndex + direction;
            if (newIndex >= 0 && newIndex < simpleModeExercises.length) {
                renderSimpleModeExercise(newIndex);
            }
        }

        // ---===[ INICIALIZACIÓN DE LA APP ]===---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded. Initializing app...");

            // 1. Setup Supabase Client
            try {
                const { createClient } = window.supabase;
                const SUPABASE_URL = 'https://izocmtacvdforxywfxgr.supabase.co';
                // La API key (SUPABASE_API_KEY) ya está definida en el script
                supabase = createClient(SUPABASE_URL, SUPABASE_API_KEY);
                console.log("Supabase client initialized.");
            } catch (e) {
                console.error("Failed to initialize Supabase client:", e);
                document.body.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">Error fatal: No se pudo inicializar la base de datos.</div>';
                return;
            }

            // 2. Get User Identifier from URL (El paso que faltaba)
            try {
                const urlParams = new URLSearchParams(window.location.search);
                userIdentifier = urlParams.get('user'); 
                
                if (!userIdentifier) {
                    console.warn("No 'user' parameter in URL. Using 'default-user'.");
                    userIdentifier = 'default-user'; // Fallback
                }

                console.log(`User Identifier set to: ${userIdentifier}`);
            } catch (e) {
                console.error("Failed to get user from URL:", e);
                userIdentifier = 'default-user'; // Fallback
            }

            // 3. Initialize the main application (La llamada que faltaba)
            initializeWorkoutApp();

            // 4. Setup other listeners (También faltaban)
            document.getElementById('viewWorkoutHistoryButton').onclick = () => {
                currentDate = new Date();
                renderCalendar();
                openModal(mainHistoryModal);
            };
            
            // Nota: El botón 'addExtrasButton' no existe en el HTML, pero si lo añades, esto funcionará.
            // const addExtrasBtn = document.getElementById('addExtrasButton');
            // if (addExtrasBtn) {
            //     addExtrasBtn.onclick = () => {
            //         setupExtrasForm();
            //         openModal(extrasModal);
            //     };
            // }

            // Listener for closing settings menus if clicking outside
            document.addEventListener('click', (event) => {
                // Close settings menus
                const activeMenu = document.querySelector('.quick-mode-header-buttons.is-active');
                const activeButton = document.querySelector('.quick-mode-settings-button.active');
                if (activeMenu && activeButton && !activeButton.contains(event.target) && !activeMenu.contains(event.target)) {
                    activeMenu.classList.remove('is-active');
                    activeButton.classList.remove('active');
                }

                // Close numeric keypad if clicking outside
                const keypadModal = document.getElementById('numericKeypadModal');
                if (isKeypadOpen && !keypadModal.querySelector('.modal-content').contains(event.target)) {
                    if (ignoreNextKeypadClose) {
                        ignoreNextKeypadClose = false;
                    } else {
                        closeModalElement(keypadModal);
                        isKeypadOpen = false;
                        activeInput = null;
                    }
                }
            });

            // Set main menu URL
            const mainMenuButton = document.getElementById('mainMenuButton');
            if (mainMenuButton) {
                mainMenuButton.href = `${APP_CONFIG.urls.mainPanelUrl}${userIdentifier || ''}`;
            }
        });

    </script>
</body>
</html>




