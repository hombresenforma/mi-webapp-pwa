<!DOCTYPE html>
<html lang="es">
<head>
    <!-- MODIFIED: Updated manifest and icon paths to include the repository name -->
    <link rel="manifest" href="/mi-webapp-pwa/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/mi-webapp-pwa/icons/icon-192x192.png">
    <meta charset="UTF-8">
    <!-- MODIFIED: Added user-scalable=no to prevent zoom on double-tap -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Entrenamiento - Programa Hombres en Forma</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for audio feedback in timers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Chart.js for historical data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for sharing feature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Supabase Client for database interaction -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Orbitron font for timers -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> 
    
    <style>
        /* General Body and Scrollbar Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821c6f4dbcf316861282241.png');
            background-color: #1A263A; /* Fallback color */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden; 
            color: #e5e7eb;
            /* MODIFIED: Added touch-action to prevent zoom on double-tap on mobile devices */
            touch-action: manipulation;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #4A5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #eab308; }

        /* Main App Container */
        .main-container {
            width: 100%;
            max-width: 36rem; /* Equivalent to max-w-md */
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 640px) { .main-container { max-width: 42rem; } } /* sm:max-w-lg */
        @media (min-width: 768px) { .main-container { max-width: 48rem; } } /* md:max-w-2xl */

        /* Tab Navigation (kept for consistency, though only one tab is active here) */
        .app-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2x2 Grid for mobile */
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .app-tab {
            position: relative;
            padding: 0.75rem 0.5rem; /* Adjusted padding for smaller screens */
            font-weight: 600;
            color: #d1d5db;
            background-color: rgba(31, 41, 55, 0.8);
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem; /* Slightly smaller font for mobile */
        }
        .app-tab:hover {
            background-color: rgba(55, 65, 81, 0.9);
            color: #facc15;
        }
        .app-tab.active {
            background-color: #facc15;
            color: #1f2937;
            border-color: #facc15;
        }
        /* NEW: Style for active notification tabs */
        .app-tab.app-tab-notify {
            background-color: #22c55e; /* Green color */
            color: #1f2937;
            border-color: #22c55e;
        }
        .app-tab.app-tab-notify:hover {
            background-color: #16a34a; /* Darker green on hover */
            border-color: #16a34a;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal, .modal-base { 
            transition: opacity 0.25s ease; 
        }
        .modal-content { 
            transition: transform 0.25s ease; 
            max-height: 90vh; 
        }
        #quickModeWorkoutModal .modal-content, #detailedHistoryModal .modal-content, #mainHistoryModal .modal-content, #fullWorkoutLogModal .modal-content { /* Added fullWorkoutLogModal */
            width: 95%;
            max-width: 700px; 
        }
        #workoutSummaryModal .modal-content, #warmupModal .modal-content, #extrasModal .modal-content {
            width: 95%;
            max-width: 450px;
        }

        /* --- WORKOUT SPECIFIC STYLES --- */
        .day-selection-container { display: flex; flex-direction: column; gap: 1rem; }
        .day-tab-bar { display: flex; flex-direction: column; gap: 0.5rem; }
        .day-tab { padding: 0.75rem 1rem; color: #d1d5db; font-weight: 500; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; text-align: center; background-color: rgba(31, 41, 55, 0.8); border: 1px solid #4b5563; }
        .day-tab:hover { background-color: rgba(55, 65, 81, 0.9); color: #facc15; }
        .day-tab.active { background-color: #facc15; color: #1f2937; font-weight: 600; border-color: #facc15; }
        .workout-preview-container { background-color: rgba(55, 65, 81, 0.7); border-radius: 0.5rem; padding: 1rem; border: 1px solid rgba(250, 204, 21, 0.3); min-height: 200px; display: flex; flex-direction: column; justify-content: space-between; }
        .workout-preview-container h3 { color: #fde047; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .workout-preview-container ul { list-style: none; padding-left: 0; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; flex-grow: 1; }
        .workout-preview-container li { color: #d1d5db; padding: 0.2rem 0; font-size: 0.85rem; }
        .start-workout-preview-button { background-color: #facc15; color: #1f2937; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out; margin-top: auto; font-size: 0.95rem; }
        .start-workout-preview-button:hover { background-color: #eab308; }
        .main-action-button { background-color: #4A5568; color: #facc15; border: 1px solid #facc15; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; text-align: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; margin-top: 1rem; font-size: 0.95rem; }
        .main-action-button:hover:not(:disabled) { background-color: #facc15; color: #1f2937; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .exercise-card-container, .quick-mode-superset-container { border-left: 4px solid #facc15; background-color: rgba(42, 50, 62, 0.8); backdrop-filter: blur(5px); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 0.75rem; margin-bottom: 1rem; }
        .exercise-card-container-title, .quick-mode-superset-container .superset-title { font-size: 1rem; font-weight: 600; color: #fde047; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #4b5563; }
        .set-input input[readonly], .action-button:disabled, .quick-mode-register-button:disabled { background-color: #4A5568 !important; border-color: #718096 !important; color: #a0aec0 !important; cursor: not-allowed; }
        input::placeholder { color: #718096; opacity: 1; }
        .history-entry { border-bottom: 1px solid #4A5568; }
        .history-entry:last-child { border-bottom: none; }
        .history-reps-good { color: #4ade80; font-weight: bold; }
        .history-reps-bad { color: #f87171; font-weight: bold; }
        .main-history-item { background-color: #4a5568; color: #e5e7eb; padding: 0.75rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; width: 100%; margin-bottom: 0.5rem; text-align: left; cursor: pointer; }
        .main-history-item:hover { background-color: #5a6578; }
        .quick-mode-exercise-item { background-color: rgba(55, 65, 81, 0.8); border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #facc15; box-shadow: 0 2px 4px rgba(0,0,0,0.2); padding: 0.75rem; transition: border-left-color 0.3s ease; }
        .quick-mode-exercise-item.completed-good { border-left-color: #22c55e; background-color: rgba(34, 197, 94, 0.2); }
        .quick-mode-exercise-item.completed-bad { border-left-color: #ef4444; background-color: rgba(239, 68, 68, 0.2); }
        .quick-mode-superset-container .quick-mode-exercise-item { border-left: none; padding-left: 0.5rem; margin-left: -0.5rem; }
        
        /* MODIFIED: quick-mode-exercise-header for new layout */
        .quick-mode-exercise-header { 
            display: flex; 
            flex-direction: column; /* Stack elements vertically */
            gap: 0.75rem; /* Space between image/info block and buttons */
            margin-bottom: 0.75rem; /* Space below header */
        }
        /* Container for image and main text/settings */
        .quick-mode-exercise-header .flex-top-row {
            display: flex;
            align-items: center; /* Align items to the center */
            gap: 0.75rem; /* Space between image and text/settings */
            width: 100%;
        }
        /* Container for text and settings */
        .quick-mode-exercise-header .info-and-settings {
            flex-grow: 1;
            min-width: 0; /* Allow content to shrink */
            display: flex;
            flex-direction: column; /* Stack info and settings vertically if needed, but flex-wrap will keep them horizontal */
        }
        /* Flex for name/increase indicator and settings button */
        .quick-mode-exercise-header .info-line-with-settings {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align name/settings to top */
            width: 100%;
            gap: 0.5rem; /* Space between info and settings button */
        }

        .quick-mode-exercise-header .info { flex-grow: 1; min-width: 0; }
        .quick-mode-exercise-header .info .title-line { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .quick-mode-exercise-header .info strong { color: #fde047; font-weight: 600; font-size: 1rem; line-height: 1.3; }
        .quick-mode-exercise-header .info span { color: #d1d5db; font-size: 0.75rem; display: block; }

        /* MODIFIED: Buttons are now below inputs, centered */
        .quick-mode-header-buttons {
            display: flex;
            justify-content: center; /* Align to the center */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            width: 100%;
            gap: 0.75rem; /* Increased gap slightly */
            margin-top: 0.75rem; /* Add space above the buttons */
        }
        .quick-mode-header-buttons .quick-action-btn {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid #4b5563;
            color: #facc15;
            cursor: pointer;
            width: 2.75rem; /* Slightly wider */
            height: 2.75rem; /* Slightly taller */
            font-size: 1.1rem; /* Bigger icon */
            border-radius: 0.375rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }
        .quick-mode-header-buttons .quick-action-btn:hover:not(:disabled) {
            color: #eab308; background-color: #4b5563;
        }
        .quick-mode-header-buttons .quick-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .increase-weight-btn { background: #facc15; border-color: #facc15; width: 2rem; height: 2rem; font-size: 0.9rem; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center; }
        .quick-mode-exercise-body { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 0.5rem; align-items: center; }
        .quick-mode-input { width: 100%; background-color: #1f2937; border: 1px solid #4b5563; color: white; border-radius: 0.375rem; padding: 0.5rem; text-align: center; font-size: 0.9rem; }
        .quick-mode-register-button { width: 100%; height: 100%; background-color: #facc15; color: #1f2937; font-weight: bold; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .quick-mode-register-button i { font-size: 1.1rem; }
        .quick-mode-register-button:hover:not(:disabled) { background-color: #eab308; }
        .timer-modal .modal-content { background-color: #1f2937; border: 2px solid #facc15; }
        .timer-modal h3 { color: #facc15; }
        .timer-modal .timer-display { font-family: 'Orbitron', sans-serif; color: #ffffff; }
        .timer-modal .timer-actions { display: flex; gap: 1rem; justify-content: center; }
        .timer-modal .timer-action-button { flex-grow: 1; }
        .set-data-row { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 0.5rem; }
        .set-data-row > span { flex-basis: auto; margin-right: 0.75rem; white-space: nowrap; }
        .set-data-row .set-input { display: flex; gap: 0.5rem; flex-grow: 1; }
        #newRecordModal .modal-content { position: relative; background: linear-gradient(145deg, #fde047, #facc15); color: #1f2937; }
        #newRecordModal .close-button, #warmupModal .close-button { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #a0aec0; cursor: pointer; line-height: 1; }
        #newRecordModal .close-button:hover, #warmupModal .close-button:hover { color: white; }
        .settings-menu-button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; color: #e5e7eb; background-color: #4a5568; border-radius: 0.375rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease-in-out; }
        .settings-menu-button i { margin-right: 0.75rem; width: 20px; text-align: center; }
        #shareCard { background: linear-gradient(135deg, #2d3748, #1a202c); color: white; padding: 2rem; border-radius: 1rem; border: 2px solid #facc15; width: 350px; }
        #shareCard h4 { color: #facc15; font-weight: bold; font-size: 1.5rem; text-align: center; }
        #shareCard p { font-size: 1.1rem; margin-top: 0.5rem; }
        #shareCard .logo { max-height: 50px; margin: 1rem auto; display: block; }
        #shareModal .modal-content { background: transparent; border: none; box-shadow: none; }
        .timer-card { display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem; border-radius: 0.75rem; background-color: #2d3748; border: 2px solid #4a5568; width: 100%; max-width: 400px; color: #e5e7eb; }
        .timer-card-header { text-align: center; }
        .timer-card-header h3 { font-size: 1.5rem; font-weight: 700; color: #facc15; }
        .timer-card-header p { font-size: 0.9rem; color: #9ca3af; }
        .timer-card-body { text-align: center; }
        .timer-card-main-time { font-family: 'Orbitron', sans-serif; font-size: 5rem; font-weight: 700; line-height: 1; margin: 1rem 0; color: #ffffff; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .timer-card-info { background-color: rgba(31, 41, 55, 0.7); border-radius: 0.5rem; padding: 1rem; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #4a5568; gap: 0.5rem; }
        .timer-card-info .state-label { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .timer-card-info .state-label.work { color: #f87171; }
        .timer-card-info .state-label.rest { color: #34d399; }
        .timer-card-info .state-label.countdown { color: #facc15; }
        .timer-card-info .exercise-name { font-size: 1rem; font-weight: 500; color: #e5e7eb; text-align: center; }
        .timer-card-info .exercise-details { font-size: 0.8rem; color: #9ca3af; }
        /* Adjusted to make buttons fill space */
        .timer-card-actions { display: flex; gap: 1rem; width: 100%; }
        .timer-card-actions button { flex-grow: 1; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease; }
        
        /* Styles for the new full workout log modal */
        .workout-log-entry {
            background-color: rgba(55, 65, 81, 0.8);
            border-left: 4px solid #facc15;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .workout-log-entry h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fde047;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .workout-log-entry h4:hover {
            color: #eab308;
        }
        .workout-log-entry ul {
            list-style: none;
            padding-left: 0;
        }
        .workout-log-entry li {
            font-size: 0.9rem;
            color: #d1d5db;
            padding: 0.2rem 0;
        }
        .workout-log-entry .pr-icon {
            color: #facc15; /* Yellow for trophy */
            font-size: 1.2em;
        }
        /* Style for the new history button inside fullLogModal */
        .full-log-history-button {
            background: none;
            border: none;
            color: #facc15;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            padding: 0.2rem;
            transition: color 0.2s ease-in-out;
        }
        .full-log-history-button:hover {
            color: #eab308;
        }

        .button-disabled { opacity: 0.5; cursor: not-allowed !important; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #FACC15; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NEW: Minimized Timer Styles */
        #minimizedRestTimer {
            background-color: rgba(31, 41, 55, 0.9);
            border: 2px solid #facc15;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease-in-out;
            min-width: 120px; /* Ensure it's not too small */
            max-width: 150px;
            flex-direction: column; /* Keep flex-direction for content alignment */
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            /* Default to hidden */
            display: none;
        }
        /* Class to make minimized timer visible */
        #minimizedRestTimer.is-active {
            display: flex; /* Only show when active */
        }
        #minimizedRestTimer:hover {
            background-color: rgba(55, 65, 81, 0.95);
            transform: scale(1.05);
        }
        #minimizedRestTimer .min-time {
            font-size: 1.8rem;
            line-height: 1;
        }
        #minimizedRestTimer .min-next-exercise {
            font-size: 0.7rem;
            color: #d1d5db;
            line-height: 1.2;
        }

        /* Style for the new minimize button */
        .minimize-button {
            background-color: #4A5568;
            color: #facc15;
            border: 1px solid #facc15;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.9rem;
            margin-top: 1rem; /* Space below timer display */
        }
        .minimize-button:hover {
            background-color: #facc15;
            color: #1f2937;
        }

        /* Styles for quick and full log view bodies */
        .quick-view-body {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 0.5rem;
            align-items: center;
        }

        .full-log-view-body {
            border-top: 2px solid #4b5563;
            padding-top: 1rem;
            margin-top: 0.75rem;
        }
        .full-log-view-body .set-data-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            gap: 0.5rem; /* Reduced gap */
        }
        .full-log-view-body .set-data-row > span {
            flex-basis: auto;
            margin-right: 0.25rem; /* Reduced margin */
            white-space: nowrap;
            font-size: 0.85rem; /* Slightly smaller font */
        }
        .full-log-view-body .set-data-row .set-input {
            display: flex;
            gap: 0.5rem;
            flex-grow: 1;
        }
        .full-log-view-body .set-input input {
            padding: 0.4rem; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font */
        }
        .full-log-view-body .actions-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        /* MODIFIED: Removed flex-grow to allow w-full to work correctly */
        .full-log-view-body .actions-footer button {
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
        }

        /* NEW: Style for exercise notes */
        .quick-mode-exercise-item .notes {
            color: #d1d5db; /* Same color as series/objetivo */
            font-size: 0.75rem; /* Same size as series/objetivo */
            display: block;
            margin-top: 0.5rem; /* Space below inputs */
            padding-top: 0.5rem;
            border-top: 1px solid #4b5563; /* Separator line */
        }
        
        /* NEW: Style for timer exercise images */
        .timer-exercise-image {
            max-height: 120px;
            width: auto;
            max-width: 90%;
            border-radius: 0.5rem;
            object-fit: cover;
            display: none; /* Hidden by default, shown by JS */
        }
        
        /* NEW: Styles for history filter dropdown */
        .history-filter-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .history-filter-select {
            background-color: #4a5568;
            color: #e5e7eb;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .history-filter-select:hover {
            background-color: #5a6578;
        }
        
        /* NEW: Styles for the extras button and modal */
        /* MODIFIED: The button style has been changed to a small icon button */
        .extras-button {
            background: none;
            border: none;
            color: #3b82f6; /* A nice blue */
            padding: 0;
            margin: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: color 0.2s ease-in-out;
        }
        .extras-button:hover {
            color: #2563eb;
        }
        .extras-option-button {
            background-color: #4a5568;
            color: #e5e7eb;
            border: 1px solid #718096;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }
        .extras-option-button:hover {
            background-color: #5a6578;
        }
        .extras-option-button i {
            width: 20px;
            text-align: center;
        }
        /* NEW: Style for the extras form */
        #extrasFormModal .modal-content {
            background-color: #1f2937;
            border: 2px solid #3b82f6;
            color: #e5e7eb;
            padding: 1.5rem;
            width: 95%;
            max-width: 450px;
        }
        #extrasFormModal h3 {
            color: #3b82f6;
        }
        #extrasFormModal .form-group {
            margin-bottom: 1rem;
        }
        #extrasFormModal input,
        #extrasFormModal select {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        #extrasFormModal .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        /* Style for file input label */
        #extrasFormModal .custom-file-input {
            display: block;
            width: 100%;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-align: center;
            color: #9ca3af;
        }
        #extrasFormModal .custom-file-input:hover {
            background-color: #4a5568;
        }
        #extrasFormModal .file-name {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        #extrasFormModal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        #extrasFormModal .modal-actions .cancel-button {
            background-color: #4a5568;
            color: #e5e7eb;
        }
        #extrasFormModal .modal-actions .submit-button {
            background-color: #3b82f6;
            color: #fff;
        }
        #extrasFormModal #otherActivityInputGroup {
            display: none;
        }
        .history-entry .extra-activity-image-container {
            display: block;
            margin-top: 1rem;
            text-align: center;
            max-width: 100%;
        }
        .history-entry .extra-activity-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            object-fit: contain;
            border: 1px solid #4a5568;
        }
        
        /* MODIFIED: Styles for the new register and cancel buttons in extras modal */
        #registerExtraActivityButton {
            background-color: #22c55e; /* Green color for positive action */
            color: #fff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        #registerExtraActivityButton:hover {
            background-color: #16a34a;
        }
        #cancelExtraActivityButton {
            background-color: #ef4444; /* Red color for negative action */
            color: #fff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        #cancelExtraActivityButton:hover {
            background-color: #dc2626;
        }

        /* NEW: Styles for the upload file label */
        #extrasFormModal .custom-file-input {
            border: 1px solid #4a5568;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #extrasFormModal .custom-file-input:hover {
            background-color: #4a5568;
            border-color: #facc15;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-2 sm:p-4 text-gray-200">

    <div class="main-container mb-8">
        <header class="bg-gray-800/90 backdrop-blur-md shadow-xl rounded-t-xl p-4 sm:p-6 mb-0 border-b-2 border-yellow-500 text-center">
            <div class="flex justify-center items-center">
                <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" alt="Logo Programa Hombres en Forma" class="h-12 sm:h-14 md:h-16" onerror="this.alt='Logo HEF'; this.src='https://placehold.co/250x80/1a202c/facc15?text=Logo+Error';">
            </div>
        </header>

        <main class="bg-gray-800/85 backdrop-blur-md shadow-xl rounded-b-xl p-3 sm:p-4 md:p-6">
            <!-- Main Menu Button -->
            <div class="mb-4">
                <a id="mainMenuButton" href="#" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    <i class="fas fa-home mr-2"></i>Menú Principal
                </a>
            </div>

            <!-- Workout Content -->
            <div id="workoutSection" class="tab-content active">
                <section id="mainControlsSection" class="mb-4 sm:mb-6">
                    <!-- MODIFIED: Flex container for the title and the new small button -->
                    <div class="flex justify-center items-center gap-2 mb-2 sm:mb-3">
                        <h2 class="text-md sm:text-lg font-semibold text-yellow-400 text-center">SELECCIONA TU ENTRENAMIENTO</h2>
                        <button id="addExtrasButton" class="extras-button" title="Añadir Actividad Extra">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                    </div>
                    
                    <div class="day-selection-container">
                        <div id="daySelectionTabs" class="day-tab-bar"></div>
                        <div id="workoutPreviewContainer" class="workout-preview-container">
                            <p class="text-gray-400 text-center">Selecciona un día para ver la vista previa.</p>
                        </div>
                    </div>
                    <!-- MODIFIED: Changed to grid-cols-1 and added new button -->
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <button id="viewWorkoutHistoryButton" class="main-action-button">
                            <i class="fas fa-history mr-2"></i>Histórico Entrenamientos
                        </button>
                        <button id="viewExerciseHistoryButton" class="main-action-button">
                            <i class="fas fa-chart-line mr-2"></i>Histórico Ejercicios
                        </button>
                        <button id="videoCorrectionsButton" class="main-action-button">
                            <i class="fas fa-video mr-2"></i>Correcciones de Ejercicios
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODALS (Workout Specific) -->
    
    <!-- Workout History Modal (for full workout sessions) -->
    <div id="mainHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-6 w-full transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-yellow-400">Historial de Entrenamientos</h3>
                <button onclick="closeModalElement(mainHistoryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial">×</button>
            </div>
            <!-- NEW: Filter dropdown -->
            <div class="history-filter-container">
                <select id="historyFilterSelect" class="history-filter-select">
                    <option value="all">Todos</option>
                    <option value="7">Últimos 7 días</option>
                    <option value="15">Últimos 15 días</option>
                    <option value="30">Últimos 30 días</option>
                </select>
            </div>
            <div id="mainHistoryResults" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                 <p class="text-gray-400 text-center py-4">Aquí aparecerá tu historial de entrenamientos.</p>
            </div>
        </div>
    </div>

    <!-- Detailed Exercise History Modal (for individual exercise history) -->
    <div id="detailedHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-[55] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            
            <!-- View 1: List View -->
            <div id="exerciseHistoryListView">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg sm:text-xl font-semibold text-yellow-400">Historial de Ejercicios</h3>
                    <button onclick="closeDetailedHistoryModal()" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de historial detallado">×</button>
                </div>
                <div class="relative mb-4">
                    <input type="search" id="historySearchInput" placeholder="Escribe para filtrar ejercicios..." class="w-full bg-gray-700 border-2 border-gray-600 focus:border-yellow-500 text-white rounded-lg p-3 pl-10 transition-colors focus:outline-none">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="exerciseHistoryList" class="max-h-96 overflow-y-auto pr-2 space-y-2">
                    <!-- JS will populate this list -->
                </div>
            </div>

            <!-- View 2: Detail View (Initially hidden) -->
            <div id="exerciseHistoryDetailView" style="display: none;">
                 <div class="flex justify-between items-center mb-4">
                    <button id="backToExerciseListBtn" class="text-gray-400 hover:text-yellow-400"><i class="fas fa-arrow-left mr-2"></i> Volver</button>
                    <h3 id="detailedHistoryExerciseName" class="text-lg sm:text-xl font-semibold text-yellow-400 text-right truncate"></h3>
                </div>
                <div id="record1RMDisplay" class="text-center bg-gray-900/50 p-3 rounded-lg mb-4">
                    <!-- Historical 1RM will be injected here -->
                </div>
                <div class="mb-6">
                    <canvas id="rmEvolutionChart"></canvas>
                </div>
                <div id="detailedHistoryContent" class="max-h-80 overflow-y-auto pr-2 text-sm text-gray-300 space-y-4"></div>
            </div>

        </div>
    </div>

    <!-- Full Workout Log Modal -->
    <div id="fullWorkoutLogModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-[56] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="fullWorkoutLogTitle" class="text-lg sm:text-xl font-semibold text-yellow-400"></h3>
                <button onclick="closeModalElement(fullWorkoutLogModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de entrenamiento completo">×</button>
            </div>
            <div id="fullWorkoutLogContent" class="max-h-[70vh] overflow-y-auto pr-2 text-sm text-gray-300 space-y-4">
                <!-- Workout details will be loaded here -->
            </div>
            <button onclick="closeModalElement(fullWorkoutLogModal)" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2.5 px-4 rounded-lg shadow-md transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- NEW: Extras Modal -->
    <div id="extrasModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-yellow-400">Seleccionar Actividad</h3>
                <button onclick="closeModalElement(extrasModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de extras">×</button>
            </div>
            <div id="extrasOptionsContainer" class="space-y-3">
                <div class="form-group">
                    <label for="extraActivitySelect" class="block text-sm mb-1">Actividad:</label>
                    <select id="extraActivitySelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md p-2">
                        <option value="Pádel" data-icon="fas fa-tennis-ball">Pádel</option>
                        <option value="Bici" data-icon="fas fa-bicycle">Bici</option>
                        <option value="Natación" data-icon="fas fa-swimmer">Natación</option>
                        <option value="Kayak" data-icon="fas fa-water">Kayak</option>
                        <option value="Correr" data-icon="fas fa-running">Correr</option>
                        <option value="Trekking" data-icon="fas fa-hiking">Trekking</option>
                        <option value="Caminar" data-icon="fas fa-walking">Caminar</option>
                        <option value="Fútbol" data-icon="fas fa-futbol">Fútbol</option>
                        <option value="Otros">Otros...</option>
                    </select>
                </div>

                <div id="otherActivityInputGroup" class="form-group" style="display: none;">
                    <label for="otherActivityName" class="block text-sm mb-1">Nombre de la actividad:</label>
                    <input type="text" id="otherActivityName" placeholder="Escribe aquí..." class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
                </div>

                <div class="form-group">
                    <label for="extraTimeInput" class="block text-sm mb-1">Tiempo invertido (hh:mm):</label>
                    <!-- MODIFIED: Placeholder and oninput for hh:mm format validation -->
                    <input type="text" id="extraTimeInput" placeholder="Ej: 01:30" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md" oninput="this.value = this.value.replace(/[^0-9:]/g, ''); if(this.value.split(':').length > 2) { this.value = this.value.substring(0, this.value.lastIndexOf(':')); }">
                </div>

                <div class="form-group">
                    <!-- MODIFIED: Placeholder and oninput for number-only validation -->
                    <label for="extraVolumeInput" class="block text-sm mb-1">Volumen de entrenamiento (en metros):</label>
                    <input type="number" id="extraVolumeInput" placeholder="Ej: 8000" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>

                <div class="form-group">
                    <label for="extraCaptureInput" class="block text-sm mb-1">Subir captura (opcional):</label>
                    <input type="file" id="extraCaptureInput" accept="image/*" class="hidden">
                    <label for="extraCaptureInput" class="custom-file-input">
                        <i class="fas fa-upload mr-2"></i>Seleccionar Archivo
                    </label>
                    <span id="extraCaptureFileName" class="file-name">Ningún archivo seleccionado</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <!-- MODIFIED: Added distinct button styles -->
                <button id="cancelExtraActivityButton" class="cancel-button">Cancelar</button>
                <button id="registerExtraActivityButton" class="submit-button">Registrar</button>
            </div>
        </div>
    </div>

    <div id="quickModeWorkoutModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-40 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800/95 backdrop-blur-sm border border-yellow-500 rounded-lg shadow-xl p-4 sm:p-6 w-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 id="quickModeWorkoutModalTitle" class="text-xl sm:text-2xl font-bold text-yellow-500 text-left"></h3>
                <!-- MODIFIED: Removed seconds from the display time -->
                <span id="workoutDuration" class="text-lg font-mono text-white">00:00</span>
            </div>
            <div id="quickModeExerciseList" class="space-y-4 sm:space-y-6"></div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeQuickModeWorkoutModal()" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-3 px-4 rounded-lg shadow-md">
                    Cerrar
                </button>
                <button id="endQuickModeWorkoutButton" onclick="toggleWorkoutState()" class="w-1/2 workout-control-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
                    <i class="fas fa-flag-checkered mr-2"></i>Terminar
                </button>
            </div>
        </div>
    </div>

    <div id="newRecordModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content text-center transform scale-95 p-8 rounded-xl shadow-2xl">
            <button class="close-button" onclick="closeModalElement(newRecordModal)">&times;</button>
            <i class="fas fa-trophy text-6xl text-yellow-900/80 mb-4"></i>
            <h3 class="text-3xl font-bold text-gray-800">¡NUEVO RÉCORD!</h3>
            <p id="newRecordText" class="text-lg mt-2 text-gray-700">Has superado tu 1RM anterior.</p>
        </div>
    </div>

    <div id="restTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[70] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="restTimerTitle">TIEMPO DE DESCANSO</h3>
                    <p id="restOverallProgress"></p> <!-- Not used for rest, but keeping structure -->
                </div>
                <div class="timer-card-body">
                    <div id="restTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <div id="restStateLabel" class="state-label rest">DESCANSO</div>
                        <p id="restExerciseName" class="exercise-name">Siguiente: </p>
                        <p id="restExerciseDetails" class="exercise-details">Objetivo: </p>
                    </div>
                    <!-- NEW: Minimize Button -->
                    <button onclick="toggleRestTimerMinimize()" class="minimize-button">MINIMIZAR</button>
                </div>
                <div class="timer-card-actions">
                    <button onclick="adjustRestTime(-15)" class="bg-gray-600 hover:bg-gray-700 text-white">-15s</button>
                    <button onclick="closeRestTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Saltar</button>
                    <button onclick="adjustRestTime(15)" class="bg-gray-600 hover:bg-gray-700 text-white">+15s</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Minimized Rest Timer Display -->
    <div id="minimizedRestTimer" class="fixed top-4 left-4 z-[100] hidden" onclick="toggleRestTimerMinimize()">
        <span id="minimizedTimerDisplay" class="min-time">00:00</span>
        <span id="minimizedNextExercise" class="min-next-exercise"></span>
    </div>

    <!-- MODIFIED: Work Timer Modal HTML -->
    <div id="workTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[71] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="workTimerTitle">TIEMPO DE TRABAJO</h3>
                    <p id="workOverallProgress"></p>
                </div>
                <div class="timer-card-body">
                    <div id="workTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="workCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="workStateLabel" class="state-label work">TRABAJO</div>
                        <p id="workExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="workExerciseDetails" class="exercise-details">Objetivo:</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="closeWorkTimerModal(true)" class="bg-red-600 hover:bg-red-700 text-white">Finalizar Antes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="circuitTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[76] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
             <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="circuitTimerTitle">CIRCUITO EN CURSO</h3>
                    <p id="circuitOverallProgress">Ronda 1 de 3</p>
                </div>
                <div class="timer-card-body">
                    <div id="circuitTimerDisplay" class="timer-card-main-time">00:00</div>
                    <div class="timer-card-info">
                        <img id="circuitCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="circuitStateLabel" class="state-label"></div>
                        <p id="circuitExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="circuitExerciseDetails" class="exercise-details">Objetivo: 30s</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateCircuitEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipCircuitInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="swapExerciseModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[65] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-5 sm:p-6 w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="swapExerciseModalTitle" class="text-lg sm:text-xl font-semibold text-yellow-400">Sugerir Alternativa</h3>
                <button onclick="closeModalElement(swapExerciseModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar modal de sugerencias">×</button>
            </div>
            <div id="swapExerciseModalContent" class="space-y-3 max-h-60 overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button onclick="closeModalElement(swapExerciseModal)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="emomTimerModal" class="modal timer-modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[75] opacity-0 pointer-events-none">
        <div class="modal-content transform scale-95">
            <div class="timer-card">
                <div class="timer-card-header">
                    <h3 id="emomTimerTitle">EMOM EN CURSO</h3>
                    <p id="emomOverallProgress">Intervalo 1 de N</p>
                </div>
                <div class="timer-card-body">
                    <div id="emomIntervalTimerDisplay" class="timer-card-main-time">01:00</div>
                    <div class="timer-card-info">
                        <img id="emomCurrentImage" src="" alt="Ejercicio actual" class="timer-exercise-image">
                        <div id="emomStateLabel" class="state-label work">TRABAJO</div>
                        <p id="emomCurrentExerciseName" class="exercise-name">Ejercicio Actual</p>
                        <p id="emomCurrentExerciseDetails" class="exercise-details">Objetivo: <span id="emomCurrentExerciseReps">Reps</span> con <span id="emomCurrentExerciseWeight">--</span> Kg</p>
                    </div>
                </div>
                <div class="timer-card-actions">
                    <button onclick="terminateEmomEarly()" class="bg-red-600 hover:bg-red-700 text-white">Terminar</button>
                    <button onclick="skipEmomInterval()" class="bg-gray-600 hover:bg-gray-700 text-white">Saltar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="workoutSummaryModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[95] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl shadow-xl p-6 sm:p-8 w-full transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-yellow-400">Resumen del Entrenamiento</h3>
                <button onclick="closeModalElement(workoutSummaryModal)" class="text-gray-400 hover:text-yellow-400 text-2xl" aria-label="Cerrar resumen">×</button>
            </div>
            <!-- MODIFIED: Removed seconds from the display time -->
            <p class="text-gray-300 text-lg mb-2">Tiempo Total: <span id="workoutSummaryTotalTime" class="font-bold text-white">00:00</span></p>
            <p class="text-gray-300 text-lg mb-4">Volumen Total: <span id="workoutSummaryTotalVolume" class="font-bold text-white">0 Kg</span></p>
            
            <div id="workoutSummaryExerciseList" class="max-h-60 overflow-y-auto pr-2 mb-6 space-y-3"></div>
            
            <div class="grid grid-cols-2 gap-4">
                 <button onclick="closeWorkoutSummaryModal(false)" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-semibold py-3 px-4 rounded-lg shadow-md">
                    Volver
                </button>
                <button id="registerWorkoutButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                    Registrar
                </button>
            </div>
        </div>
    </div>
    
    <div id="warmupModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[67] opacity-0 pointer-events-none">
        <div class="modal-content relative bg-gray-800 border border-yellow-500 rounded-lg shadow-xl p-6 w-full transform scale-95">
            <button class="close-button" onclick="closeModalElement(warmupModal)">&times;</button>
            <h3 class="text-lg font-semibold text-yellow-400 mb-4">Calculadora de Aproximación</h3>
            <div class="mb-4">
                <label for="workingSetWeightInput" class="block text-sm text-gray-300 mb-1">Peso de tu primera serie efectiva (Kg):</label>
                <input type="number" id="workingSetWeightInput" class="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md">
            </div>
            <button onclick="calculateWarmupSets()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md mb-4">Calcular</button>
            <div id="warmupSetsResult" class="space-y-2 text-gray-200"></div>
        </div>
    </div>

    <div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[98] opacity-0 pointer-events-none">
        <div class="modal-content">
            <div id="shareCard">
                <!-- Content will be injected by JS -->
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button onclick="downloadShareableImage()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg">Descargar</button>
                <button onclick="closeModalElement(shareModal)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- REMOVED: Video Submission Prompt Modal -->
    
    <!-- Weekday Notice Modal -->
    <div id="weekdayNoticeModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[99] opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-xl p-6 w-full max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-semibold text-yellow-400 mb-4">Función No Disponible</h3>
            <p class="text-gray-300 mb-6">Esta función solo está disponible en los días configurados.</p>
            <button onclick="closeModalElement(weekdayNoticeModal)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>

    <script>
        // =================================================================
        // =================== APP CONFIGURATION =========================
        // =================================================================
        const APP_CONFIG = {
            urls: {
                // MODIFIED: The workoutData URL is now generated dynamically based on the user identifier in the URL.
                workoutSubmission: 'https://aceleratumetabolismo.es/registro-entrenos',
                progressExternalUrl: 'https://aceleratumetabolismo.es/registro_', 
                mainPanelUrl: 'https://www.aceleratumetabolismo.es/panel_', // Base URL for the main panel
                videoUploadUrl: 'https://forms.gle/FSmmciaUWurD4A2g6'
            },
        };

        // MODIFIED: This is now a 'let' and will be updated dynamically from the client's JS file.
        // The default is 'all' (always active), which will be used if no specific config is found in the remote file.
        let VIDEO_PROMPT_CONFIG = {
            // Options:
            // 'all'    - Show every week.
            // 'even'   - Show on even-numbered weeks (2, 4, 6...).
            // 'odd'    - Show on odd-numbered weeks (1, 3, 5...).
            // 'none'   - Never show the prompt.
            // [30, 32] - Show only on specific week numbers (e.g., week 30 and 32).
            activeWeeks: 'none' // MODIFIED: Default to 'none' if no config is found
        };
        // =================================================================
        // =================== END OF CONFIGURATION ======================
        // =================================================================


        // --- GLOBAL APP STATE & VARIABLES ---
        let individualExerciseLogs = []; // Stores individual exercise logs for history and pre-filling
        let workoutSessionSummaries = []; // Stores full workout session summaries
        // NEW: Array for extra activities
        let extraActivities = [];
        let allHistoryItems = [];
        let currentActiveDayKey = null;
        let isWorkoutInProgress = false; 
        let workoutTimerInterval = null;
        let workoutStartTime = 0;
        let restTimerInterval = null, currentRestDuration = 0, restTimerEndTime = 0;
        let workTimerInterval = null, currentWorkDuration = 0, workTimerEndTime = 0; 
        let emomIntervalTimer = null, currentEmomIntervalNumber = 0, currentEmomExerciseIndex = 0, emomExercisesArray = [], totalEmomIntervals = 0, emomWorkIntervalSeconds = 60, currentEmomMainOrder = null; 
        let circuitTimerInterval = null, currentCircuitPhase = 'idle', currentCircuitRound = 0, currentCircuitExerciseIndexInRound = 0, currentCircuitTimeLeft = 0, circuitExercisesArray = [], circuitDetailsGlobal = null, currentCircuitMainOrder = null;
        let toneSynth = null;
        let currentWorkoutSummaryData = []; // Data for the current workout session before registration
        let currentSessionId = null; // Unique ID for the current workout session being performed
        let rmChartInstance = null; // Corrected: Declared with let here
        let workoutData = null; // Will be loaded from URL
        let exerciseAlternatives = null; // Will be loaded from URL
        let wakeLock = null; // NEW: For Screen Wake Lock API

        // NEW: Global variables for time-based exercise sequence
        let currentTimedExerciseCardId = null;
        let currentTimedExerciseSetNumber = 0;
        let totalSetsForCurrentTimedExercise = 0;
        let currentRestDurationForTimedExercise = 0; // Rest duration for the current timed exercise
        let timedExerciseSetsLogged = []; // To store sets logged automatically by the timer

        // NEW: Flag for unsaved changes in fullLogModal (now for in-card view)
        let hasUnsavedFullLogChanges = false;
        
        // NEW: Global variable for storing the uploaded image file
        let uploadedCaptureFile = null;

        // --- Supabase Setup ---
        let supabase = null;
        let userIdentifier = null; // This will store the client_id from the URL
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6b2NtdGFjdmRmb3J4eXdmeGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MTQzNDQsImV4cCI6MjA2NDI5MDM0NH0.aPqF71fIUas99K3TY2heedNdj-X2MflrndmYjtCOgNU';

        // --- UTILITY FUNCTIONS (SHARED) ---
        function openModal(modalElement) {
            if (!modalElement) return;
            modalElement.classList.remove('opacity-0', 'pointer-events-none', 'hidden');
            modalElement.classList.add('opacity-100');
            const content = modalElement.querySelector('.modal-content, .relative'); // Added .relative for photo modal
            if (content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
        }

        function closeModalElement(modalElement) {
            if (!modalElement) return;
            const content = modalElement.querySelector('.modal-content, .relative'); // Added .relative for photo modal
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            modalElement.classList.remove('opacity-100', 'pointer-events-auto');
            modalElement.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                if (!modalElement.classList.contains('opacity-100')) {
                    modalElement.classList.add('hidden');
                }
            }, 300);
        }

        function showCustomAlert(message, type = 'info') {
            const alertContainerId = 'customAlert';
            const existingAlert = document.getElementById(alertContainerId);
            if (existingAlert) existingAlert.remove();

            const alertContainer = document.createElement('div');
            alertContainer.id = alertContainerId;
            alertContainer.className = `fixed top-5 right-5 z-[100] p-4 rounded-md shadow-lg text-white max-w-sm transition-opacity duration-300 ease-out opacity-0`;
            
            let bgColor = 'bg-blue-500 border-blue-700';
            let iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

            if (type === 'error') { bgColor = 'bg-red-500 border-red-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; } 
            else if (type === 'warning') { bgColor = 'bg-yellow-500 border-yellow-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`; } 
            else if (type === 'info') { bgColor = 'bg-sky-500 border-sky-700'; iconSVG = `<svg class="fill-current h-6 w-6 text-white mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 0118 0zm0 14a6 6 0 110-12 6 6 0 010 12zm-1-5a1 10 011-1h.01a1 10 110 2H10a1 10 01-1-1zm0-3a1 10 011-1h.01a1 10 110 2H10a1 10 01-1-1z"></path></svg>`; }
            
            alertContainer.classList.add(...bgColor.split(' '));
            alertContainer.innerHTML = `<div class="flex items-center">${iconSVG}<span class="text-sm">${message}</span><button onclick="this.closest('#${alertContainerId}').remove()" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-white hover:text-gray-200 rounded-lg p-1.5 inline-flex h-8 w-8 items-center justify-center"><span class="sr-only">Cerrar</span><svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg></button></div>`;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.classList.remove('opacity-0'); alertContainer.classList.add('opacity-100'); }, 10);
            setTimeout(() => { alertContainer.classList.remove('opacity-100'); alertContainer.classList.add('opacity-0'); setTimeout(() => {alertContainer.remove();}, 7000); }, 7000);
        }

        function showCustomConfirm(message, callback) {
            const confirmContainerId = 'customConfirmModal';
            if (document.getElementById(confirmContainerId)) return;
            const confirmContainer = document.createElement('div');
            confirmContainer.id = confirmContainerId;
            confirmContainer.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-75 p-4 transition-opacity duration-300 ease-out opacity-0';
            confirmContainer.innerHTML = `<div class="bg-gray-700 p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all duration-300 ease-out scale-95"><p class="text-gray-200 text-lg mb-6">${message}</p><div class="flex justify-end space-x-3"><button id="confirmCancelBtn" class="nav-button py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-600">Cancelar</button><button id="confirmOkBtn" class="danger-button py-2 px-4 rounded-md text-sm font-medium">Confirmar</button></div></div>`;
            document.body.appendChild(confirmContainer);
            setTimeout(() => { confirmContainer.classList.remove('opacity-0'); confirmContainer.classList.add('opacity-100'); confirmContainer.querySelector('div > div').classList.remove('scale-95'); confirmContainer.querySelector('div > div').classList.add('scale-100'); }, 10);
            document.getElementById('confirmOkBtn').onclick = () => { callback(); confirmContainer.remove(); };
            document.getElementById('confirmCancelBtn').onclick = () => { confirmContainer.remove(); };
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // MODIFIED: More robust audio initialization for mobile devices (especially iOS).
            // The audio context must be started by a direct user gesture.
            const initAudio = async () => {
                try {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        console.log('Audio context started successfully.');
                    }
                    
                    // Create the synth instance if it's not already there
                    if (!toneSynth) {
                        toneSynth = new Tone.Synth().toDestination();
                        console.log('Tone.Synth created.');
                    }

                    // Play a silent note to "prime" the synth.
                    toneSynth.volume.value = -Infinity;
                    toneSynth.triggerAttackRelease("C4", "32n", Tone.now());
                    toneSynth.volume.value = 0;
                    
                    console.log('Audio synth primed successfully.');
                    showCustomAlert('Sonido activado.', 'info');

                } catch (e) {
                    console.error('Could not initialize or prime audio:', e);
                    showCustomAlert('Error al activar el sonido.', 'error');
                } finally {
                    // Remove the event listeners after the first interaction
                    document.body.removeEventListener('click', initAudio);
                    document.body.removeEventListener('touchstart', initAudio);
                }
            };
            // Add listeners that will trigger the audio initialization on the first user tap/click.
            document.body.addEventListener('click', initAudio, { once: true });
            document.body.addEventListener('touchstart', initAudio, { once: true });

            // Initialize Supabase and userIdentifier first
            initializeSupabaseClient();
            
            // Initialize the workout app logic
            initializeWorkoutApp();
            
            // NEW: Add event listener for the new extras button
            const addExtrasButton = document.getElementById('addExtrasButton');
            if(addExtrasButton) {
                addExtrasButton.addEventListener('click', () => {
                    setupExtrasForm();
                    openModal(document.getElementById('extrasModal'));
                });
            }
            
            // NEW: Added event listener for the new Cancel button
            const cancelExtraActivityButton = document.getElementById('cancelExtraActivityButton');
            if(cancelExtraActivityButton) {
                cancelExtraActivityButton.addEventListener('click', () => {
                    closeModalElement(document.getElementById('extrasModal'));
                });
            }

            // Set the href for the main menu button
            const mainMenuButton = document.getElementById('mainMenuButton');
            if (mainMenuButton && userIdentifier) {
                // MODIFIED: Changed the link to point to index.html with the `usuario` parameter
                mainMenuButton.href = `/mi-webapp-pwa/index.html?usuario=${userIdentifier}`;
            } else if (mainMenuButton) {
                mainMenuButton.href = `/mi-webapp-pwa/index.html`;
                console.warn("User identifier not found for main menu button. Using default link.");
            }

            // NEW: Add listener for page visibility to manage wake lock
            document.addEventListener('visibilitychange', handleVisibilityChange);

        });

        // Function to initialize Supabase client and get user identifier
        function initializeSupabaseClient() {
            const supabaseUrl = 'https://izocmtacvdforxywfxgr.supabase.co';
            
            try {
                // MODIFIED: Use the provided Supabase API key
                supabase = window.supabase.createClient(supabaseUrl, SUPABASE_API_KEY);
            } catch (e) {
                console.error("Error inicializando Supabase:", e);
                showCustomAlert("Error de configuración: No se pudo conectar a la base de datos. Asegúrate de que tu clave API de Supabase sea correcta.", "error");
                return;
            }

            // MODIFIED: Updated to check for 'usuario' parameter first
            function obtenerParametroUrl(nombre) {
                nombre = nombre.replace(/[\[\]]/g, '\\$&');
                var regex = new RegExp('[?&]' + nombre + '(=([^&#]*)|&|#|$)'),
                    resultados = regex.exec(window.location.href);
                if (!resultados) return null;
                if (!resultados[2]) return '';
                return decodeURIComponent(resultados[2].replace(/\+/g, ' '));
            }
            userIdentifier = obtenerParametroUrl('usuario');
            if (userIdentifier) {
                console.log('User ID for training:', userIdentifier);
                return;
            }

            const path = window.location.pathname;
            const match = path.match(/\/app_([^/]+)/);
            userIdentifier = match ? match[1] : null;

            if (!userIdentifier) {
                const urlParams = new URLSearchParams(window.location.search);
                const userFromQuery = urlParams.get('user');
                if (userFromQuery) {
                    userIdentifier = userFromQuery;
                } else {
                    console.warn("User identifier not found in URL. Using a default/placeholder. Data might not be isolated correctly.");
                    userIdentifier = "default-user-id"; // Placeholder for development
                    showCustomAlert("Advertencia: Usuario no identificado en la URL. Los datos pueden no guardarse correctamente.", "warning");
                }
            }
        }

        // #############################################################
        // #                 SCREEN WAKE LOCK LOGIC                    #
        // #############################################################
        
        // NEW: Function to request a screen wake lock
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock was released');
                    });
                    console.log('Screen Wake Lock is active');
                    showCustomAlert('La pantalla se mantendrá encendida.', 'info');
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            } else {
                console.warn('Wake Lock API not supported.');
            }
        };

        // NEW: Function to release the screen wake lock
        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
            }
        };

        // NEW: Handle visibility changes to re-acquire the lock if needed
        const handleVisibilityChange = async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && isWorkoutInProgress) {
                await requestWakeLock();
            }
        };


        // #############################################################
        // #                    WORKOUT APP LOGIC                      #
        // #############################################################
        const daySelectionTabsContainer = document.getElementById('daySelectionTabs'); 
        const workoutPreviewContainer = document.getElementById('workoutPreviewContainer'); 
        const viewWorkoutHistoryButton = document.getElementById('viewWorkoutHistoryButton');
        const viewExerciseHistoryButton = document.getElementById('viewExerciseHistoryButton');
        const mainHistoryModal = document.getElementById('mainHistoryModal');
        const historySearchInput = document.getElementById('historySearchInput');
        const mainHistoryResults = document.getElementById('mainHistoryResults');
        const detailedHistoryModal = document.getElementById('detailedHistoryModal');
        const exerciseHistoryListView = document.getElementById('exerciseHistoryListView');
        const exerciseHistoryDetailView = document.getElementById('exerciseHistoryDetailView');
        const exerciseHistoryList = document.getElementById('exerciseHistoryList');
        const backToExerciseListBtn = document.getElementById('backToExerciseListBtn');
        const detailedHistoryExerciseName = document.getElementById('detailedHistoryExerciseName');
        const detailedHistoryContent = document.getElementById('detailedHistoryContent');
        const record1RMDisplay = document.getElementById('record1RMDisplay');
        const rmEvolutionChartCanvas = document.getElementById('rmEvolutionChart');
        const fullWorkoutLogModal = document.getElementById('fullWorkoutLogModal');
        const fullWorkoutLogTitle = document.getElementById('fullWorkoutLogTitle');
        const fullWorkoutLogContent = document.getElementById('fullWorkoutLogContent');
        const quickModeWorkoutModal = document.getElementById('quickModeWorkoutModal');
        const quickModeWorkoutModalTitle = document.getElementById('quickModeWorkoutModalTitle');
        const quickModeExerciseList = document.getElementById('quickModeExerciseList');
        const endQuickModeWorkoutButton = document.getElementById('endQuickModeWorkoutButton'); 
        const restTimerModal = document.getElementById('restTimerModal');
        const restTimerTitle = document.getElementById('restTimerTitle');
        const restOverallProgress = document.getElementById('restOverallProgress');
        const restTimerDisplay = document.getElementById('restTimerDisplay');
        const restStateLabel = document.getElementById('restStateLabel');
        const restExerciseName = document.getElementById('restExerciseName');
        const restExerciseDetails = document.getElementById('restExerciseDetails');
        const minimizedRestTimer = document.getElementById('minimizedRestTimer');
        const minimizedTimerDisplay = document.getElementById('minimizedTimerDisplay');
        const minimizedNextExercise = document.getElementById('minimizedNextExercise');
        // MODIFIED: Extras modal has been simplified to a single modal
        const extrasModal = document.getElementById('extrasModal');
        const extraActivitySelect = document.getElementById('extraActivitySelect');
        const otherActivityInputGroup = document.getElementById('otherActivityInputGroup');
        const otherActivityNameInput = document.getElementById('otherActivityName');
        const extraTimeInput = document.getElementById('extraTimeInput');
        const extraVolumeInput = document.getElementById('extraVolumeInput');
        const extraCaptureInput = document.getElementById('extraCaptureInput');
        const extraCaptureFileName = document.getElementById('extraCaptureFileName');
        const registerExtraActivityButton = document.getElementById('registerExtraActivityButton');
        const cancelExtraActivityButton = document.getElementById('cancelExtraActivityButton');


        // MODIFIED: Element selectors for the new work timer modal
        const workTimerModal = document.getElementById('workTimerModal'); 
        const workTimerTitle = document.getElementById('workTimerTitle');
        const workOverallProgress = document.getElementById('workOverallProgress');
        const workTimerDisplay = document.getElementById('workTimerDisplay');
        const workStateLabel = document.getElementById('workStateLabel');
        const workExerciseName = document.getElementById('workExerciseName');
        const workExerciseDetails = document.getElementById('workExerciseDetails');
        const workCurrentImage = document.getElementById('workCurrentImage');
        
        const circuitTimerModal = document.getElementById('circuitTimerModal'); 
        const circuitOverallProgress = document.getElementById('circuitOverallProgress'); 
        const circuitStateLabel = document.getElementById('circuitStateLabel'); 
        const circuitExerciseName = document.getElementById('circuitExerciseName'); 
        const circuitExerciseDetails = document.getElementById('circuitExerciseDetails'); 
        const circuitTimerDisplay = document.getElementById('circuitTimerDisplay'); 
        const swapExerciseModal = document.getElementById('swapExerciseModal');
        const swapExerciseModalTitle = document.getElementById('swapExerciseModalTitle');
        const swapExerciseModalContent = document.getElementById('swapExerciseModalContent');
        const emomTimerModal = document.getElementById('emomTimerModal');
        const emomTimerTitle = document.getElementById('emomTimerTitle'); 
        const emomOverallProgress = document.getElementById('emomOverallProgress');
        const emomStateLabel = document.getElementById('emomStateLabel');
        const emomCurrentExerciseName = document.getElementById('emomCurrentExerciseName');
        const emomCurrentExerciseReps = document.getElementById('emomCurrentExerciseReps');
        const emomCurrentExerciseWeight = document.getElementById('emomCurrentExerciseWeight');
        const emomCurrentExerciseDetails = document.getElementById('emomCurrentExerciseDetails');
        const emomIntervalTimerDisplay = document.getElementById('emomIntervalTimerDisplay'); 
        const workoutSummaryModal = document.getElementById('workoutSummaryModal');
        const workoutSummaryTotalTime = document.getElementById('workoutSummaryTotalTime');
        const workoutSummaryTotalVolume = document.getElementById('workoutSummaryTotalVolume');
        const workoutSummaryExerciseList = document.getElementById('workoutSummaryExerciseList');
        const registerWorkoutButton = document.getElementById('registerWorkoutButton');
        const newRecordModal = document.getElementById('newRecordModal');
        const newRecordText = document.getElementById('newRecordText');
        const warmupModal = document.getElementById('warmupModal');
        const shareModal = document.getElementById('shareModal');
        
        // NEW: Helper function to get the ISO week number of the year.
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            // Return array of week number and year
            return weekNo;
        }

        function openVideoLink(videoUrl) { if (videoUrl) { window.open(videoUrl, '_blank'); } }
        function calculateEpley1RM(weight, reps) { if (reps == 0 || weight == 0) return 0; if (reps == 1) return parseFloat(weight); return parseFloat(weight) * (1 + (parseFloat(reps) / 30)); }
        function isTimeBased(repsString) { return typeof repsString === 'string' && repsString.endsWith('s'); }
        function parseRepRange(repString) { if (!repString || typeof repString !== 'string') return { type: 'unknown' }; const cleaned = repString.replace(/reps|lado|\/lado/gi, '').trim(); if (cleaned.includes('-')) { const [min, max] = cleaned.split('-').map(n => parseInt(n, 10)); return { type: 'range', min, max }; } if (cleaned.includes(',')) { const reps = cleaned.split(',').map(n => parseInt(n.trim(), 10)); return { type: 'specific', target: Math.min(...reps) }; } const specific = parseInt(cleaned, 10); if (!isNaN(specific)) { return { type: 'specific', target: specific }; } return { type: 'unknown' }; }
        function getRepCompletionState(performedReps, targetRepsString) { 
            if (isTimeBased(targetRepsString)) {
                return 'good';
            }
            const parsedTarget = parseRepRange(targetRepsString); 
            const performed = parseInt(performedReps, 10); 
            if (isNaN(performed)) return 'neutral'; 
            switch (parsedTarget.type) { 
                case 'range': 
                    if (performed >= parsedTarget.max) return 'good'; 
                    if (performed < parsedTarget.min) return 'bad'; 
                    return 'neutral'; 
                case 'specific': 
                    if (performed >= parsedTarget.target) return 'good'; 
                    if (performed <= parsedTarget.target - 3) return 'bad'; 
                    return 'neutral'; 
                default: return 'neutral'; 
            } 
        }
        
        function getLastLoggedDataForSet(exerciseName, setNumber) {
            const entries = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a,b) => new Date(b.raw_date) - new Date(a.raw_date));
            if (entries.length > 0) {
                const setsPerformed = entries[0].sets_performed;
                const setData = setsPerformed.find(s => s.serie === setNumber);
                if (setData) return { kg: setData.kg || "", reps: setData.reps || "" };
                if(setsPerformed.length > 0) return { kg: setsPerformed[0].kg || "", reps: setsPerformed[0].reps || "" };
            }
            return { kg: "", reps: "" };
        }
        
        function getLastWorkoutEntry(exerciseName) {
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a, b) => new Date(b.raw_date) - new Date(a.raw_date));
            return historyForExercise.length > 0 ? historyForExercise[0] : null;
        }

        function openExerciseHistoryExplorer() {
            showExerciseListView();
            historySearchInput.value = '';
            handleExerciseHistorySearch();
            openModal(detailedHistoryModal);
        }

        function showExerciseListView() {
            exerciseHistoryListView.style.display = 'block';
            exerciseHistoryDetailView.style.display = 'none';
        }

        function showExerciseDetailView(exerciseName) {
            exerciseHistoryListView.style.display = 'none';
            exerciseHistoryDetailView.style.display = 'block';
            detailedHistoryExerciseName.textContent = exerciseName;
            const entries = individualExerciseLogs.filter(e => e.exercise_name === exerciseName).sort((a, b) => new Date(a.raw_date) - new Date(b.raw_date));
            detailedHistoryContent.innerHTML = '';
            const chartLabels = [], chartData = [];
            let historicalMaxRm = 0;
            let historicalMaxRmDate = '';
            if (entries.length === 0) {
                detailedHistoryContent.innerHTML = '<p class="text-gray-400 text-center">No hay registros.</p>';
                record1RMDisplay.innerHTML = '<p class="text-gray-400">Sin récord de 1RM</p>';
            } else {
                entries.forEach(entry => {
                    let maxRmForEntry = 0, bestSetForRm = null;
                    const setsPerformed = entry.sets_performed || [];
                    setsPerformed.forEach(set => {
                        if (!isTimeBased(set.reps)) {
                            const currentRm = calculateEpley1RM(set.kg, set.reps);
                            if (currentRm > maxRmForEntry) { maxRmForEntry = currentRm; bestSetForRm = set; }
                            if (currentRm > historicalMaxRm) { historicalMaxRm = currentRm; historicalMaxRmDate = entry.date; }
                        }
                    });
                    if (maxRmForEntry > 0) {
                        chartLabels.push(entry.date);
                        chartData.push(maxRmForEntry.toFixed(1));
                    }
                    const rmDisplay = maxRmForEntry > 0 && bestSetForRm ? `<p class="text-xs text-blue-400">1RM Est. (Serie ${bestSetForRm.serie}): ${maxRmForEntry.toFixed(1)}kg</p>` : '';
                    const setsList = setsPerformed.map(s => {
                        const completionClass = s.completionState === 'good' ? 'history-reps-good' : (s.completionState === 'bad' ? 'history-reps-bad' : '');
                        return `<li>Serie ${s.serie}: ${s.kg || 0}kg x <span class="${completionClass}">${s.reps || 0} ${isTimeBased(s.reps) ? 's' : 'reps'}</span></li>`;
                    }).join('');
                    detailedHistoryContent.innerHTML += `<div class="history-entry pb-3 mb-3"><p class="font-semibold text-yellow-400">${entry.date} - ${entry.time}</p>${rmDisplay}<ul class="list-disc list-inside pl-2 text-gray-300 mt-1">${setsList}</ul></div>`;
                });
                record1RMDisplay.innerHTML = `<span class="text-gray-300">Récord Histórico (1RM): </span><strong class="text-yellow-400 text-lg">${historicalMaxRm.toFixed(1)} kg</strong> <span class="text-gray-400 text-sm">(${historicalMaxRmDate})</span>`;
            }
            renderRmEvolutionChart(chartLabels, chartData);
        }
        
        function viewExerciseHistoryFromLog(exerciseName) {
            showExerciseDetailView(exerciseName);
            openModal(detailedHistoryModal);
        }

        function handleExerciseHistorySearch() {
            const query = historySearchInput.value.toLowerCase().trim();
            exerciseHistoryList.innerHTML = '';
            const uniqueExercises = [...new Set(individualExerciseLogs.map(item => item.exercise_name))].sort();
            const filteredExercises = uniqueExercises.filter(name => name.toLowerCase().includes(query));
            if (filteredExercises.length === 0) {
                exerciseHistoryList.innerHTML = '<p class="text-gray-400 text-center py-4">No se encontraron ejercicios.</p>';
                return;
            }
            filteredExercises.forEach(exerciseName => {
                const button = document.createElement('button');
                button.className = 'main-history-item';
                button.textContent = exerciseName;
                const escapedName = exerciseName.replace(/'/g, "\\'").replace(/"/g, '\\"');
                button.onclick = () => showExerciseDetailView(escapedName);
                exerciseHistoryList.appendChild(button);
            });
        }

        function closeDetailedHistoryModal() {
            if (rmChartInstance) {
                rmChartInstance.destroy();
                rmChartInstance = null;
            }
            closeModalElement(detailedHistoryModal);
        }

        if(viewWorkoutHistoryButton) viewWorkoutHistoryButton.addEventListener('click', () => { 
            renderWorkoutHistoryList('all'); // Call with default filter 'all'
            openModal(mainHistoryModal); 
        });
        if(viewExerciseHistoryButton) viewExerciseHistoryButton.addEventListener('click', openExerciseHistoryExplorer);
        if(historySearchInput) historySearchInput.addEventListener('input', handleExerciseHistorySearch);
        if(backToExerciseListBtn) backToExerciseListBtn.addEventListener('click', showExerciseListView);
        
        // NEW: History filter element
        const historyFilterSelect = document.getElementById('historyFilterSelect');
        if (historyFilterSelect) {
            historyFilterSelect.addEventListener('change', (event) => {
                renderWorkoutHistoryList(event.target.value);
            });
        }
        
        // MODIFIED: renderWorkoutHistoryList to accept a filter and render both workouts and extras
        function renderWorkoutHistoryList(filter) {
            mainHistoryResults.innerHTML = '';
            const now = new Date();
            let filteredHistory = [];

            // Combine and sort all history items
            const allItems = [...workoutSessionSummaries, ...extraActivities];

            // Filter logic
            if (filter === '7') {
                const sevenDaysAgo = new Date(now.setDate(now.getDate() - 7));
                filteredHistory = allItems.filter(s => new Date(s.raw_date) > sevenDaysAgo);
            } else if (filter === '15') {
                const fifteenDaysAgo = new Date(now.setDate(now.getDate() - 15));
                filteredHistory = allItems.filter(s => new Date(s.raw_date) > fifteenDaysAgo);
            } else if (filter === '30') {
                const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));
                filteredHistory = allItems.filter(s => new Date(s.raw_date) > thirtyDaysAgo);
            } else { // 'all'
                filteredHistory = allItems;
            }

            const sortedHistory = Array.from(filteredHistory).sort((a, b) => new Date(b.raw_date) - new Date(a.raw_date));
            
            if (sortedHistory.length === 0) {
                mainHistoryResults.innerHTML = '<p class="text-gray-400 text-center py-4">No hay entrenamientos ni actividades registradas para este periodo.</p>';
                return;
            }
            
            sortedHistory.forEach(session => {
                const button = document.createElement('button');
                button.className = 'main-history-item';
                const workoutName = session.name_workout || 'Entrenamiento no nombrado';
                let icon = '';
                // NEW: Get the duration string
                let durationHtml = session.total_time_session ? ` <span class="text-sm text-gray-400 ml-2"><i class="fas fa-clock mr-1"></i>${session.total_time_session}</span>` : '';
                
                // Check if it's a workout session or an extra activity
                if (session.exercise_name === "Workout Session Summary") {
                    icon = '<i class="fas fa-dumbbell mr-2 text-yellow-300"></i>';
                    button.onclick = () => { openFullWorkoutLogModal(session.session_id); };
                } else if (session.exercise_name === "Extra Activity") {
                    icon = getExtrasIcon(workoutName);
                    // Pass the whole session object to showExtraActivityDetails
                    button.onclick = () => { showExtraActivityDetails(session); };
                }

                button.innerHTML = `
                    <div class="flex items-center w-full">
                        ${icon}
                        <div class="flex flex-col items-start w-full">
                            <span class="font-bold text-yellow-300">${workoutName} ${durationHtml}</span>
                            <span class="text-sm text-gray-400 mt-1">${session.date} - ${session.time}</span>
                        </div>
                    </div>
                `;
                mainHistoryResults.appendChild(button);
            });
        }

        // NEW: Function to get an icon for an extra activity
        function getExtrasIcon(activityName) {
            const normalizedName = activityName.toLowerCase();
            if (normalizedName.includes('pádel')) return '<i class="fas fa-tennis-ball mr-2 text-blue-300"></i>';
            if (normalizedName.includes('bici')) return '<i class="fas fa-bicycle mr-2 text-blue-300"></i>';
            if (normalizedName.includes('natación')) return '<i class="fas fa-swimmer mr-2 text-blue-300"></i>';
            if (normalizedName.includes('kayak')) return '<i class="fas fa-water mr-2 text-blue-300"></i>';
            if (normalizedName.includes('correr')) return '<i class="fas fa-running mr-2 text-blue-300"></i>';
            if (normalizedName.includes('trecking')) return '<i class="fas fa-hiking mr-2 text-blue-300"></i>';
            if (normalizedName.includes('caminar')) return '<i class="fas fa-walking mr-2 text-blue-300"></i>';
            if (normalizedName.includes('fútbol')) return '<i class="fas fa-futbol mr-2 text-blue-300"></i>';
            return '<i class="fas fa-ellipsis-h mr-2 text-blue-300"></i>';
        }
        
        // MODIFIED: showExtraActivityDetails to display optional data and image
        function showExtraActivityDetails(activity) {
            let detailsHtml = `
                <div class="workout-log-entry">
                    <h4 class="text-yellow-400">${activity.name_workout}</h4>
                    <p class="text-gray-300 mt-2">Registrado el ${activity.date} a las ${activity.time}.</p>
            `;

            // Check and display time
            if (activity.total_time_session) {
                detailsHtml += `<p class="text-gray-300 mt-2"><i class="fas fa-clock mr-2 text-yellow-400"></i>Tiempo: ${activity.total_time_session}</p>`;
            }

            // Check and display volume
            if (activity.total_volume_session) {
                detailsHtml += `<p class="text-gray-300 mt-2"><i class="fas fa-chart-bar mr-2 text-yellow-400"></i>Volumen: ${activity.total_volume_session}</p>`;
            }

            detailsHtml += `</div>`;
            
            // Check and display image
            if (activity.capture_url) {
                detailsHtml += `
                    <div class="extra-activity-image-container">
                        <img src="${activity.capture_url}" alt="Captura de ${activity.name_workout}">
                    </div>
                `;
            }

            fullWorkoutLogContent.innerHTML = detailsHtml;
            fullWorkoutLogTitle.textContent = "Detalles de Actividad Extra";
            openModal(fullWorkoutLogModal);
        }
        
        function renderRmEvolutionChart(labels, data) { 
            if (rmChartInstance) { rmChartInstance.destroy(); } 
            const ctx = rmEvolutionChartCanvas.getContext('2d'); 
            rmChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Evolución 1RM (kg)', 
                        data, 
                        backgroundColor: 'rgba(250, 204, 21, 0.2)', 
                        borderColor: '#facc15', 
                        borderWidth: 2 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } }, 
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } } 
                    }, 
                    plugins: { legend: { labels: { color: '#d1d5db' } } } 
                } 
            }); 
        }
        
        // MODIFIED: Timer sound logic
        function playTimerSound(note, duration) {
            if (toneSynth && Tone.context.state === 'running') {
                try {
                    toneSynth.triggerAttackRelease(note, duration, Tone.now());
                } catch (e) {
                    console.error("Error playing sound:", e);
                }
            } else {
                console.warn("Cannot play sound, audio context not ready or synth not initialized.");
            }
        }

        function startRestTimer(durationSeconds, nextExerciseData = null) {
            currentRestDuration = durationSeconds;
            clearInterval(restTimerInterval);
            restTimerEndTime = Date.now() + currentRestDuration * 1000;
            restStateLabel.textContent = 'DESCANSO';
            restStateLabel.className = 'state-label rest';
            if (nextExerciseData) {
                restExerciseName.textContent = `Siguiente: ${nextExerciseData.name || ''}`;
                restExerciseDetails.textContent = `Objetivo: ${nextExerciseData.reps || ''} con ${nextExerciseData.kg || '--'} Kg`;
            } else {
                restExerciseName.textContent = '';
                restExerciseDetails.textContent = '';
            }
            minimizedRestTimer.classList.remove('is-active');
            openModal(restTimerModal);
            playTimerSound("C5", "16n");
            restTimerInterval = setInterval(() => {
                const timeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(restTimerInterval);
                    closeRestTimerModal(false);
                    playTimerSound("A5", "8n");
                } else {
                    updateRestTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function adjustRestTime(secondsAdjustment) { 
            if (!restTimerInterval) return; 
            restTimerEndTime += secondsAdjustment * 1000; 
            let newTimeLeft = Math.round((restTimerEndTime - Date.now()) / 1000); 
            if (newTimeLeft <= 0) { 
                clearInterval(restTimerInterval); 
                closeRestTimerModal(false); 
                playTimerSound("A5", "8n");
            } 
            updateRestTimerDisplay(newTimeLeft); 
        }

        function updateRestTimerDisplay(timeLeft) { 
            const seconds = timeLeft % 60;
            const minutes = Math.floor(timeLeft / 60);
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            restTimerDisplay.textContent = formattedTime;
            minimizedTimerDisplay.textContent = formattedTime;
            minimizedNextExercise.textContent = restExerciseName.textContent.replace('Siguiente: ', '');
        }

        function closeRestTimerModal(skipped = false) { 
            clearInterval(restTimerInterval); 
            restTimerDisplay.textContent = '00:00';
            minimizedTimerDisplay.textContent = '00:00';
            minimizedNextExercise.textContent = '';
            minimizedRestTimer.classList.remove('is-active');
            closeModalElement(restTimerModal); 
        }

        function toggleRestTimerMinimize() {
            if (restTimerModal.classList.contains('opacity-100')) {
                closeModalElement(restTimerModal);
                minimizedRestTimer.classList.add('is-active');
            } else {
                minimizedRestTimer.classList.remove('is-active');
                openModal(restTimerModal);
            }
        }

        function openSwapExerciseModal(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const primordialExerciseData = JSON.parse(card.dataset.primordialExerciseData);
            swapExerciseModalTitle.textContent = `Alternativas para: ${card.dataset.currentName}`;
            const alternatives = exerciseAlternatives[primordialExerciseData.name] || [];
            swapExerciseModalContent.innerHTML = '';
            if (card.dataset.isSwapped === "true") {
                const revertButton = document.createElement('button');
                revertButton.className = 'w-full text-left p-3 bg-blue-700 hover:bg-blue-600 rounded-md transition-colors mb-2';
                revertButton.innerHTML = `<strong class="text-yellow-300"><i class="fas fa-undo mr-2"></i>Volver a ${primordialExerciseData.name}</strong>`;
                revertButton.onclick = () => { performExerciseSwap(cardId, primordialExerciseData); closeModalElement(swapExerciseModal); };
                swapExerciseModalContent.appendChild(revertButton);
            }
            alternatives.forEach(alt => {
                if (alt.name === card.dataset.currentName) return;
                const button = document.createElement('button');
                button.className = 'w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md transition-colors';
                button.innerHTML = `<strong class="text-yellow-400">${alt.name}</strong>`;
                // MODIFIED: Pass imageUrl along with other alternative data
                button.onclick = () => { performExerciseSwap(cardId, { ...primordialExerciseData, name: alt.name, videoUrl: alt.videoUrl, imageUrl: alt.imageUrl }); closeModalElement(swapExerciseModal); };
                swapExerciseModalContent.appendChild(button);
            });
            if (swapExerciseModalContent.innerHTML === '') {
                swapExerciseModalContent.innerHTML += '<p class="text-gray-400">No hay alternativas definidas.</p>';
            }
            openModal(swapExerciseModal);
        }
        function performExerciseSwap(cardId, newExerciseData) { const card = document.getElementById(cardId); if (!card) return; const parent = card.parentNode; const isSubItem = card.dataset.subOrder !== ''; let specialData = null; if (isSubItem) { const supersetContainer = card.closest('.quick-mode-superset-container'); if(supersetContainer){ const supersetBlockData = workoutData[currentActiveDayKey].exercises.find(ex => `qm-superset-${currentActiveDayKey}-${ex.order}` === supersetContainer.id); if(supersetBlockData && supersetBlockData.isEMOM) { specialData = { series: Math.ceil(supersetBlockData.emomDetails.totalIntervals / supersetBlockData.items.length) }; } else if (supersetBlockData && supersetBlockData.circuitDetails) { specialData = { series: supersetBlockData.circuitDetails.totalRounds }; } } } const primordialData = JSON.parse(card.dataset.primordialExerciseData || '{}'); const exerciseToCreate = { ...newExerciseData, primordialExerciseData: primordialData }; const newCard = createQuickModeExerciseCard(card.dataset.dayKey, parseInt(card.dataset.mainOrder), exerciseToCreate, isSubItem, specialData); if (parent) { parent.replaceChild(newCard, card); } updateAllExerciseCardInputStates(); }
        function confirmBeforeClosingWorkoutModal(modalElement, callbackOnConfirm) { if (isWorkoutInProgress) { const confirmCloseModal = document.createElement('div'); confirmCloseModal.id = 'confirmCloseModal'; confirmCloseModal.className = 'modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[90]'; confirmCloseModal.innerHTML = `<div class="modal-content bg-gray-800 border-2 border-red-500 rounded-xl p-6 w-full max-w-sm text-center"><h3 class="text-xl font-semibold text-red-400 mb-3">Entrenamiento en Curso</h3><p class="text-gray-300 mb-6 text-sm">¿Seguro que quieres cerrar? El progreso se perderá.</p><div class="flex gap-4"><button id="confirmCloseYes" class="w-1/2 bg-red-600 text-white py-2.5 rounded-lg">Sí, Cerrar</button><button id="confirmCloseNo" class="w-1/2 bg-gray-600 text-white py-2.5 rounded-lg">No</button></div></div>`; document.body.appendChild(confirmCloseModal); openModal(confirmCloseModal); document.getElementById('confirmCloseYes').onclick = () => { isWorkoutInProgress = false; clearInterval(workoutTimerInterval); currentWorkoutSummaryData = []; releaseWakeLock(); /* NEW: Release lock on close */ closeModalElement(modalElement); closeModalElement(confirmCloseModal); confirmCloseModal.remove(); if (callbackOnConfirm) callbackOnConfirm(); }; document.getElementById('confirmCloseNo').onclick = () => { closeModalElement(confirmCloseModal); confirmCloseModal.remove(); }; } else { closeModalElement(modalElement); if (callbackOnConfirm) callbackOnConfirm(); } }
        
        // MODIFIED: toggleWorkoutState to include Wake Lock
        function toggleWorkoutState() { 
            if (isWorkoutInProgress) { 
                openWorkoutSummaryModal(); 
                releaseWakeLock(); // NEW: Release lock when finishing workout
            } else { 
                isWorkoutInProgress = true; 
                workoutStartTime = Date.now(); 
                workoutTimerInterval = setInterval(updateWorkoutDuration, 1000); 
                currentSessionId = crypto.randomUUID();
                updateAllExerciseCardInputStates(); 
                requestWakeLock(); // NEW: Request lock when starting workout
            } 
        }
        // MODIFIED: Update workout duration to HH:MM format
        function updateWorkoutDuration() { 
            if (!isWorkoutInProgress || !workoutStartTime) return; 
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000); 
            const h = Math.floor(elapsed / 3600);
            const m = Math.floor((elapsed % 3600) / 60);
            const timeString = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            const durationEl = document.getElementById('workoutDuration'); 
            if (durationEl) durationEl.textContent = timeString; 
        }
        
        function getHistoricalMaxRm(exerciseName) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => e.exercise_name === exerciseName);
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) {
                            maxRm = currentRm;
                        }
                    }
                });
            });
            return maxRm;
        }

        function getHistoricalMaxRmExcludingSession(exerciseName, sessionDate, sessionTime) {
            let maxRm = 0;
            const historyForExercise = individualExerciseLogs.filter(e => 
                e.exercise_name === exerciseName && 
                !(e.date === sessionDate && e.time === sessionTime)
            );
            if (historyForExercise.length === 0) return 0;
            historyForExercise.forEach(entry => {
                const setsPerformed = entry.sets_performed || [];
                setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        const currentRm = calculateEpley1RM(set.kg, set.reps);
                        if (currentRm > maxRm) {
                            maxRm = currentRm;
                        }
                    }
                });
            });
            return maxRm;
        }

        function showNewRecordAlert(newRm) { newRecordText.textContent = `¡Has alcanzado un 1RM estimado de ${newRm.toFixed(1)}kg!`; openModal(newRecordModal); }
        function closeQuickModeWorkoutModal() { confirmBeforeClosingWorkoutModal(quickModeWorkoutModal, () => { releaseWakeLock(); }); }

        function updateAllExerciseCardInputStates() { 
            document.querySelectorAll('#quickModeWorkoutModal .quick-mode-exercise-item').forEach(card => { 
                const exerciseName = card.dataset.currentName; 
                const logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseName);
                const isFinalized = logEntry && logEntry.setsPerformed && logEntry.setsPerformed.length > 0;
                const isTimeBasedExercise = card.dataset.isTimeBased === "true";
                const isTimerActiveForThisCard = isTimeBasedExercise && currentTimedExerciseCardId === card.id && workTimerInterval !== null;
                let isDisabledOverall = !isWorkoutInProgress || isFinalized || isTimerActiveForThisCard;
                const quickViewBody = document.getElementById(`quickViewBody-${card.id}`);
                const fullLogViewBody = document.getElementById(`fullLogViewBody-${card.id}`);

                if (quickViewBody) {
                    const kgInput = quickViewBody.querySelector('input[aria-label*="Peso"]');
                    const repsInput = quickViewBody.querySelector('input[aria-label*="Repeticiones"]');
                    const registerBtn = quickViewBody.querySelector('.quick-mode-register-button');
                    kgInput.disabled = isDisabledOverall;
                    repsInput.disabled = isDisabledOverall;
                    registerBtn.disabled = isDisabledOverall;
                    if (isTimeBasedExercise && !isTimerActiveForThisCard && !isFinalized) {
                        repsInput.disabled = false;
                    }
                    if (kgInput.disabled) kgInput.classList.add('bg-gray-700'); else kgInput.classList.remove('bg-gray-700');
                    if (repsInput.disabled) repsInput.classList.add('bg-gray-700'); else repsInput.classList.remove('bg-gray-700');
                    if (isTimerActiveForThisCard) {
                        registerBtn.innerHTML = '<i class="fas fa-hourglass-half text-xl"></i>';
                    } else if (isFinalized) {
                        registerBtn.innerHTML = '<i class="fas fa-check-double text-xl"></i>';
                        registerBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                        registerBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    } else {
                        const originalExerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
                        if (originalExerciseData.isSuperset || originalExerciseData.isEMOM || originalExerciseData.circuitDetails) {
                             registerBtn.innerHTML = '<i class="fas fa-list-ol text-xl"></i>';
                        } else {
                            registerBtn.innerHTML = '<i class="fas fa-check text-xl"></i>';
                        }
                        registerBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        registerBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    }
                }
                
                if (fullLogViewBody) {
                    fullLogViewBody.querySelectorAll('.set-data-row').forEach(row => {
                        const setNumber = parseInt(row.dataset.setNumber, 10);
                        const kgInput = row.querySelector('input[aria-label*="Peso"]');
                        const repsInput = row.querySelector('input[aria-label*="Reps"]');
                        const existingSet = logEntry ? logEntry.setsPerformed.find(s => s.serie === setNumber) : null;
                        const isSetAlreadyLogged = existingSet && existingSet.isQuickMode === undefined;
                        const shouldBeDisabled = isSetAlreadyLogged || !isWorkoutInProgress || isFinalized;
                        if (kgInput) {
                            kgInput.readOnly = shouldBeDisabled;
                            kgInput.disabled = shouldBeDisabled;
                            if (shouldBeDisabled) kgInput.classList.add('bg-gray-700'); else kgInput.classList.remove('bg-gray-700');
                        }
                        if (repsInput) {
                            repsInput.readOnly = shouldBeDisabled;
                            repsInput.disabled = shouldBeDisabled;
                            if (shouldBeDisabled) repsInput.classList.add('bg-gray-700'); else repsInput.classList.remove('bg-gray-700');
                        }
                    });
                    fullLogViewBody.querySelectorAll('.actions-footer button').forEach(btn => {
                        btn.disabled = !isWorkoutInProgress || isFinalized;
                    });
                }

                card.querySelectorAll('.quick-mode-header-buttons .quick-action-btn').forEach(btn => {
                    if (btn.id && btn.id.startsWith('toggleViewBtn-')) {
                        btn.disabled = isFinalized;
                    } else {
                        btn.disabled = isFinalized;
                    }
                });

                card.classList.remove('completed-good', 'completed-bad');
                if (isFinalized && logEntry.completionState && logEntry.completionState !== 'neutral') {
                    card.classList.add(`completed-${logEntry.completionState}`);
                }
            });
        }
        
        function startQuickMode(dayKey) { 
            currentActiveDayKey = dayKey; 
            if (typeof workoutData === 'undefined' || !workoutData[dayKey]) { return; } 
            const dayData = workoutData[dayKey]; 
            quickModeWorkoutModalTitle.textContent = dayData.name.toUpperCase(); 
            quickModeExerciseList.innerHTML = ''; 
            currentWorkoutSummaryData = []; 
            currentTimedExerciseCardId = null;
            currentTimedExerciseSetNumber = 0;
            totalSetsForCurrentTimedExercise = 0;
            currentRestDurationForTimedExercise = 0;
            timedExerciseSetsLogged = [];
            dayData.exercises.forEach((exerciseItem) => { 
                if (exerciseItem.isSuperset || exerciseItem.isEMOM || exerciseItem.circuitDetails) { 
                    quickModeExerciseList.appendChild(createQuickModeSupersetCard(dayKey, exerciseItem.order, exerciseItem));
                } else { 
                    quickModeExerciseList.appendChild(createQuickModeExerciseCard(dayKey, exerciseItem.order, exerciseItem, false, null));
                } 
            }); 
            isWorkoutInProgress = false; 
            toggleWorkoutState(); 
            openModal(quickModeWorkoutModal); 
        }

        function createQuickModeExerciseCard(dayKey, mainOrder, exerciseInput, isSubItem, specialData = null) { 
            const card = document.createElement('div'); 
            const cardId = isSubItem ? `qm-ex-${dayKey}-${mainOrder}-${exerciseInput.subOrder}` : `qm-ex-${dayKey}-${mainOrder}`; 
            card.id = cardId; 
            card.className = `quick-mode-exercise-item`; 
            card.dataset.dayKey = dayKey; 
            card.dataset.mainOrder = String(mainOrder); 
            card.dataset.subOrder = exerciseInput.subOrder !== undefined ? String(exerciseInput.subOrder) : ''; 
            card.dataset.currentName = exerciseInput.name; 
            card.dataset.originalExerciseData = JSON.stringify(exerciseInput); 
            const primordialData = exerciseInput.primordialExerciseData ? exerciseInput.primordialExerciseData : exerciseInput; 
            card.dataset.primordialExerciseData = JSON.stringify(primordialData); 
            card.dataset.isSwapped = (exerciseInput.name !== primordialData.name).toString(); 
            card.dataset.viewMode = 'quick';
            const isTimeBasedExercise = isTimeBased(exerciseInput.reps);
            const inputType = isTimeBasedExercise ? 'text' : 'number';
            const repsPlaceholder = isTimeBasedExercise ? exerciseInput.reps : (getLastLoggedDataForSet(exerciseInput.name, 1).reps || exerciseInput.reps || 'Reps');
            const kgPlaceholder = getLastLoggedDataForSet(exerciseInput.name, 1).kg || 'Kg';
            const repsOnClick = isTimeBasedExercise ? `onclick="handleTimeBasedRepsClick(this, '${cardId}')"` : '';
            const dataIsTimeBased = isTimeBasedExercise ? `data-is-time-based="true"` : '';
            card.dataset.totalSets = String(exerciseInput.sets || 1);
            const repsString = isTimeBasedExercise ? exerciseInput.reps : `${exerciseInput.reps || 'N/A'} reps`; 
            const lastData = getLastLoggedDataForSet(exerciseInput.name, 1); 
            let increaseWeightIndicator = ''; 
            if (getLastWorkoutEntry(exerciseInput.name) && getLastWorkoutEntry(exerciseInput.name).completion_state === 'good') { 
                increaseWeightIndicator = `<div class="increase-weight-btn" title="¡Buen trabajo! Sube el peso en esta sesión."><i class="fas fa-arrow-up text-gray-900"></i></div>`; 
            } 
            let seriesText = `Series: ${specialData ? specialData.series : (exerciseInput.sets || '1')}`; 
            let restHtml = ''; 
            const restDurationMatch = typeof exerciseInput.rest === 'string' ? exerciseInput.rest.match(/(\d+)s/) : null; 
            if(restDurationMatch && !isTimeBasedExercise){
                const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item'));
                const currentCardIndex = allExerciseCards.findIndex(card => card.id === cardId);
                let nextExerciseForRest = null;
                if (currentCardIndex !== -1 && currentCardIndex + 1 < allExerciseCards.length) {
                    const nextCard = allExerciseCards[currentCardIndex + 1];
                    nextExerciseForRest = {
                        name: nextCard.dataset.currentName,
                        reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                        kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--'
                    };
                }
                restHtml = `<button onclick='startRestTimer(${parseInt(restDurationMatch[1])}, ${JSON.stringify(nextExerciseForRest)})' title="Descanso" class="quick-action-btn"><i class="fas fa-clock"></i></button>`; 
            } 
            let actionButtonsHtml = '';
            const originalEscapedName = (exerciseInput.name || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
            actionButtonsHtml += `<button onclick="viewExerciseHistoryFromLog('${originalEscapedName}')" title="Ver Histórico" class="quick-action-btn"><i class="fas fa-chart-line"></i></button>`;
            if (!isSubItem) {
                actionButtonsHtml += `<button onclick="openWarmupModal()" title="Calculadora de Aproximación" class="quick-action-btn"><i class="fas fa-fire"></i></button>`;
            }
            const alternatives = exerciseAlternatives[primordialData.name] || [];
            if (alternatives.length > 0 || card.dataset.isSwapped === "true") {
                actionButtonsHtml += `<button onclick="openSwapExerciseModal('${cardId}')" title="Cambiar Ejercicio" class="quick-action-btn"><i class="fas fa-exchange-alt"></i></button>`;
            }
            const notesHtml = exerciseInput.notes ? `<div class="notes">${exerciseInput.notes}</div>` : '';
            const imageUrl = exerciseInput.imageUrl;
            const videoUrl = exerciseInput.videoUrl;
            let imageHtml = '';
            if (imageUrl) {
                const imageTag = `<img src="${imageUrl}" alt="Preview de ${exerciseInput.name}" class="w-24 h-24 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/4A5568/FACC15?text=No+Img';">`;
                if (videoUrl) {
                    imageHtml = `<a href="${videoUrl}" target="_blank" class="flex-shrink-0" title="Ver vídeo">${imageTag}</a>`;
                } else {
                    imageHtml = `<div class="flex-shrink-0">${imageTag}</div>`;
                }
            }
            card.innerHTML = ` 
                <div class="quick-mode-exercise-header"> 
                    <div class="flex-top-row">
                        ${imageHtml}
                        <div class="info-and-settings">
                            <div class="info-line-with-settings">
                                <div class="info"> 
                                    <div class="title-line"> 
                                        <strong>${isSubItem ? `${mainOrder}.${exerciseInput.subOrder}` : exerciseInput.order}. ${exerciseInput.name}</strong> ${increaseWeightIndicator} 
                                    </div> 
                                    <span>${seriesText} | Objetivo: ${repsString}</span> 
                                </div> 
                            </div>
                        </div>
                    </div>
                </div> 
                <div id="quickViewBody-${cardId}" class="quick-view-body"> 
                    <input type="number" value="${lastData.kg || ''}" placeholder="${kgPlaceholder}" class="quick-mode-input" aria-label="Peso para ${exerciseInput.name}"> 
                    <input type="${inputType}" value="${lastData.reps || ''}" placeholder="${repsPlaceholder}" class="quick-mode-input" aria-label="Repeticiones para ${exerciseInput.name}" ${repsOnClick} ${dataIsTimeBased}> 
                    <button class="quick-mode-register-button" onclick="logQuickModeSetFromCard(this, '${cardId}')" aria-label="Registrar set"> 
                        <i class="fas fa-check"></i> 
                    </button> 
                </div> 
                <div class="quick-mode-header-buttons">
                    ${restHtml} 
                    <button id="toggleViewBtn-${cardId}" onclick='toggleExerciseCardView("${cardId}")' title="Registro Completo" class="quick-action-btn"><i class="fas fa-list-ol"></i></button> 
                    ${actionButtonsHtml}
                </div>
                <div id="fullLogViewBody-${cardId}" class="full-log-view-body" style="display: none;"></div>
                ${notesHtml}
            `; 
            return card; 
        }

        function createQuickModeSupersetCard(dayKey, mainOrder, supersetInput) { 
            const card = document.createElement('div'); 
            card.className = 'quick-mode-superset-container'; 
            card.id = `qm-superset-${dayKey}-${mainOrder}`; 
            let controlButtonHtml = ''; 
            let specialData = null; 
            let titleText = ''; 
            if (supersetInput.isEMOM) { 
                titleText = 'EMOM'; 
                controlButtonHtml = `<button onclick="startEmom('${dayKey}', ${mainOrder})" class="bg-purple-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR EMOM</button>`; 
                if (supersetInput.emomDetails && supersetInput.items) { 
                    const exerciseCount = supersetInput.items.length; 
                    const totalIntervals = parseInt(supersetInput.emomDetails.totalIntervals, 10); 
                    if (exerciseCount > 0 && totalIntervals > 0) { 
                        specialData = { series: Math.ceil(totalIntervals / exerciseCount) }; 
                    } 
                } 
            } else if (supersetInput.circuitDetails) { 
                titleText = 'CIRCUITO'; 
                controlButtonHtml = `<button onclick="startCircuit('${dayKey}', ${mainOrder})" class="bg-green-600 text-white px-3 py-1 rounded-md text-sm font-semibold">EMPEZAR CIRCUITO</button>`; 
                specialData = { series: supersetInput.circuitDetails.totalRounds }; 
            } else if (supersetInput.isSuperset) { 
                titleText = 'SUPERSERIE'; 
            } else { 
                titleText = supersetInput.name; 
            } 
            card.innerHTML = `<div class="flex justify-between items-center"><h3 class="exercise-card-container-title" style="border-bottom:0; margin-bottom:0;">${mainOrder}. ${titleText.toUpperCase()}</h3><div>${controlButtonHtml}</div></div>`; 
            if (supersetInput.items && Array.isArray(supersetInput.items)) { 
                supersetInput.items.forEach((subExercise) => { 
                    card.appendChild(createQuickModeExerciseCard(dayKey, mainOrder, subExercise, true, specialData));
                }); 
            } 
            return card; 
        }
        
        function toggleExerciseCardView(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const toggleButton = document.getElementById(`toggleViewBtn-${cardId}`);
            const quickViewBody = document.getElementById(`quickViewBody-${card.id}`);
            const fullLogViewBody = document.getElementById(`fullLogViewBody-${card.id}`);
            if (card.dataset.viewMode === 'quick') {
                quickViewBody.style.display = 'none';
                fullLogViewBody.style.display = 'block';
                card.dataset.viewMode = 'full-log';
                toggleButton.innerHTML = '<i class="fas fa-times"></i>';
                toggleButton.title = 'Cerrar Registro Detallado';
                renderFullLogViewContent(card);
            } else {
                if (hasUnsavedFullLogChanges) {
                    showCustomConfirm("Si cierras sin registrar, los cambios se perderán. ¿Deseas continuar?", () => {
                        hasUnsavedFullLogChanges = false;
                        quickViewBody.style.display = 'grid';
                        fullLogViewBody.style.display = 'none';
                        card.dataset.viewMode = 'quick';
                        toggleButton.innerHTML = '<i class="fas fa-list-ol"></i>';
                        toggleButton.title = 'Registro Completo';
                    });
                } else {
                    quickViewBody.style.display = 'grid';
                    fullLogViewBody.style.display = 'none';
                    card.dataset.viewMode = 'quick';
                    toggleButton.innerHTML = '<i class="fas fa-list-ol"></i>';
                    toggleButton.title = 'Registro Completo';
                }
            }
            updateAllExerciseCardInputStates();
        }

        function renderFullLogViewContent(card) {
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const fullLogViewBody = document.getElementById(`fullLogViewBody-${card.id}`);
            fullLogViewBody.innerHTML = '';
            let repGoals = []; 
            const repsValue = exerciseData.reps; 
            if (typeof repsValue === 'string' && repsValue.includes(',')) { 
                repGoals = repsValue.split(',').map(r => r.trim()); 
            } 
            let numberOfSets = parseInt(exerciseData.sets, 10); 
            if(repGoals.length > numberOfSets) numberOfSets = repGoals.length; 
            const parentSuperset = card.closest('.quick-mode-superset-container');
            if (parentSuperset) {
                const mainOrder = parseInt(card.dataset.mainOrder);
                const supersetBlockData = workoutData[card.dataset.dayKey].exercises.find(ex => ex.order === mainOrder);
                if (supersetBlockData && supersetBlockData.isEMOM) {
                    const exerciseCount = supersetBlockData.items.length;
                    const totalIntervals = parseInt(supersetBlockData.emomDetails.totalIntervals, 10);
                    if (exerciseCount > 0 && totalIntervals > 0) numberOfSets = Math.ceil(totalIntervals / exerciseCount);
                } else if (supersetBlockData && supersetBlockData.circuitDetails) {
                    numberOfSets = parseInt(supersetBlockData.circuitDetails.totalRounds, 10);
                }
            }
            if(isNaN(numberOfSets) || numberOfSets <= 0) numberOfSets = 1; 
            let setsHtml = '';
            for (let i = 1; i <= numberOfSets; i++) { 
                const lastSetData = getLastLoggedDataForSet(exerciseData.name, i); 
                let repsTargetForThisSet = repGoals.length > 0 ? (repGoals[i - 1] || repGoals[repGoals.length - 1]) : (Array.isArray(exerciseData.reps) ? (exerciseData.reps[i-1] || exerciseData.reps[0]) : exerciseData.reps); 
                const repsPlaceholder = lastSetData.reps || repsTargetForThisSet || 'Reps'; 
                const inputType = isTimeBased(repsTargetForThisSet) ? 'text' : 'number'; 
                const existingLog = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseData.name);
                const existingSet = existingLog ? existingLog.setsPerformed.find(s => s.serie === i) : null;
                const initialKg = existingSet ? existingSet.kg : (lastSetData.kg || '');
                const initialReps = existingSet ? existingSet.reps : (lastSetData.reps || '');
                const isSetLogged = existingSet && existingSet.isQuickMode === undefined;
                const currentCompletionState = existingSet ? existingSet.completionState : 'neutral';
                const repsClass = currentCompletionState === 'good' ? 'history-reps-good' : (currentCompletionState === 'bad' ? 'history-reps-bad' : '');
                setsHtml += `
                    <div class="set-data-row" data-set-number="${i}">
                        <span class="text-gray-300 w-auto pr-2 text-sm shrink-0">S.${i}: ${repsTargetForThisSet || ''}</span>
                        <div class="set-input flex-grow flex gap-2">
                            <input type="number" value="${initialKg}" placeholder="Kg" class="p-1.5 border border-gray-600 bg-gray-900 text-white rounded text-center text-sm w-full" aria-label="Peso para S.${i}" ${isSetLogged ? 'readonly' : ''}>
                            <input type="${inputType}" value="${initialReps}" placeholder="Reps" class="p-1.5 border border-gray-600 bg-gray-900 text-white rounded text-center text-sm w-full ${repsClass}" aria-label="Reps para S.${i}" ${isSetLogged ? 'readonly' : ''}>
                        </div>
                    </div>
                `;
            }
            // MODIFIED: Removed the "Completar Series" button and made "Registrar Series" full-width
            fullLogViewBody.innerHTML = `
                <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    ${setsHtml}
                </div>
                <div class="actions-footer">
                    <button onclick="logFullSetsForCard('${card.id}')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2.5 px-4 rounded-lg shadow-md">
                        Registrar Series
                    </button>
                </div>
            `;
            hasUnsavedFullLogChanges = false;
            fullLogViewBody.querySelectorAll('.set-input input').forEach(input => {
                input.addEventListener('input', () => {
                    hasUnsavedFullLogChanges = true;
                });
            });
        }

        function completeAllSetsForCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const firstSetRow = card.querySelector('.set-data-row');
            if (firstSetRow) {
                const firstKgInput = firstSetRow.querySelector('input[aria-label*="Peso"]');
                const firstRepsInput = firstSetRow.querySelector('input[aria-label*="Repeticiones"]');
                const firstKgValue = firstKgInput ? firstKgInput.value.trim() : '';
                const firstRepsValue = firstRepsInput ? firstRepsInput.value.trim() : '';
                if (firstKgValue !== '' || firstRepsValue !== '') {
                    card.querySelectorAll('.set-data-row').forEach((row, index) => {
                        const kgInput = row.querySelector('input[aria-label*="Peso"]');
                        const repsInput = row.querySelector('input[aria-label*="Repeticiones"]');
                        if (kgInput && kgInput.value.trim() === '' && !kgInput.readOnly) {
                            kgInput.value = firstKgValue;
                        }
                        if (repsInput && repsInput.value.trim() === '' && !repsInput.readOnly) {
                            repsInput.value = firstRepsValue;
                        }
                        if (kgInput.value.trim() !== firstKgValue || repsInput.value.trim() !== firstRepsValue) {
                            hasUnsavedFullLogChanges = true;
                        }
                    });
                }
            }
            showCustomAlert("Series vacías completadas con los valores de la primera serie.", "info");
            hasUnsavedFullLogChanges = true;
        }

        function logFullSetsForCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para registrar series.", "warning");
                return;
            }
            const exerciseName = card.dataset.currentName;
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const setsData = [];
            let allSetsFilledForThisExercise = true;
            let maxRmInSession = 0;
            let overallCompletionState = 'good';
            let heaviestSet = { kg: '0', reps: '0' };
            card.querySelectorAll('.set-data-row').forEach(row => {
                const setNumber = parseInt(row.dataset.setNumber, 10);
                const kgInput = row.querySelector('input[aria-label*="Peso"]');
                const repsInput = row.querySelector('input[aria-label*="Reps"]');
                const kg = kgInput.value.trim();
                const reps = repsInput.value.trim();
                if (!isTimeBased(repsInput.placeholder) && (kg === '' || reps === '')) {
                    allSetsFilledForThisExercise = false;
                }
                const targetReps = Array.isArray(exerciseData.reps) ? exerciseData.reps[setNumber - 1] : exerciseData.reps;
                const completionState = getRepCompletionState(reps, targetReps);
                if (completionState === 'bad') {
                    overallCompletionState = 'bad';
                } else if (completionState === 'neutral' && overallCompletionState !== 'bad') {
                    overallCompletionState = 'neutral';
                }
                setsData.push({ serie: setNumber, kg: kg || '0', reps: reps || '0', completionState });
                if (kg !== '' && reps !== '' && !isTimeBased(reps)) {
                    const currentRm = calculateEpley1RM(kg, reps);
                    if (currentRm > maxRmInSession) maxRmInSession = currentRm;
                    if (parseFloat(kg) > parseFloat(heaviestSet.kg)) heaviestSet = { kg, reps };
                }
                kgInput.readOnly = true;
                kgInput.disabled = true;
                repsInput.readOnly = true;
                repsInput.disabled = true;
                repsInput.classList.remove('history-reps-good', 'history-reps-bad');
                if (completionState === 'good') repsInput.classList.add('history-reps-good');
                else if (completionState === 'bad') repsInput.classList.add('history-reps-bad');
            });
            if (!allSetsFilledForThisExercise) {
                showCustomAlert(`Por favor, completa todas las series para el ejercicio "${exerciseName}" o rellena los campos vacíos.`, 'warning');
                return;
            } else {
                const logEntry = {
                    exerciseName,
                    date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    rawDate: new Date().toISOString(),
                    dayKey: card.dataset.dayKey,
                    setsPerformed: setsData,
                    completionState: overallCompletionState
                };
                const existingEntryIndex = currentWorkoutSummaryData.findIndex(e => e.exerciseName === exerciseName);
                if (existingEntryIndex > -1) {
                    currentWorkoutSummaryData[existingEntryIndex] = logEntry;
                } else {
                    currentWorkoutSummaryData.push(logEntry);
                }
                card.dataset.completionState = overallCompletionState;
                const mainKgInput = document.getElementById(`quickViewBody-${cardId}`).querySelector('input[aria-label*="Peso"]');
                const mainRepsInput = document.getElementById(`quickViewBody-${cardId}`).querySelector('input[aria-label*="Repeticiones"]');
                if (mainKgInput) mainKgInput.value = heaviestSet.kg;
                if (mainRepsInput && !isTimeBased(mainRepsInput.placeholder)) mainRepsInput.value = heaviestSet.reps;
                hasUnsavedFullLogChanges = false;
                toggleExerciseCardView(cardId);
                updateAllExerciseCardInputStates();
            }
        }
        
        function logSingleSetAndStartRest(button, cardId, setNumber) {
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para registrar series.", "warning");
                return;
            }
            const setRow = button.closest('.set-data-row');
            if (!setRow) return;
            const kgInput = setRow.querySelector('input[aria-label*="Peso"]');
            const repsInput = setRow.querySelector('input[aria-label*="Repeticiones"]');
            const kg = kgInput.value.trim();
            const reps = repsInput.value.trim();
            if (kg === '' || reps === '') {
                showCustomAlert("Por favor, introduce el peso y las repeticiones para esta serie.", "warning");
                return;
            }
            const card = document.getElementById(cardId);
            if (!card) return;
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const targetReps = Array.isArray(exerciseData.reps) ? exerciseData.reps[setNumber - 1] : exerciseData.reps;
            const completionState = getRepCompletionState(reps, targetReps);
            kgInput.readOnly = true;
            kgInput.disabled = true;
            repsInput.readOnly = true;
            repsInput.disabled = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check-double"></i>';
            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            button.classList.add('bg-green-500', 'hover:bg-green-600');
            repsInput.classList.remove('history-reps-good', 'history-reps-bad');
            if (completionState === 'good') repsInput.classList.add('history-reps-good');
            else if (completionState === 'bad') repsInput.classList.add('history-reps-bad');
            let logEntry = currentWorkoutSummaryData.find(e => e.exerciseName === exerciseData.name);
            if (!logEntry) {
                logEntry = {
                    exerciseName: exerciseData.name,
                    date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    rawDate: new Date().toISOString(),
                    dayKey: card.dataset.dayKey,
                    setsPerformed: [],
                    completionState: 'neutral'
                };
                currentWorkoutSummaryData.push(logEntry);
            }
            const existingSetIndex = logEntry.setsPerformed.findIndex(s => s.serie === setNumber);
            if (existingSetIndex > -1) {
                logEntry.setsPerformed[existingSetIndex] = { serie: setNumber, kg, reps, completionState };
            } else {
                logEntry.setsPerformed.push({ serie: setNumber, kg, reps, completionState });
                logEntry.setsPerformed.sort((a, b) => a.serie - b.serie);
            }
            let overallCompletion = 'good';
            for (const s of logEntry.setsPerformed) {
                if (s.completionState === 'bad') {
                    overallCompletion = 'bad';
                    break;
                } else if (s.completionState === 'neutral') {
                    overallCompletion = 'neutral';
                }
            }
            logEntry.completionState = overallCompletion;
            card.dataset.completionState = overallCompletion;
            let heaviestSet = { kg: '0', reps: '0' };
            logEntry.setsPerformed.forEach(s => {
                if (parseFloat(s.kg) > parseFloat(heaviestSet.kg)) heaviestSet = { kg: s.kg, reps: s.reps };
            });
            const mainKgInput = document.getElementById(`quickViewBody-${cardId}`).querySelector('input[aria-label*="Peso"]');
            const mainRepsInput = document.getElementById(`quickViewBody-${cardId}`).querySelector('input[aria-label*="Repeticiones"]');
            if (mainKgInput) mainKgInput.value = heaviestSet.kg;
            if (mainRepsInput && !isTimeBased(mainRepsInput.placeholder)) mainRepsInput.value = heaviestSet.reps;
            hasUnsavedFullLogChanges = true;
            const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
            if (restDurationMatch) {
                const restSeconds = parseInt(restDurationMatch[1], 10);
                if (restSeconds > 0) {
                    const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                    const currentCardElement = document.getElementById(cardId);
                    const currentCardIndex = allExerciseCards.findIndex(el => el.id === cardId || el.contains(currentCardElement));
                    let nextExerciseForRest = null;
                    if (currentCardIndex !== -1) {
                        let nextCard = null;
                        for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                            if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) {
                                nextCard = allExerciseCards[i];
                                break;
                            } else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) {
                                const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item');
                                if (firstSubExercise) {
                                    nextCard = firstSubExercise;
                                    break;
                                }
                            }
                        }
                        if (nextCard) {
                            nextExerciseForRest = {
                                name: nextCard.dataset.currentName,
                                reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                                kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--'
                            };
                        }
                    }
                    startRestTimer(restSeconds, nextExerciseForRest);
                }
            }
            updateAllExerciseCardInputStates();
        }

        function logQuickModeSetFromCard(button, cardId) {
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para registrar series.", "warning");
                return;
            }
            const card = document.getElementById(cardId);
            if (!card) return;
            const kgInput = card.querySelector('.quick-view-body input[aria-label*="Peso"]');
            const repsInput = card.querySelector('.quick-view-body input[aria-label*="Repeticiones"]');
            const kg = kgInput.value.trim();
            const reps = repsInput.value.trim();
            if (kg === '' || reps === '') {
                showCustomAlert("Por favor, introduce el peso y las repeticiones.", "warning");
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const exerciseName = exerciseData.name;
            const targetReps = exerciseData.reps;
            const completionState = getRepCompletionState(reps, targetReps);
            const setsData = [{ serie: 1, kg: kg || '0', reps: reps || '0', completionState, isQuickMode: true }];
            const logEntry = {
                exerciseName,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                rawDate: new Date().toISOString(),
                dayKey: card.dataset.dayKey,
                setsPerformed: setsData,
                completionState: completionState
            };
            const existingEntryIndex = currentWorkoutSummaryData.findIndex(e => e.exerciseName === exerciseName);
            if (existingEntryIndex > -1) {
                currentWorkoutSummaryData[existingEntryIndex] = logEntry;
            } else {
                currentWorkoutSummaryData.push(logEntry);
            }
            card.dataset.completionState = completionState;
            kgInput.readOnly = true;
            kgInput.disabled = true;
            repsInput.readOnly = true;
            repsInput.disabled = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check-double text-xl"></i>';
            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            button.classList.add('bg-green-500', 'hover:bg-green-600');
            repsInput.classList.remove('history-reps-good', 'history-reps-bad');
            if (completionState === 'good') repsInput.classList.add('history-reps-good');
            else if (completionState === 'bad') repsInput.classList.add('history-reps-bad');
            showCustomAlert("¡Set registrado con éxito!", "info");
            const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
            if (restDurationMatch) {
                const restSeconds = parseInt(restDurationMatch[1], 10);
                if (restSeconds > 0) {
                    const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                    const currentCardElement = document.getElementById(cardId);
                    const currentCardIndex = allExerciseCards.findIndex(el => el.id === cardId || el.contains(currentCardElement));
                    let nextCard = null;
                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) {
                            nextCard = allExerciseCards[i];
                            break;
                        } else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) {
                            const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item');
                            if (firstSubExercise) {
                                nextCard = firstSubExercise;
                                break;
                            }
                        }
                    }
                    if (nextCard) {
                        nextExerciseForRest = {
                            name: nextCard.dataset.currentName,
                            reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                            kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--'
                        };
                    }
                }
            }
            updateAllExerciseCardInputStates();
        }

        function openWorkoutSummaryModal() {
            const elapsed = workoutStartTime > 0 ? Math.floor((Date.now() - workoutStartTime) / 1000) : 0;
            const h = Math.floor(elapsed / 3600), m = Math.floor((elapsed % 3600) / 60);
            // MODIFIED: Format to HH:MM
            workoutSummaryTotalTime.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            let totalVolume = 0;
            currentWorkoutSummaryData.forEach(entry => {
                entry.setsPerformed.forEach(set => {
                    if (!isTimeBased(set.reps)) {
                        totalVolume += (parseFloat(set.kg) || 0) * (parseInt(set.reps) || 0);
                    }
                });
            });
            workoutSummaryTotalVolume.textContent = `${totalVolume.toFixed(0)} Kg`;
            workoutSummaryExerciseList.innerHTML = '';
            if (currentWorkoutSummaryData.length === 0) {
                workoutSummaryExerciseList.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios.</p>';
            } else {
                currentWorkoutSummaryData.forEach(entry => {
                    let displayInfo = entry.setsPerformed.map(s => {
                        const repsUnit = isTimeBased(s.reps) ? 's' : 'r';
                        return `${s.kg}kg x ${s.reps}${repsUnit}`;
                    }).join(', ');
                    workoutSummaryExerciseList.innerHTML += `<div class="summary-exercise-item"><p class="font-semibold text-yellow-400">${entry.exerciseName}</p><p class="text-gray-300 text-sm">${displayInfo}</p></div>`;
                });
            }
            registerWorkoutButton.onclick = async () => {
                registerWorkoutButton.innerHTML = 'Procesando...';
                registerWorkoutButton.disabled = true;
                releaseWakeLock(); // NEW: Release lock on registration
                try {
                    const individualLogsToInsert = currentWorkoutSummaryData.map(entry => ({
                        client_id: userIdentifier,
                        date: entry.date,
                        time: entry.time,
                        raw_date: entry.rawDate,
                        day_key: entry.dayKey,
                        exercise_name: entry.exerciseName,
                        sets_performed: entry.setsPerformed,
                        completion_state: entry.completionState,
                        session_id: currentSessionId
                    }));
                    if (individualLogsToInsert.length > 0) {
                        const { error: individualInsertError } = await supabase
                            .from('workout_logs')
                            .insert(individualLogsToInsert);
                        if (individualInsertError) {
                            throw new Error(`Error inserting individual exercise logs: ${individualInsertError.message}`);
                        }
                    }
                    const sessionSummaryLog = {
                        client_id: userIdentifier,
                        date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                        time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                        raw_date: new Date().toISOString(),
                        exercise_name: "Workout Session Summary",
                        // MODIFIED: Add workout name to the summary log
                        name_workout: workoutData[currentActiveDayKey].name,
                        sets_performed: JSON.stringify(currentWorkoutSummaryData),
                        completion_state: "completed",
                        session_id: currentSessionId,
                        total_time_session: workoutSummaryTotalTime.textContent,
                        total_volume_session: parseFloat(workoutSummaryTotalVolume.textContent.replace(' Kg', ''))
                    };
                    const { error: summaryInsertError } = await supabase
                        .from('workout_logs')
                        .insert([sessionSummaryLog]);
                    if (summaryInsertError) {
                        throw new Error(`Error inserting workout session summary: ${summaryInsertError.message}`);
                        }
                    showCustomAlert("¡Entrenamiento registrado con éxito!", "info");
                    await loadWorkoutLogs();
                    isWorkoutInProgress = false;
                    registerWorkoutButton.innerHTML = '¡Registrado!';
                    
                    // MODIFIED: Removed video prompt logic, now just closes modals
                    setTimeout(() => {
                        closeModalElement(workoutSummaryModal);
                        closeModalElement(quickModeWorkoutModal);
                        if(registerWorkoutButton) {
                            registerWorkoutButton.innerHTML = 'Registrar';
                            registerWorkoutButton.disabled = false;
                        }
                    }, 1500);

                } catch (error) {
                    console.error("Unexpected error during workout registration:", error);
                    showCustomAlert(`Ha ocurrido un error inesperado al registrar el entrenamiento: ${error.message}`, "error");
                    registerWorkoutButton.innerHTML = 'Error';
                    setTimeout(() => { registerWorkoutButton.innerHTML = 'Registrar'; registerWorkoutButton.disabled = false; }, 2000);
                }
            };
            openModal(workoutSummaryModal);
        }

        function closeWorkoutSummaryModal(registered = false) { closeModalElement(workoutSummaryModal); if (registered) { currentWorkoutSummaryData = []; closeModalElement(quickModeWorkoutModal); } }
        
        // MODIFIED: Updated parsing logic to handle hh:mm format
        function parseDurationToSeconds(durationInput) {
            if (durationInput === null || typeof durationInput === 'undefined' || durationInput === '') { return 0; }
            const durationString = String(durationInput).trim().toLowerCase();
            let totalSeconds = 0;
            
            const hmsMatch = durationString.match(/^(\d+):(\d+):(\d+)$/);
            if(hmsMatch) {
                totalSeconds = parseInt(hmsMatch[1], 10) * 3600 + parseInt(hmsMatch[2], 10) * 60 + parseInt(hmsMatch[3], 10);
            } else {
                 const hmMatch = durationString.match(/^(\d+):(\d+)$/);
                 if(hmMatch) {
                    totalSeconds = parseInt(hmMatch[1], 10) * 3600 + parseInt(hmMatch[2], 10) * 60;
                 } else {
                    // Fallback for simple numbers or original format
                    const minutesMatch = durationString.match(/(\d+)\s*(min|minute|minutes|m)/);
                    const secondsMatch = durationString.match(/(\d+)\s*(s|sec|second|seconds)/);
                    const justNumberMatch = durationString.match(/^(\d+)$/);
                    if (minutesMatch) { totalSeconds += parseInt(minutesMatch[1], 10) * 60; }
                    if (secondsMatch) { totalSeconds += parseInt(secondsMatch[1], 10); } 
                    else if (justNumberMatch && !minutesMatch && !secondsMatch) { totalSeconds += parseInt(justNumberMatch[1], 10); }
                 }
            }
            if (isNaN(totalSeconds) || totalSeconds === 0) { return 0; }
            return totalSeconds;
        }

        function openWarmupModal() { document.getElementById('warmupSetsResult').innerHTML = ''; document.getElementById('workingSetWeightInput').value = ''; openModal(warmupModal); }
        
        function calculateWarmupSets() { 
            const workingWeight = parseFloat(document.getElementById('workingSetWeightInput').value); 
            const resultDiv = document.getElementById('warmupSetsResult'); 
            resultDiv.innerHTML = ''; 
            
            if (isNaN(workingWeight) || workingWeight <= 0) { 
                resultDiv.innerHTML = '<p class="text-red-400">Por favor, introduce un peso válido.</p>'; 
                return; 
            } 
            
            // MODIFIED: Calculation now based on a target of 6 reps
            const sets = [ 
                { weight: workingWeight * 0.5, reps: '8', label: 'Serie 1' }, 
                { weight: workingWeight * 0.7, reps: '6', label: 'Serie 2' }, 
                { weight: workingWeight * 0.85, reps: '3', label: 'Serie 3' }, 
            ]; 
            
            const list = document.createElement('ul'); 
            list.className = 'list-disc list-inside space-y-1'; 
            
            sets.forEach(set => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span class="font-semibold text-yellow-400">${set.label}:</span> ${set.weight.toFixed(1)} Kg x ${set.reps} reps`; 
                list.appendChild(li); 
            }); 
            
            resultDiv.appendChild(list); 
        }
        function prepareShareableCard() { const cardContent = document.getElementById('shareCard'); const dayData = workoutData[currentActiveDayKey]; const totalVolume = workoutSummaryTotalVolume.textContent; const totalTime = workoutSummaryTotalTime.textContent; cardContent.innerHTML = ` <h4>${dayData.name.toUpperCase()}</h4> <img src="https://storage.googleapis.com/msgsndr/dikOTQ4DE3OClw85d5oB/media/6821cea25072096f7d31d5c1.png" class="logo" alt="Logo"> <p><strong><i class="fas fa-clock mr-2"></i>Tiempo:</strong> ${totalTime}</p> <p><strong><i class="fas fa-weight-hanging mr-2"></i>Volumen:</strong> ${totalVolume}</p> <p class="text-center text-xs mt-4">¡Entrenamiento completado!</p> `; openModal(shareModal); }
        function downloadShareableImage() { const cardToCapture = document.getElementById('shareCard'); html2canvas(cardToCapture, { backgroundColor: null, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = 'resumen-entrenamiento.png'; link.href = canvas.toDataURL('image/png'); link.click(); }); }
        
        function startEmom(dayKey, mainOrder) {
            const emomBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.isEMOM);
            if (!emomBlock || !emomBlock.emomDetails || !emomBlock.items) {
                showCustomAlert("Datos de EMOM no encontrados.", "error"); return;
            }
            emomExercisesArray = emomBlock.items;
            totalEmomIntervals = parseInt(emomBlock.emomDetails.totalIntervals, 10);
            emomWorkIntervalSeconds = 60;
            currentEmomMainOrder = mainOrder;
            if (isNaN(totalEmomIntervals) || isNaN(emomWorkIntervalSeconds) || emomWorkIntervalSeconds <= 0) {
                showCustomAlert("Configuración de EMOM inválida.", "error"); return;
            }
            currentEmomIntervalNumber = 0;
            currentEmomExerciseIndex = 0;
            openModal(emomTimerModal);
            startCountdownTimer('emom');
        }

        function runNextEmomInterval() {
            clearInterval(emomIntervalTimer);
            if (currentEmomIntervalNumber >= totalEmomIntervals) {
                terminateEmom(true); return;
            }
            currentEmomIntervalNumber++;
            currentEmomExerciseIndex = (currentEmomIntervalNumber - 1) % emomExercisesArray.length;
            const currentExercise = emomExercisesArray[currentEmomExerciseIndex];
            updateEmomModalDisplay(currentExercise);
            let timeLeftInInterval = emomWorkIntervalSeconds;
            emomStateLabel.textContent = 'TRABAJO';
            emomStateLabel.className = 'state-label work';
            // MODIFIED: Format to HH:MM:SS
            emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
            emomIntervalTimer = setInterval(() => {
                timeLeftInInterval--;
                // MODIFIED: Format to HH:MM:SS
                emomIntervalTimerDisplay.textContent = formatTime(timeLeftInInterval);
                if (timeLeftInInterval <= 3 && timeLeftInInterval > 0) {
                    playTimerSound("C4", "16n");
                }
                if (timeLeftInInterval <= 0) {
                    clearInterval(emomIntervalTimer);
                    playTimerSound("A5", "8n");
                    runNextEmomInterval();
                }
            }, 1000);
        }

        function updateEmomModalDisplay(exercise) {
            emomOverallProgress.textContent = `Intervalo ${currentEmomIntervalNumber} de ${totalEmomIntervals}`;
            emomCurrentExerciseName.textContent = exercise.name;
            emomCurrentExerciseReps.textContent = exercise.reps || 'N/A';
            emomCurrentExerciseWeight.textContent = exercise.kg || '--';
            const imgElement = document.getElementById('emomCurrentImage');
            if (imgElement && exercise.imageUrl) {
                imgElement.src = exercise.imageUrl;
                imgElement.style.display = 'block';
            } else if (imgElement) {
                imgElement.style.display = 'none';
                imgElement.src = '';
            }
        }

        function terminateEmom(completed = false) {
            clearInterval(emomIntervalTimer);
            closeModalElement(emomTimerModal);
            if (completed) { showCustomAlert("¡EMOM completado!", "info"); } 
            else { showCustomAlert("EMOM terminado antes de tiempo.", "warning"); }
        }

        function terminateEmomEarly() { terminateEmom(false); }
        function skipEmomInterval() {
            clearInterval(emomIntervalTimer);
            playTimerSound("A4", "8n");
            runNextEmomInterval();
        }

        // MODIFIED: Circuit timer logic
        function startCircuit(dayKey, mainOrder) {
            const circuitBlock = workoutData[dayKey].exercises.find(ex => ex.order === mainOrder && ex.circuitDetails);
            if (!circuitBlock || !circuitBlock.circuitDetails || !circuitBlock.items) {
                showCustomAlert("Datos de Circuito no encontrados.", "error"); return;
            }
            circuitExercisesArray = circuitBlock.items;
            circuitDetailsGlobal = circuitBlock.circuitDetails;
            currentCircuitMainOrder = mainOrder;
            if (isNaN(circuitDetailsGlobal.totalRounds) || circuitDetailsGlobal.totalRounds <= 0) {
                showCustomAlert("Configuración de Circuito inválida.", "error"); return;
            }
            currentCircuitRound = 1; // Start at round 1
            currentCircuitExerciseIndexInRound = 0;
            currentCircuitPhase = 'countdown'; 
            currentCircuitTimeLeft = 5;
            openModal(circuitTimerModal);
            startCountdownTimer('circuit');
        }

        function runNextCircuitInterval() {
            clearInterval(circuitTimerInterval);

            // Determine next phase
            if (currentCircuitPhase === 'countdown') {
                currentCircuitPhase = 'working';
            } else if (currentCircuitPhase === 'working') {
                currentCircuitExerciseIndexInRound++;
                if (currentCircuitExerciseIndexInRound >= circuitExercisesArray.length) {
                    // End of a round
                    if (currentCircuitRound < circuitDetailsGlobal.totalRounds) {
                        currentCircuitPhase = 'resting_round';
                    } else {
                        terminateCircuit(true);
                        return;
                    }
                } else {
                    // Rest between exercises
                    currentCircuitPhase = 'resting_exercise';
                }
            } else if (currentCircuitPhase === 'resting_exercise') {
                currentCircuitPhase = 'working';
            } else if (currentCircuitPhase === 'resting_round') {
                currentCircuitRound++;
                currentCircuitExerciseIndexInRound = 0;
                currentCircuitPhase = 'working';
            }
            
            // Set time for the new phase
            switch(currentCircuitPhase) {
                case 'working':
                    const currentExercise = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    currentCircuitTimeLeft = parseDurationToSeconds(currentExercise.reps);
                    if (currentCircuitTimeLeft === 0 && isTimeBased(currentExercise.reps)) {
                         showCustomAlert(`Ejercicio ${currentExercise.name} no tiene duración definida. Saltando.`, "warning");
                         runNextCircuitInterval(); // Skip to next interval
                         return;
                    }
                    break;
                case 'resting_exercise':
                    currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenExercisesSeconds);
                    break;
                case 'resting_round':
                    currentCircuitTimeLeft = parseDurationToSeconds(circuitDetailsGlobal.restBetweenRoundsSeconds);
                    break;
            }

            updateCircuitModalDisplay();

            // Start the timer if the phase has a duration
            if (currentCircuitTimeLeft > 0) {
                circuitTimerInterval = setInterval(() => {
                    currentCircuitTimeLeft--;
                    // MODIFIED: Format to HH:MM:SS
                    circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
                    if (currentCircuitTimeLeft <= 3 && currentCircuitTimeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                    if (currentCircuitTimeLeft <= 0) {
                        clearInterval(circuitTimerInterval);
                        playTimerSound("A5", "8n");
                        runNextCircuitInterval();
                    }
                }, 1000);
            } else {
                // If there's no duration (e.g., rep-based exercise), move to the next interval immediately
                runNextCircuitInterval();
            }
        }

        function updateCircuitModalDisplay() {
            circuitOverallProgress.textContent = `Ronda ${currentCircuitRound} de ${circuitDetailsGlobal.totalRounds}`;
            // MODIFIED: Format to HH:MM:SS
            circuitTimerDisplay.textContent = formatTime(currentCircuitTimeLeft);
            let exerciseForDisplay = null;
            switch (currentCircuitPhase) {
                case 'countdown':
                    exerciseForDisplay = circuitExercisesArray[0];
                    circuitStateLabel.textContent = 'CUENTA ATRÁS';
                    circuitStateLabel.className = 'state-label countdown';
                    circuitExerciseName.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`;
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'working':
                    exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    circuitStateLabel.textContent = 'TRABAJO';
                    circuitStateLabel.className = 'state-label work';
                    circuitExerciseName.textContent = exerciseForDisplay?.name || '';
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'resting_exercise':
                    exerciseForDisplay = circuitExercisesArray[currentCircuitExerciseIndexInRound];
                    circuitStateLabel.textContent = 'DESCANSO';
                    circuitStateLabel.className = 'state-label rest';
                    circuitExerciseName.textContent = `Siguiente: ${exerciseForDisplay?.name || ''}`;
                    circuitExerciseDetails.textContent = `Objetivo: ${exerciseForDisplay?.reps || ''}`;
                    break;
                case 'resting_round':
                    exerciseForDisplay = circuitExercisesArray[0];
                    circuitStateLabel.textContent = 'DESCANSO';
                    circuitStateLabel.className = 'state-label rest';
                    circuitExerciseName.textContent = `Prepárate para la Ronda ${currentCircuitRound + 1}`;
                    circuitExerciseDetails.textContent = `Empezando con: ${exerciseForDisplay?.name || ''}`;
                    break;
            }
            const imgElement = document.getElementById('circuitCurrentImage');
            if (imgElement && exerciseForDisplay && exerciseForDisplay.imageUrl) {
                imgElement.src = exerciseForDisplay.imageUrl;
                imgElement.style.display = 'block';
            } else if (imgElement) {
                imgElement.style.display = 'none';
                imgElement.src = '';
            }
        }
        
        function terminateCircuit(completed = false) {
            clearInterval(circuitTimerInterval);
            closeModalElement(circuitTimerModal);
            if (completed) { showCustomAlert("¡Circuito completado!", "info"); } 
            else { showCustomAlert("Circuito terminado antes de tiempo.", "warning"); }
        }

        function terminateCircuitEarly() { terminateCircuit(false); }
        
        function skipCircuitInterval() {
            clearInterval(circuitTimerInterval);
            playTimerSound("A4", "8n");
            runNextCircuitInterval(); // The main function now handles all state transitions correctly
        }

        // MODIFIED: Updated formatTime to HH:MM:SS
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // NEW: Format time to HH:MM only
        function formatTimeHHMM(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
        }

        let countdownTimerInterval = null;
        let countdownTimeLeft = 0;
        let countdownCallback = null;
        let countdownType = '';

        // MODIFIED: startCountdownTimer to handle the new work timer UI
        function startCountdownTimer(type, duration = 5, callback = null) {
            countdownType = type;
            countdownTimeLeft = duration;
            countdownCallback = callback;
            clearInterval(countdownTimerInterval);

            let modalTitleEl, timerDisplayEl, stateLabelEl, progressEl, nameEl, detailsEl, imgEl;
            if (type === 'work') {
                modalTitleEl = workTimerTitle;
                timerDisplayEl = workTimerDisplay;
                stateLabelEl = workStateLabel;
                progressEl = workOverallProgress;
                nameEl = workExerciseName;
                detailsEl = workExerciseDetails;
                imgEl = workCurrentImage;
                openModal(workTimerModal);
            } else if (type === 'emom') {
                modalTitleEl = emomTimerTitle;
                timerDisplayEl = emomIntervalTimerDisplay;
                stateLabelEl = emomStateLabel;
                openModal(emomTimerModal);
            } else if (type === 'circuit') {
                modalTitleEl = circuitTimerTitle;
                timerDisplayEl = circuitTimerDisplay;
                stateLabelEl = circuitStateLabel;
                openModal(circuitTimerModal);
            }

            if (modalTitleEl) modalTitleEl.textContent = 'PREPÁRATE';
            if (stateLabelEl) {
                stateLabelEl.textContent = 'CUENTA ATRÁS';
                stateLabelEl.className = 'state-label countdown';
            }
            
            if (type === 'work' && currentTimedExerciseCardId) {
                const card = document.getElementById(currentTimedExerciseCardId);
                if (card) {
                    const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
                    if(progressEl) progressEl.textContent = `Serie ${currentTimedExerciseSetNumber} de ${totalSetsForCurrentTimedExercise}`;
                    if(nameEl) nameEl.textContent = `Empezando con: ${exerciseData.name}`;
                    if(detailsEl) detailsEl.textContent = `Objetivo: ${exerciseData.reps}`;
                    if (imgEl && exerciseData.imageUrl) {
                        imgEl.src = exerciseData.imageUrl;
                        imgEl.style.display = 'block';
                    } else if (imgEl) {
                        imgEl.style.display = 'none';
                        imgEl.src = '';
                    }
                }
            }
            
            if (timerDisplayEl) timerDisplayEl.textContent = formatTime(countdownTimeLeft);

            countdownTimerInterval = setInterval(() => {
                countdownTimeLeft--;
                if (timerDisplayEl) timerDisplayEl.textContent = formatTime(countdownTimeLeft);
                if (countdownTimeLeft <= 0) {
                    clearInterval(countdownTimerInterval);
                    playTimerSound("A5", "8n");
                    if (type === 'work') {
                        if (currentTimedExerciseCardId !== null) {
                            runWorkTimerForTimedExercise(parseDurationToSeconds(JSON.parse(document.getElementById(currentTimedExerciseCardId).dataset.originalExerciseData).reps));
                        } else { runWorkTimer(); }
                    } else if (type === 'emom') { runNextEmomInterval(); } 
                    else if (type === 'circuit') { runNextCircuitInterval(); }
                    if (countdownCallback) countdownCallback();
                } else if (countdownTimeLeft <= 3 && countdownTimeLeft > 0) {
                    playTimerSound("C4", "16n");
                }
            }, 1000);
        }

        function startWorkTimer(durationSeconds, exerciseCardId) {
            currentWorkDuration = durationSeconds;
            clearInterval(workTimerInterval);
            startCountdownTimer('work', 5, () => { runWorkTimer(); });
        }

        function runWorkTimer() {
            workTimerEndTime = Date.now() + currentWorkDuration * 1000;
            updateWorkTimerDisplay(currentWorkDuration);
            openModal(workTimerModal);
            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(workTimerInterval);
                    closeWorkTimerModal(false);
                    playTimerSound("A5", "8n");
                } else {
                    updateWorkTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function updateWorkTimerDisplay(timeLeft) {
            const seconds = timeLeft % 60;
            const minutes = Math.floor(timeLeft / 60);
            workTimerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function closeWorkTimerModal(skipped = false) { 
            clearInterval(workTimerInterval); 
            closeModalElement(workTimerModal); 
            if (skipped && currentTimedExerciseCardId !== null) {
                finalizeTimedExerciseSequence();
                showCustomAlert("Ejercicio basado en tiempo finalizado antes de tiempo.", "warning");
            }
        }

        function handleTimeBasedRepsClick(inputElement, cardId) {
            if (!isWorkoutInProgress) {
                showCustomAlert("Inicia el entrenamiento primero para usar el cronómetro.", "warning");
                return;
            }
            const card = document.getElementById(cardId);
            if (!card) return;
            if (currentTimedExerciseCardId === cardId && workTimerInterval !== null) {
                showCustomAlert("El cronómetro para este ejercicio ya está activo.", "info");
                return;
            }
            if (currentTimedExerciseCardId !== null && currentTimedExerciseCardId !== cardId && workTimerInterval !== null) {
                 showCustomAlert("Ya hay un cronómetro de ejercicio activo. Finalízalo antes de empezar otro.", "warning");
                 return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            const workDuration = parseDurationToSeconds(exerciseData.reps);
            const totalSets = parseInt(card.dataset.totalSets, 10);
            const restDurationMatch = typeof exerciseData.rest === 'string' ? exerciseData.rest.match(/(\d+)s/) : null;
            currentRestDurationForTimedExercise = restDurationMatch ? parseInt(restDurationMatch[1], 10) : 0;
            if (workDuration <= 0) {
                showCustomAlert("Duración de trabajo no válida para el ejercicio basado en tiempo.", "error");
                return;
            }
            currentTimedExerciseCardId = cardId;
            currentTimedExerciseSetNumber = 1;
            totalSetsForCurrentTimedExercise = totalSets;
            timedExerciseSetsLogged = [];
            const registerBtn = card.querySelector('.quick-view-body .quick-mode-register-button');
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<i class="fas fa-hourglass-half text-xl"></i>';
            }
            startCountdownTimer('work', 5);
        }

        // MODIFIED: runWorkTimerForTimedExercise to populate the new UI
        function runWorkTimerForTimedExercise(durationSeconds) {
            clearInterval(workTimerInterval);
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found for work timer.");
                finalizeTimedExerciseSequence();
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            workTimerEndTime = Date.now() + durationSeconds * 1000;
            
            workTimerTitle.textContent = 'TIEMPO DE TRABAJO';
            workOverallProgress.textContent = `Serie ${currentTimedExerciseSetNumber} de ${totalSetsForCurrentTimedExercise}`;
            workStateLabel.textContent = 'TRABAJO';
            workStateLabel.className = 'state-label work';
            workExerciseName.textContent = exerciseData.name;
            workExerciseDetails.textContent = `Objetivo: ${exerciseData.reps}`;
            if (workCurrentImage && exerciseData.imageUrl) {
                workCurrentImage.src = exerciseData.imageUrl;
                workCurrentImage.style.display = 'block';
            } else if (workCurrentImage) {
                workCurrentImage.style.display = 'none';
                workCurrentImage.src = '';
            }

            updateWorkTimerDisplay(durationSeconds);
            openModal(workTimerModal);

            workTimerInterval = setInterval(() => {
                const timeLeft = Math.round((workTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(workTimerInterval);
                    closeWorkTimerModal(false);
                    playTimerSound("A5", "8n");
                    timedExerciseSetsLogged.push({
                        serie: currentTimedExerciseSetNumber,
                        kg: 'N/A',
                        reps: exerciseData.reps,
                        isQuickMode: true,
                        completionState: 'good'
                    });
                    if (currentTimedExerciseSetNumber < totalSetsForCurrentTimedExercise) {
                        currentTimedExerciseSetNumber++;
                        startRestTimerForTimedExercise();
                    } else {
                        finalizeTimedExerciseSequence();
                    }
                } else {
                    updateWorkTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function startRestTimerForTimedExercise() {
            clearInterval(restTimerInterval);
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found for rest timer.");
                finalizeTimedExerciseSequence();
                return;
            }
            const exerciseData = JSON.parse(card.dataset.originalExerciseData || '{}');
            let nextExerciseForRest = null;
            if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) {
                nextExerciseForRest = {
                    name: card.dataset.currentName,
                    reps: exerciseData.reps,
                    kg: 'N/A'
                };
            } else {
                const allExerciseCards = Array.from(quickModeExerciseList.querySelectorAll('.quick-mode-exercise-item, .quick-mode-superset-container'));
                const currentCardElement = document.getElementById(currentTimedExerciseCardId);
                const currentCardIndex = allExerciseCards.findIndex(el => el.id === currentTimedExerciseCardId || el.contains(currentCardElement));
                if (currentCardIndex !== -1) {
                    let nextCard = null;
                    for (let i = currentCardIndex + 1; i < allExerciseCards.length; i++) {
                        if (allExerciseCards[i].classList.contains('quick-mode-exercise-item')) {
                            nextCard = allExerciseCards[i];
                            break;
                        } else if (allExerciseCards[i].classList.contains('quick-mode-superset-container')) {
                            const firstSubExercise = allExerciseCards[i].querySelector('.quick-mode-exercise-item');
                            if (firstSubExercise) {
                                nextCard = firstSubExercise;
                                break;
                            }
                        }
                    }
                    if (nextCard) {
                        nextExerciseForRest = {
                            name: nextCard.dataset.currentName,
                            reps: nextCard.querySelector('input[aria-label*="Repeticiones"]')?.placeholder || 'N/A',
                            kg: nextCard.querySelector('input[aria-label*="Peso"]')?.placeholder || '--'
                        };
                    }
                }
            }
            currentRestDuration = currentRestDurationForTimedExercise;
            restTimerEndTime = Date.now() + currentRestDuration * 1000;
            restTimerTitle.textContent = `DESCANSO - Serie ${currentTimedExerciseSetNumber - 1} de ${totalSetsForCurrentTimedExercise} completada`;
            restStateLabel.textContent = 'DESCANSO';
            restStateLabel.className = 'state-label rest';
            if (nextExerciseForRest) {
                restExerciseName.textContent = `Siguiente: ${nextExerciseForRest.name || ''}`;
                restExerciseDetails.textContent = `Objetivo: ${nextExerciseForRest.reps || ''} con ${nextExerciseForRest.kg || '--'} Kg`;
            } else {
                restExerciseName.textContent = 'Entrenamiento casi terminado';
                restExerciseDetails.textContent = '';
            }
            minimizedRestTimer.classList.remove('is-active');
            openModal(restTimerModal);
            playTimerSound("C5", "16n");
            restTimerInterval = setInterval(() => {
                const timeLeft = Math.round((restTimerEndTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(restTimerInterval);
                    closeRestTimerModal(false);
                    playTimerSound("A5", "8n");
                     if (currentTimedExerciseSetNumber <= totalSetsForCurrentTimedExercise) {
                        const workDuration = parseDurationToSeconds(exerciseData.reps);
                        startCountdownTimer('work', 5);
                    } else {
                        finalizeTimedExerciseSequence();
                    }
                } else {
                    updateRestTimerDisplay(timeLeft);
                    if (timeLeft <= 3 && timeLeft > 0) {
                        playTimerSound("C4", "16n");
                    }
                }
            }, 1000);
        }

        function finalizeTimedExerciseSequence() {
            const card = document.getElementById(currentTimedExerciseCardId);
            if (!card) {
                console.error("Timed exercise card not found during finalization.");
                return;
            }
            const exerciseName = card.dataset.currentName;
            const logEntry = {
                exerciseName,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                rawDate: new Date().toISOString(),
                dayKey: card.dataset.dayKey,
                setsPerformed: timedExerciseSetsLogged,
                completionState: 'good'
            };
            const existingEntryIndex = currentWorkoutSummaryData.findIndex(e => e.exerciseName === exerciseName);
            if (existingEntryIndex > -1) {
                currentWorkoutSummaryData[existingEntryIndex] = logEntry;
            } else {
                currentWorkoutSummaryData.push(logEntry);
            }
            card.dataset.completionState = 'good';
            updateAllExerciseCardInputStates();
            showCustomAlert(`¡Ejercicio "${exerciseName}" completado!`, "info");
            currentTimedExerciseCardId = null;
            currentTimedExerciseSetNumber = 0;
            totalSetsForCurrentTimedExercise = 0;
            currentRestDurationForTimedExercise = 0;
            timedExerciseSetsLogged = [];
        }

        // MODIFIED: This function now dynamically builds the URL for the workout data and reads client config.
        async function initializeWorkoutApp() {
            try {
                // Dynamically construct the workout data URL from the user identifier in the page URL.
                const workoutDataUrl = `https://raw.githubusercontent.com/hombresenforma/ivan-data/main/${userIdentifier || 'default-user'}.js`;
                console.log(`Fetching workout data from: ${workoutDataUrl}`);

                const mainResponse = await fetch(workoutDataUrl);
                if (!mainResponse.ok) {
                    throw new Error(`Network response for workout data was not ok: ${mainResponse.statusText} (URL: ${workoutDataUrl})`);
                }
                const mainDataText = await mainResponse.text();

                // REMOVED: Old logic for extracting datosCliente from the JS file
                
                // Extract workout data
                const workoutDataRegex = /const workoutData = ({[\s\S]*?});/;
                const workoutDataMatch = mainDataText.match(workoutDataRegex);
                if (!workoutDataMatch) throw new Error("Could not find 'workoutData' object in the main source file.");
                workoutData = new Function(`return ${workoutDataMatch[1]}`)();

                // Extract exercise alternatives
                const alternativesRegex = /const exerciseAlternatives = ({[\s\S]*?});/;
                const alternativesMatch = mainDataText.match(alternativesRegex);
                if (!alternativesMatch) throw new Error("Could not find 'exerciseAlternatives' object in the main source file.");
                exerciseAlternatives = new Function(`return ${alternativesMatch[1]}`)();
                
                await loadWorkoutLogs();
                setupDaySelectionTabs();
                // MODIFIED: Call new function to get video config from Supabase
                await fetchVideoConfigFromSupabase();

            } catch (error) {
                console.error("Error initializing workout app:", error);
                const previewContainer = document.getElementById('workoutPreviewContainer');
                if (previewContainer) {
                    previewContainer.innerHTML = `<p class="text-center text-red-500 font-semibold">Error al cargar la rutina. Asegúrate de que el usuario en la URL ('${userIdentifier}') es correcto y tiene un plan asignado.</p>`;
                }
            }
        }
        
        // NEW: Function to fetch video config from Supabase
        async function fetchVideoConfigFromSupabase() {
            if (!supabase || !userIdentifier) {
                console.warn("Supabase client or user identifier not available. Cannot fetch video config.");
                setupVideoCorrectionsButton(); // Set up with default 'none'
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_configs')
                    .select('exercises_data')
                    .eq('client_id', userIdentifier)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 means no row found, which is a valid case
                    console.error("Error fetching video config from Supabase:", error);
                    showCustomAlert("Error al cargar la configuración de correcciones de vídeo.", "error");
                }
                
                if (data && data.exercises_data && data.exercises_data.activeWeeks) {
                    VIDEO_PROMPT_CONFIG.activeWeeks = data.exercises_data.activeWeeks;
                    console.log(`Video activeWeeks configured from Supabase to: "${VIDEO_PROMPT_CONFIG.activeWeeks}"`);
                } else {
                    console.log('No video config found in Supabase for this user. Using default \'none\'.');
                    VIDEO_PROMPT_CONFIG.activeWeeks = 'none';
                }

            } catch (e) {
                console.error("Unexpected error fetching video config:", e);
                showCustomAlert("Error inesperado al cargar la configuración de vídeo.", "error");
            }

            // Always call the setup button function after attempting to fetch the config
            setupVideoCorrectionsButton();
        }

        // NEW: Function to configure the new video corrections button
        function setupVideoCorrectionsButton() {
            const videoCorrectionsButton = document.getElementById('videoCorrectionsButton');
            if (!videoCorrectionsButton) return;

            const currentWeek = getWeekNumber(new Date());
            const config = VIDEO_PROMPT_CONFIG.activeWeeks;
            let isFeatureActive = false;

            if (config === 'all') {
                isFeatureActive = true;
            } else if (config === 'none') {
                isFeatureActive = false;
            } else if (config === 'even') {
                isFeatureActive = currentWeek % 2 === 0;
            } else if (config === 'odd') {
                isFeatureActive = currentWeek % 2 !== 0;
            } else if (Array.isArray(config)) {
                isFeatureActive = config.includes(currentWeek);
            }

            if (isFeatureActive) {
                videoCorrectionsButton.classList.remove('button-disabled');
                videoCorrectionsButton.addEventListener('click', () => {
                    window.open(APP_CONFIG.urls.videoUploadUrl, '_blank');
                });
            } else {
                videoCorrectionsButton.classList.add('button-disabled');
                videoCorrectionsButton.addEventListener('click', () => {
                    openModal(document.getElementById('weekdayNoticeModal'));
                });
            }
        }

        async function loadWorkoutLogs() {
            if (!supabase || !userIdentifier) {
                console.warn("Supabase client or user identifier not available. Cannot load workout logs.");
                individualExerciseLogs = [];
                workoutSessionSummaries = [];
                extraActivities = [];
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('workout_logs')
                    .select('*')
                   .eq('client_id', userIdentifier)
                    .order('raw_date', { ascending: false });
                if (error) {
                    console.error("Error loading workout logs from Supabase:", error);
                    showCustomAlert("No se pudo cargar el historial de entrenamientos.", "error");
                    individualExerciseLogs = [];
                    workoutSessionSummaries = [];
                    extraActivities = [];
                    return;
                }
                individualExerciseLogs = data.filter(log => log.exercise_name !== "Workout Session Summary" && log.exercise_name !== "Extra Activity");
                workoutSessionSummaries = data.filter(log => log.exercise_name === "Workout Session Summary");
                extraActivities = data.filter(log => log.exercise_name === "Extra Activity");
                console.log("Individual Exercise Logs loaded:", individualExerciseLogs);
                console.log("Workout Session Summaries loaded:", workoutSessionSummaries);
                console.log("Extra Activities loaded:", extraActivities);
            } catch (e) {
                console.error("Error inesperado al cargar el historial de entrenamientos.", "error");
                individualExerciseLogs = [];
                workoutSessionSummaries = [];
                extraActivities = [];
            }
        }

        function openFullWorkoutLogModal(sessionId) {
            closeModalElement(mainHistoryModal);
            fullWorkoutLogContent.innerHTML = '';
            const sessionSummaryEntry = workoutSessionSummaries.find(s => s.session_id === sessionId);
            if (!sessionSummaryEntry) {
                fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se encontraron detalles para este entrenamiento.</p>';
                openModal(fullWorkoutLogModal);
                return;
            }
            fullWorkoutLogTitle.textContent = `Entrenamiento del ${sessionSummaryEntry.date} a las ${sessionSummaryEntry.time}`;
            let exercisesInSession = [];
            try {
                exercisesInSession = JSON.parse(sessionSummaryEntry.sets_performed); 
            } catch (e) {
                console.error("Error parsing exercises_performed for session summary:", e);
                fullWorkoutLogContent.innerHTML = '<p class="text-red-400 text-center">Error al cargar los detalles del entrenamiento.</p>';
                openModal(fullWorkoutLogModal);
                return;
            }
            if (exercisesInSession.length === 0) {
                fullWorkoutLogContent.innerHTML = '<p class="text-gray-400 text-center">No se registraron ejercicios en esta sesión.</p>';
            } else {
                exercisesInSession.forEach(exerciseEntry => {
                    let maxRmForExerciseInSession = 0;
                    exerciseEntry.setsPerformed.forEach(set => {
                        if (!isTimeBased(set.reps)) {
                            const currentRm = calculateEpley1RM(set.kg, set.reps);
                            if (currentRm > maxRmForExerciseInSession) {
                                maxRmForExerciseInSession = currentRm;
                            }
                        }
                    });
                    const historicalMaxRmBeforeThisSession = getHistoricalMaxRmExcludingSession(exerciseEntry.exerciseName, sessionSummaryEntry.date, sessionSummaryEntry.time);
                    const isNewPR = historicalMaxRmBeforeThisSession > 0 && maxRmForExerciseInSession > historicalMaxRmBeforeThisSession;
                    const prIcon = isNewPR ? '<i class="fas fa-trophy pr-icon ml-2" title="¡Nuevo Récord Personal!"></i>' : '';
                    const escapedExerciseName = exerciseEntry.exerciseName.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    const exerciseHtml = document.createElement('div');
                    exerciseHtml.className = 'workout-log-entry';
                    exerciseHtml.innerHTML = `
                        <h4 onclick="viewExerciseHistoryFromLog('${escapedExerciseName}')" style="cursor: pointer;" title="Ver historial de este ejercicio">${exerciseEntry.exerciseName}${prIcon}</h4>
                        <ul>
                            ${exerciseEntry.setsPerformed.map(set => { // Note: it's setsPerformed here
                                const completionClass = set.completionState === 'good' ? 'history-reps-good' : (set.completionState === 'bad' ? 'history-reps-bad' : '');
                                const repsUnit = isTimeBased(set.reps) ? 's' : 'reps';
                                return `<li>S.${set.serie}: ${set.kg || 0}kg x <span class="${completionClass}">${set.reps || 0} ${repsUnit}</span></li>`;
                            }).join('')}
                        </ul>
                    `;
                    fullWorkoutLogContent.appendChild(exerciseHtml);
                });
            }
            openModal(fullWorkoutLogModal);
        }

        function setupDaySelectionTabs() { 
            daySelectionTabsContainer.innerHTML = ''; 
            if (typeof workoutData === 'undefined') { 
                return; 
            } 
            const dayKeys = Object.keys(workoutData); 
            dayKeys.forEach((dayKey) => { 
                const tab = document.createElement('button'); 
                tab.className = 'day-tab'; 
                // Corrected: Access name from workoutData[dayKey]
                tab.textContent = workoutData[dayKey].name.split(':')[0].trim(); 
                tab.dataset.dayKey = dayKey; 
                tab.onclick = () => displayWorkoutPreview(dayKey); 
                daySelectionTabsContainer.appendChild(tab); 
            }); 
            if (dayKeys[0]) { 
                displayWorkoutPreview(dayKeys[0]); 
            } 
        }
        
        // Modified displayWorkoutPreview to use window.workoutData explicitly
        function displayWorkoutPreview(dayKey) { 
            currentActiveDayKey = dayKey; 
            if (typeof workoutData === 'undefined' || !workoutData[dayKey]) { 
                return; 
            } 
            const dayData = workoutData[dayKey]; 
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.dayKey === dayKey)); 
            let previewHtml = `<h3>${dayData.name.toUpperCase()}</h3><ul>`; 
            dayData.exercises.forEach(ex => { 
                let titleText = ''; 
                if (ex.isEMOM) { titleText = 'EMOM'; } 
                else if (ex.circuitDetails) { titleText = 'CIRCUITO'; } 
                else if (ex.isSuperset) { titleText = 'SUPERSERIE'; } 
                else { titleText = ex.name; } 
                previewHtml += `<li>${ex.order}. ${titleText.toUpperCase()}</li>`; 
                if (ex.items && Array.isArray(ex.items)) { 
                    ex.items.forEach(sub => { previewHtml += `<li style="padding-left: 1.5rem;">${ex.order}.${sub.subOrder}. ${sub.name}</li>`; }); 
                } 
            }); 
            previewHtml += `</ul><button onclick="startQuickMode('${dayKey}')" class="start-workout-preview-button"><i class="fas fa-play mr-2"></i>Empezar Entrenamiento</button>`; 
            workoutPreviewContainer.innerHTML = previewHtml; 
        }

        // NEW: Function to set up the extras form modal
        function setupExtrasForm() {
            // Reset form fields
            extraActivitySelect.value = 'Pádel';
            otherActivityInputGroup.style.display = 'none';
            otherActivityNameInput.value = '';
            extraTimeInput.value = '';
            extraVolumeInput.value = '';
            extraCaptureInput.value = '';
            extraCaptureFileName.textContent = 'Ningún archivo seleccionado';
            uploadedCaptureFile = null;

            // Handle "Otros" option visibility
            extraActivitySelect.onchange = () => {
                if (extraActivitySelect.value === 'Otros') {
                    otherActivityInputGroup.style.display = 'block';
                } else {
                    otherActivityInputGroup.style.display = 'none';
                }
            };

            // Display selected file name
            extraCaptureInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    extraCaptureFileName.textContent = file.name;
                    uploadedCaptureFile = file;
                } else {
                    extraCaptureFileName.textContent = 'Ningún archivo seleccionado';
                    uploadedCaptureFile = null;
                }
            };
            
            // Set up the register button
            registerExtraActivityButton.onclick = () => {
                const activityName = extraActivitySelect.value === 'Otros' ? otherActivityNameInput.value.trim() : extraActivitySelect.value;
                if (activityName === '') {
                    showCustomAlert("Por favor, introduce el nombre de la actividad.", "warning");
                    return;
                }
                registerExtraActivity(activityName, extraTimeInput.value.trim(), extraVolumeInput.value.trim(), uploadedCaptureFile);
            };
        }

        // NEW: Function to upload file and register the extra activity
        async function registerExtraActivity(activityName, time, volume, captureFile) {
            if (!supabase || !userIdentifier) {
                showCustomAlert("No se pudo registrar la actividad. Usuario no identificado.", "error");
                return;
            }
            
            closeModalElement(extrasModal);
            showCustomAlert(`Registrando "${activityName}"...`, "info");
            
            let captureUrl = null;
            if (captureFile) {
                try {
                    const filePath = `extra_captures/${userIdentifier}/${Date.now()}_${captureFile.name}`;
                    const { data, error } = await supabase.storage
                        .from('workout-captures')
                        .upload(filePath, captureFile, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        throw new Error(`Error uploading image: ${error.message}`);
                    }
                    
                    // Construct the public URL
                    const publicUrl = supabase.storage
                        .from('workout-captures')
                        .getPublicUrl(filePath).data.publicUrl;
                    captureUrl = publicUrl;
                } catch (error) {
                    console.error("Error al subir la imagen:", error);
                    showCustomAlert(`Error al subir la imagen: ${error.message}`, "error");
                }
            }
            
            // MODIFIED: total_time_session is formatted to HH:MM before sending
            const [hoursStr = '0', minutesStr = '0'] = time.split(':');
            const totalTimeInSeconds = (parseInt(hoursStr) * 3600) + (parseInt(minutesStr) * 60);

            const logEntry = {
                client_id: userIdentifier,
                date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                raw_date: new Date().toISOString(),
                exercise_name: "Extra Activity", // Unique identifier for extra activities
                name_workout: activityName,
                sets_performed: '[]', // Placeholder to maintain schema consistency
                completion_state: "completed",
                session_id: crypto.randomUUID(),
                total_time_session: formatTimeHHMM(totalTimeInSeconds) || null,
                total_volume_session: volume || null,
                capture_url: captureUrl
            };
            
            try {
                const { error } = await supabase
                    .from('workout_logs')
                    .insert([logEntry]);
                
                if (error) {
                    throw new Error(`Error inserting extra activity log: ${error.message}`);
                }
                
                showCustomAlert(`Actividad "${activityName}" registrada con éxito.`, "info");
                await loadWorkoutLogs(); // Reload logs to show the new entry in history
                renderWorkoutHistoryList('all'); // Re-render the history list
            } catch (error) {
                console.error("Error al registrar la actividad extra:", error);
                showCustomAlert(`Error al registrar la actividad: ${error.message}`, "error");
            }
        }

    </script>
</body>
</html>
